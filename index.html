<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام تذاكر - إدارة البيانات والمبالغ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a5276);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            margin: 0 10px;
            text-align: center;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #e74c3c, #3498db);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(45deg); }
            50% { transform: translateY(-5px) rotate(45deg); }
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
            padding: 0 10px;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-section, .report-section {
            background-color: white;
            padding: 20px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
        }
        
        h2 {
            color: var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
            font-size: 1.5rem;
            position: relative;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 70px;
            height: 2px;
            background: linear-gradient(to left, var(--secondary-color), var(--success-color));
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #fafafa;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background-color: white;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }
        
        @media (min-width: 480px) {
            .radio-group {
                flex-direction: row;
            }
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 6px;
            background-color: #f8f9fa;
            transition: all 0.3s;
            flex: 1;
        }
        
        .radio-option input {
            width: auto;
            margin-left: 5px;
        }
        
        .radio-option label {
            margin-bottom: 0;
            flex: 1;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
            margin-top: 8px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .btn-print {
            background: linear-gradient(135deg, var(--primary-color), #1a252f);
            width: auto;
            margin: 0;
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .btn-reset {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            margin-top: 12px;
        }
        
        .btn-add-company {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            margin-bottom: 15px;
        }
        
        /* تحسينات للجدول على الهاتف */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* الحد الأدنى لعرض الجدول */
            font-size: 0.85rem;
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 12px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
            background-color: white;
        }
        
        tr:nth-child(even) td {
            background-color: #fafafa;
        }
        
        .total-row {
            font-weight: bold;
            background: linear-gradient(135deg, #e8f4fc, #d4eaf7) !important;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .total-row td {
            border-top: 2px solid var(--secondary-color);
        }
        
        .transaction-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .transaction-ticket {
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            color: #219653;
        }
        
        .transaction-fine {
            background: linear-gradient(135deg, #fde0dc, #f9c9c2);
            color: #c0392b;
        }
        
        .transaction-payment {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #2980b9;
        }
        
        .transaction-initial {
            background: linear-gradient(135deg, #f8f4e6, #f5e9c8);
            color: #d68910;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .summary-box {
            background: linear-gradient(135deg, white, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
        }
        
        .summary-box h3 {
            font-size: 0.9rem;
            color: var(--dark-color);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-box .value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .total-amount {
            color: var(--primary-color);
        }
        
        .total-tickets {
            color: var(--success-color);
        }
        
        .total-fines {
            color: var(--accent-color);
        }
        
        .total-payments {
            color: var(--secondary-color);
        }
        
        .company-selector {
            margin-bottom: 20px;
        }
        
        .company-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid var(--secondary-color);
        }
        
        @media (min-width: 480px) {
            .company-info {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-info h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin: 0;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .company-info h3 {
                text-align: right;
            }
        }
        
        .company-balance {
            font-size: 1.4rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 6px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .positive-balance {
            color: var(--success-color);
            border-right: 3px solid var(--success-color);
        }
        
        .negative-balance {
            color: var(--accent-color);
            border-right: 3px solid var(--accent-color);
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 0.85rem;
            padding-bottom: 20px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .form-section, .summary {
                display: none !important;
            }
            
            .report-section {
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
            }
            
            .company-info {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            
            table {
                font-size: 11px !important;
                box-shadow: none !important;
                min-width: 100% !important;
            }
            
            th, td {
                padding: 8px !important;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        .company-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .company-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            margin-bottom: 8px;
            border-radius: 6px;
            border-right: 3px solid var(--secondary-color);
        }
        
        @media (min-width: 480px) {
            .company-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .company-item-balance {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: white;
            font-size: 0.9rem;
        }
        
        .company-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .delete-company {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            flex: 1;
        }
        
        /* نافذة إضافة شركة جديدة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background: linear-gradient(135deg, white, #f8f9fa);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #eaeaea;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #7f8c8d;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .balance-type {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (min-width: 480px) {
            .balance-type {
                flex-direction: row;
            }
        }
        
        .debit-option, .credit-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }
        
        .debit-option.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
            color: var(--accent-color);
        }
        
        .credit-option.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
            color: var(--success-color);
        }
        
        .balance-explanation {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            font-size: 0.9rem;
            color: #555;
            border-right: 3px solid var(--secondary-color);
        }
        
        .explanation-positive {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .explanation-negative {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .initial-balance-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .report-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        @media (min-width: 480px) {
            .report-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-report-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .company-report-title {
                text-align: right;
            }
        }
        
        .destination-abbr {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            color: #333;
            font-size: 0.8rem;
        }
        
        /* تحسينات للشاشات الصغيرة جداً */
        @media (max-width: 360px) {
            header {
                padding: 15px 10px;
            }
            
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .logo-icon {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
            
            .form-section, .report-section {
                padding: 15px 10px;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-box {
                padding: 12px;
            }
            
            .summary-box .value {
                font-size: 1.3rem;
            }
        }
        
        /* تحسينات للشاشات المتوسطة */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                flex-direction: row;
            }
            
            .form-section {
                flex: 1;
            }
            
            .report-section {
                flex: 2;
            }
            
            header {
                padding: 25px 20px;
            }
            
            .logo {
                flex-direction: row;
                justify-content: center;
            }
            
            .logo h1 {
                font-size: 2.2rem;
            }
            
            .logo-icon {
                width: 80px;
                height: 80px;
                font-size: 3rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
        
        /* منع التكبير التلقائي على الحقول */
        input, select, textarea {
            font-size: 16px !important; /* يمنع التكبير التلقائي في iOS */
        }
        
        /* تحسينات للأجهزة التي تدعم اللمس */
        @media (hover: none) and (pointer: coarse) {
            .btn, .delete-company, .radio-option, .debit-option, .credit-option {
                min-height: 44px; /* الحجم الأدنى للمس */
            }
            
            input, select, textarea {
                min-height: 44px;
            }
        }
        
        /* إخفاء شريط التمرير في بعض المتصفحات */
        .company-list::-webkit-scrollbar {
            width: 5px;
        }
        
        .company-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .company-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
        
        .company-list::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        
        /* رسالة عدم وجود بيانات */
        #no-data, #no-companies {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-row">
                <div class="logo-icon">
                    <i class="fas fa-plane airplane-icon"></i>
                </div>
                <h1>نظام تذاكر</h1>
            </div>
        </div>
        <p class="subtitle">برنامج إدارة بيانات التذاكر والمبالغ - متابعة العمليات المالية مع الشركات</p>
    </header>
    
    <div class="container">
        <div class="form-section no-print">
            <h2><i class="fas fa-plus-circle"></i> تسجيل عملية جديدة</h2>
            
            <!-- إدارة الشركات -->
            <button class="btn btn-add-company" id="open-add-company-modal">
                <i class="fas fa-plus"></i> إضافة شركة جديدة
            </button>
            
            <div class="company-list" id="company-list">
                <p id="no-companies">لا توجد شركات مضافة بعد</p>
            </div>
            
            <div class="company-selector">
                <label for="company">اختر الشركة</label>
                <select id="company">
                    <option value="">-- اختر الشركة --</option>
                </select>
            </div>
            
            <div class="company-info">
                <div>
                    <h3 id="current-company">--</h3>
                    <p style="color: #666; margin-top: 5px; font-size: 0.9rem;">الرصيد الحالي</p>
                </div>
                <div class="company-balance" id="company-balance">0 دينار</div>
            </div>
            
            <div class="form-group">
                <label>نوع العملية</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="ticket" name="transaction-type" value="ticket" checked>
                        <label for="ticket">تذكرة</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="fine" name="transaction-type" value="fine">
                        <label for="fine">غرامة</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="payment" name="transaction-type" value="payment">
                        <label for="payment">تسليم دفعة</label>
                    </div>
                </div>
            </div>
            
            <!-- حقول التذكرة والغرامة -->
            <div id="ticket-fine-fields">
                <div class="form-group">
                    <label for="passenger-name">اسم المسافر</label>
                    <input type="text" id="passenger-name" placeholder="أدخل اسم المسافر">
                </div>
                
                <div class="form-group">
                    <label for="document-number">رقم المستند</label>
                    <input type="text" id="document-number" placeholder="أدخل رقم المستند">
                </div>
                
                <div class="form-group">
                    <label for="destination">الوجهة</label>
                    <select id="destination">
                        <option value="TIP - IST">طرابلس - اسطنبول (TIP - IST)</option>
                        <option value="TIP - ANK">طرابلس - أنقرة (TIP - ANK)</option>
                        <option value="TIP - IZM">طرابلس - إزمير (TIP - IZM)</option>
                        <option value="TIP - BJV">طرابلس - بودروم (TIP - BJV)</option>
                        <option value="TIP - DXB">طرابلس - دبي (TIP - DXB)</option>
                        <option value="TIP - CAI">طرابلس - القاهرة (TIP - CAI)</option>
                        <option value="TIP - MED">طرابلس - المدينة (TIP - MED)</option>
                        <option value="TIP - JED">طرابلس - جدة (TIP - JED)</option>
                        <option value="TIP - TUN">طرابلس - تونس (TIP - TUN)</option>
                        <option value="TIP - ALG">طرابلس - الجزائر (TIP - ALG)</option>
                        <option value="other">وجهة أخرى</option>
                    </select>
                    <input type="text" id="other-destination" placeholder="أدخل الوجهة (مثال: TIP - ROM)" class="hidden">
                </div>
                
                <div class="form-group">
                    <label for="trip-type">نوع الرحلة</label>
                    <select id="trip-type">
                        <option value="ذهاب">ذهاب فقط</option>
                        <option value="ذهاب وعودة">ذهاب وعودة</option>
                    </select>
                </div>
            </div>
            
            <!-- حقول الغرامة فقط -->
            <div id="fine-only-fields" class="hidden">
                <div class="form-group">
                    <label for="fine-reason">سبب الغرامة</label>
                    <textarea id="fine-reason" placeholder="أدخل سبب الغرامة" rows="2"></textarea>
                </div>
            </div>
            
            <!-- حقول التسليم -->
            <div id="payment-fields" class="hidden">
                <div class="form-group">
                    <label for="payment-description">وصف الدفعة</label>
                    <input type="text" id="payment-description" placeholder="مثال: تسليم دفعة شهر أكتوبر">
                </div>
            </div>
            
            <!-- حقول مشتركة -->
            <div class="form-group">
                <label for="amount">المبلغ (دينار)</label>
                <input type="number" id="amount" placeholder="أدخل المبلغ" min="0" step="0.01" inputmode="decimal">
            </div>
            
            <div class="form-group">
                <label for="date">تاريخ العملية</label>
                <input type="date" id="date" value="">
            </div>
            
            <div class="form-group" id="notes-group">
                <label for="notes">ملاحظات إضافية</label>
                <input type="text" id="notes" placeholder="ملاحظات (اختياري)">
            </div>
            
            <button class="btn btn-add" id="add-transaction">
                <i class="fas fa-plus"></i> إضافة العملية
            </button>
            
            <button class="btn btn-reset" id="reset-form">
                <i class="fas fa-redo"></i> مسح النموذج
            </button>
        </div>
        
        <div class="report-section">
            <div class="report-header">
                <h2 class="company-report-title" id="report-company-name">كشف الحساب</h2>
                <button class="btn btn-print no-print" id="print-report">
                    <i class="fas fa-print"></i> طباعة الكشف
                </button>
            </div>
            
            <div class="summary no-print">
                <div class="summary-box">
                    <h3>عدد التذاكر</h3>
                    <div class="value total-tickets" id="total-tickets">0</div>
                </div>
                <div class="summary-box">
                    <h3>إجمالي الغرامات</h3>
                    <div class="value total-fines" id="total-fines">0 دينار</div>
                </div>
                <div class="summary-box">
                    <h3>إجمالي التسليمات</h3>
                    <div class="value total-payments" id="total-payments">0 دينار</div>
                </div>
                <div class="summary-box">
                    <h3>الرصيد النهائي</h3>
                    <div class="value total-amount" id="total-balance">0 دينار</div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>المسافر</th>
                            <th>المستند</th>
                            <th>الوجهة</th>
                            <th>الرحلة</th>
                            <th>السبب</th>
                            <th>المبلغ</th>
                            <th>الرصيد</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- البيانات ستضاف هنا بواسطة الجافاسكريبت -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-data">
                لا توجد عمليات مسجلة بعد. قم بإضافة عمليات جديدة باستخدام النموذج.
            </div>
        </div>
    </div>
    
    <!-- نافذة إضافة شركة جديدة -->
    <div id="add-company-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-building"></i> إضافة شركة جديدة</h3>
                <button class="close-modal" id="close-add-company-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="new-company-name">اسم الشركة</label>
                <input type="text" id="new-company-name" placeholder="أدخل اسم الشركة">
            </div>
            
            <div class="initial-balance-section">
                <label>الرصيد الافتتاحي</label>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">حدد إذا كانت الشركة تحتاج منك أو أنت تحتاج من الشركة</p>
                
                <div class="balance-type">
                    <div class="credit-option" id="credit-option">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">دائن</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">الشركة تحتاج منك</div>
                    </div>
                    <div class="debit-option" id="debit-option">
                        <i class="fas fa-money-bill-wave"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">مدين</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">أنت تحتاج من الشركة</div>
                    </div>
                </div>
                
                <div class="balance-explanation">
                    <div id="credit-explanation" class="hidden">
                        <p><strong class="explanation-positive">دائن:</strong> الشركة تحتاج منك مبلغاً (لديك رصيد موجب لدى الشركة)</p>
                    </div>
                    <div id="debit-explanation" class="hidden">
                        <p><strong class="explanation-negative">مدين:</strong> أنت تحتاج من الشركة مبلغاً (لديك رصيد سالب لدى الشركة)</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="initial-balance">المبلغ (دينار)</label>
                    <input type="number" id="initial-balance" placeholder="أدخل المبلغ" min="0" step="0.01" inputmode="decimal">
                </div>
            </div>
            
            <button class="btn btn-add" id="save-new-company">
                <i class="fas fa-save"></i> حفظ الشركة
            </button>
        </div>
    </div>
    
    <footer class="no-print">
        <p>نظام تذاكر &copy; 2023 - برنامج إدارة بيانات التذاكر والمبالغ</p>
        <p>جميع العمليات المالية مسجلة ومتابعة بشكل آمن</p>
    </footer>

    <script>
        // بيانات التطبيق
        let transactions = [];
        let companies = {};
        
        // حالة نافذة إضافة الشركة
        let balanceType = 'credit';
        let initialBalance = 0;
        
        // عناصر DOM
        const openAddCompanyModalBtn = document.getElementById('open-add-company-modal');
        const addCompanyModal = document.getElementById('add-company-modal');
        const closeAddCompanyModalBtn = document.getElementById('close-add-company-modal');
        const saveNewCompanyBtn = document.getElementById('save-new-company');
        
        const newCompanyNameInput = document.getElementById('new-company-name');
        const debitOption = document.getElementById('debit-option');
        const creditOption = document.getElementById('credit-option');
        const debitExplanation = document.getElementById('debit-explanation');
        const creditExplanation = document.getElementById('credit-explanation');
        const initialBalanceInput = document.getElementById('initial-balance');
        
        const companyList = document.getElementById('company-list');
        const noCompaniesMsg = document.getElementById('no-companies');
        const companySelect = document.getElementById('company');
        const currentCompanyElement = document.getElementById('current-company');
        const companyBalanceElement = document.getElementById('company-balance');
        const reportCompanyNameElement = document.getElementById('report-company-name');
        const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
        
        // حقول التذكرة والغرامة
        const ticketFineFields = document.getElementById('ticket-fine-fields');
        const fineOnlyFields = document.getElementById('fine-only-fields');
        const passengerNameInput = document.getElementById('passenger-name');
        const documentNumberInput = document.getElementById('document-number');
        const destinationSelect = document.getElementById('destination');
        const otherDestinationInput = document.getElementById('other-destination');
        const tripTypeSelect = document.getElementById('trip-type');
        
        // حقول الغرامة فقط
        const fineReasonInput = document.getElementById('fine-reason');
        
        // حقول التسليم
        const paymentFields = document.getElementById('payment-fields');
        const paymentDescriptionInput = document.getElementById('payment-description');
        
        // حقول مشتركة
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const notesInput = document.getElementById('notes');
        const notesGroup = document.getElementById('notes-group');
        
        // أزرار
        const addTransactionButton = document.getElementById('add-transaction');
        const resetFormButton = document.getElementById('reset-form');
        const printReportButton = document.getElementById('print-report');
        
        // عناصر التقرير
        const transactionsBody = document.getElementById('transactions-body');
        const noDataElement = document.getElementById('no-data');
        const totalTicketsElement = document.getElementById('total-tickets');
        const totalFinesElement = document.getElementById('total-fines');
        const totalPaymentsElement = document.getElementById('total-payments');
        const totalBalanceElement = document.getElementById('total-balance');
        
        // تعيين تاريخ اليوم كتاريخ افتراضي
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        
        // منع التكبير التلقائي في iOS
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // أحداث التحكم
        openAddCompanyModalBtn.addEventListener('click', openAddCompanyModal);
        closeAddCompanyModalBtn.addEventListener('click', closeAddCompanyModal);
        saveNewCompanyBtn.addEventListener('click', saveNewCompany);
        
        // أحداث خيارات الرصيد
        debitOption.addEventListener('click', function() {
            selectBalanceType('debit');
        });
        
        creditOption.addEventListener('click', function() {
            selectBalanceType('credit');
        });
        
        companySelect.addEventListener('change', function() {
            const companyName = this.value || '--';
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = companyName === '--' ? 'كشف الحساب' : `كشف حساب: ${companyName}`;
            updateCompanyBalance(this.value);
            updateReport();
        });
        
        destinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherDestinationInput.classList.remove('hidden');
            } else {
                otherDestinationInput.classList.add('hidden');
            }
        });
        
        // تغيير حقول النموذج حسب نوع العملية
        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateFormFields(this.value);
            });
        });
        
        addTransactionButton.addEventListener('click', addTransaction);
        resetFormButton.addEventListener('click', resetForm);
        printReportButton.addEventListener('click', printReport);
        
        // تحميل البيانات من localStorage إذا وجدت
        loadData();
        
        // تحديث كشف الحساب
        updateReport();
        
        // دالة فتح نافذة إضافة شركة
        function openAddCompanyModal() {
            addCompanyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            newCompanyNameInput.value = '';
            selectBalanceType('credit');
            initialBalanceInput.value = '';
            setTimeout(() => newCompanyNameInput.focus(), 100);
        }
        
        // دالة إغلاق نافذة إضافة شركة
        function closeAddCompanyModal() {
            addCompanyModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // دالة اختيار نوع الرصيد
        function selectBalanceType(type) {
            balanceType = type;
            
            if (type === 'debit') {
                debitOption.classList.add('selected');
                creditOption.classList.remove('selected');
                debitExplanation.classList.remove('hidden');
                creditExplanation.classList.add('hidden');
            } else {
                debitOption.classList.remove('selected');
                creditOption.classList.add('selected');
                debitExplanation.classList.add('hidden');
                creditExplanation.classList.remove('hidden');
            }
        }
        
        // دالة حفظ شركة جديدة
        function saveNewCompany() {
            const companyName = newCompanyNameInput.value.trim();
            const balance = parseFloat(initialBalanceInput.value) || 0;
            
            if (companyName === '') {
                alert('يرجى إدخال اسم الشركة');
                newCompanyNameInput.focus();
                return;
            }
            
            if (companies.hasOwnProperty(companyName)) {
                alert('هذه الشركة موجودة مسبقاً');
                return;
            }
            
            // حساب الرصيد الافتتاحي
            let openingBalance = balance;
            if (balanceType === 'debit') {
                openingBalance = -balance;
            }
            
            // إضافة الشركة مع الرصيد الافتتاحي
            companies[companyName] = openingBalance;
            
            // إذا كان هناك رصيد افتتاحي، نضيفه كعملية أولية
            if (balance > 0) {
                const transaction = {
                    id: generateId(),
                    date: today,
                    type: 'initial',
                    company: companyName,
                    amount: balance,
                    description: `رصيد افتتاحي ${balanceType === 'credit' ? 'دائن (الشركة تحتاج مني)' : 'مدين (أحتاج من الشركة)'}`
                };
                
                transactions.push(transaction);
            }
            
            // تحديث واجهة المستخدم
            updateCompanyList();
            updateCompanySelect();
            
            // اختيار الشركة الجديدة تلقائياً
            companySelect.value = companyName;
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = `كشف حساب: ${companyName}`;
            updateCompanyBalance(companyName);
            
            // إغلاق النافذة وحفظ البيانات
            closeAddCompanyModal();
            saveData();
            
            // تحديث التقرير
            updateReport();
            
            alert('تم إضافة الشركة بنجاح!');
        }
        
        // دالة تحديث حقول النموذج حسب نوع العملية
        function updateFormFields(transactionType) {
            // إخفاء جميع الحقول أولاً
            ticketFineFields.classList.add('hidden');
            fineOnlyFields.classList.add('hidden');
            paymentFields.classList.add('hidden');
            
            // إظهار الحقول المناسبة حسب نوع العملية
            if (transactionType === 'ticket') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.add('hidden');
                notesGroup.classList.remove('hidden');
            } else if (transactionType === 'fine') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            } else if (transactionType === 'payment') {
                paymentFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            }
        }
        
        // دالة إضافة عملية جديدة
        function addTransaction() {
            // التحقق من وجود شركة
            const company = companySelect.value;
            if (!company) {
                alert('يرجى اختيار شركة أولاً');
                companySelect.focus();
                return;
            }
            
            // التحقق من صحة البيانات
            if (!validateForm()) {
                return;
            }
            
            // تحديد نوع العملية
            let transactionType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) transactionType = radio.value;
            });
            
            // إنشاء كائن العملية
            const transaction = {
                id: generateId(),
                date: dateInput.value,
                type: transactionType,
                company: company,
                amount: parseFloat(amountInput.value)
            };
            
            // إضافة بيانات إضافية حسب نوع العملية
            if (transactionType === 'ticket') {
                let destination = destinationSelect.value;
                if (destination === 'other') {
                    destination = otherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        otherDestinationInput.focus();
                        return;
                    }
                }
                
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destination;
                transaction.tripType = tripTypeSelect.value;
                transaction.notes = notesInput.value.trim();
                
                if (transaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    passengerNameInput.focus();
                    return;
                }
                
                if (transaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    documentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destinationSelect.value;
                transaction.tripType = tripTypeSelect.value;
                transaction.reason = fineReasonInput.value.trim();
                
                if (transaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    fineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                transaction.description = paymentDescriptionInput.value.trim();
                
                if (transaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    paymentDescriptionInput.focus();
                    return;
                }
            }
            
            // تحديث رصيد الشركة
            updateCompanyBalanceAfterTransaction(company, transaction.type, transaction.amount);
            
            // إضافة العملية للمصفوفة
            transactions.push(transaction);
            
            // حفظ البيانات
            saveData();
            
            // تحديث العرض
            updateReport();
            updateCompanyList();
            
            // إعادة تعيين النموذج
            resetForm();
            
            // عرض رسالة نجاح
            alert('تم إضافة العملية بنجاح!');
        }
        
        // دالة التحقق من صحة البيانات
        function validateForm() {
            if (amountInput.value === '' || parseFloat(amountInput.value) <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                amountInput.focus();
                return false;
            }
            
            return true;
        }
        
        // دالة تحديث رصيد الشركة بعد العملية
        function updateCompanyBalanceAfterTransaction(company, type, amount) {
            if (type === 'ticket' || type === 'fine') {
                companies[company] += amount;
            } else if (type === 'payment') {
                companies[company] -= amount;
            }
        }
        
        // دالة تحديث عرض رصيد الشركة
        function updateCompanyBalance(company) {
            if (!company) {
                companyBalanceElement.textContent = '0 دينار';
                companyBalanceElement.className = 'company-balance';
                return;
            }
            
            let balance = companies[company] || 0;
            let balanceText = formatCurrency(Math.abs(balance));
            
            if (balance > 0) {
                companyBalanceElement.className = 'company-balance positive-balance';
                companyBalanceElement.textContent = balanceText + ' (دائن)';
            } else if (balance < 0) {
                companyBalanceElement.className = 'company-balance negative-balance';
                companyBalanceElement.textContent = balanceText + ' (مدين)';
            } else {
                companyBalanceElement.className = 'company-balance';
                companyBalanceElement.textContent = balanceText;
            }
        }
        
        // دالة تحديث قائمة الشركات
        function updateCompanyList() {
            if (Object.keys(companies).length === 0) {
                noCompaniesMsg.style.display = 'block';
                companyList.innerHTML = '<p id="no-companies">لا توجد شركات مضافة بعد</p>';
                return;
            }
            
            noCompaniesMsg.style.display = 'none';
            companyList.innerHTML = '';
            
            Object.keys(companies).sort().forEach(company => {
                const companyItem = document.createElement('div');
                companyItem.className = 'company-item';
                
                const balance = companies[company];
                let balanceText = formatCurrency(Math.abs(balance));
                
                if (balance > 0) {
                    balanceText += ' (دائن)';
                } else if (balance < 0) {
                    balanceText += ' (مدين)';
                }
                
                const balanceClass = balance > 0 ? 'positive-balance' : (balance < 0 ? 'negative-balance' : '');
                
                companyItem.innerHTML = `
                    <div class="company-name">${company}</div>
                    <div class="company-item-balance ${balanceClass}">${balanceText}</div>
                    <div class="company-item-actions">
                        <button class="delete-company" data-company="${company}">حذف</button>
                    </div>
                `;
                
                companyList.appendChild(companyItem);
            });
            
            // إضافة أحداث لحذف الشركات
            document.querySelectorAll('.delete-company').forEach(btn => {
                btn.addEventListener('click', function() {
                    const companyToDelete = this.getAttribute('data-company');
                    deleteCompany(companyToDelete);
                });
            });
        }
        
        // دالة حذف شركة
        function deleteCompany(companyName) {
            if (!confirm(`هل أنت متأكد من حذف شركة "${companyName}"؟ سيتم حذف جميع عملياتها أيضاً.`)) {
                return;
            }
            
            delete companies[companyName];
            transactions = transactions.filter(t => t.company !== companyName);
            
            updateCompanyList();
            updateCompanySelect();
            updateReport();
            saveData();
            
            alert('تم حذف الشركة وعملياتها بنجاح!');
        }
        
        // دالة تحديث قائمة الشركات في الـ select
        function updateCompanySelect() {
            const currentValue = companySelect.value;
            
            companySelect.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                companySelect.value = currentValue;
            }
        }
        
        // دالة تحديث كشف الحساب
        function updateReport() {
            const currentCompany = companySelect.value;
            if (currentCompany) {
                reportCompanyNameElement.textContent = `كشف حساب: ${currentCompany}`;
            } else {
                reportCompanyNameElement.textContent = 'كشف الحساب';
            }
            
            updateCompanyBalance(currentCompany);
            
            if (transactions.length > 0) {
                noDataElement.style.display = 'none';
                transactionsBody.innerHTML = '';
            } else {
                noDataElement.style.display = 'block';
                transactionsBody.innerHTML = '';
                updateSummary();
                return;
            }
            
            let filteredTransactions = [];
            
            if (currentCompany) {
                filteredTransactions = transactions.filter(t => t.company === currentCompany);
            } else {
                filteredTransactions = [...transactions];
            }
            
            let balance = 0;
            filteredTransactions.forEach((transaction, index) => {
                if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                    balance += transaction.amount;
                } else if (transaction.type === 'payment') {
                    balance -= transaction.amount;
                }
                
                const row = document.createElement('tr');
                
                let typeClass = '';
                let typeText = '';
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                    typeText = 'تذكرة';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                    typeText = 'غرامة';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                    typeText = 'تسليم';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                    typeText = 'افتتاحي';
                }
                
                let passengerName = transaction.passengerName || '-';
                let documentNumber = transaction.documentNumber || '-';
                
                let destination = transaction.destination || '-';
                if (destination.includes('(')) {
                    const match = destination.match(/\(([^)]+)\)/);
                    if (match) {
                        destination = `<span class="destination-abbr">${match[1]}</span>`;
                    }
                }
                
                let tripType = transaction.tripType || '-';
                let reasonDesc = transaction.reason || transaction.description || '-';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${documentNumber}</td>
                    <td>${destination}</td>
                    <td>${tripType}</td>
                    <td>${reasonDesc}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td>${formatCurrency(balance)}</td>
                `;
                
                transactionsBody.appendChild(row);
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="8">الرصيد النهائي</td>
                <td colspan="2">${formatCurrency(balance)}</td>
            `;
            transactionsBody.appendChild(totalRow);
            
            updateSummary(filteredTransactions, balance);
        }
        
        // دالة تحديث الملخص
        function updateSummary(filteredTransactions = null, finalBalance = 0) {
            const transactionsToCalculate = filteredTransactions || transactions;
            
            let totalTickets = 0;
            let totalFines = 0;
            let totalPayments = 0;
            
            transactionsToCalculate.forEach(transaction => {
                if (transaction.type === 'ticket') {
                    totalTickets++;
                } else if (transaction.type === 'fine') {
                    totalFines += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                }
            });
            
            totalTicketsElement.textContent = totalTickets;
            totalFinesElement.textContent = formatCurrency(totalFines);
            totalPaymentsElement.textContent = formatCurrency(totalPayments);
            totalBalanceElement.textContent = formatCurrency(finalBalance);
            
            if (finalBalance > 0) {
                totalBalanceElement.style.color = 'var(--success-color)';
            } else if (finalBalance < 0) {
                totalBalanceElement.style.color = 'var(--accent-color)';
            } else {
                totalBalanceElement.style.color = 'var(--primary-color)';
            }
        }
        
        // دالة إعادة تعيين النموذج
        function resetForm() {
            passengerNameInput.value = '';
            documentNumberInput.value = '';
            destinationSelect.value = 'TIP - IST';
            otherDestinationInput.classList.add('hidden');
            otherDestinationInput.value = '';
            tripTypeSelect.value = 'ذهاب';
            
            fineReasonInput.value = '';
            paymentDescriptionInput.value = '';
            
            amountInput.value = '';
            dateInput.value = today;
            notesInput.value = '';
            
            if (companySelect.value) {
                passengerNameInput.focus();
            }
        }
        
        // دالة طباعة التقرير
        function printReport() {
            window.print();
        }
        
        // دالة توليد معرف فريد
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // دالة تنسيق العملة
        function formatCurrency(amount) {
            const absAmount = Math.abs(amount);
            const formatted = new Intl.NumberFormat('ar-LY', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(absAmount) + ' دينار';
            
            if (amount < 0) {
                return '-' + formatted;
            }
            return formatted;
        }
        
        // دالة حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('ticketSystem_transactions', JSON.stringify(transactions));
            localStorage.setItem('ticketSystem_companies', JSON.stringify(companies));
        }
        
        // دالة تحميل البيانات من localStorage
        function loadData() {
            const savedTransactions = localStorage.getItem('ticketSystem_transactions');
            const savedCompanies = localStorage.getItem('ticketSystem_companies');
            
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            
            if (savedCompanies) {
                companies = JSON.parse(savedCompanies);
                updateCompanySelect();
                updateCompanyList();
            }
        }
        
        // إغلاق النافذة عند النقر خارجها
        addCompanyModal.addEventListener('click', function(e) {
            if (e.target === addCompanyModal) {
                closeAddCompanyModal();
            }
        });
        
        // اختيار نوع الرصيد الافتراضي
        selectBalanceType('credit');
        
        // إغلاق النافذة بمفتاح ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !addCompanyModal.classList.contains('hidden')) {
                closeAddCompanyModal();
            }
        });
    </script>
</body>
</html>