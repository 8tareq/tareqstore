<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام تذاكر - إدارة البيانات والمبالغ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a5276);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            margin: 0 10px;
            text-align: center;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #e74c3c, #3498db);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(45deg); }
            50% { transform: translateY(-5px) rotate(45deg); }
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
            padding: 0 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
            background-color: #f8fafc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-section, .report-section, .manage-section {
            background-color: white;
            padding: 20px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
        }
        
        h2 {
            color: var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
            font-size: 1.5rem;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        h2 span {
            font-size: 1rem;
            color: #666;
            font-weight: normal;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 70px;
            height: 2px;
            background: linear-gradient(to left, var(--secondary-color), var(--success-color));
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #fafafa;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background-color: white;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }
        
        @media (min-width: 480px) {
            .radio-group {
                flex-direction: row;
            }
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 6px;
            background-color: #f8f9fa;
            transition: all 0.3s;
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* تمييز نوع العملية النشط */
        .radio-option.active-ticket {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(39, 174, 96, 0.05));
            border: 2px solid var(--success-color);
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.2);
        }
        
        .radio-option.active-fine {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(231, 76, 60, 0.05));
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.2);
        }
        
        .radio-option.active-payment {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(52, 152, 219, 0.05));
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
        }
        
        .radio-option.active-ticket::before,
        .radio-option.active-fine::before,
        .radio-option.active-payment::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8) 1%, transparent 20%);
            z-index: 1;
        }
        
        .radio-option.active-ticket label {
            color: var(--success-color);
            font-weight: 700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .radio-option.active-fine label {
            color: var(--accent-color);
            font-weight: 700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .radio-option.active-payment label {
            color: var(--secondary-color);
            font-weight: 700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        /* أيقونات مضيئة */
        .radio-icon {
            font-size: 1.2rem;
            transition: all 0.3s;
            z-index: 2;
        }
        
        .active-ticket .radio-icon {
            color: var(--success-color);
            text-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
            transform: scale(1.2);
        }
        
        .active-fine .radio-icon {
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            transform: scale(1.2);
        }
        
        .active-payment .radio-icon {
            color: var(--secondary-color);
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            transform: scale(1.2);
        }
        
        /* مؤشر نوع العملية */
        .type-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            color: var(--primary-color);
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            z-index: 3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .active-ticket .type-indicator {
            background-color: var(--success-color);
            color: white;
        }
        
        .active-fine .type-indicator {
            background-color: var(--accent-color);
            color: white;
        }
        
        .active-payment .type-indicator {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* توهج النص */
        .radio-text-glow {
            position: relative;
            z-index: 2;
        }
        
        .active-ticket .radio-text-glow {
            animation: textGlowGreen 2s infinite alternate;
        }
        
        .active-fine .radio-text-glow {
            animation: textGlowRed 2s infinite alternate;
        }
        
        .active-payment .radio-text-glow {
            animation: textGlowBlue 2s infinite alternate;
        }
        
        @keyframes textGlowGreen {
            from { text-shadow: 0 0 5px rgba(39, 174, 96, 0.5); }
            to { text-shadow: 0 0 15px rgba(39, 174, 96, 0.8); }
        }
        
        @keyframes textGlowRed {
            from { text-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            to { text-shadow: 0 0 15px rgba(231, 76, 60, 0.8); }
        }
        
        @keyframes textGlowBlue {
            from { text-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }
            to { text-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
        }
        
        /* تأثير النبض */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .radio-option.active-ticket,
        .radio-option.active-fine,
        .radio-option.active-payment {
            animation: pulse 3s infinite;
        }
        
        .radio-option input {
            width: auto;
            margin-left: 5px;
            position: relative;
            z-index: 2;
        }
        
        .radio-option label {
            margin-bottom: 0;
            flex: 1;
            position: relative;
            z-index: 2;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
            margin-top: 8px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
        }
        
        .btn-print {
            background: linear-gradient(135deg, var(--primary-color), #1a252f);
            width: auto;
            margin: 0;
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            margin-top: 12px;
        }
        
        .btn-add-company {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            margin-bottom: 15px;
        }
        
        .btn-cancel {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-save {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        /* تحسينات للجدول على الهاتف */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .manage-table-container {
            max-height: 500px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            font-size: 0.85rem;
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 12px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
            background-color: white;
        }
        
        tr:nth-child(even) td {
            background-color: #fafafa;
        }
        
        .total-row {
            font-weight: bold;
            background: linear-gradient(135deg, #e8f4fc, #d4eaf7) !important;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .total-row td {
            border-top: 2px solid var(--secondary-color);
        }
        
        .transaction-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .transaction-ticket {
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            color: #219653;
        }
        
        .transaction-fine {
            background: linear-gradient(135deg, #fde0dc, #f9c9c2);
            color: #c0392b;
        }
        
        .transaction-payment {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #2980b9;
        }
        
        .transaction-initial {
            background: linear-gradient(135deg, #f8f4e6, #f5e9c8);
            color: #d68910;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
            color: white;
            white-space: nowrap;
            touch-action: manipulation;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .action-btn-edit {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .action-btn-delete {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .summary-box {
            background: linear-gradient(135deg, white, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
        }
        
        .summary-box h3 {
            font-size: 0.9rem;
            color: var(--dark-color);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-box .value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .company-selector {
            margin-bottom: 20px;
        }
        
        .company-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid var(--secondary-color);
        }
        
        @media (min-width: 480px) {
            .company-info {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-info h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin: 0;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .company-info h3 {
                text-align: right;
            }
        }
        
        .company-balance {
            font-size: 1.4rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 6px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .positive-balance {
            color: var(--success-color);
            border-right: 3px solid var(--success-color);
        }
        
        .negative-balance {
            color: var(--accent-color);
            border-right: 3px solid var(--accent-color);
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 0.85rem;
            padding-bottom: 20px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .form-section, .summary, .manage-section, .tabs {
                display: none !important;
            }
            
            .report-section {
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
            }
            
            .company-info {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            
            table {
                font-size: 11px !important;
                box-shadow: none !important;
                min-width: 100% !important;
            }
            
            th, td {
                padding: 8px !important;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        .company-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .company-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            margin-bottom: 8px;
            border-radius: 6px;
            border-right: 3px solid var(--secondary-color);
        }
        
        @media (min-width: 480px) {
            .company-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .company-item-balance {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: white;
            font-size: 0.9rem;
        }
        
        .company-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .delete-company {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            flex: 1;
        }
        
        /* نافذة إضافة شركة جديدة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background: linear-gradient(135deg, white, #f8f9fa);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #eaeaea;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #7f8c8d;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .balance-type {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (min-width: 480px) {
            .balance-type {
                flex-direction: row;
            }
        }
        
        .debit-option, .credit-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }
        
        .debit-option.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
            color: var(--accent-color);
        }
        
        .credit-option.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
            color: var(--success-color);
        }
        
        .balance-explanation {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            font-size: 0.9rem;
            color: #555;
            border-right: 3px solid var(--secondary-color);
        }
        
        .explanation-positive {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .explanation-negative {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .initial-balance-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .report-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        @media (min-width: 480px) {
            .report-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-report-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .company-report-title {
                text-align: right;
            }
        }
        
        .destination-abbr {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            color: #333;
            font-size: 0.8rem;
        }
        
        /* تحسينات للشاشات الصغيرة جداً */
        @media (max-width: 360px) {
            header {
                padding: 15px 10px;
            }
            
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .logo-icon {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
            
            .form-section, .report-section, .manage-section {
                padding: 15px 10px;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-box {
                padding: 12px;
            }
            
            .summary-box .value {
                font-size: 1.3rem;
            }
            
            .radio-option {
                padding: 10px;
            }
            
            .radio-icon {
                font-size: 1rem;
            }
        }
        
        /* تحسينات للشاشات المتوسطة */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-section {
                flex: 1;
                min-width: 300px;
            }
            
            .report-section, .manage-section {
                flex: 2;
                min-width: 300px;
            }
            
            header {
                padding: 25px 20px;
            }
            
            .logo {
                flex-direction: row;
                justify-content: center;
            }
            
            .logo h1 {
                font-size: 2.2rem;
            }
            
            .logo-icon {
                width: 80px;
                height: 80px;
                font-size: 3rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
        
        /* منع التكبير التلقائي على الحقول */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* تحسينات للأجهزة التي تدعم اللمس */
        @media (hover: none) and (pointer: coarse) {
            .btn, .delete-company, .radio-option, .debit-option, .credit-option, .action-btn {
                min-height: 44px;
            }
            
            input, select, textarea {
                min-height: 44px;
            }
        }
        
        /* إخفاء شريط التمرير في بعض المتصفحات */
        .company-list::-webkit-scrollbar,
        .table-container::-webkit-scrollbar {
            width: 5px;
        }
        
        .company-list::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .company-list::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
        
        .company-list::-webkit-scrollbar-thumb:hover,
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        
        /* رسالة عدم وجود بيانات */
        #no-data, #no-companies, #no-transactions {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        
        /* قسم إدارة العمليات */
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 480px) {
            .filter-controls {
                flex-direction: row;
                align-items: flex-end;
            }
            
            .filter-group {
                flex: 1;
            }
        }
        
        .filter-group {
            margin-bottom: 0;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .edit-form {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 4px solid var(--warning-color);
        }
        
        .edit-form h3 {
            color: var(--warning-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .edit-form-buttons .btn {
            margin-top: 0;
            flex: 1;
        }
        
        /* تأثيرات للعمليات */
        .transaction-row {
            transition: all 0.3s;
        }
        
        .transaction-row:hover {
            background-color: #f1f8ff !important;
        }
        
        /* رسالة تأكيد الحذف */
        .confirm-delete {
            background: linear-gradient(135deg, #fde0dc, #f9c9c2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid var(--accent-color);
            text-align: center;
        }
        
        .confirm-delete h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .confirm-buttons button {
            flex: 1;
        }
        
        /* قسم العنوان مع تمييز النوع */
        .active-type-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .active-type-ticket {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
            border-right: 4px solid var(--success-color);
        }
        
        .active-type-fine {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
            border-right: 4px solid var(--accent-color);
        }
        
        .active-type-payment {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border-right: 4px solid var(--secondary-color);
        }
        
        .active-type-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .active-type-ticket .active-type-icon {
            background: linear-gradient(135deg, var(--success-color), #219653);
            color: white;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }
        
        .active-type-fine .active-type-icon {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            color: white;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }
        
        .active-type-payment .active-type-icon {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        
        .active-type-text {
            flex: 1;
        }
        
        .active-type-text h3 {
            margin: 0;
            color: var(--dark-color);
            font-size: 1.3rem;
        }
        
        .active-type-ticket .active-type-text h3 {
            color: var(--success-color);
        }
        
        .active-type-fine .active-type-text h3 {
            color: var(--accent-color);
        }
        
        .active-type-payment .active-type-text h3 {
            color: var(--secondary-color);
        }
        
        .active-type-text p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-row">
                <div class="logo-icon">
                    <i class="fas fa-plane airplane-icon"></i>
                </div>
                <h1>نظام تذاكر</h1>
            </div>
        </div>
        <p class="subtitle">برنامج إدارة بيانات التذاكر والمبالغ - متابعة العمليات المالية مع الشركات</p>
    </header>
    
    <!-- تبويبات التنقل -->
    <div class="tabs no-print">
        <div class="tab active" data-tab="add">إضافة عملية</div>
        <div class="tab" data-tab="report">كشف الحساب</div>
        <div class="tab" data-tab="manage">إدارة العمليات</div>
    </div>
    
    <div class="container">
        <!-- تبويب إضافة عملية -->
        <div class="tab-content form-section active" id="add-tab">
            <h2><i class="fas fa-plus-circle"></i> تسجيل عملية جديدة</h2>
            
            <!-- تمييز نوع العملية النشط -->
            <div id="active-type-indicator" class="hidden">
                <!-- سيتم تعبئته بواسطة الجافاسكريبت -->
            </div>
            
            <!-- إدارة الشركات -->
            <button class="btn btn-add-company" id="open-add-company-modal">
                <i class="fas fa-plus"></i> إضافة شركة جديدة
            </button>
            
            <div class="company-list" id="company-list">
                <p id="no-companies">لا توجد شركات مضافة بعد</p>
            </div>
            
            <div class="company-selector">
                <label for="company">اختر الشركة</label>
                <select id="company">
                    <option value="">-- اختر الشركة --</option>
                </select>
            </div>
            
            <div class="company-info">
                <div>
                    <h3 id="current-company">--</h3>
                    <p style="color: #666; margin-top: 5px; font-size: 0.9rem;">الرصيد الحالي</p>
                </div>
                <div class="company-balance" id="company-balance">0 دينار</div>
            </div>
            
            <div class="form-group">
                <label>نوع العملية</label>
                <div class="radio-group">
                    <div class="radio-option" id="ticket-option">
                        <i class="fas fa-ticket-alt radio-icon"></i>
                        <input type="radio" id="ticket" name="transaction-type" value="ticket" checked>
                        <label for="ticket" class="radio-text-glow">تذكرة</label>
                        <div class="type-indicator">نشط</div>
                    </div>
                    <div class="radio-option" id="fine-option">
                        <i class="fas fa-exclamation-triangle radio-icon"></i>
                        <input type="radio" id="fine" name="transaction-type" value="fine">
                        <label for="fine" class="radio-text-glow">غرامة</label>
                        <div class="type-indicator">نشط</div>
                    </div>
                    <div class="radio-option" id="payment-option">
                        <i class="fas fa-money-bill-wave radio-icon"></i>
                        <input type="radio" id="payment" name="transaction-type" value="payment">
                        <label for="payment" class="radio-text-glow">تسليم دفعة</label>
                        <div class="type-indicator">نشط</div>
                    </div>
                </div>
            </div>
            
            <!-- حقول التذكرة والغرامة -->
            <div id="ticket-fine-fields">
                <div class="form-group">
                    <label for="passenger-name">اسم المسافر</label>
                    <input type="text" id="passenger-name" placeholder="أدخل اسم المسافر">
                </div>
                
                <div class="form-group">
                    <label for="document-number">رقم المستند</label>
                    <input type="text" id="document-number" placeholder="أدخل رقم المستند">
                </div>
                
                <div class="form-group">
                    <label for="destination">الوجهة</label>
                    <select id="destination">
                        <option value="TIP - IST">طرابلس - اسطنبول (TIP - IST)</option>
                        <option value="TIP - ANK">طرابلس - أنقرة (TIP - ANK)</option>
                        <option value="TIP - IZM">طرابلس - إزمير (TIP - IZM)</option>
                        <option value="TIP - BJV">طرابلس - بودروم (TIP - BJV)</option>
                        <option value="TIP - DXB">طرابلس - دبي (TIP - DXB)</option>
                        <option value="TIP - CAI">طرابلس - القاهرة (TIP - CAI)</option>
                        <option value="TIP - MED">طرابلس - المدينة (TIP - MED)</option>
                        <option value="TIP - JED">طرابلس - جدة (TIP - JED)</option>
                        <option value="TIP - TUN">طرابلس - تونس (TIP - TUN)</option>
                        <option value="TIP - ALG">طرابلس - الجزائر (TIP - ALG)</option>
                        <option value="other">وجهة أخرى</option>
                    </select>
                    <input type="text" id="other-destination" placeholder="أدخل الوجهة (مثال: TIP - ROM)" class="hidden">
                </div>
                
                <div class="form-group">
                    <label for="trip-type">نوع الرحلة</label>
                    <select id="trip-type">
                        <option value="ذهاب">ذهاب فقط</option>
                        <option value="ذهاب وعودة">ذهاب وعودة</option>
                    </select>
                </div>
            </div>
            
            <!-- حقول الغرامة فقط -->
            <div id="fine-only-fields" class="hidden">
                <div class="form-group">
                    <label for="fine-reason">سبب الغرامة</label>
                    <textarea id="fine-reason" placeholder="أدخل سبب الغرامة" rows="2"></textarea>
                </div>
            </div>
            
            <!-- حقول التسليم -->
            <div id="payment-fields" class="hidden">
                <div class="form-group">
                    <label for="payment-description">وصف الدفعة</label>
                    <input type="text" id="payment-description" placeholder="مثال: تسليم دفعة شهر أكتوبر">
                </div>
            </div>
            
            <!-- حقول مشتركة -->
            <div class="form-group">
                <label for="amount">المبلغ (دينار)</label>
                <input type="number" id="amount" placeholder="أدخل المبلغ" min="0" step="0.01" inputmode="decimal">
            </div>
            
            <div class="form-group">
                <label for="date">تاريخ العملية</label>
                <input type="date" id="date" value="">
            </div>
            
            <div class="form-group" id="notes-group">
                <label for="notes">ملاحظات إضافية</label>
                <input type="text" id="notes" placeholder="ملاحظات (اختياري)">
            </div>
            
            <button class="btn btn-add" id="add-transaction">
                <i class="fas fa-plus"></i> إضافة العملية
            </button>
            
            <button class="btn btn-reset" id="reset-form">
                <i class="fas fa-redo"></i> مسح النموذج
            </button>
        </div>
        
        <!-- تبويب كشف الحساب -->
        <div class="tab-content report-section" id="report-tab">
            <div class="report-header">
                <h2 class="company-report-title" id="report-company-name">كشف الحساب</h2>
                <button class="btn btn-print no-print" id="print-report">
                    <i class="fas fa-print"></i> طباعة الكشف
                </button>
            </div>
            
            <div class="summary no-print">
                <div class="summary-box">
                    <h3>عدد التذاكر</h3>
                    <div class="value total-tickets" id="total-tickets">0</div>
                </div>
                <div class="summary-box">
                    <h3>إجمالي الغرامات</h3>
                    <div class="value total-fines" id="total-fines">0 دينار</div>
                </div>
                <div class="summary-box">
                    <h3>إجمالي التسليمات</h3>
                    <div class="value total-payments" id="total-payments">0 دينار</div>
                </div>
                <div class="summary-box">
                    <h3>الرصيد النهائي</h3>
                    <div class="value total-amount" id="total-balance">0 دينار</div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>المسافر</th>
                            <th>المستند</th>
                            <th>الوجهة</th>
                            <th>الرحلة</th>
                            <th>السبب</th>
                            <th>المبلغ</th>
                            <th>الرصيد</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- البيانات ستضاف هنا بواسطة الجافاسكريبت -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-data">
                لا توجد عمليات مسجلة بعد. قم بإضافة عمليات جديدة باستخدام النموذج.
            </div>
        </div>
        
        <!-- تبويب إدارة العمليات -->
        <div class="tab-content manage-section" id="manage-tab">
            <h2><i class="fas fa-cog"></i> إدارة العمليات</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filter-company">تصفية حسب الشركة</label>
                    <select id="filter-company">
                        <option value="">جميع الشركات</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-type">تصفية حسب النوع</label>
                    <select id="filter-type">
                        <option value="">جميع الأنواع</option>
                        <option value="ticket">تذكرة</option>
                        <option value="fine">غرامة</option>
                        <option value="payment">تسليم دفعة</option>
                        <option value="initial">رصيد افتتاحي</option>
                    </select>
                </div>
                
                <button class="btn btn-reset" id="reset-filters" style="margin-top: 0;">
                    <i class="fas fa-filter"></i> إعادة التعيين
                </button>
            </div>
            
            <!-- نموذج التعديل -->
            <div id="edit-form-container" class="hidden">
                <div class="edit-form">
                    <h3><i class="fas fa-edit"></i> تعديل العملية</h3>
                    <div class="form-group">
                        <label for="edit-transaction-type">نوع العملية</label>
                        <select id="edit-transaction-type">
                            <option value="ticket">تذكرة</option>
                            <option value="fine">غرامة</option>
                            <option value="payment">تسليم دفعة</option>
                        </select>
                    </div>
                    
                    <div id="edit-ticket-fields">
                        <div class="form-group">
                            <label for="edit-passenger-name">اسم المسافر</label>
                            <input type="text" id="edit-passenger-name" placeholder="اسم المسافر">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-document-number">رقم المستند</label>
                            <input type="text" id="edit-document-number" placeholder="رقم المستند">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-destination">الوجهة</label>
                            <select id="edit-destination">
                                <option value="TIP - IST">طرابلس - اسطنبول (TIP - IST)</option>
                                <option value="TIP - ANK">طرابلس - أنقرة (TIP - ANK)</option>
                                <option value="TIP - IZM">طرابلس - إزمير (TIP - IZM)</option>
                                <option value="TIP - BJV">طرابلس - بودروم (TIP - BJV)</option>
                                <option value="TIP - DXB">طرابلس - دبي (TIP - DXB)</option>
                                <option value="TIP - CAI">طرابلس - القاهرة (TIP - CAI)</option>
                                <option value="other">وجهة أخرى</option>
                            </select>
                            <input type="text" id="edit-other-destination" placeholder="أدخل الوجهة" class="hidden">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-trip-type">نوع الرحلة</label>
                            <select id="edit-trip-type">
                                <option value="ذهاب">ذهاب فقط</option>
                                <option value="ذهاب وعودة">ذهاب وعودة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="edit-fine-only-fields" class="hidden">
                        <div class="form-group">
                            <label for="edit-fine-reason">سبب الغرامة</label>
                            <textarea id="edit-fine-reason" placeholder="سبب الغرامة" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div id="edit-payment-fields" class="hidden">
                        <div class="form-group">
                            <label for="edit-payment-description">وصف الدفعة</label>
                            <input type="text" id="edit-payment-description" placeholder="وصف الدفعة">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-amount">المبلغ (دينار)</label>
                        <input type="number" id="edit-amount" placeholder="المبلغ" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-date">تاريخ العملية</label>
                        <input type="date" id="edit-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notes">ملاحظات إضافية</label>
                        <input type="text" id="edit-notes" placeholder="ملاحظات">
                    </div>
                    
                    <div class="edit-form-buttons">
                        <button class="btn btn-cancel" id="cancel-edit">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                        <button class="btn btn-save" id="save-edit">
                            <i class="fas fa-save"></i> حفظ التعديلات
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تأكيد الحذف -->
            <div id="delete-confirm-container" class="hidden">
                <div class="confirm-delete">
                    <h4><i class="fas fa-exclamation-triangle"></i> تأكيد الحذف</h4>
                    <p>هل أنت متأكد من حذف هذه العملية؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-cancel" id="cancel-delete">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                        <button class="btn btn-delete" id="confirm-delete">
                            <i class="fas fa-trash"></i> نعم، احذف
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-container manage-table-container">
                <table id="manage-transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>الشركة</th>
                            <th>النوع</th>
                            <th>المسافر</th>
                            <th>المبلغ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="manage-transactions-body">
                        <!-- البيانات ستضاف هنا بواسطة الجافاسكريبت -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-transactions">
                لا توجد عمليات مسجلة بعد. قم بإضافة عمليات جديدة باستخدام تبويب "إضافة عملية".
            </div>
        </div>
    </div>
    
    <!-- نافذة إضافة شركة جديدة -->
    <div id="add-company-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-building"></i> إضافة شركة جديدة</h3>
                <button class="close-modal" id="close-add-company-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="new-company-name">اسم الشركة</label>
                <input type="text" id="new-company-name" placeholder="أدخل اسم الشركة">
            </div>
            
            <div class="initial-balance-section">
                <label>الرصيد الافتتاحي</label>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">حدد إذا كانت الشركة تحتاج منك أو أنت تحتاج من الشركة</p>
                
                <div class="balance-type">
                    <div class="credit-option" id="credit-option">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">دائن</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">الشركة تحتاج منك</div>
                    </div>
                    <div class="debit-option" id="debit-option">
                        <i class="fas fa-money-bill-wave"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">مدين</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">أنت تحتاج من الشركة</div>
                    </div>
                </div>
                
                <div class="balance-explanation">
                    <div id="credit-explanation" class="hidden">
                        <p><strong class="explanation-positive">دائن:</strong> الشركة تحتاج منك مبلغاً (لديك رصيد موجب لدى الشركة)</p>
                    </div>
                    <div id="debit-explanation" class="hidden">
                        <p><strong class="explanation-negative">مدين:</strong> أنت تحتاج من الشركة مبلغاً (لديك رصيد سالب لدى الشركة)</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="initial-balance">المبلغ (دينار)</label>
                    <input type="number" id="initial-balance" placeholder="أدخل المبلغ" min="0" step="0.01" inputmode="decimal">
                </div>
            </div>
            
            <button class="btn btn-add" id="save-new-company">
                <i class="fas fa-save"></i> حفظ الشركة
            </button>
        </div>
    </div>
    
    <footer class="no-print">
        <p>نظام تذاكر &copy; 2023 - برنامج إدارة بيانات التذاكر والمبالغ</p>
        <p>جميع العمليات المالية مسجلة ومتابعة بشكل آمن</p>
    </footer>

    <script>
        // بيانات التطبيق
        let transactions = [];
        let companies = {};
        
        // حالة التطبيق
        let balanceType = 'credit';
        let initialBalance = 0;
        let currentEditTransactionId = null;
        let currentDeleteTransactionId = null;
        
        // عناصر DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // مؤشر نوع العملية النشط
        const activeTypeIndicator = document.getElementById('active-type-indicator');
        
        // إدارة الشركات
        const openAddCompanyModalBtn = document.getElementById('open-add-company-modal');
        const addCompanyModal = document.getElementById('add-company-modal');
        const closeAddCompanyModalBtn = document.getElementById('close-add-company-modal');
        const saveNewCompanyBtn = document.getElementById('save-new-company');
        
        const newCompanyNameInput = document.getElementById('new-company-name');
        const debitOption = document.getElementById('debit-option');
        const creditOption = document.getElementById('credit-option');
        const debitExplanation = document.getElementById('debit-explanation');
        const creditExplanation = document.getElementById('credit-explanation');
        const initialBalanceInput = document.getElementById('initial-balance');
        
        const companyList = document.getElementById('company-list');
        const noCompaniesMsg = document.getElementById('no-companies');
        const companySelect = document.getElementById('company');
        const currentCompanyElement = document.getElementById('current-company');
        const companyBalanceElement = document.getElementById('company-balance');
        const reportCompanyNameElement = document.getElementById('report-company-name');
        const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
        
        // عناصر خيارات نوع العملية
        const ticketOption = document.getElementById('ticket-option');
        const fineOption = document.getElementById('fine-option');
        const paymentOption = document.getElementById('payment-option');
        
        // حقول إضافة العملية
        const ticketFineFields = document.getElementById('ticket-fine-fields');
        const fineOnlyFields = document.getElementById('fine-only-fields');
        const passengerNameInput = document.getElementById('passenger-name');
        const documentNumberInput = document.getElementById('document-number');
        const destinationSelect = document.getElementById('destination');
        const otherDestinationInput = document.getElementById('other-destination');
        const tripTypeSelect = document.getElementById('trip-type');
        const fineReasonInput = document.getElementById('fine-reason');
        const paymentFields = document.getElementById('payment-fields');
        const paymentDescriptionInput = document.getElementById('payment-description');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const notesInput = document.getElementById('notes');
        const notesGroup = document.getElementById('notes-group');
        
        // حقول التعديل
        const editFormContainer = document.getElementById('edit-form-container');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editTicketFields = document.getElementById('edit-ticket-fields');
        const editFineOnlyFields = document.getElementById('edit-fine-only-fields');
        const editPaymentFields = document.getElementById('edit-payment-fields');
        const editPassengerNameInput = document.getElementById('edit-passenger-name');
        const editDocumentNumberInput = document.getElementById('edit-document-number');
        const editDestinationSelect = document.getElementById('edit-destination');
        const editOtherDestinationInput = document.getElementById('edit-other-destination');
        const editTripTypeSelect = document.getElementById('edit-trip-type');
        const editFineReasonInput = document.getElementById('edit-fine-reason');
        const editPaymentDescriptionInput = document.getElementById('edit-payment-description');
        const editAmountInput = document.getElementById('edit-amount');
        const editDateInput = document.getElementById('edit-date');
        const editNotesInput = document.getElementById('edit-notes');
        
        // تأكيد الحذف
        const deleteConfirmContainer = document.getElementById('delete-confirm-container');
        
        // فلاتر إدارة العمليات
        const filterCompanySelect = document.getElementById('filter-company');
        const filterTypeSelect = document.getElementById('filter-type');
        const resetFiltersBtn = document.getElementById('reset-filters');
        
        // أزرار
        const addTransactionButton = document.getElementById('add-transaction');
        const resetFormButton = document.getElementById('reset-form');
        const printReportButton = document.getElementById('print-report');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        
        // عناصر التقرير
        const transactionsBody = document.getElementById('transactions-body');
        const manageTransactionsBody = document.getElementById('manage-transactions-body');
        const noDataElement = document.getElementById('no-data');
        const noTransactionsElement = document.getElementById('no-transactions');
        const totalTicketsElement = document.getElementById('total-tickets');
        const totalFinesElement = document.getElementById('total-fines');
        const totalPaymentsElement = document.getElementById('total-payments');
        const totalBalanceElement = document.getElementById('total-balance');
        
        // تعيين تاريخ اليوم كتاريخ افتراضي
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        editDateInput.value = today;
        
        // أحداث التحكم
        // التبويبات
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
                
                if (tabId === 'manage') {
                    updateManageTable();
                }
                
                if (tabId === 'report') {
                    updateReport();
                }
                
                if (tabId === 'add') {
                    updateActiveTypeIndicator();
                }
            });
        });
        
        // إدارة الشركات
        openAddCompanyModalBtn.addEventListener('click', openAddCompanyModal);
        closeAddCompanyModalBtn.addEventListener('click', closeAddCompanyModal);
        saveNewCompanyBtn.addEventListener('click', saveNewCompany);
        
        // أحداث خيارات الرصيد
        debitOption.addEventListener('click', function() {
            selectBalanceType('debit');
        });
        
        creditOption.addEventListener('click', function() {
            selectBalanceType('credit');
        });
        
        // أحداث الحقول
        companySelect.addEventListener('change', function() {
            const companyName = this.value || '--';
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = companyName === '--' ? 'كشف الحساب' : `كشف حساب: ${companyName}`;
            updateCompanyBalance(this.value);
            updateReport();
        });
        
        destinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherDestinationInput.classList.remove('hidden');
            } else {
                otherDestinationInput.classList.add('hidden');
            }
        });
        
        editDestinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                editOtherDestinationInput.classList.remove('hidden');
            } else {
                editOtherDestinationInput.classList.add('hidden');
            }
        });
        
        // تغيير حقول النموذج حسب نوع العملية
        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateFormFields(this.value);
                updateActiveTypeClasses(this.value);
                updateActiveTypeIndicator();
            });
        });
        
        editTransactionTypeSelect.addEventListener('change', function() {
            updateEditFormFields(this.value);
        });
        
        // فلاتر إدارة العمليات
        filterCompanySelect.addEventListener('change', updateManageTable);
        filterTypeSelect.addEventListener('change', updateManageTable);
        resetFiltersBtn.addEventListener('click', function() {
            filterCompanySelect.value = '';
            filterTypeSelect.value = '';
            updateManageTable();
        });
        
        // أزرار العمل
        addTransactionButton.addEventListener('click', addTransaction);
        resetFormButton.addEventListener('click', resetForm);
        printReportButton.addEventListener('click', printReport);
        cancelEditBtn.addEventListener('click', cancelEdit);
        saveEditBtn.addEventListener('click', saveEdit);
        cancelDeleteBtn.addEventListener('click', cancelDelete);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        
        // تحميل البيانات من localStorage
        loadData();
        
        // تحديث واجهة المستخدم
        updateReport();
        updateActiveTypeIndicator();
        updateActiveTypeClasses('ticket'); // تذكرة هي الافتراضية
        
        // دالة تحديث فئات النوع النشط
        function updateActiveTypeClasses(activeType) {
            // إزالة جميع الفئات النشطة أولاً
            ticketOption.classList.remove('active-ticket');
            fineOption.classList.remove('active-fine');
            paymentOption.classList.remove('active-payment');
            
            // إضافة الفئة المناسبة
            if (activeType === 'ticket') {
                ticketOption.classList.add('active-ticket');
            } else if (activeType === 'fine') {
                fineOption.classList.add('active-fine');
            } else if (activeType === 'payment') {
                paymentOption.classList.add('active-payment');
            }
        }
        
        // دالة تحديث مؤشر النوع النشط
        function updateActiveTypeIndicator() {
            let activeType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) activeType = radio.value;
            });
            
            let icon = '';
            let title = '';
            let description = '';
            let className = '';
            
            if (activeType === 'ticket') {
                icon = 'fas fa-ticket-alt';
                title = 'تذكرة';
                description = 'أنت تقوم بتسجيل تذكرة جديدة. الرجاء ملء بيانات المسافر والمستند والوجهة.';
                className = 'active-type-ticket';
            } else if (activeType === 'fine') {
                icon = 'fas fa-exclamation-triangle';
                title = 'غرامة';
                description = 'أنت تقوم بتسجيل غرامة. الرجاء ملء سبب الغرامة وبياناتها.';
                className = 'active-type-fine';
            } else if (activeType === 'payment') {
                icon = 'fas fa-money-bill-wave';
                title = 'تسليم دفعة';
                description = 'أنت تقوم بتسجيل تسليم دفعة للشركة. الرجاء إدخال وصف الدفعة.';
                className = 'active-type-payment';
            }
            
            activeTypeIndicator.innerHTML = `
                <div class="active-type-header ${className}">
                    <div class="active-type-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="active-type-text">
                        <h3>نوع العملية الحالي: ${title}</h3>
                        <p>${description}</p>
                    </div>
                </div>
            `;
            
            activeTypeIndicator.classList.remove('hidden');
        }
        
        // دالة فتح نافذة إضافة شركة
        function openAddCompanyModal() {
            addCompanyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            newCompanyNameInput.value = '';
            selectBalanceType('credit');
            initialBalanceInput.value = '';
            setTimeout(() => newCompanyNameInput.focus(), 100);
        }
        
        // دالة إغلاق نافذة إضافة شركة
        function closeAddCompanyModal() {
            addCompanyModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // دالة اختيار نوع الرصيد
        function selectBalanceType(type) {
            balanceType = type;
            
            if (type === 'debit') {
                debitOption.classList.add('selected');
                creditOption.classList.remove('selected');
                debitExplanation.classList.remove('hidden');
                creditExplanation.classList.add('hidden');
            } else {
                debitOption.classList.remove('selected');
                creditOption.classList.add('selected');
                debitExplanation.classList.add('hidden');
                creditExplanation.classList.remove('hidden');
            }
        }
        
        // دالة حفظ شركة جديدة
        function saveNewCompany() {
            const companyName = newCompanyNameInput.value.trim();
            const balance = parseFloat(initialBalanceInput.value) || 0;
            
            if (companyName === '') {
                alert('يرجى إدخال اسم الشركة');
                newCompanyNameInput.focus();
                return;
            }
            
            if (companies.hasOwnProperty(companyName)) {
                alert('هذه الشركة موجودة مسبقاً');
                return;
            }
            
            let openingBalance = balance;
            if (balanceType === 'debit') {
                openingBalance = -balance;
            }
            
            companies[companyName] = openingBalance;
            
            if (balance > 0) {
                const transaction = {
                    id: generateId(),
                    date: today,
                    type: 'initial',
                    company: companyName,
                    amount: balance,
                    description: `رصيد افتتاحي ${balanceType === 'credit' ? 'دائن (الشركة تحتاج مني)' : 'مدين (أحتاج من الشركة)'}`
                };
                
                transactions.push(transaction);
            }
            
            updateCompanyList();
            updateCompanySelect();
            updateFilterCompanySelect();
            
            companySelect.value = companyName;
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = `كشف حساب: ${companyName}`;
            updateCompanyBalance(companyName);
            
            closeAddCompanyModal();
            saveData();
            
            updateReport();
            updateManageTable();
            
            alert('تم إضافة الشركة بنجاح!');
        }
        
        // دالة تحديث حقول النموذج حسب نوع العملية
        function updateFormFields(transactionType) {
            ticketFineFields.classList.add('hidden');
            fineOnlyFields.classList.add('hidden');
            paymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.add('hidden');
                notesGroup.classList.remove('hidden');
            } else if (transactionType === 'fine') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            } else if (transactionType === 'payment') {
                paymentFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            }
        }
        
        // دالة تحديث حقول نموذج التعديل
        function updateEditFormFields(transactionType) {
            editTicketFields.classList.add('hidden');
            editFineOnlyFields.classList.add('hidden');
            editPaymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.add('hidden');
            } else if (transactionType === 'fine') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.remove('hidden');
            } else if (transactionType === 'payment') {
                editPaymentFields.classList.remove('hidden');
            }
        }
        
        // دالة إضافة عملية جديدة
        function addTransaction() {
            const company = companySelect.value;
            if (!company) {
                alert('يرجى اختيار شركة أولاً');
                companySelect.focus();
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            let transactionType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) transactionType = radio.value;
            });
            
            const transaction = {
                id: generateId(),
                date: dateInput.value,
                type: transactionType,
                company: company,
                amount: parseFloat(amountInput.value)
            };
            
            if (transactionType === 'ticket') {
                let destination = destinationSelect.value;
                if (destination === 'other') {
                    destination = otherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        otherDestinationInput.focus();
                        return;
                    }
                }
                
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destination;
                transaction.tripType = tripTypeSelect.value;
                transaction.notes = notesInput.value.trim();
                
                if (transaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    passengerNameInput.focus();
                    return;
                }
                
                if (transaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    documentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destinationSelect.value;
                transaction.tripType = tripTypeSelect.value;
                transaction.reason = fineReasonInput.value.trim();
                
                if (transaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    fineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                transaction.description = paymentDescriptionInput.value.trim();
                
                if (transaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    paymentDescriptionInput.focus();
                    return;
                }
            }
            
            updateCompanyBalanceAfterTransaction(company, transaction.type, transaction.amount);
            
            transactions.push(transaction);
            
            saveData();
            
            updateReport();
            updateCompanyList();
            updateManageTable();
            
            resetForm();
            
            alert('تم إضافة العملية بنجاح!');
        }
        
        // دالة التحقق من صحة البيانات
        function validateForm() {
            if (amountInput.value === '' || parseFloat(amountInput.value) <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                amountInput.focus();
                return false;
            }
            
            return true;
        }
        
        // دالة تحديث رصيد الشركة بعد العملية
        function updateCompanyBalanceAfterTransaction(company, type, amount) {
            if (type === 'ticket' || type === 'fine') {
                companies[company] += amount;
            } else if (type === 'payment') {
                companies[company] -= amount;
            }
        }
        
        // دالة تحديث عرض رصيد الشركة
        function updateCompanyBalance(company) {
            if (!company) {
                companyBalanceElement.textContent = '0 دينار';
                companyBalanceElement.className = 'company-balance';
                return;
            }
            
            let balance = companies[company] || 0;
            let balanceText = formatCurrency(Math.abs(balance));
            
            if (balance > 0) {
                companyBalanceElement.className = 'company-balance positive-balance';
                companyBalanceElement.textContent = balanceText + ' (دائن)';
            } else if (balance < 0) {
                companyBalanceElement.className = 'company-balance negative-balance';
                companyBalanceElement.textContent = balanceText + ' (مدين)';
            } else {
                companyBalanceElement.className = 'company-balance';
                companyBalanceElement.textContent = balanceText;
            }
        }
        
        // دالة تحديث قائمة الشركات
        function updateCompanyList() {
            if (Object.keys(companies).length === 0) {
                noCompaniesMsg.style.display = 'block';
                companyList.innerHTML = '<p id="no-companies">لا توجد شركات مضافة بعد</p>';
                return;
            }
            
            noCompaniesMsg.style.display = 'none';
            companyList.innerHTML = '';
            
            Object.keys(companies).sort().forEach(company => {
                const companyItem = document.createElement('div');
                companyItem.className = 'company-item';
                
                const balance = companies[company];
                let balanceText = formatCurrency(Math.abs(balance));
                
                if (balance > 0) {
                    balanceText += ' (دائن)';
                } else if (balance < 0) {
                    balanceText += ' (مدين)';
                }
                
                const balanceClass = balance > 0 ? 'positive-balance' : (balance < 0 ? 'negative-balance' : '');
                
                companyItem.innerHTML = `
                    <div class="company-name">${company}</div>
                    <div class="company-item-balance ${balanceClass}">${balanceText}</div>
                    <div class="company-item-actions">
                        <button class="delete-company" data-company="${company}">حذف</button>
                    </div>
                `;
                
                companyList.appendChild(companyItem);
            });
            
            document.querySelectorAll('.delete-company').forEach(btn => {
                btn.addEventListener('click', function() {
                    const companyToDelete = this.getAttribute('data-company');
                    deleteCompany(companyToDelete);
                });
            });
        }
        
        // دالة حذف شركة
        function deleteCompany(companyName) {
            if (!confirm(`هل أنت متأكد من حذف شركة "${companyName}"؟ سيتم حذف جميع عملياتها أيضاً.`)) {
                return;
            }
            
            delete companies[companyName];
            transactions = transactions.filter(t => t.company !== companyName);
            
            updateCompanyList();
            updateCompanySelect();
            updateFilterCompanySelect();
            updateReport();
            updateManageTable();
            saveData();
            
            alert('تم حذف الشركة وعملياتها بنجاح!');
        }
        
        // دالة تحديث قائمة الشركات في select
        function updateCompanySelect() {
            const currentValue = companySelect.value;
            
            companySelect.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                companySelect.value = currentValue;
            }
        }
        
        // دالة تحديث قائمة الشركات في فلتر إدارة العمليات
        function updateFilterCompanySelect() {
            filterCompanySelect.innerHTML = '<option value="">جميع الشركات</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                filterCompanySelect.appendChild(option);
            });
        }
        
        // دالة فتح نموذج التعديل
        function openEditForm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentEditTransactionId = transactionId;
            
            editFormContainer.classList.remove('hidden');
            deleteConfirmContainer.classList.add('hidden');
            
            editTransactionTypeSelect.value = transaction.type;
            updateEditFormFields(transaction.type);
            
            if (transaction.type === 'ticket') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ذهاب';
                editNotesInput.value = transaction.notes || '';
            } else if (transaction.type === 'fine') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ذهاب';
                editFineReasonInput.value = transaction.reason || '';
            } else if (transaction.type === 'payment') {
                editPaymentDescriptionInput.value = transaction.description || '';
            }
            
            editAmountInput.value = transaction.amount;
            editDateInput.value = transaction.date;
            
            editFormContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء التعديل
        function cancelEdit() {
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
        }
        
        // دالة حفظ التعديلات
        function saveEdit() {
            if (!currentEditTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentEditTransactionId);
            if (transactionIndex === -1) return;
            
            const oldTransaction = transactions[transactionIndex];
            const oldAmount = oldTransaction.amount;
            const oldType = oldTransaction.type;
            
            if (oldType === 'ticket' || oldType === 'fine') {
                companies[oldTransaction.company] -= oldAmount;
            } else if (oldType === 'payment') {
                companies[oldTransaction.company] += oldAmount;
            }
            
            const transactionType = editTransactionTypeSelect.value;
            const amount = parseFloat(editAmountInput.value);
            
            if (!amount || amount <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                editAmountInput.focus();
                return;
            }
            
            const updatedTransaction = {
                ...oldTransaction,
                date: editDateInput.value,
                type: transactionType,
                amount: amount
            };
            
            if (transactionType === 'ticket') {
                let destination = editDestinationSelect.value;
                if (destination === 'other') {
                    destination = editOtherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        editOtherDestinationInput.focus();
                        return;
                    }
                }
                
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = destination;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.notes = editNotesInput.value.trim();
                updatedTransaction.reason = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    editPassengerNameInput.focus();
                    return;
                }
                
                if (updatedTransaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    editDocumentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = editDestinationSelect.value;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.reason = editFineReasonInput.value.trim();
                updatedTransaction.notes = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    editFineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                updatedTransaction.description = editPaymentDescriptionInput.value.trim();
                updatedTransaction.passengerName = '';
                updatedTransaction.documentNumber = '';
                updatedTransaction.destination = '';
                updatedTransaction.tripType = '';
                updatedTransaction.reason = '';
                updatedTransaction.notes = '';
                
                if (updatedTransaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    editPaymentDescriptionInput.focus();
                    return;
                }
            }
            
            if (transactionType === 'ticket' || transactionType === 'fine') {
                companies[updatedTransaction.company] += amount;
            } else if (transactionType === 'payment') {
                companies[updatedTransaction.company] -= amount;
            }
            
            transactions[transactionIndex] = updatedTransaction;
            
            saveData();
            updateReport();
            updateCompanyList();
            updateManageTable();
            
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
            
            alert('تم تحديث العملية بنجاح!');
        }
        
        // دالة فتح تأكيد الحذف
        function openDeleteConfirm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentDeleteTransactionId = transactionId;
            
            deleteConfirmContainer.classList.remove('hidden');
            editFormContainer.classList.add('hidden');
            
            deleteConfirmContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء الحذف
        function cancelDelete() {
            deleteConfirmContainer.classList.add('hidden');
            currentDeleteTransactionId = null;
        }
        
        // دالة تأكيد الحذف
        function confirmDelete() {
            if (!currentDeleteTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentDeleteTransactionId);
            if (transactionIndex === -1) return;
            
            const transaction = transactions[transactionIndex];
            
            if (confirm(`هل أنت متأكد من حذف هذه العملية؟\n\nالتفاصيل:\n- الشركة: ${transaction.company}\n- النوع: ${getTypeName(transaction.type)}\n- المبلغ: ${formatCurrency(transaction.amount)}\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
                if (transaction.type === 'ticket' || transaction.type === 'fine') {
                    companies[transaction.company] -= transaction.amount;
                } else if (transaction.type === 'payment') {
                    companies[transaction.company] += transaction.amount;
                }
                
                transactions.splice(transactionIndex, 1);
                
                saveData();
                updateReport();
                updateCompanyList();
                updateManageTable();
                
                deleteConfirmContainer.classList.add('hidden');
                currentDeleteTransactionId = null;
                
                alert('تم حذف العملية بنجاح!');
            }
        }
        
        // دالة تحديث جدول إدارة العمليات
        function updateManageTable() {
            const filterCompany = filterCompanySelect.value;
            const filterType = filterTypeSelect.value;
            
            let filteredTransactions = [...transactions];
            
            if (filterCompany) {
                filteredTransactions = filteredTransactions.filter(t => t.company === filterCompany);
            }
            
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            
            if (filteredTransactions.length > 0) {
                noTransactionsElement.style.display = 'none';
                manageTransactionsBody.innerHTML = '';
            } else {
                noTransactionsElement.style.display = 'block';
                manageTransactionsBody.innerHTML = '';
                return;
            }
            
            filteredTransactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.className = 'transaction-row';
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                }
                
                let passengerName = transaction.passengerName || transaction.description || '-';
                if (passengerName.length > 20) {
                    passengerName = passengerName.substring(0, 20) + '...';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.company}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn action-btn-edit" data-id="${transaction.id}">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn action-btn-delete" data-id="${transaction.id}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </td>
                `;
                
                manageTransactionsBody.appendChild(row);
            });
            
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openEditForm(transactionId);
                });
            });
            
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openDeleteConfirm(transactionId);
                });
            });
        }
        
        // دالة تحديث كشف الحساب
        function updateReport() {
            const currentCompany = companySelect.value;
            if (currentCompany) {
                reportCompanyNameElement.textContent = `كشف حساب: ${currentCompany}`;
            } else {
                reportCompanyNameElement.textContent = 'كشف الحساب';
            }
            
            updateCompanyBalance(currentCompany);
            
            if (transactions.length > 0) {
                noDataElement.style.display = 'none';
                transactionsBody.innerHTML = '';
            } else {
                noDataElement.style.display = 'block';
                transactionsBody.innerHTML = '';
                updateSummary();
                return;
            }
            
            let filteredTransactions = [];
            
            if (currentCompany) {
                filteredTransactions = transactions.filter(t => t.company === currentCompany);
            } else {
                filteredTransactions = [...transactions];
            }
            
            let balance = 0;
            filteredTransactions.forEach((transaction, index) => {
                if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                    balance += transaction.amount;
                } else if (transaction.type === 'payment') {
                    balance -= transaction.amount;
                }
                
                const row = document.createElement('tr');
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                }
                
                let passengerName = transaction.passengerName || '-';
                let documentNumber = transaction.documentNumber || '-';
                
                let destination = transaction.destination || '-';
                if (destination.includes('(')) {
                    const match = destination.match(/\(([^)]+)\)/);
                    if (match) {
                        destination = `<span class="destination-abbr">${match[1]}</span>`;
                    }
                }
                
                let tripType = transaction.tripType || '-';
                let reasonDesc = transaction.reason || transaction.description || '-';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${documentNumber}</td>
                    <td>${destination}</td>
                    <td>${tripType}</td>
                    <td>${reasonDesc}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td>${formatCurrency(balance)}</td>
                `;
                
                transactionsBody.appendChild(row);
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="8">الرصيد النهائي</td>
                <td colspan="2">${formatCurrency(balance)}</td>
            `;
            transactionsBody.appendChild(totalRow);
            
            updateSummary(filteredTransactions, balance);
        }
        
        // دالة تحديث الملخص
        function updateSummary(filteredTransactions = null, finalBalance = 0) {
            const transactionsToCalculate = filteredTransactions || transactions;
            
            let totalTickets = 0;
            let totalFines = 0;
            let totalPayments = 0;
            
            transactionsToCalculate.forEach(transaction => {
                if (transaction.type === 'ticket') {
                    totalTickets++;
                } else if (transaction.type === 'fine') {
                    totalFines += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                }
            });
            
            totalTicketsElement.textContent = totalTickets;
            totalFinesElement.textContent = formatCurrency(totalFines);
            totalPaymentsElement.textContent = formatCurrency(totalPayments);
            totalBalanceElement.textContent = formatCurrency(finalBalance);
            
            if (finalBalance > 0) {
                totalBalanceElement.style.color = 'var(--success-color)';
            } else if (finalBalance < 0) {
                totalBalanceElement.style.color = 'var(--accent-color)';
            } else {
                totalBalanceElement.style.color = 'var(--primary-color)';
            }
        }
        
        // دالة إعادة تعيين النموذج
        function resetForm() {
            passengerNameInput.value = '';
            documentNumberInput.value = '';
            destinationSelect.value = 'TIP - IST';
            otherDestinationInput.classList.add('hidden');
            otherDestinationInput.value = '';
            tripTypeSelect.value = 'ذهاب';
            
            fineReasonInput.value = '';
            paymentDescriptionInput.value = '';
            
            amountInput.value = '';
            dateInput.value = today;
            notesInput.value = '';
            
            if (companySelect.value) {
                passengerNameInput.focus();
            }
        }
        
        // دالة طباعة التقرير
        function printReport() {
            window.print();
        }
        
        // دالة الحصول على اسم النوع
        function getTypeName(type) {
            switch(type) {
                case 'ticket': return 'تذكرة';
                case 'fine': return 'غرامة';
                case 'payment': return 'تسليم';
                case 'initial': return 'افتتاحي';
                default: return type;
            }
        }
        
        // دالة توليد معرف فريد
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // دالة تنسيق العملة
        function formatCurrency(amount) {
            const absAmount = Math.abs(amount);
            const formatted = new Intl.NumberFormat('ar-LY', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(absAmount) + ' دينار';
            
            if (amount < 0) {
                return '-' + formatted;
            }
            return formatted;
        }
        
        // دالة حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('ticketSystem_transactions', JSON.stringify(transactions));
            localStorage.setItem('ticketSystem_companies', JSON.stringify(companies));
        }
        
        // دالة تحميل البيانات من localStorage
        function loadData() {
            const savedTransactions = localStorage.getItem('ticketSystem_transactions');
            const savedCompanies = localStorage.getItem('ticketSystem_companies');
            
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            
            if (savedCompanies) {
                companies = JSON.parse(savedCompanies);
                updateCompanySelect();
                updateFilterCompanySelect();
                updateCompanyList();
            }
        }
        
        // إغلاق النافذة عند النقر خارجها
        addCompanyModal.addEventListener('click', function(e) {
            if (e.target === addCompanyModal) {
                closeAddCompanyModal();
            }
        });
        
        // اختيار نوع الرصيد الافتراضي
        selectBalanceType('credit');
        
        // إغلاق النافذة بمفتاح ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!addCompanyModal.classList.contains('hidden')) {
                    closeAddCompanyModal();
                }
                if (editFormContainer.classList.contains('hidden') === false) {
                    cancelEdit();
                }
                if (deleteConfirmContainer.classList.contains('hidden') === false) {
                    cancelDelete();
                }
            }
        });
    </script>
</body>
</html>