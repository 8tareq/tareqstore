<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ISAM لحجز التذاكر</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #9b59b6;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #333;
            --text-light: #7f8c8d;
            --border: #bdc3c7;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* رأس الصفحة */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 25px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.2rem;
            color: #f1c40f;
        }
        
        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .logo span {
            color: #f1c40f;
        }
        
        /* القائمة الرئيسية */
        .main-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .menu-btn {
            background: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s;
            min-width: 200px;
            justify-content: center;
        }
        
        .menu-btn:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-3px);
        }
        
        .menu-btn i {
            font-size: 1.3rem;
        }
        
        /* أشكال المحتوى */
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
            display: none;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .section-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header h2 i {
            color: var(--secondary);
        }
        
        /* أشكال الإدخال */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--secondary), var(--info));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), #2ecc71);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(46, 204, 113, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning), #f1c40f);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(241, 196, 15, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(231, 76, 60, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(to right, #17a2b8, #1abc9c);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(23, 162, 184, 0.3);
        }
        
        /* نماذج تأكيد الحذف */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .confirmation-modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .confirmation-modal h3 {
            color: var(--danger);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .confirmation-modal p {
            margin-bottom: 25px;
            color: var(--text);
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* تذييل الصفحة */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* ستايلات كشف الحساب الجديد */
        .statement-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        .account-statement {
            width: 100%;
            min-width: 1000px;
        }

        .statement-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
        }

        .statement-header h3 {
            color: var(--primary);
            font-size: 24px;
            margin-bottom: 5px;
        }

        .statement-header p {
            color: var(--text-light);
            font-size: 16px;
        }

        .statement-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }

        .statement-table th {
            background-color: #2c3e50;
            color: white;
            padding: 8px 4px;
            border: 1px solid #ddd;
            text-align: center;
            font-weight: bold;
        }

        .statement-table td {
            padding: 6px 4px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 11px;
        }

        .statement-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .balance-cell {
            font-weight: bold;
        }

        .balance-positive {
            color: #27ae60;
        }

        .balance-negative {
            color: #e74c3c;
        }

        .debit-cell {
            color: #e74c3c;
            font-weight: bold;
        }

        .credit-cell {
            color: #27ae60;
            font-weight: bold;
        }

        .statement-summary {
            margin-top: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .summary-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 14px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .summary-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
            text-align: right;
        }

        .summary-table td:first-child {
            font-weight: bold;
            text-align: left;
            width: 150px;
        }

        .final-balance {
            margin-top: 20px;
            padding: 15px;
            background: #2c3e50;
            color: white;
            border-radius: 5px;
            text-align: center;
        }

        .final-label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .final-value {
            font-size: 20px;
            font-weight: bold;
        }

        .statement-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 11px;
        }

        .statement-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* ستايلات المعاملات */
        .transactions-container {
            width: 100%;
        }

        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .filter-box {
            width: 200px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        .transactions-table th {
            background-color: var(--primary);
            color: white;
            padding: 12px 8px;
            border: 1px solid var(--border);
            text-align: center;
            font-weight: 600;
        }

        .transactions-table td {
            padding: 10px 8px;
            border: 1px solid var(--border);
            text-align: center;
            vertical-align: middle;
        }

        .transactions-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .transactions-table tr:hover {
            background-color: #e8f4fc;
        }

        .transaction-type-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-ticket {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }

        .badge-fine {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }

        .badge-delivery {
            background-color: rgba(155, 89, 182, 0.15);
            color: var(--info);
        }

        .amount-positive {
            color: var(--success);
            font-weight: bold;
        }

        .amount-negative {
            color: var(--danger);
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        /* الطباعة - الشكل المطلوب */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #printableStatement, #printableStatement * {
                visibility: visible;
            }
            
            #printableStatement {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background: white;
                color: black;
                font-family: 'Arial', sans-serif;
                direction: rtl;
            }
            
            .print-statement {
                width: 100%;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #333;
            }
            
            .print-header h1 {
                font-size: 20px;
                color: #2c3e50;
                margin-bottom: 5px;
            }
            
            .print-header h2 {
                font-size: 16px;
                color: #666;
                font-weight: normal;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
                font-size: 10px;
                page-break-inside: auto;
                border: 1px solid #ddd;
            }
            
            .print-table th {
                background-color: #f5f5f5 !important;
                color: black !important;
                font-weight: bold;
                padding: 6px 4px;
                border: 1px solid #ddd;
                text-align: center;
                font-size: 10px;
            }
            
            .print-table td {
                padding: 5px 4px;
                border: 1px solid #ddd;
                text-align: center;
                page-break-inside: avoid;
                word-wrap: break-word;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .print-table tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            .print-balance-positive {
                color: #27ae60;
                font-weight: bold;
            }
            
            .print-balance-negative {
                color: #e74c3c;
                font-weight: bold;
            }
            
            .print-debit {
                color: #e74c3c;
                font-weight: bold;
            }
            
            .print-credit {
                color: #27ae60;
                font-weight: bold;
            }
            
            .print-summary {
                margin-top: 20px;
                padding: 10px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 5px;
                page-break-inside: avoid;
                font-size: 11px;
            }
            
            .print-summary-title {
                text-align: center;
                font-size: 12px;
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px solid #ddd;
            }
            
            .print-summary-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            
            .print-summary-table td {
                padding: 6px 8px;
                border: 1px solid #ddd;
                text-align: right;
            }
            
            .print-summary-table td:first-child {
                font-weight: bold;
                text-align: left;
                width: 120px;
            }
            
            .print-total-balance {
                margin-top: 15px;
                padding: 10px;
                background: #2c3e50;
                color: white;
                border-radius: 5px;
                text-align: center;
                font-size: 12px;
                page-break-inside: avoid;
            }
            
            .print-total-label {
                font-size: 11px;
                margin-bottom: 5px;
            }
            
            .print-total-value {
                font-size: 16px;
                font-weight: bold;
            }
            
            .print-footer {
                text-align: center;
                margin-top: 15px;
                padding-top: 8px;
                border-top: 1px solid #ddd;
                color: #666;
                font-size: 9px;
                page-break-inside: avoid;
            }
            
            /* إخفاء العناصر غير المرغوب فيها */
            .no-print, .btn, button, .menu-btn, footer, header,
            .section-header, .main-menu, .form-control, .form-select,
            .search-filters, .transaction-actions {
                display: none !important;
            }
            
            /* إجبار اتجاه الطباعة أفقي */
            @page {
                size: landscape;
                margin: 5mm;
            }
        }
        
        /* التجاوب مع الشاشات المختلفة */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .main-menu {
                flex-direction: column;
            }
            
            .menu-btn {
                min-width: 100%;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .search-filters {
                flex-direction: column;
            }
            
            .search-box, .filter-box {
                width: 100%;
            }
            
            .transactions-table {
                font-size: 12px;
            }
            
            .transactions-table th,
            .transactions-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- نموذج تأكيد الحذف -->
    <div id="deleteConfirmation" class="modal-overlay">
        <div class="confirmation-modal">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger); margin-bottom: 15px;"></i>
            <h3>تأكيد الحذف</h3>
            <p id="deleteMessage">هل أنت متأكد من حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="modal-buttons">
                <button id="confirmDelete" class="btn btn-danger">نعم، احذف</button>
                <button id="cancelDelete" class="btn btn-primary">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج تعديل المعاملة -->
    <div id="editModal" class="modal-overlay">
        <div class="confirmation-modal" style="max-width: 600px;">
            <h3 id="editModalTitle">تعديل المعاملة</h3>
            <form id="editForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editDocumentNo">رقم المستند</label>
                        <input type="text" id="editDocumentNo" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editName">الاسم</label>
                        <input type="text" id="editName" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editInfo">المعلومات</label>
                        <input type="text" id="editInfo" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editAmount">المبلغ</label>
                        <input type="text" id="editAmount" class="form-control" 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                </div>
                
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">حفظ التعديلات</button>
                    <button type="button" id="cancelEdit" class="btn btn-primary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- حاوية الطباعة (مخفية) -->
    <div id="printContainer" class="print-container"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-plane-departure"></i>
                    <h1>نظام <span>ISAM</span> لحجز التذاكر</h1>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- رسالة الترحيب (تظهر فقط عند عدم وجود بيانات) -->
        <div id="welcomeMessage" style="text-align: center; padding: 50px 20px; background: white; border-radius: 15px; box-shadow: 0 5px 15px var(--shadow); margin-bottom: 30px;">
            <i class="fas fa-plane-departure" style="font-size: 4rem; color: var(--secondary); margin-bottom: 20px;"></i>
            <h2 style="color: var(--primary); margin-bottom: 15px;">مرحباً بك في نظام ISAM لحجز التذاكر</h2>
            <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.1rem; line-height: 1.6;">
                نظام متكامل لإدارة حجوزات التذاكر والعمليات المالية للشركات. 
                ابدأ بإضافة شركتك الأولى، ثم أضف التذاكر والعمليات الأخرى.
            </p>
            <button onclick="showSection('addCompany')" class="btn btn-success" style="font-size: 1.2rem; padding: 15px 30px;">
                <i class="fas fa-plus-circle"></i> إضافة شركتك الأولى
            </button>
        </div>
        
        <!-- القائمة الرئيسية (تظهر بعد إضافة الشركات) -->
        <div class="main-menu" id="mainMenu" style="display: none;">
            <button class="menu-btn active" data-section="addCompany">
                <i class="fas fa-building"></i> إضافة شركة
            </button>
            <button class="menu-btn" data-section="addTransaction">
                <i class="fas fa-ticket-alt"></i> إضافة تذكرة
            </button>
            <button class="menu-btn" data-section="addFine">
                <i class="fas fa-exclamation-triangle"></i> إضافة غرامة
            </button>
            <button class="menu-btn" data-section="addDelivery">
                <i class="fas fa-hand-holding-usd"></i> تسليم مبلغ
            </button>
            <button class="menu-btn" data-section="transactionsList">
                <i class="fas fa-list-alt"></i> قائمة المعاملات
            </button>
            <button class="menu-btn" data-section="statement">
                <i class="fas fa-file-invoice-dollar"></i> كشف حساب
            </button>
            <button class="menu-btn" data-section="companiesList">
                <i class="fas fa-list"></i> قائمة الشركات
            </button>
        </div>
        
        <!-- إضافة شركة جديدة -->
        <div id="addCompany" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-building"></i> إضافة شركة جديدة</h2>
            </div>
            
            <form id="companyForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName">اسم الشركة *</label>
                        <input type="text" id="companyName" class="form-control" placeholder="أدخل اسم الشركة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="companyType">نوع الحساب *</label>
                        <select id="companyType" class="form-select" required>
                            <option value="">اختر نوع الحساب</option>
                            <option value="دائن">دائن (الشركة تبي مني)</option>
                            <option value="مدين">مدين (أنا أحتاج من الشركة)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="initialBalance">الرصيد الابتدائي *</label>
                        <input type="text" id="initialBalance" class="form-control" placeholder="أدخل الرصيد الابتدائي" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                        <small style="color: var(--text-light);">مثال: 1500.500 أو 1200</small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> حفظ الشركة
                </button>
            </form>
        </div>
        
        <!-- إضافة تذكرة -->
        <div id="addTransaction" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-ticket-alt"></i> إضافة تذكرة جديدة</h2>
            </div>
            
            <form id="transactionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="transactionCompany">الشركة *</label>
                        <select id="transactionCompany" class="form-select" required>
                            <option value="">اختر الشركة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="documentNo">رقم المستند *</label>
                        <input type="text" id="documentNo" class="form-control" placeholder="أدخل رقم المستند" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="passengerName">اسم المسافر *</label>
                        <input type="text" id="passengerName" class="form-control" placeholder="أدخل اسم المسافر" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="destination">الوجهة *</label>
                        <select id="destination" class="form-select" required>
                            <option value="">اختر الوجهة</option>
                            <option value="TRP">طرابلس (TRP)</option>
                            <option value="IST">اسطنبول (IST)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ticketAmount">قيمة التذكرة *</label>
                        <input type="text" id="ticketAmount" class="form-control" placeholder="أدخل قيمة التذكرة" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check-circle"></i> إضافة التذكرة
                </button>
            </form>
        </div>
        
        <!-- إضافة غرامة -->
        <div id="addFine" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-exclamation-triangle"></i> إضافة غرامة</h2>
                <small style="color: var(--text-light);">الغرامة تضاف للشركة الدائن (التي تبي مني) مثل التذكرة</small>
            </div>
            
            <form id="fineForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fineCompany">الشركة *</label>
                        <select id="fineCompany" class="form-select" required>
                            <option value="">اختر الشركة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="finePerson">اسم الشخص المُغرَم *</label>
                        <input type="text" id="finePerson" class="form-control" placeholder="أدخل اسم الشخص" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fineAmount">قيمة الغرامة *</label>
                        <input type="text" id="fineAmount" class="form-control" placeholder="أدخل قيمة الغرامة" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                    
                    <div class="form-group">
                        <label for="fineReason">سبب الغرامة *</label>
                        <input type="text" id="fineReason" class="form-control" placeholder="أدخل سبب الغرامة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fineDocument">رقم المستند (اختياري)</label>
                        <input type="text" id="fineDocument" class="form-control" placeholder="أدخل رقم المستند">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-exclamation-circle"></i> إضافة الغرامة
                </button>
            </form>
        </div>
        
        <!-- تسليم مبلغ -->
        <div id="addDelivery" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-hand-holding-usd"></i> تسليم مبلغ</h2>
                <small style="color: var(--text-light);">التسليم يخصم من رصيد الشركة (سواء كانت دائن أو مدين)</small>
            </div>
            
            <form id="deliveryForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="deliveryCompany">الشركة *</label>
                        <select id="deliveryCompany" class="form-select" required>
                            <option value="">اختر الشركة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryAmount">المبلغ المسلّم *</label>
                        <input type="text" id="deliveryAmount" class="form-control" placeholder="أدخل المبلغ المسلّم" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveredTo">اسم المستلم *</label>
                        <input type="text" id="deliveredTo" class="form-control" placeholder="أدخل اسم المستلم" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryNotes">ملاحظات (اختياري)</label>
                        <textarea id="deliveryNotes" class="form-control" placeholder="أدخل ملاحظات إضافية" rows="3"></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-handshake"></i> تسجيل التسليم
                </button>
            </form>
        </div>
        
        <!-- قائمة المعاملات -->
        <div id="transactionsList" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> قائمة جميع المعاملات</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="refreshTransactionsList()" class="btn btn-info">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>
            </div>
            
            <div class="search-filters">
                <div class="search-box">
                    <input type="text" id="searchTransactions" class="form-control" placeholder="ابحث بالاسم أو رقم المستند...">
                </div>
                <div class="filter-box">
                    <select id="filterType" class="form-select">
                        <option value="">جميع الأنواع</option>
                        <option value="ticket">تذاكر</option>
                        <option value="fine">غرامات</option>
                        <option value="delivery">تسليمات</option>
                    </select>
                </div>
                <div class="filter-box">
                    <select id="filterCompany" class="form-select">
                        <option value="">جميع الشركات</option>
                    </select>
                </div>
                <div class="filter-box">
                    <input type="date" id="filterDate" class="form-control">
                </div>
            </div>
            
            <div id="transactionsListContent">
                <div class="no-data">
                    <i class="fas fa-list-alt"></i>
                    <h3>لا توجد معاملات مسجلة</h3>
                    <p>ابدأ بإضافة معاملة جديدة من خلال القائمة أعلاه</p>
                </div>
            </div>
        </div>
        
        <!-- كشف حساب -->
        <div id="statement" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> كشف حساب الشركة</h2>
                <div>
                    <select id="statementCompany" class="form-select" style="width: 200px; margin-left: 10px;">
                        <option value="">اختر الشركة</option>
                    </select>
                    <button id="printStatementBtn" class="btn btn-info">
                        <i class="fas fa-print"></i> طباعة الكشف
                    </button>
                </div>
            </div>
            
            <div id="statementContent">
                <div class="account-statement" style="text-align: center; padding: 50px 20px;">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 5rem; color: #bdc3c7; margin-bottom: 20px;"></i>
                    <h3 style="color: #7f8c8d;">اختر شركة لعرض كشف الحساب</h3>
                    <p>سيتم عرض جميع المعاملات والرصيد الحالي للشركة المحددة</p>
                </div>
            </div>
        </div>
        
        <!-- قائمة الشركات -->
        <div id="companiesList" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> قائمة الشركات المسجلة</h2>
            </div>
            
            <div id="companiesListContent">
                <div style="text-align: center; padding: 50px 20px; color: var(--text-light);">
                    <i class="fas fa-building" style="font-size: 5rem; color: #bdc3c7; margin-bottom: 20px;"></i>
                    <h3 style="color: #7f8c8d;">اختر شركة لعرض القائمة</h3>
                    <p>الرجاء اختيار شركة من القائمة أعلاه لعرض تفاصيلها</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>نظام ISAM لحجز التذاكر &copy; <span id="currentYear"></span> - جميع الحقوق محفوظة</p>
            <p>تم التطوير بلغات HTML, CSS, JavaScript</p>
        </div>
    </footer>

    <script>
        // بيانات النظام - تبدأ فارغة تماماً
        let isamData = {
            companies: [],
            transactions: [],
            fines: [],
            deliveries: []
        };

        // متغيرات للحذف والتعديل
        let deleteType = '';
        let deleteId = null;
        let editType = '';
        let editId = null;

        // تحميل البيانات من localStorage
        function loadData() {
            const savedData = localStorage.getItem('isamData');
            if (savedData) {
                isamData = JSON.parse(savedData);
                if (isamData.companies.length > 0) {
                    showMainInterface();
                }
                updateCompaniesSelect();
                displayCompaniesList();
                displayTransactionsList();
            }
        }

        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('isamData', JSON.stringify(isamData));
            updateCompaniesSelect();
            displayCompaniesList();
            displayTransactionsList();
            
            if (isamData.companies.length > 0) {
                showMainInterface();
            } else {
                hideMainInterface();
            }
        }

        // عرض الواجهة الرئيسية
        function showMainInterface() {
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
        }

        // إخفاء الواجهة الرئيسية
        function hideMainInterface() {
            document.getElementById('welcomeMessage').style.display = 'block';
            document.getElementById('mainMenu').style.display = 'none';
        }

        // تحديث قائمة الشركات في عناصر select
        function updateCompaniesSelect() {
            const companySelects = [
                'transactionCompany', 
                'fineCompany', 
                'deliveryCompany', 
                'statementCompany',
                'filterCompany'
            ];
            
            companySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // حفظ القيمة المحددة حالياً
                const currentValue = select.value;
                
                // إزالة الخيارات القديمة (باستثناء الخيار الأول)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // إضافة الشركات
                isamData.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    select.appendChild(option);
                });
                
                // استعادة القيمة المحددة إذا كانت موجودة
                if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // عرض قائمة الشركات
        function displayCompaniesList() {
            const contentDiv = document.getElementById('companiesListContent');
            
            if (isamData.companies.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: var(--text-light);">
                        <i class="fas fa-building" style="font-size: 5rem; color: #bdc3c7; margin-bottom: 20px;"></i>
                        <h3 style="color: #7f8c8d;">لا توجد شركات مسجلة</h3>
                        <p>ابدأ بإضافة أول شركة من خلال قائمة "إضافة شركة"</p>
                    </div>
                `;
                return;
            }
            
            let companiesHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            `;
            
            isamData.companies.forEach(company => {
                // حساب إجمالي المعاملات
                const companyTransactions = isamData.transactions.filter(t => t.companyId == company.id);
                const companyFines = isamData.fines.filter(f => f.companyId == company.id);
                const companyDeliveries = isamData.deliveries.filter(d => d.companyId == company.id);
                
                const totalTransactions = companyTransactions.length + companyFines.length + companyDeliveries.length;
                
                companiesHTML += `
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 3px 10px var(--shadow); border-right: 5px solid ${company.type === 'دائن' ? '#27ae60' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--primary); margin: 0;">${company.name}</h3>
                            <span style="padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; background-color: ${company.type === 'دائن' ? 'rgba(39, 174, 96, 0.15)' : 'rgba(231, 76, 60, 0.15)'}; color: ${company.type === 'دائن' ? '#27ae60' : '#e74c3c'}">
                                ${company.type}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-light); font-size: 0.9rem;">الرصيد الحالي:</span>
                                <span style="font-weight: 600; color: ${company.balance >= 0 ? '#27ae60' : '#e74c3c'}">
                                    ${formatDecimal(company.balance)}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-light); font-size: 0.9rem;">عدد المعاملات:</span>
                                <span style="font-weight: 600;">${totalTransactions}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-light); font-size: 0.9rem;">تاريخ الإنشاء:</span>
                                <span style="font-weight: 600;">${formatGregorianDate(company.date)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; gap: 10px;">
                            <button onclick="generateStatement(${company.id}); showSection('statement');" 
                                    class="btn btn-info" style="padding: 8px 15px; font-size: 0.9rem; flex: 1;">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                            <button onclick="requestDelete('company', ${company.id})" 
                                    class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem; flex: 1;">
                                <i class="fas fa-trash-alt"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            companiesHTML += `</div>`;
            contentDiv.innerHTML = companiesHTML;
        }

        // عرض قائمة المعاملات
        function displayTransactionsList() {
            const contentDiv = document.getElementById('transactionsListContent');
            
            // جمع جميع المعاملات
            let allItems = [];
            
            // إضافة التذاكر
            isamData.transactions.forEach(trans => {
                allItems.push({
                    id: trans.id,
                    type: 'ticket',
                    date: trans.date,
                    documentNo: trans.documentNo,
                    name: trans.passenger,
                    company: isamData.companies.find(c => c.id == trans.companyId)?.name || 'غير معروف',
                    amount: trans.amount,
                    details: trans.destination,
                    companyId: trans.companyId,
                    originalData: trans
                });
            });
            
            // إضافة الغرامات
            isamData.fines.forEach(fine => {
                allItems.push({
                    id: fine.id,
                    type: 'fine',
                    date: fine.date,
                    documentNo: fine.documentNo || '--',
                    name: fine.person,
                    company: isamData.companies.find(c => c.id == fine.companyId)?.name || 'غير معروف',
                    amount: fine.amount,
                    details: fine.reason,
                    companyId: fine.companyId,
                    originalData: fine
                });
            });
            
            // إضافة التسليمات
            isamData.deliveries.forEach(delivery => {
                allItems.push({
                    id: delivery.id,
                    type: 'delivery',
                    date: delivery.date,
                    documentNo: '--',
                    name: delivery.deliveredTo,
                    company: isamData.companies.find(c => c.id == delivery.companyId)?.name || 'غير معروف',
                    amount: delivery.amount,
                    details: delivery.notes || '--',
                    companyId: delivery.companyId,
                    originalData: delivery
                });
            });
            
            // ترتيب حسب التاريخ (من الأحدث إلى الأقدم)
            allItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // تطبيق عوامل التصفية
            const searchTerm = document.getElementById('searchTransactions')?.value.toLowerCase() || '';
            const filterType = document.getElementById('filterType')?.value || '';
            const filterCompany = document.getElementById('filterCompany')?.value || '';
            const filterDate = document.getElementById('filterDate')?.value || '';
            
            let filteredItems = allItems.filter(item => {
                // البحث بالاسم أو رقم المستند
                if (searchTerm && !item.name.toLowerCase().includes(searchTerm) && 
                    !item.documentNo.toLowerCase().includes(searchTerm) &&
                    !item.company.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // تصفية بالنوع
                if (filterType && item.type !== filterType) {
                    return false;
                }
                
                // تصفية بالشركة
                if (filterCompany && item.companyId != filterCompany) {
                    return false;
                }
                
                // تصفية بالتاريخ
                if (filterDate) {
                    const itemDate = new Date(item.date).toISOString().split('T')[0];
                    if (itemDate !== filterDate) {
                        return false;
                    }
                }
                
                return true;
            });
            
            if (filteredItems.length === 0) {
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <h3>لا توجد معاملات مطابقة للبحث</h3>
                        <p>حاول تغيير معايير البحث أو أضف معاملة جديدة</p>
                    </div>
                `;
                return;
            }
            
            let transactionsHTML = `
                <div class="transactions-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>نوع المعاملة</th>
                                <th>رقم المستند</th>
                                <th>الاسم</th>
                                <th>الشركة</th>
                                <th>المبلغ</th>
                                <th>التاريخ</th>
                                <th>التفاصيل</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredItems.forEach((item, index) => {
                let typeText = '';
                let badgeClass = '';
                
                switch(item.type) {
                    case 'ticket':
                        typeText = 'تذكرة';
                        badgeClass = 'badge-ticket';
                        break;
                    case 'fine':
                        typeText = 'غرامة';
                        badgeClass = 'badge-fine';
                        break;
                    case 'delivery':
                        typeText = 'تسليم';
                        badgeClass = 'badge-delivery';
                        break;
                }
                
                transactionsHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="transaction-type-badge ${badgeClass}">${typeText}</span></td>
                        <td>${item.documentNo}</td>
                        <td>${item.name}</td>
                        <td>${item.company}</td>
                        <td class="${item.amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatDecimal(item.amount)}</td>
                        <td>${formatGregorianDate(item.date)}</td>
                        <td>${item.details}</td>
                        <td>
                            <button onclick="openEditModal('${item.type === 'ticket' ? 'transaction' : item.type === 'fine' ? 'fine' : 'delivery'}', ${item.id})" 
                                    class="btn btn-warning" style="padding: 5px 10px; font-size: 0.9rem; margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="requestDelete('${item.type === 'ticket' ? 'transaction' : item.type === 'fine' ? 'fine' : 'delivery'}', ${item.id})" 
                                    class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            transactionsHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: center; color: var(--text-light); font-size: 0.9rem;">
                        إجمالي النتائج: ${filteredItems.length} معاملة
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = transactionsHTML;
        }

        // تحديث قائمة المعاملات
        function refreshTransactionsList() {
            displayTransactionsList();
        }

        // تحويل النص إلى رقم مع السماح بثلاث منازل عشرية
        function parseDecimal(value) {
            if (!value) return 0;
            // إزالة أي فواصل آلاف
            value = value.replace(/,/g, '');
            // تحقق من صيغة الرقم
            if (!/^\d+(\.\d{1,3})?$/.test(value)) {
                throw new Error('الرجاء إدخال رقم صحيح أو عشري بحد أقصى 3 منازل عشرية');
            }
            return parseFloat(value);
        }

        // تنسيق الرقم بثلاث منازل عشرية
        function formatDecimal(number) {
            return number.toFixed(3).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // تحويل التاريخ إلى تنسيق مسيحي (YYYY-MM-DD)
        function formatGregorianDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
        }

        // الحصول على اسم المدينة الكامل من الاختصار
        function getCityName(code) {
            const cities = {
                'TRP': 'طرابلس',
                'IST': 'اسطنبول'
            };
            return cities[code] || code;
        }

        // إنشاء كشف الحساب للعرض
        function generateStatement(companyId) {
            const company = isamData.companies.find(c => c.id == companyId);
            if (!company) return;
            
            // تحديث الـ select ليعرض الشركة المحددة
            document.getElementById('statementCompany').value = companyId;
            
            // جمع جميع المعاملات
            const companyTransactions = isamData.transactions.filter(t => t.companyId == companyId);
            const companyFines = isamData.fines.filter(f => f.companyId == companyId);
            const companyDeliveries = isamData.deliveries.filter(d => d.companyId == companyId);
            
            // دمج جميع المعاملات في مصفوفة واحدة
            let allItems = [];
            
            // إضافة التذاكر
            companyTransactions.forEach(trans => {
                allItems.push({
                    id: trans.id,
                    type: 'ticket',
                    date: trans.date,
                    documentNo: trans.documentNo,
                    passenger: trans.passenger,
                    destination: trans.destination,
                    amount: trans.amount,
                    amountFormatted: formatDecimal(trans.amount)
                });
            });
            
            // إضافة الغرامات
            companyFines.forEach(fine => {
                allItems.push({
                    id: fine.id,
                    type: 'fine',
                    date: fine.date,
                    documentNo: fine.documentNo || '--',
                    passenger: fine.person,
                    destination: fine.reason,
                    amount: fine.amount,
                    amountFormatted: formatDecimal(fine.amount)
                });
            });
            
            // إضافة التسليمات
            companyDeliveries.forEach(delivery => {
                allItems.push({
                    id: delivery.id,
                    type: 'delivery',
                    date: delivery.date,
                    documentNo: '--',
                    passenger: delivery.deliveredTo,
                    destination: delivery.notes || '--',
                    amount: delivery.amount,
                    amountFormatted: formatDecimal(delivery.amount)
                });
            });
            
            // ترتيب حسب التاريخ (من الأحدث إلى الأقدم)
            allItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // حساب الإجماليات
            const totalTickets = companyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalFines = companyFines.reduce((sum, f) => sum + f.amount, 0);
            const totalDeliveries = companyDeliveries.reduce((sum, d) => sum + d.amount, 0);
            
            // حساب إجمالي الدائن والمعين
            let totalDebit = totalTickets + totalFines;
            let totalCredit = totalDeliveries;
            
            // حساب الرصيد التراكمي
            let runningBalance = parseDecimal(company.initialBalance || '0');
            if (company.type === 'دائن') {
                runningBalance = totalCredit - totalDebit;
            } else {
                runningBalance = totalDebit - totalCredit;
            }
            
            // إنشاء HTML لكشف الحساب
            let statementHTML = `
                <div class="account-statement" id="printableStatement">
                    <div class="statement-header">
                        <h3>كشف حساب - ${company.name}</h3>
                        <p>نظام ISAM لحجز التذاكر</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">الشركة:</div>
                            <div style="font-weight: bold;">${company.name}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">نوع الحساب:</div>
                            <div style="font-weight: bold;">${company.type}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">التاريخ:</div>
                            <div style="font-weight: bold;">${formatGregorianDate(new Date().toISOString())}</div>
                        </div>
                    </div>
                    
                    <div class="statement-wrapper">
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>الرصيد</th>
                                    <th>معين</th>
                                    <th>دائن</th>
                                    <th>المسار</th>
                                    <th>رقم المستند</th>
                                    <th>الحالة</th>
                                    <th>البيان</th>
                                    <th>التاريخ</th>
                                    <th>الخدمة</th>
                                    <th>#</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // إضافة سطر الرصيد الافتتاحي
            let openingBalance = parseDecimal(company.initialBalance || '0');
            if (company.type === 'دائن') {
                openingBalance = -openingBalance;
            }
            
            statementHTML += `
                <tr>
                    <td class="balance-cell ${openingBalance >= 0 ? 'balance-positive' : 'balance-negative'}">${formatDecimal(openingBalance)}</td>
                    <td class="debit-cell">${company.type === 'مدين' ? formatDecimal(Math.abs(openingBalance)) : '0.000'}</td>
                    <td class="credit-cell">${company.type === 'دائن' ? formatDecimal(Math.abs(openingBalance)) : '0.000'}</td>
                    <td>1488</td>
                    <td>NW</td>
                    <td>NW</td>
                    <td>${company.name}</td>
                    <td>${formatGregorianDate(company.date)}</td>
                    <td>ايصال قبض</td>
                    <td>1</td>
                </tr>
            `;
            
            // تحديث الرصيد التراكمي
            let cumulativeBalance = openingBalance;
            
            // إضافة جميع المعاملات
            allItems.forEach((item, index) => {
                // تحديد القيم بناءً على نوع المعاملة
                let debit = 0;
                let credit = 0;
                let path = '';
                let service = '';
                
                if (item.type === 'ticket' || item.type === 'fine') {
                    debit = item.amount;
                    path = item.destination === 'IST' ? 'IST/MJI' : 'MJI/JST';
                    service = item.type === 'ticket' ? 'تذكرة' : 'غرامة';
                } else if (item.type === 'delivery') {
                    credit = item.amount;
                    path = '';
                    service = 'تسليم';
                }
                
                // تحديث الرصيد التراكمي
                if (credit > 0) {
                    cumulativeBalance += credit; // دائن يزيد الرصيد
                } else {
                    cumulativeBalance -= debit; // معين ينقص الرصيد
                }
                
                // تحديد لون الرصيد
                const balanceClass = cumulativeBalance >= 0 ? 'balance-positive' : 'balance-negative';
                
                statementHTML += `
                    <tr>
                        <td class="balance-cell ${balanceClass}">${formatDecimal(cumulativeBalance)}</td>
                        <td class="debit-cell">${debit > 0 ? formatDecimal(debit) : '0.000'}</td>
                        <td class="credit-cell">${credit > 0 ? formatDecimal(credit) : '0.000'}</td>
                        <td>${path}</td>
                        <td>${item.documentNo}</td>
                        <td>NW</td>
                        <td>${item.passenger}</td>
                        <td>${formatGregorianDate(item.date)}</td>
                        <td>${service}</td>
                        <td>${index + 2}</td>
                    </tr>
                `;
            });
            
            // حساب الرصيد النهائي
            const finalBalance = cumulativeBalance;
            
            statementHTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="statement-summary">
                        <div class="summary-title">أجمالي التقرير بالعملة LYD</div>
                        <table class="summary-table">
                            <tr>
                                <td>الدائن</td>
                                <td>${formatDecimal(totalCredit)} LYD</td>
                            </tr>
                            <tr>
                                <td>المعين</td>
                                <td>${formatDecimal(totalDebit)} LYD</td>
                            </tr>
                            <tr>
                                <td>الرصيد</td>
                                <td>${formatDecimal(finalBalance)} LYD</td>
                            </tr>
                            <tr>
                                <td>الرصيد السابق</td>
                                <td>${formatDecimal(openingBalance)} LYD</td>
                            </tr>
                            <tr>
                                <td>اجمال الرصيد</td>
                                <td>${formatDecimal(finalBalance)} LYD</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="final-balance">
                        <div class="final-label">الرصيد النهائي</div>
                        <div class="final-value">${formatDecimal(finalBalance)} LYD</div>
                        <div style="margin-top: 5px; font-size: 14px;">
                            ${finalBalance < 0 ? 'مدين' : 'دائن'}
                        </div>
                    </div>
                    
                    <div class="statement-footer">
                        <p>تم إنشاء هذا الكشف آلياً بواسطة نظام ISAM لحجز التذاكر</p>
                        <p>${formatGregorianDate(new Date().toISOString())} - جميع الحقوق محفوظة</p>
                    </div>
                    
                    <div class="statement-actions">
                        <button onclick="printStatement(${companyId})" class="btn btn-info">
                            <i class="fas fa-print"></i> طباعة الكشف
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('statementContent').innerHTML = statementHTML;
        }

        // طباعة كشف الحساب - بنفس الشكل تماماً
        function printStatement(companyId) {
            if (!companyId) {
                companyId = document.getElementById('statementCompany').value;
            }
            
            if (!companyId) {
                alert('يرجى اختيار شركة أولاً');
                return;
            }
            
            const company = isamData.companies.find(c => c.id == companyId);
            if (!company) return;
            
            // جمع جميع المعاملات
            const companyTransactions = isamData.transactions.filter(t => t.companyId == companyId);
            const companyFines = isamData.fines.filter(f => f.companyId == companyId);
            const companyDeliveries = isamData.deliveries.filter(d => d.companyId == companyId);
            
            // دمج جميع المعاملات في مصفوفة واحدة
            let allItems = [];
            
            // إضافة التذاكر
            companyTransactions.forEach(trans => {
                allItems.push({
                    id: trans.id,
                    type: 'ticket',
                    date: trans.date,
                    documentNo: trans.documentNo,
                    passenger: trans.passenger,
                    destination: trans.destination,
                    amount: trans.amount
                });
            });
            
            // إضافة الغرامات
            companyFines.forEach(fine => {
                allItems.push({
                    id: fine.id,
                    type: 'fine',
                    date: fine.date,
                    documentNo: fine.documentNo || '',
                    passenger: fine.person,
                    destination: fine.reason,
                    amount: fine.amount
                });
            });
            
            // إضافة التسليمات
            companyDeliveries.forEach(delivery => {
                allItems.push({
                    id: delivery.id,
                    type: 'delivery',
                    date: delivery.date,
                    documentNo: '',
                    passenger: delivery.deliveredTo,
                    destination: delivery.notes || '',
                    amount: delivery.amount
                });
            });
            
            // ترتيب حسب التاريخ (من الأحدث إلى الأقدم)
            allItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // حساب الإجماليات
            const totalTickets = companyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalFines = companyFines.reduce((sum, f) => sum + f.amount, 0);
            const totalDeliveries = companyDeliveries.reduce((sum, d) => sum + d.amount, 0);
            
            // حساب إجمالي الدائن والمعين
            let totalDebit = totalTickets + totalFines;
            let totalCredit = totalDeliveries;
            
            // حساب الرصيد التراكمي
            let runningBalance = parseDecimal(company.initialBalance || '0');
            if (company.type === 'دائن') {
                runningBalance = totalCredit - totalDebit;
            } else {
                runningBalance = totalDebit - totalCredit;
            }
            
            // إنشاء HTML للطباعة بنفس الشكل
            let printHTML = `
                <div class="print-statement" id="printableStatement">
                    <div class="print-header">
                        <h1>كشف حساب - ${company.name}</h1>
                        <h2>نظام ISAM لحجز التذاكر</h2>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">الشركة:</div>
                            <div style="font-weight: bold;">${company.name}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">نوع الحساب:</div>
                            <div style="font-weight: bold;">${company.type}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">التاريخ:</div>
                            <div style="font-weight: bold;">${formatGregorianDate(new Date().toISOString())}</div>
                        </div>
                    </div>
                    
                    <table class="print-table">
                        <tr>
                            <th>الرصيد</th>
                            <th>معين</th>
                            <th>دائن</th>
                            <th>المسار</th>
                            <th>رقم المستند</th>
                            <th>الحالة</th>
                            <th>البيان</th>
                            <th>التاريخ</th>
                            <th>الخدمة</th>
                            <th>#</th>
                        </tr>
            `;
            
            // إضافة سطر الرصيد الافتتاحي
            let openingBalance = parseDecimal(company.initialBalance || '0');
            if (company.type === 'دائن') {
                openingBalance = -openingBalance;
            }
            
            printHTML += `
                <tr>
                    <td class="${openingBalance >= 0 ? 'print-balance-positive' : 'print-balance-negative'}">${formatDecimal(openingBalance)}</td>
                    <td class="print-debit">${company.type === 'مدين' ? formatDecimal(Math.abs(openingBalance)) : '0.000'}</td>
                    <td class="print-credit">${company.type === 'دائن' ? formatDecimal(Math.abs(openingBalance)) : '0.000'}</td>
                    <td>1488</td>
                    <td>NW</td>
                    <td>NW</td>
                    <td>${company.name}</td>
                    <td>${formatGregorianDate(company.date)}</td>
                    <td>ايصال قبض</td>
                    <td>1</td>
                </tr>
            `;
            
            // تحديث الرصيد التراكمي
            let cumulativeBalance = openingBalance;
            
            // إضافة جميع المعاملات
            allItems.forEach((item, index) => {
                // تحديد القيم بناءً على نوع المعاملة
                let debit = 0;
                let credit = 0;
                let path = '';
                let service = '';
                
                if (item.type === 'ticket' || item.type === 'fine') {
                    debit = item.amount;
                    path = item.destination === 'IST' ? 'IST/MJI' : 'MJI/JST';
                    service = item.type === 'ticket' ? 'تذكرة' : 'غرامة';
                } else if (item.type === 'delivery') {
                    credit = item.amount;
                    path = '';
                    service = 'تسليم';
                }
                
                // تحديث الرصيد التراكمي
                if (credit > 0) {
                    cumulativeBalance += credit;
                } else {
                    cumulativeBalance -= debit;
                }
                
                // تحديد لون الرصيد
                const balanceClass = cumulativeBalance >= 0 ? 'print-balance-positive' : 'print-balance-negative';
                
                printHTML += `
                    <tr>
                        <td class="${balanceClass}">${formatDecimal(cumulativeBalance)}</td>
                        <td class="print-debit">${debit > 0 ? formatDecimal(debit) : '0.000'}</td>
                        <td class="print-credit">${credit > 0 ? formatDecimal(credit) : '0.000'}</td>
                        <td>${path}</td>
                        <td>${item.documentNo}</td>
                        <td>NW</td>
                        <td>${item.passenger}</td>
                        <td>${formatGregorianDate(item.date)}</td>
                        <td>${service}</td>
                        <td>${index + 2}</td>
                    </tr>
                `;
            });
            
            // حساب الرصيد النهائي
            const finalBalance = cumulativeBalance;
            
            printHTML += `
                    </table>
                    
                    <div class="print-summary">
                        <div class="print-summary-title">أجمالي التقرير بالعملة LYD</div>
                        <table class="print-summary-table">
                            <tr>
                                <td>الدائن</td>
                                <td>${formatDecimal(totalCredit)} LYD</td>
                            </tr>
                            <tr>
                                <td>المعين</td>
                                <td>${formatDecimal(totalDebit)} LYD</td>
                            </tr>
                            <tr>
                                <td>الرصيد</td>
                                <td>${formatDecimal(finalBalance)} LYD</td>
                            </tr>
                            <tr>
                                <td>الرصيد السابق</td>
                                <td>${formatDecimal(openingBalance)} LYD</td>
                            </tr>
                            <tr>
                                <td>اجمال الرصيد</td>
                                <td>${formatDecimal(finalBalance)} LYD</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="print-total-balance">
                        <div class="print-total-label">الرصيد النهائي</div>
                        <div class="print-total-value">${formatDecimal(finalBalance)} LYD</div>
                        <div style="margin-top: 5px; font-size: 11px;">
                            ${finalBalance < 0 ? 'مدين' : 'دائن'}
                        </div>
                    </div>
                    
                    <div class="print-footer">
                        <p>تم إنشاء هذا الكشف آلياً بواسطة نظام ISAM لحجز التذاكر</p>
                        <p>${formatGregorianDate(new Date().toISOString())} - جميع الحقوق محفوظة</p>
                    </div>
                </div>
            `;
            
            // فتح نافذة جديدة للطباعة
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>كشف حساب - ${company.name}</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #333;
                            direction: rtl;
                            background: white;
                        }
                        
                        .print-statement {
                            width: 100%;
                        }
                        
                        .print-header {
                            text-align: center;
                            margin-bottom: 20px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #333;
                        }
                        
                        .print-header h1 {
                            font-size: 20px;
                            color: #2c3e50;
                            margin-bottom: 5px;
                        }
                        
                        .print-header h2 {
                            font-size: 16px;
                            color: #666;
                            font-weight: normal;
                        }
                        
                        .print-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            font-size: 10px;
                            page-break-inside: auto;
                            border: 1px solid #ddd;
                        }
                        
                        .print-table th {
                            background-color: #f5f5f5 !important;
                            color: black !important;
                            font-weight: bold;
                            padding: 6px 4px;
                            border: 1px solid #ddd;
                            text-align: center;
                            font-size: 10px;
                        }
                        
                        .print-table td {
                            padding: 5px 4px;
                            border: 1px solid #ddd;
                            text-align: center;
                            page-break-inside: avoid;
                            word-wrap: break-word;
                            max-width: 120px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                        
                        .print-table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        
                        .print-balance-positive {
                            color: #27ae60;
                            font-weight: bold;
                        }
                        
                        .print-balance-negative {
                            color: #e74c3c;
                            font-weight: bold;
                        }
                        
                        .print-debit {
                            color: #e74c3c;
                            font-weight: bold;
                        }
                        
                        .print-credit {
                            color: #27ae60;
                            font-weight: bold;
                        }
                        
                        .print-summary {
                            margin-top: 20px;
                            padding: 10px;
                            background: #f8f9fa;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            page-break-inside: avoid;
                            font-size: 11px;
                        }
                        
                        .print-summary-title {
                            text-align: center;
                            font-size: 12px;
                            font-weight: bold;
                            color: #2c3e50;
                            margin-bottom: 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .print-summary-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 10px 0;
                        }
                        
                        .print-summary-table td {
                            padding: 6px 8px;
                            border: 1px solid #ddd;
                            text-align: right;
                        }
                        
                        .print-summary-table td:first-child {
                            font-weight: bold;
                            text-align: left;
                            width: 120px;
                        }
                        
                        .print-total-balance {
                            margin-top: 15px;
                            padding: 10px;
                            background: #2c3e50;
                            color: white;
                            border-radius: 5px;
                            text-align: center;
                            font-size: 12px;
                            page-break-inside: avoid;
                        }
                        
                        .print-total-label {
                            font-size: 11px;
                            margin-bottom: 5px;
                        }
                        
                        .print-total-value {
                            font-size: 16px;
                            font-weight: bold;
                        }
                        
                        .print-footer {
                            text-align: center;
                            margin-top: 15px;
                            padding-top: 8px;
                            border-top: 1px solid #ddd;
                            color: #666;
                            font-size: 9px;
                            page-break-inside: avoid;
                        }
                        
                        @media print {
                            @page {
                                size: landscape;
                                margin: 5mm;
                            }
                            
                            body {
                                margin: 0;
                                padding: 10mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 100);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // فتح نموذج التعديل
        function openEditModal(type, id) {
            editType = type;
            editId = id;
            
            let item = null;
            let title = '';
            
            switch(type) {
                case 'transaction':
                    item = isamData.transactions.find(t => t.id === id);
                    title = 'تعديل التذكرة';
                    break;
                case 'fine':
                    item = isamData.fines.find(f => f.id === id);
                    title = 'تعديل الغرامة';
                    break;
                case 'delivery':
                    item = isamData.deliveries.find(d => d.id === id);
                    title = 'تعديل التسليم';
                    break;
            }
            
            if (!item) return;
            
            document.getElementById('editModalTitle').textContent = title;
            document.getElementById('editDocumentNo').value = item.documentNo || '';
            
            if (type === 'transaction') {
                document.getElementById('editName').value = item.passenger;
                document.getElementById('editInfo').value = item.destination;
            } else if (type === 'fine') {
                document.getElementById('editName').value = item.person;
                document.getElementById('editInfo').value = item.reason;
            } else {
                document.getElementById('editName').value = item.deliveredTo;
                document.getElementById('editInfo').value = item.notes || '';
            }
            
            document.getElementById('editAmount').value = formatDecimal(item.amount);
            
            document.getElementById('editModal').classList.add('active');
        }

        // حفظ التعديلات
        function saveEdit() {
            if (!editType || !editId) return;
            
            const documentNo = document.getElementById('editDocumentNo').value;
            const name = document.getElementById('editName').value;
            const info = document.getElementById('editInfo').value;
            let amount;
            
            try {
                amount = parseDecimal(document.getElementById('editAmount').value);
            } catch (error) {
                alert(error.message);
                return;
            }
            
            if (!name || isNaN(amount) || amount <= 0) {
                alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            let item = null;
            let companyId = null;
            let oldAmount = 0;
            
            switch(editType) {
                case 'transaction':
                    item = isamData.transactions.find(t => t.id === editId);
                    if (item) {
                        companyId = item.companyId;
                        oldAmount = item.amount;
                        item.documentNo = documentNo;
                        item.passenger = name;
                        item.destination = info;
                        item.amount = amount;
                    }
                    break;
                case 'fine':
                    item = isamData.fines.find(f => f.id === editId);
                    if (item) {
                        companyId = item.companyId;
                        oldAmount = item.amount;
                        item.documentNo = documentNo;
                        item.person = name;
                        item.reason = info;
                        item.amount = amount;
                    }
                    break;
                case 'delivery':
                    item = isamData.deliveries.find(d => d.id === editId);
                    if (item) {
                        companyId = item.companyId;
                        oldAmount = item.amount;
                        item.deliveredTo = name;
                        item.notes = info;
                        item.amount = amount;
                    }
                    break;
            }
            
            if (!item || !companyId) {
                alert('حدث خطأ في العثور على المعاملة');
                return;
            }
            
            // تحديث رصيد الشركة
            const company = isamData.companies.find(c => c.id === companyId);
            if (company) {
                // إرجاع التأثير القديم
                if (editType === 'transaction' || editType === 'fine') {
                    if (company.type === 'دائن') {
                        company.balance -= oldAmount;
                        company.balance += amount;
                    } else {
                        company.balance += oldAmount;
                        company.balance -= amount;
                    }
                } else if (editType === 'delivery') {
                    company.balance += oldAmount;
                    company.balance -= amount;
                }
            }
            
            saveData();
            
            // تحديث عرض كشف الحساب
            const currentCompanyId = document.getElementById('statementCompany').value;
            if (currentCompanyId && currentCompanyId == companyId) {
                generateStatement(currentCompanyId);
            }
            
            closeEditModal();
            alert('تم تعديل المعاملة بنجاح!');
        }

        // إغلاق نموذج التعديل
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editType = '';
            editId = null;
        }

        // طلب حذف
        function requestDelete(type, id) {
            deleteType = type;
            deleteId = id;
            
            let message = '';
            switch(type) {
                case 'company':
                    message = 'هل أنت متأكد من حذف هذه الشركة؟ سيتم حذف جميع التذاكر والغرامات والتسليمات المرتبطة بها.';
                    break;
                case 'transaction':
                    message = 'هل أنت متأكد من حذف هذه التذكرة؟';
                    break;
                case 'fine':
                    message = 'هل أنت متأكد من حذف هذه الغرامة؟';
                    break;
                case 'delivery':
                    message = 'هل أنت متأكد من حذف عملية التسليم هذه؟';
                    break;
            }
            
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteConfirmation').classList.add('active');
        }

        // تأكيد الحذف
        function confirmDelete() {
            let companyId = null;
            
            switch(deleteType) {
                case 'company':
                    // حذف الشركة
                    isamData.companies = isamData.companies.filter(c => c.id !== deleteId);
                    // حذف جميع معاملات الشركة
                    isamData.transactions = isamData.transactions.filter(t => t.companyId !== deleteId);
                    isamData.fines = isamData.fines.filter(f => f.companyId !== deleteId);
                    isamData.deliveries = isamData.deliveries.filter(d => d.companyId !== deleteId);
                    break;
                    
                case 'transaction':
                    const trans = isamData.transactions.find(t => t.id === deleteId);
                    if (trans) {
                        companyId = trans.companyId;
                        // تحديث رصيد الشركة
                        const company = isamData.companies.find(c => c.id === trans.companyId);
                        if (company) {
                            if (company.type === 'دائن') {
                                company.balance -= trans.amount;
                            } else {
                                company.balance += trans.amount;
                            }
                        }
                        // حذف التذكرة
                        isamData.transactions = isamData.transactions.filter(t => t.id !== deleteId);
                    }
                    break;
                    
                case 'fine':
                    const fine = isamData.fines.find(f => f.id === deleteId);
                    if (fine) {
                        companyId = fine.companyId;
                        // تحديث رصيد الشركة
                        const company = isamData.companies.find(c => c.id === fine.companyId);
                        if (company) {
                            if (company.type === 'دائن') {
                                company.balance -= fine.amount;
                            } else {
                                company.balance += fine.amount;
                            }
                        }
                        // حذف الغرامة
                        isamData.fines = isamData.fines.filter(f => f.id !== deleteId);
                    }
                    break;
                    
                case 'delivery':
                    const delivery = isamData.deliveries.find(d => d.id === deleteId);
                    if (delivery) {
                        companyId = delivery.companyId;
                        // تحديث رصيد الشركة
                        const company = isamData.companies.find(c => c.id === delivery.companyId);
                        if (company) {
                            company.balance += delivery.amount;
                        }
                        // حذف التسليم
                        isamData.deliveries = isamData.deliveries.filter(d => d.id !== deleteId);
                    }
                    break;
            }
            
            saveData();
            closeDeleteModal();
            alert('تم الحذف بنجاح');
            
            // تحديث عرض كشف الحساب إذا كان مفتوحاً
            const currentCompanyId = document.getElementById('statementCompany').value;
            if (currentCompanyId && companyId && currentCompanyId == companyId) {
                generateStatement(currentCompanyId);
            }
        }

        // إغلاق نموذج الحذف
        function closeDeleteModal() {
            document.getElementById('deleteConfirmation').classList.remove('active');
            deleteType = '';
            deleteId = null;
        }

        // عرض القسم المحدد
        function showSection(sectionId) {
            // إخفاء رسالة الترحيب
            document.getElementById('welcomeMessage').style.display = 'none';
            
            // إظهار الواجهة الرئيسية إذا كانت هناك شركات
            if (isamData.companies.length > 0) {
                document.getElementById('mainMenu').style.display = 'flex';
            }
            
            // تحديث الأزرار النشطة
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-section') === sectionId) {
                    btn.classList.add('active');
                }
            });
            
            // إخفاء جميع الأقسام
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // إظهار القسم المحدد
            document.getElementById(sectionId).classList.add('active');
            
            // تحديث المحتوى حسب القسم
            if (sectionId === 'statement') {
                updateCompaniesSelect();
                const companyId = document.getElementById('statementCompany').value;
                if (companyId) {
                    generateStatement(companyId);
                }
            } else if (sectionId === 'companiesList') {
                displayCompaniesList();
            } else if (sectionId === 'transactionsList') {
                displayTransactionsList();
            }
        }

        // تهيئة التاريخ
        function initializeDate() {
            const now = new Date();
            document.getElementById('currentYear').textContent = now.getFullYear();
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeDate();
            loadData();
            
            // أحداث نموذج الحذف
            document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
            document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
            
            // أحداث نموذج التعديل
            document.getElementById('editForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEdit();
            });
            
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            
            // حدث select كشف الحساب
            document.getElementById('statementCompany').addEventListener('change', function() {
                if (this.value) {
                    generateStatement(this.value);
                }
            });
            
            // زر طباعة الكشف
            document.getElementById('printStatementBtn').addEventListener('click', function() {
                printStatement();
            });
            
            // أحداث البحث في المعاملات
            document.getElementById('searchTransactions')?.addEventListener('input', function() {
                displayTransactionsList();
            });
            
            document.getElementById('filterType')?.addEventListener('change', function() {
                displayTransactionsList();
            });
            
            document.getElementById('filterCompany')?.addEventListener('change', function() {
                displayTransactionsList();
            });
            
            document.getElementById('filterDate')?.addEventListener('change', function() {
                displayTransactionsList();
            });
            
            // أحداث القائمة الرئيسية
            document.querySelectorAll('.menu-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });
            
            // نموذج إضافة الشركة
            document.getElementById('companyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyName = document.getElementById('companyName').value;
                const companyType = document.getElementById('companyType').value;
                let initialBalance;
                
                try {
                    initialBalance = parseDecimal(document.getElementById('initialBalance').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                if (!companyName || !companyType || isNaN(initialBalance)) {
                    alert('يرجى ملء جميع الحقول المطلوبة');
                    return;
                }
                
                // حساب الرصيد بناءً على نوع الحساب
                const balance = companyType === 'دائن' ? initialBalance : -initialBalance;
                
                // إضافة شركة جديدة
                const newId = isamData.companies.length > 0 
                    ? Math.max(...isamData.companies.map(c => c.id)) + 1 
                    : 1;
                
                const newCompany = {
                    id: newId,
                    name: companyName,
                    type: companyType,
                    balance: balance,
                    initialBalance: initialBalance,
                    date: new Date().toISOString()
                };
                
                isamData.companies.push(newCompany);
                saveData();
                
                alert('تم إضافة الشركة بنجاح!');
                this.reset();
                showSection('companiesList');
            });
            
            // نموذج إضافة تذكرة
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyId = parseInt(document.getElementById('transactionCompany').value);
                const documentNo = document.getElementById('documentNo').value;
                const passengerName = document.getElementById('passengerName').value;
                const destination = document.getElementById('destination').value;
                let amount;
                
                try {
                    amount = parseDecimal(document.getElementById('ticketAmount').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                if (!companyId || !documentNo || !passengerName || !destination || isNaN(amount) || amount <= 0) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }
                
                // إنشاء معرف فريد للمعاملة
                const newId = isamData.transactions.length > 0 
                    ? Math.max(...isamData.transactions.map(t => t.id)) + 1 
                    : 1;
                
                // إضافة المعاملة
                const newTransaction = {
                    id: newId,
                    companyId: companyId,
                    documentNo: documentNo,
                    passenger: passengerName,
                    destination: destination,
                    amount: amount,
                    date: new Date().toISOString()
                };
                
                isamData.transactions.push(newTransaction);
                
                // تحديث رصيد الشركة
                const company = isamData.companies.find(c => c.id === companyId);
                if (company) {
                    if (company.type === 'دائن') {
                        company.balance += amount;
                    } else {
                        company.balance -= amount;
                    }
                }
                
                saveData();
                
                alert('تم إضافة التذكرة بنجاح!');
                this.reset();
            });
            
            // نموذج إضافة غرامة
            document.getElementById('fineForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyId = parseInt(document.getElementById('fineCompany').value);
                const personName = document.getElementById('finePerson').value;
                let amount;
                
                try {
                    amount = parseDecimal(document.getElementById('fineAmount').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                const reason = document.getElementById('fineReason').value;
                const documentNo = document.getElementById('fineDocument').value;
                
                if (!companyId || !personName || !reason || isNaN(amount) || amount <= 0) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }
                
                // إنشاء معرف فريد للغرامة
                const newId = isamData.fines.length > 0 
                    ? Math.max(...isamData.fines.map(f => f.id)) + 1 
                    : 1;
                
                // إضافة الغرامة
                const newFine = {
                    id: newId,
                    companyId: companyId,
                    person: personName,
                    amount: amount,
                    reason: reason,
                    documentNo: documentNo || `FINE-${newId.toString().padStart(3, '0')}`,
                    date: new Date().toISOString()
                };
                
                isamData.fines.push(newFine);
                
                // تحديث رصيد الشركة
                const company = isamData.companies.find(c => c.id === companyId);
                if (company) {
                    if (company.type === 'دائن') {
                        company.balance += amount;
                    } else {
                        company.balance -= amount;
                    }
                }
                
                saveData();
                
                alert('تم إضافة الغرامة بنجاح!');
                this.reset();
            });
            
            // نموذج إضافة تسليم مبلغ
            document.getElementById('deliveryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyId = parseInt(document.getElementById('deliveryCompany').value);
                let amount;
                
                try {
                    amount = parseDecimal(document.getElementById('deliveryAmount').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                const deliveredTo = document.getElementById('deliveredTo').value;
                const notes = document.getElementById('deliveryNotes').value;
                
                if (!companyId || !deliveredTo || isNaN(amount) || amount <= 0) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }
                
                // إنشاء معرف فريد للتسليم
                const newId = isamData.deliveries.length > 0 
                    ? Math.max(...isamData.deliveries.map(d => d.id)) + 1 
                    : 1;
                
                // إضافة التسليم
                const newDelivery = {
                    id: newId,
                    companyId: companyId,
                    amount: amount,
                    deliveredTo: deliveredTo,
                    notes: notes,
                    date: new Date().toISOString()
                };
                
                isamData.deliveries.push(newDelivery);
                
                // تحديث رصيد الشركة
                const company = isamData.companies.find(c => c.id === companyId);
                if (company) {
                    company.balance -= amount;
                }
                
                saveData();
                
                alert('تم تسجيل التسليم بنجاح!');
                this.reset();
            });
            
            console.log("نظام ISAM لحجز التذاكر - جاهز للاستخدام");
        });
    </script>
</body>
</html>