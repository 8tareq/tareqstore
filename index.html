<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ISAM لحجز التذاكر</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #9b59b6;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #333;
            --text-light: #7f8c8d;
            --border: #bdc3c7;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* رأس الصفحة */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 25px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.2rem;
            color: #f1c40f;
        }
        
        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .logo span {
            color: #f1c40f;
        }
        
        /* القائمة الرئيسية */
        .main-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .menu-btn {
            background: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s;
            min-width: 200px;
            justify-content: center;
        }
        
        .menu-btn:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-3px);
        }
        
        .menu-btn i {
            font-size: 1.3rem;
        }
        
        /* أشكال المحتوى */
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
            display: none;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .section-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header h2 i {
            color: var(--secondary);
        }
        
        /* أشكال الإدخال */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--secondary), var(--info));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), #2ecc71);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(46, 204, 113, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning), #f1c40f);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(241, 196, 15, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(231, 76, 60, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(to right, #17a2b8, #1abc9c);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(23, 162, 184, 0.3);
        }
        
        /* كشف الحساب - التصميم الجديد */
        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .transaction-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            border-right: 5px solid;
        }
        
        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }
        
        .transaction-item.ticket {
            border-right-color: var(--success);
        }
        
        .transaction-item.fine {
            border-right-color: var(--warning);
        }
        
        .transaction-item.delivery {
            border-right-color: var(--info);
        }
        
        .transaction-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .transaction-icon.ticket {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }
        
        .transaction-icon.fine {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        
        .transaction-icon.delivery {
            background-color: rgba(155, 89, 182, 0.15);
            color: var(--info);
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .transaction-type {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .transaction-type.ticket {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }
        
        .transaction-type.fine {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        
        .transaction-type.delivery {
            background-color: rgba(155, 89, 182, 0.15);
            color: var(--info);
        }
        
        .transaction-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .transaction-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            color: var(--text);
        }
        
        .transaction-amount {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: left;
            min-width: 120px;
        }
        
        .transaction-amount.ticket {
            color: var(--success);
        }
        
        .transaction-amount.fine {
            color: var(--warning);
        }
        
        .transaction-amount.delivery {
            color: var(--info);
        }
        
        .transaction-actions {
            display: flex;
            gap: 10px;
        }
        
        /* نماذج تأكيد الحذف */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .confirmation-modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .confirmation-modal h3 {
            color: var(--danger);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .confirmation-modal p {
            margin-bottom: 25px;
            color: var(--text);
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* تذييل الصفحة */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* تنسيقات الطباعة */
        .print-container {
            display: none;
        }
        
        @media print {
            body * {
                display: none !important;
                visibility: hidden !important;
            }
            
            body {
                background: white !important;
                margin: 0 !important;
                padding: 10mm 5mm !important;
                font-family: 'Arial', 'sans-serif' !important;
                direction: rtl !important;
                color: black !important;
                font-size: 12px !important;
            }
            
            /* حاوية الطباعة */
            .print-container, 
            .print-container * {
                display: block !important;
                visibility: visible !important;
                position: relative !important;
                width: 100% !important;
                max-width: 100% !important;
                overflow: visible !important;
                font-family: 'Arial', 'sans-serif' !important;
            }
            
            .print-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                padding: 0;
                background: white;
                color: black;
            }
            
            /* ترويسة الشركة */
            .company-header {
                text-align: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #333;
            }
            
            .company-header h1 {
                color: #2c3e50;
                font-size: 22px;
                margin: 0 0 5px 0;
                font-weight: bold;
            }
            
            .company-header h2 {
                color: #3498db;
                font-size: 16px;
                margin: 0;
                font-weight: normal;
            }
            
            /* جدول المعاملات - نفس تصميم الصورة */
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
                font-size: 10px;
                page-break-inside: auto;
                border: 1px solid #ddd;
            }
            
            .print-table th {
                background-color: #f5f5f5 !important;
                color: black !important;
                font-weight: bold;
                padding: 8px 5px;
                border: 1px solid #ddd;
                text-align: center;
                font-size: 10px;
            }
            
            .print-table td {
                padding: 6px 4px;
                border: 1px solid #ddd;
                text-align: center;
                page-break-inside: avoid;
                word-wrap: break-word;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* تنسيق الأعمدة */
            .print-table th:nth-child(1),
            .print-table td:nth-child(1) {
                width: 40px; /* # */
            }
            
            .print-table th:nth-child(2),
            .print-table td:nth-child(2) {
                width: 80px; /* التاريخ */
            }
            
            .print-table th:nth-child(3),
            .print-table td:nth-child(3) {
                width: 60px; /* الخدمة */
            }
            
            .print-table th:nth-child(4),
            .print-table td:nth-child(4) {
                width: 110px; /* رقم المستند */
            }
            
            .print-table th:nth-child(5),
            .print-table td:nth-child(5) {
                width: 100px; /* الحالة */
            }
            
            .print-table th:nth-child(6),
            .print-table td:nth-child(6) {
                width: 140px; /* البيان */
            }
            
            .print-table th:nth-child(7),
            .print-table td:nth-child(7) {
                width: 80px; /* المسار */
            }
            
            .print-table th:nth-child(8),
            .print-table td:nth-child(8) {
                width: 70px; /* دائن */
            }
            
            .print-table th:nth-child(9),
            .print-table td:nth-child(9) {
                width: 70px; /* معين */
            }
            
            .print-table th:nth-child(10),
            .print-table td:nth-child(10) {
                width: 100px; /* الرصيد */
            }
            
            .print-table tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            /* تنسيق الأرقام */
            .amount-negative {
                color: #e74c3c;
                font-weight: bold;
            }
            
            .amount-positive {
                color: #27ae60;
                font-weight: bold;
            }
            
            .credit-amount {
                color: #27ae60;
                font-weight: bold;
            }
            
            .debit-amount {
                color: #e74c3c;
                font-weight: bold;
            }
            
            /* ملخص التقرير */
            .report-summary {
                margin-top: 20px;
                padding: 10px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 5px;
                page-break-inside: avoid;
                font-size: 11px;
            }
            
            .summary-title {
                text-align: center;
                font-size: 13px;
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px solid #ddd;
            }
            
            .summary-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            
            .summary-table td {
                padding: 8px 10px;
                border: 1px solid #ddd;
                text-align: right;
            }
            
            .summary-table td:first-child {
                font-weight: bold;
                text-align: left;
                width: 150px;
            }
            
            .total-balance {
                margin-top: 15px;
                padding: 12px;
                background: #2c3e50;
                color: white;
                border-radius: 5px;
                text-align: center;
                font-size: 13px;
                page-break-inside: avoid;
            }
            
            .total-label {
                font-size: 12px;
                margin-bottom: 5px;
            }
            
            .total-value {
                font-size: 18px;
                font-weight: bold;
            }
            
            /* تذييل الطباعة */
            .print-footer {
                text-align: center;
                margin-top: 20px;
                padding-top: 10px;
                border-top: 1px solid #ddd;
                color: #666;
                font-size: 9px;
                page-break-inside: avoid;
            }
            
            /* إخفاء العناصر غير المرغوب فيها */
            .transaction-actions,
            .btn,
            button,
            .menu-btn,
            footer,
            header,
            .section-header,
            .main-menu,
            .form-control,
            .form-select,
            .no-print {
                display: none !important;
            }
            
            /* إجبار اتجاه الطباعة أفقي */
            @page {
                size: landscape;
                margin: 5mm;
            }
            
            /* منع قطع الصفوف بين الصفحات */
            .print-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
        
        /* التجاوب مع الشاشات المختلفة */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .main-menu {
                flex-direction: column;
            }
            
            .menu-btn {
                min-width: 100%;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .transaction-amount {
                text-align: right;
                align-self: flex-end;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- نموذج تأكيد الحذف -->
    <div id="deleteConfirmation" class="modal-overlay">
        <div class="confirmation-modal">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger); margin-bottom: 15px;"></i>
            <h3>تأكيد الحذف</h3>
            <p id="deleteMessage">هل أنت متأكد من حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="modal-buttons">
                <button id="confirmDelete" class="btn btn-danger">نعم، احذف</button>
                <button id="cancelDelete" class="btn btn-primary">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج تعديل المعاملة -->
    <div id="editModal" class="modal-overlay">
        <div class="confirmation-modal" style="max-width: 600px;">
            <h3 id="editModalTitle">تعديل المعاملة</h3>
            <form id="editForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editDocumentNo">رقم المستند</label>
                        <input type="text" id="editDocumentNo" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editName">الاسم</label>
                        <input type="text" id="editName" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editInfo">المعلومات</label>
                        <input type="text" id="editInfo" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editAmount">المبلغ</label>
                        <input type="text" id="editAmount" class="form-control" 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                </div>
                
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">حفظ التعديلات</button>
                    <button type="button" id="cancelEdit" class="btn btn-primary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- حاوية الطباعة (مخفية) -->
    <div id="printContainer" class="print-container"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-plane-departure"></i>
                    <h1>نظام <span>ISAM</span> لحجز التذاكر</h1>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- رسالة الترحيب (تظهر فقط عند عدم وجود بيانات) -->
        <div id="welcomeMessage" style="text-align: center; padding: 50px 20px; background: white; border-radius: 15px; box-shadow: 0 5px 15px var(--shadow); margin-bottom: 30px;">
            <i class="fas fa-plane-departure" style="font-size: 4rem; color: var(--secondary); margin-bottom: 20px;"></i>
            <h2 style="color: var(--primary); margin-bottom: 15px;">مرحباً بك في نظام ISAM لحجز التذاكر</h2>
            <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.1rem; line-height: 1.6;">
                نظام متكامل لإدارة حجوزات التذاكر والعمليات المالية للشركات. 
                ابدأ بإضافة شركتك الأولى، ثم أضف التذاكر والعمليات الأخرى.
            </p>
            <button onclick="showSection('addCompany')" class="btn btn-success" style="font-size: 1.2rem; padding: 15px 30px;">
                <i class="fas fa-plus-circle"></i> إضافة شركتك الأولى
            </button>
        </div>
        
        <!-- القائمة الرئيسية (تظهر بعد إضافة الشركات) -->
        <div class="main-menu" id="mainMenu" style="display: none;">
            <button class="menu-btn active" data-section="addCompany">
                <i class="fas fa-building"></i> إضافة شركة
            </button>
            <button class="menu-btn" data-section="addTransaction">
                <i class="fas fa-ticket-alt"></i> إضافة تذكرة
            </button>
            <button class="menu-btn" data-section="addFine">
                <i class="fas fa-exclamation-triangle"></i> إضافة غرامة
            </button>
            <button class="menu-btn" data-section="addDelivery">
                <i class="fas fa-hand-holding-usd"></i> تسليم مبلغ
            </button>
            <button class="menu-btn" data-section="statement">
                <i class="fas fa-file-invoice-dollar"></i> كشف حساب
            </button>
            <button class="menu-btn" data-section="companiesList">
                <i class="fas fa-list"></i> قائمة الشركات
            </button>
        </div>
        
        <!-- إضافة شركة جديدة -->
        <div id="addCompany" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-building"></i> إضافة شركة جديدة</h2>
            </div>
            
            <form id="companyForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName">اسم الشركة *</label>
                        <input type="text" id="companyName" class="form-control" placeholder="أدخل اسم الشركة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="companyType">نوع الحساب *</label>
                        <select id="companyType" class="form-select" required>
                            <option value="">اختر نوع الحساب</option>
                            <option value="دائن">دائن (الشركة تبي مني)</option>
                            <option value="مدين">مدين (أنا أحتاج من الشركة)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="initialBalance">الرصيد الابتدائي *</label>
                        <input type="text" id="initialBalance" class="form-control" placeholder="أدخل الرصيد الابتدائي" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                        <small style="color: var(--text-light);">مثال: 1500.500 أو 1200</small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> حفظ الشركة
                </button>
            </form>
        </div>
        
        <!-- إضافة تذكرة -->
        <div id="addTransaction" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-ticket-alt"></i> إضافة تذكرة جديدة</h2>
            </div>
            
            <form id="transactionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="transactionCompany">الشركة *</label>
                        <select id="transactionCompany" class="form-select" required>
                            <option value="">اختر الشركة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="documentNo">رقم المستند *</label>
                        <input type="text" id="documentNo" class="form-control" placeholder="أدخل رقم المستند" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="passengerName">اسم المسافر *</label>
                        <input type="text" id="passengerName" class="form-control" placeholder="أدخل اسم المسافر" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="destination">الوجهة *</label>
                        <select id="destination" class="form-select" required>
                            <option value="">اختر الوجهة</option>
                            <option value="TRP">طرابلس (TRP)</option>
                            <option value="IST">اسطنبول (IST)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ticketAmount">قيمة التذكرة *</label>
                        <input type="text" id="ticketAmount" class="form-control" placeholder="أدخل قيمة التذكرة" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check-circle"></i> إضافة التذكرة
                </button>
            </form>
        </div>
        
        <!-- إضافة غرامة -->
        <div id="addFine" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-exclamation-triangle"></i> إضافة غرامة</h2>
                <small style="color: var(--text-light);">الغرامة تضاف للشركة الدائن (التي تبي مني) مثل التذكرة</small>
            </div>
            
            <form id="fineForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fineCompany">الشركة *</label>
                        <select id="fineCompany" class="form-select" required>
                            <option value="">اختر الشركة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="finePerson">اسم الشخص المُغرَم *</label>
                        <input type="text" id="finePerson" class="form-control" placeholder="أدخل اسم الشخص" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fineAmount">قيمة الغرامة *</label>
                        <input type="text" id="fineAmount" class="form-control" placeholder="أدخل قيمة الغرامة" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                    
                    <div class="form-group">
                        <label for="fineReason">سبب الغرامة *</label>
                        <input type="text" id="fineReason" class="form-control" placeholder="أدخل سبب الغرامة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fineDocument">رقم المستند (اختياري)</label>
                        <input type="text" id="fineDocument" class="form-control" placeholder="أدخل رقم المستند">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-exclamation-circle"></i> إضافة الغرامة
                </button>
            </form>
        </div>
        
        <!-- تسليم مبلغ -->
        <div id="addDelivery" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-hand-holding-usd"></i> تسليم مبلغ</h2>
                <small style="color: var(--text-light);">التسليم يخصم من رصيد الشركة (سواء كانت دائن أو مدين)</small>
            </div>
            
            <form id="deliveryForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="deliveryCompany">الشركة *</label>
                        <select id="deliveryCompany" class="form-select" required>
                            <option value="">اختر الشركة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryAmount">المبلغ المسلّم *</label>
                        <input type="text" id="deliveryAmount" class="form-control" placeholder="أدخل المبلغ المسلّم" required 
                               pattern="\d+(\.\d{1,3})?" title="أدخل رقماً صحيحاً أو عشرياً بحد أقصى 3 منازل عشرية">
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveredTo">اسم المستلم *</label>
                        <input type="text" id="deliveredTo" class="form-control" placeholder="أدخل اسم المستلم" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryNotes">ملاحظات (اختياري)</label>
                        <textarea id="deliveryNotes" class="form-control" placeholder="أدخل ملاحظات إضافية" rows="3"></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-handshake"></i> تسجيل التسليم
                </button>
            </form>
        </div>
        
        <!-- كشف حساب -->
        <div id="statement" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> كشف حساب الشركة</h2>
                <div>
                    <select id="statementCompany" class="form-select" style="width: 200px; margin-left: 10px;">
                        <option value="">اختر الشركة</option>
                    </select>
                    <button id="printStatementBtn" class="btn btn-info">
                        <i class="fas fa-print"></i> طباعة الكشف
                    </button>
                </div>
            </div>
            
            <div id="statementContent">
                <div class="account-statement" style="text-align: center; padding: 50px 20px;">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 5rem; color: #bdc3c7; margin-bottom: 20px;"></i>
                    <h3 style="color: #7f8c8d;">اختر شركة لعرض كشف الحساب</h3>
                    <p>سيتم عرض جميع المعاملات والرصيد الحالي للشركة المحددة</p>
                </div>
            </div>
        </div>
        
        <!-- قائمة الشركات -->
        <div id="companiesList" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> قائمة الشركات المسجلة</h2>
            </div>
            
            <div id="companiesListContent">
                <div style="text-align: center; padding: 50px 20px; color: var(--text-light);">
                    <i class="fas fa-building" style="font-size: 5rem; color: #bdc3c7; margin-bottom: 20px;"></i>
                    <h3 style="color: #7f8c8d;">اختر شركة لعرض القائمة</h3>
                    <p>الرجاء اختيار شركة من القائمة أعلاه لعرض تفاصيلها</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>نظام ISAM لحجز التذاكر &copy; <span id="currentYear"></span> - جميع الحقوق محفوظة</p>
            <p>تم التطوير بلغات HTML, CSS, JavaScript</p>
        </div>
    </footer>

    <script>
        // بيانات النظام - تبدأ فارغة تماماً
        let isamData = {
            companies: [],
            transactions: [],
            fines: [],
            deliveries: []
        };

        // متغيرات للحذف والتعديل
        let deleteType = '';
        let deleteId = null;
        let editType = '';
        let editId = null;

        // تحميل البيانات من localStorage
        function loadData() {
            const savedData = localStorage.getItem('isamData');
            if (savedData) {
                isamData = JSON.parse(savedData);
                if (isamData.companies.length > 0) {
                    showMainInterface();
                }
                updateCompaniesSelect();
                displayCompaniesList();
            }
        }

        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('isamData', JSON.stringify(isamData));
            updateCompaniesSelect();
            displayCompaniesList();
            
            if (isamData.companies.length > 0) {
                showMainInterface();
            } else {
                hideMainInterface();
            }
        }

        // عرض الواجهة الرئيسية
        function showMainInterface() {
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
        }

        // إخفاء الواجهة الرئيسية
        function hideMainInterface() {
            document.getElementById('welcomeMessage').style.display = 'block';
            document.getElementById('mainMenu').style.display = 'none';
        }

        // تحديث قائمة الشركات في عناصر select
        function updateCompaniesSelect() {
            const companySelects = [
                'transactionCompany', 
                'fineCompany', 
                'deliveryCompany', 
                'statementCompany'
            ];
            
            companySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // حفظ القيمة المحددة حالياً
                const currentValue = select.value;
                
                // إزالة الخيارات القديمة (باستثناء الخيار الأول)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // إضافة الشركات
                isamData.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    select.appendChild(option);
                });
                
                // استعادة القيمة المحددة إذا كانت موجودة
                if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // عرض قائمة الشركات
        function displayCompaniesList() {
            const contentDiv = document.getElementById('companiesListContent');
            
            if (isamData.companies.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: var(--text-light);">
                        <i class="fas fa-building" style="font-size: 5rem; color: #bdc3c7; margin-bottom: 20px;"></i>
                        <h3 style="color: #7f8c8d;">لا توجد شركات مسجلة</h3>
                        <p>ابدأ بإضافة أول شركة من خلال قائمة "إضافة شركة"</p>
                    </div>
                `;
                return;
            }
            
            let companiesHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            `;
            
            isamData.companies.forEach(company => {
                // حساب إجمالي المعاملات
                const companyTransactions = isamData.transactions.filter(t => t.companyId == company.id);
                const companyFines = isamData.fines.filter(f => f.companyId == company.id);
                const companyDeliveries = isamData.deliveries.filter(d => d.companyId == company.id);
                
                const totalTransactions = companyTransactions.length + companyFines.length + companyDeliveries.length;
                
                companiesHTML += `
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 3px 10px var(--shadow); border-right: 5px solid ${company.type === 'دائن' ? '#27ae60' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--primary); margin: 0;">${company.name}</h3>
                            <span style="padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; background-color: ${company.type === 'دائن' ? 'rgba(39, 174, 96, 0.15)' : 'rgba(231, 76, 60, 0.15)'}; color: ${company.type === 'دائن' ? '#27ae60' : '#e74c3c'}">
                                ${company.type}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-light); font-size: 0.9rem;">الرصيد الحالي:</span>
                                <span style="font-weight: 600; color: ${company.balance >= 0 ? '#27ae60' : '#e74c3c'}">
                                    ${formatDecimal(company.balance)}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-light); font-size: 0.9rem;">عدد المعاملات:</span>
                                <span style="font-weight: 600;">${totalTransactions}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-light); font-size: 0.9rem;">تاريخ الإنشاء:</span>
                                <span style="font-weight: 600;">${formatGregorianDate(company.date)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; gap: 10px;">
                            <button onclick="generateStatement(${company.id}); showSection('statement');" 
                                    class="btn btn-info" style="padding: 8px 15px; font-size: 0.9rem; flex: 1;">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                            <button onclick="requestDelete('company', ${company.id})" 
                                    class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem; flex: 1;">
                                <i class="fas fa-trash-alt"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            companiesHTML += `</div>`;
            contentDiv.innerHTML = companiesHTML;
        }

        // تحويل النص إلى رقم مع السماح بثلاث منازل عشرية
        function parseDecimal(value) {
            if (!value) return 0;
            // إزالة أي فواصل آلاف
            value = value.replace(/,/g, '');
            // تحقق من صيغة الرقم
            if (!/^\d+(\.\d{1,3})?$/.test(value)) {
                throw new Error('الرجاء إدخال رقم صحيح أو عشري بحد أقصى 3 منازل عشرية');
            }
            return parseFloat(value);
        }

        // تنسيق الرقم بثلاث منازل عشرية
        function formatDecimal(number) {
            return number.toFixed(3).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // تحويل التاريخ إلى تنسيق مسيحي (YYYY-MM-DD)
        function formatGregorianDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // الحصول على اسم المدينة الكامل من الاختصار
        function getCityName(code) {
            const cities = {
                'TRP': 'طرابلس',
                'IST': 'اسطنبول'
            };
            return cities[code] || code;
        }

        // إنشاء كشف الحساب للعرض
        function generateStatement(companyId) {
            const company = isamData.companies.find(c => c.id == companyId);
            if (!company) return;
            
            // تحديث الـ select ليعرض الشركة المحددة
            document.getElementById('statementCompany').value = companyId;
            
            // جمع جميع المعاملات
            const companyTransactions = isamData.transactions.filter(t => t.companyId == companyId);
            const companyFines = isamData.fines.filter(f => f.companyId == companyId);
            const companyDeliveries = isamData.deliveries.filter(d => d.companyId == companyId);
            
            // دمج جميع المعاملات في مصفوفة واحدة
            let allItems = [];
            
            // إضافة التذاكر
            companyTransactions.forEach(trans => {
                allItems.push({
                    id: trans.id,
                    type: 'ticket',
                    date: trans.date,
                    documentNo: trans.documentNo,
                    name: trans.passenger,
                    info: trans.destination,
                    amount: trans.amount,
                    amountFormatted: formatDecimal(trans.amount),
                    originalData: trans
                });
            });
            
            // إضافة الغرامات
            companyFines.forEach(fine => {
                allItems.push({
                    id: fine.id,
                    type: 'fine',
                    date: fine.date,
                    documentNo: fine.documentNo || '--',
                    name: fine.person,
                    info: fine.reason,
                    amount: fine.amount,
                    amountFormatted: formatDecimal(fine.amount),
                    originalData: fine
                });
            });
            
            // إضافة التسليمات
            companyDeliveries.forEach(delivery => {
                allItems.push({
                    id: delivery.id,
                    type: 'delivery',
                    date: delivery.date,
                    documentNo: '--',
                    name: delivery.deliveredTo,
                    info: delivery.notes || '--',
                    amount: delivery.amount,
                    amountFormatted: formatDecimal(delivery.amount),
                    originalData: delivery
                });
            });
            
            // ترتيب حسب التاريخ (من الأحدث إلى الأقدم)
            allItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // حساب الإجماليات
            const totalTickets = companyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalFines = companyFines.reduce((sum, f) => sum + f.amount, 0);
            const totalDeliveries = companyDeliveries.reduce((sum, d) => sum + d.amount, 0);
            
            // إنشاء HTML لكشف الحساب
            let statementHTML = `
                <div class="account-statement">
                    <div style="background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.8rem;">${company.name}</h3>
                            <p style="margin: 5px 0 0; opacity: 0.9; font-size: 0.95rem;">
                                نوع الحساب: <strong>${company.type}</strong> - ${company.type === 'دائن' ? 'الشركة تبي مني' : 'أنا أحتاج من الشركة'}
                            </p>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 1rem; opacity: 0.9; margin-bottom: 5px;">الرصيد الحالي</div>
                            <div style="font-size: 2.5rem; font-weight: 700; color: ${company.balance >= 0 ? '#27ae60' : '#e74c3c'}">
                                ${formatDecimal(company.balance)}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 20px;">جميع المعاملات</h3>
            `;
            
            if (allItems.length === 0) {
                statementHTML += `
                    <div style="text-align: center; padding: 50px 20px; color: var(--text-light);">
                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3 style="color: #7f8c8d;">لا توجد معاملات مسجلة</h3>
                        <p>ابدأ بإضافة أول معاملة للشركة</p>
                    </div>
                `;
            } else {
                statementHTML += `<div class="transaction-list">`;
                
                allItems.forEach(item => {
                    let typeText = '';
                    let typeClass = '';
                    let iconClass = '';
                    
                    switch(item.type) {
                        case 'ticket':
                            typeText = 'تذكرة';
                            typeClass = 'ticket';
                            iconClass = 'ticket';
                            break;
                        case 'fine':
                            typeText = 'غرامة';
                            typeClass = 'fine';
                            iconClass = 'fine';
                            break;
                        case 'delivery':
                            typeText = 'تسليم مبلغ';
                            typeClass = 'delivery';
                            iconClass = 'delivery';
                            break;
                    }
                    
                    statementHTML += `
                        <div class="transaction-item ${typeClass}">
                            <div class="transaction-icon ${iconClass}">
                                ${item.type === 'ticket' ? '<i class="fas fa-ticket-alt"></i>' : 
                                  item.type === 'fine' ? '<i class="fas fa-exclamation-triangle"></i>' : 
                                  '<i class="fas fa-hand-holding-usd"></i>'}
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-header">
                                    <span class="transaction-type ${typeClass}">${typeText}</span>
                                    <span class="transaction-date">${formatGregorianDate(item.date)}</span>
                                </div>
                                <div class="transaction-info">
                                    <div class="info-item">
                                        <span class="info-label">رقم المستند</span>
                                        <span class="info-value">${item.documentNo}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">${item.type === 'ticket' ? 'المسافر' : item.type === 'fine' ? 'المُغرَم' : 'المستلم'}</span>
                                        <span class="info-value">${item.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">${item.type === 'ticket' ? 'الوجهة' : item.type === 'fine' ? 'السبب' : 'ملاحظات'}</span>
                                        <span class="info-value">${item.type === 'ticket' ? `${getCityName(item.info)} (${item.info})` : item.info}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="transaction-amount ${typeClass}">${item.amountFormatted}</div>
                            <div class="transaction-actions">
                                <button onclick="openEditModal('${item.type === 'ticket' ? 'transaction' : item.type === 'fine' ? 'fine' : 'delivery'}', ${item.id})" 
                                        class="btn btn-warning" style="padding: 5px 10px; font-size: 0.9rem;">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button onclick="requestDelete('${item.type === 'ticket' ? 'transaction' : item.type === 'fine' ? 'fine' : 'delivery'}', ${item.id})" 
                                        class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;">
                                    <i class="fas fa-trash-alt"></i> حذف
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                statementHTML += `</div>`;
            }
            
            statementHTML += `
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--light);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 10px;">
                                <div style="font-size: 0.9rem; color: var(--text-light);">إجمالي التذاكر</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${formatDecimal(totalTickets)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">${companyTransactions.length} تذكرة</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 10px;">
                                <div style="font-size: 0.9rem; color: var(--text-light);">إجمالي الغرامات</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${formatDecimal(totalFines)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">${companyFines.length} غرامة</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 10px;">
                                <div style="font-size: 0.9rem; color: var(--text-light);">إجمالي التسليمات</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${formatDecimal(totalDeliveries)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">${companyDeliveries.length} تسليم</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementContent').innerHTML = statementHTML;
        }

        // إنشاء كشف الحساب للطباعة بنفس تنسيق الصورة
        function createPrintableStatement(companyId) {
            const company = isamData.companies.find(c => c.id == companyId);
            if (!company) return '';
            
            // جمع جميع المعاملات
            const companyTransactions = isamData.transactions.filter(t => t.companyId == companyId);
            const companyFines = isamData.fines.filter(f => f.companyId == companyId);
            const companyDeliveries = isamData.deliveries.filter(d => d.companyId == companyId);
            
            // دمج جميع المعاملات في مصفوفة واحدة
            let allItems = [];
            
            // إضافة التذاكر
            companyTransactions.forEach(trans => {
                allItems.push({
                    id: trans.id,
                    type: 'تذكرة',
                    date: trans.date,
                    documentNo: trans.documentNo,
                    passenger: trans.passenger,
                    destination: trans.destination,
                    amount: trans.amount,
                    debit: trans.amount,
                    credit: 0,
                    status: 'NW',
                    path: trans.destination === 'IST' ? 'IST/MJI' : 'MJI/JST'
                });
            });
            
            // إضافة الغرامات
            companyFines.forEach(fine => {
                allItems.push({
                    id: fine.id,
                    type: 'غرامة',
                    date: fine.date,
                    documentNo: fine.documentNo || '--',
                    passenger: fine.person,
                    destination: fine.reason,
                    amount: fine.amount,
                    debit: fine.amount,
                    credit: 0,
                    status: 'NW',
                    path: 'MJI/JST'
                });
            });
            
            // إضافة التسليمات
            companyDeliveries.forEach(delivery => {
                allItems.push({
                    id: delivery.id,
                    type: 'تسليم',
                    date: delivery.date,
                    documentNo: '--',
                    passenger: delivery.deliveredTo,
                    destination: delivery.notes || 'تسليم مبلغ',
                    amount: delivery.amount,
                    debit: 0,
                    credit: delivery.amount,
                    status: 'NW',
                    path: ''
                });
            });
            
            // ترتيب حسب التاريخ (من الأقدم إلى الأحدث)
            allItems.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // حساب الإجماليات
            const totalTickets = companyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalFines = companyFines.reduce((sum, f) => sum + f.amount, 0);
            const totalDeliveries = companyDeliveries.reduce((sum, d) => sum + d.amount, 0);
            
            // حساب إجمالي الدائن والمعين
            let totalDebit = totalTickets + totalFines;
            let totalCredit = totalDeliveries;
            
            // حساب الرصيد التراكمي
            let runningBalance = parseDecimal(company.initialBalance || '0');
            if (company.type === 'دائن') {
                runningBalance = totalCredit - totalDebit;
            } else {
                runningBalance = totalDebit - totalCredit;
            }
            
            // بناء الجدول للطباعة - بنفس تنسيق الصورة
            let tableRows = '';
            
            // إضافة الترويسة
            tableRows += `
                <tr>
                    <th>#</th>
                    <th>الخدمة</th>
                    <th>التاريخ</th>
                    <th>البيان</th>
                    <th>الحالة</th>
                    <th>رقم المستند</th>
                    <th>المسار</th>
                    <th>دائن</th>
                    <th>معين</th>
                    <th>الرصيد</th>
                </tr>
            `;
            
            // إضافة سطر الرصيد الافتتاحي
            let openingBalance = parseDecimal(company.initialBalance || '0');
            if (company.type === 'دائن') {
                openingBalance = -openingBalance;
            }
            
            tableRows += `
                <tr>
                    <td>1</td>
                    <td>ايصال قبض</td>
                    <td>${formatGregorianDate(company.date)}</td>
                    <td>${company.name}</td>
                    <td>NW</td>
                    <td>--</td>
                    <td>${company.type === 'دائن' ? '1488' : '--'}</td>
                    <td class="credit-amount">${company.type === 'دائن' ? formatDecimal(Math.abs(openingBalance)) : '0'}</td>
                    <td class="debit-amount">${company.type === 'مدين' ? formatDecimal(Math.abs(openingBalance)) : '0'}</td>
                    <td class="amount-negative">${formatDecimal(openingBalance)}</td>
                </tr>
            `;
            
            // تحديث الرصيد التراكمي
            runningBalance = openingBalance;
            
            // إضافة جميع المعاملات
            allItems.forEach((item, index) => {
                // تحديث الرصيد التراكمي
                if (item.credit > 0) {
                    runningBalance += item.credit; // دائن يزيد الرصيد
                } else {
                    runningBalance -= item.debit; // معين ينقص الرصيد
                }
                
                // تحديد لون الرصيد
                const balanceClass = runningBalance < 0 ? 'amount-negative' : 'amount-positive';
                
                tableRows += `
                    <tr>
                        <td>${index + 2}</td>
                        <td>نذكر</td>
                        <td>${formatGregorianDate(item.date)}</td>
                        <td>${item.passenger}</td>
                        <td>${item.status}</td>
                        <td>${item.documentNo}</td>
                        <td>${item.path}</td>
                        <td class="credit-amount">${formatDecimal(item.credit)}</td>
                        <td class="debit-amount">${formatDecimal(item.debit)}</td>
                        <td class="${balanceClass}">${formatDecimal(runningBalance)}</td>
                    </tr>
                `;
            });
            
            // حساب الرصيد النهائي
            const finalBalance = openingBalance + totalCredit - totalDebit;
            
            // إنشاء كشف الحساب للطباعة بنفس تصميم الصورة
            const printHTML = `
                <div class="print-statement">
                    <!-- ترويسة الشركة -->
                    <div class="company-header">
                        <h1>كشف حساب - ${company.name}</h1>
                        <h2>نظام ISAM لحجز التذاكر</h2>
                    </div>
                    
                    <!-- جدول المعاملات -->
                    <table class="print-table">
                        ${tableRows}
                    </table>
                    
                    <!-- ملخص التقرير -->
                    <div class="report-summary">
                        <div class="summary-title">أجمالي التقرير بالعملة LYD</div>
                        <table class="summary-table">
                            <tr>
                                <td>الدائن</td>
                                <td>${formatDecimal(totalCredit)} LYD</td>
                            </tr>
                            <tr>
                                <td>المعين</td>
                                <td>${formatDecimal(totalDebit)} LYD</td>
                            </tr>
                            <tr>
                                <td>الرصيد</td>
                                <td>${formatDecimal(finalBalance)} LYD</td>
                            </tr>
                            <tr>
                                <td>الرصيد السابق</td>
                                <td>${formatDecimal(openingBalance)} LYD</td>
                            </tr>
                            <tr>
                                <td>اجمال الرصيد</td>
                                <td>${formatDecimal(runningBalance)} LYD</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- الرصيد النهائي -->
                    <div class="total-balance">
                        <div class="total-label">الرصيد النهائي</div>
                        <div class="total-value">${formatDecimal(runningBalance)} LYD</div>
                        <div style="margin-top: 5px; font-size: 11px;">
                            ${runningBalance < 0 ? 'مدين' : 'دائن'}
                        </div>
                    </div>
                    
                    <!-- تذييل الطباعة -->
                    <div class="print-footer">
                        <p>تم إنشاء هذا الكشف آلياً بواسطة نظام ISAM لحجز التذاكر</p>
                        <p>${formatGregorianDate(new Date().toISOString())} - جميع الحقوق محفوظة</p>
                    </div>
                </div>
            `;
            
            return printHTML;
        }

        // فتح نموذج التعديل
        function openEditModal(type, id) {
            editType = type;
            editId = id;
            
            let item = null;
            let title = '';
            
            switch(type) {
                case 'transaction':
                    item = isamData.transactions.find(t => t.id === id);
                    title = 'تعديل التذكرة';
                    break;
                case 'fine':
                    item = isamData.fines.find(f => f.id === id);
                    title = 'تعديل الغرامة';
                    break;
                case 'delivery':
                    item = isamData.deliveries.find(d => d.id === id);
                    title = 'تعديل التسليم';
                    break;
            }
            
            if (!item) return;
            
            document.getElementById('editModalTitle').textContent = title;
            document.getElementById('editDocumentNo').value = item.documentNo || '';
            
            if (type === 'transaction') {
                document.getElementById('editName').value = item.passenger;
                document.getElementById('editInfo').value = item.destination;
            } else if (type === 'fine') {
                document.getElementById('editName').value = item.person;
                document.getElementById('editInfo').value = item.reason;
            } else {
                document.getElementById('editName').value = item.deliveredTo;
                document.getElementById('editInfo').value = item.notes || '';
            }
            
            document.getElementById('editAmount').value = formatDecimal(item.amount);
            
            document.getElementById('editModal').classList.add('active');
        }

        // حفظ التعديلات
        function saveEdit() {
            if (!editType || !editId) return;
            
            const documentNo = document.getElementById('editDocumentNo').value;
            const name = document.getElementById('editName').value;
            const info = document.getElementById('editInfo').value;
            let amount;
            
            try {
                amount = parseDecimal(document.getElementById('editAmount').value);
            } catch (error) {
                alert(error.message);
                return;
            }
            
            if (!name || isNaN(amount) || amount <= 0) {
                alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            let item = null;
            let companyId = null;
            let oldAmount = 0;
            
            switch(editType) {
                case 'transaction':
                    item = isamData.transactions.find(t => t.id === editId);
                    if (item) {
                        companyId = item.companyId;
                        oldAmount = item.amount;
                        item.documentNo = documentNo;
                        item.passenger = name;
                        item.destination = info;
                        item.amount = amount;
                    }
                    break;
                case 'fine':
                    item = isamData.fines.find(f => f.id === editId);
                    if (item) {
                        companyId = item.companyId;
                        oldAmount = item.amount;
                        item.documentNo = documentNo;
                        item.person = name;
                        item.reason = info;
                        item.amount = amount;
                    }
                    break;
                case 'delivery':
                    item = isamData.deliveries.find(d => d.id === editId);
                    if (item) {
                        companyId = item.companyId;
                        oldAmount = item.amount;
                        item.deliveredTo = name;
                        item.notes = info;
                        item.amount = amount;
                    }
                    break;
            }
            
            if (!item || !companyId) {
                alert('حدث خطأ في العثور على المعاملة');
                return;
            }
            
            // تحديث رصيد الشركة
            const company = isamData.companies.find(c => c.id === companyId);
            if (company) {
                // إرجاع التأثير القديم
                if (editType === 'transaction' || editType === 'fine') {
                    if (company.type === 'دائن') {
                        company.balance -= oldAmount;
                        company.balance += amount;
                    } else {
                        company.balance += oldAmount;
                        company.balance -= amount;
                    }
                } else if (editType === 'delivery') {
                    company.balance += oldAmount;
                    company.balance -= amount;
                }
            }
            
            saveData();
            
            // تحديث عرض كشف الحساب
            const currentCompanyId = document.getElementById('statementCompany').value;
            if (currentCompanyId && currentCompanyId == companyId) {
                generateStatement(currentCompanyId);
            }
            
            closeEditModal();
            alert('تم تعديل المعاملة بنجاح!');
        }

        // إغلاق نموذج التعديل
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editType = '';
            editId = null;
        }

        // طلب حذف
        function requestDelete(type, id) {
            deleteType = type;
            deleteId = id;
            
            let message = '';
            switch(type) {
                case 'company':
                    message = 'هل أنت متأكد من حذف هذه الشركة؟ سيتم حذف جميع التذاكر والغرامات والتسليمات المرتبطة بها.';
                    break;
                case 'transaction':
                    message = 'هل أنت متأكد من حذف هذه التذكرة؟';
                    break;
                case 'fine':
                    message = 'هل أنت متأكد من حذف هذه الغرامة؟';
                    break;
                case 'delivery':
                    message = 'هل أنت متأكد من حذف عملية التسليم هذه؟';
                    break;
            }
            
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteConfirmation').classList.add('active');
        }

        // تأكيد الحذف
        function confirmDelete() {
            let companyId = null;
            
            switch(deleteType) {
                case 'company':
                    // حذف الشركة
                    isamData.companies = isamData.companies.filter(c => c.id !== deleteId);
                    // حذف جميع معاملات الشركة
                    isamData.transactions = isamData.transactions.filter(t => t.companyId !== deleteId);
                    isamData.fines = isamData.fines.filter(f => f.companyId !== deleteId);
                    isamData.deliveries = isamData.deliveries.filter(d => d.companyId !== deleteId);
                    break;
                    
                case 'transaction':
                    const trans = isamData.transactions.find(t => t.id === deleteId);
                    if (trans) {
                        companyId = trans.companyId;
                        // تحديث رصيد الشركة
                        const company = isamData.companies.find(c => c.id === trans.companyId);
                        if (company) {
                            if (company.type === 'دائن') {
                                company.balance -= trans.amount;
                            } else {
                                company.balance += trans.amount;
                            }
                        }
                        // حذف التذكرة
                        isamData.transactions = isamData.transactions.filter(t => t.id !== deleteId);
                    }
                    break;
                    
                case 'fine':
                    const fine = isamData.fines.find(f => f.id === deleteId);
                    if (fine) {
                        companyId = fine.companyId;
                        // تحديث رصيد الشركة
                        const company = isamData.companies.find(c => c.id === fine.companyId);
                        if (company) {
                            if (company.type === 'دائن') {
                                company.balance -= fine.amount;
                            } else {
                                company.balance += fine.amount;
                            }
                        }
                        // حذف الغرامة
                        isamData.fines = isamData.fines.filter(f => f.id !== deleteId);
                    }
                    break;
                    
                case 'delivery':
                    const delivery = isamData.deliveries.find(d => d.id === deleteId);
                    if (delivery) {
                        companyId = delivery.companyId;
                        // تحديث رصيد الشركة
                        const company = isamData.companies.find(c => c.id === delivery.companyId);
                        if (company) {
                            company.balance += delivery.amount;
                        }
                        // حذف التسليم
                        isamData.deliveries = isamData.deliveries.filter(d => d.id !== deleteId);
                    }
                    break;
            }
            
            saveData();
            closeDeleteModal();
            alert('تم الحذف بنجاح');
            
            // تحديث عرض كشف الحساب إذا كان مفتوحاً
            const currentCompanyId = document.getElementById('statementCompany').value;
            if (currentCompanyId && companyId && currentCompanyId == companyId) {
                generateStatement(currentCompanyId);
            }
        }

        // إغلاق نموذج الحذف
        function closeDeleteModal() {
            document.getElementById('deleteConfirmation').classList.remove('active');
            deleteType = '';
            deleteId = null;
        }

        // طباعة كشف الحساب
        function printStatement() {
            const companyId = document.getElementById('statementCompany').value;
            if (!companyId) {
                alert('يرجى اختيار شركة أولاً');
                return;
            }
            
            const company = isamData.companies.find(c => c.id == companyId);
            if (!company) return;
            
            // إنشاء كشف الحساب للطباعة
            const printHTML = createPrintableStatement(companyId);
            document.getElementById('printContainer').innerHTML = printHTML;
            
            // إضافة اسم الشركة في عنوان الصفحة المطبوع
            document.title = `كشف حساب - ${company.name} - ${formatGregorianDate(new Date().toISOString())}`;
            
            // الانتظار قليلاً ثم الطباعة
            setTimeout(() => {
                window.print();
                // إعادة العنوان الأصلي
                setTimeout(() => {
                    document.title = 'نظام ISAM لحجز التذاكر';
                    // تنظيف الحاوية بعد الطباعة
                    document.getElementById('printContainer').innerHTML = '';
                }, 100);
            }, 500);
        }

        // عرض القسم المحدد
        function showSection(sectionId) {
            // إخفاء رسالة الترحيب
            document.getElementById('welcomeMessage').style.display = 'none';
            
            // إظهار الواجهة الرئيسية إذا كانت هناك شركات
            if (isamData.companies.length > 0) {
                document.getElementById('mainMenu').style.display = 'flex';
            }
            
            // تحديث الأزرار النشطة
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-section') === sectionId) {
                    btn.classList.add('active');
                }
            });
            
            // إخفاء جميع الأقسام
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // إظهار القسم المحدد
            document.getElementById(sectionId).classList.add('active');
            
            // تحديث المحتوى حسب القسم
            if (sectionId === 'statement') {
                updateCompaniesSelect();
                const companyId = document.getElementById('statementCompany').value;
                if (companyId) {
                    generateStatement(companyId);
                }
            } else if (sectionId === 'companiesList') {
                displayCompaniesList();
            }
        }

        // تهيئة التاريخ
        function initializeDate() {
            const now = new Date();
            document.getElementById('currentYear').textContent = now.getFullYear();
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeDate();
            loadData();
            
            // أحداث نموذج الحذف
            document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
            document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
            
            // أحداث نموذج التعديل
            document.getElementById('editForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEdit();
            });
            
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            
            // حدث select كشف الحساب
            document.getElementById('statementCompany').addEventListener('change', function() {
                if (this.value) {
                    generateStatement(this.value);
                }
            });
            
            // زر طباعة الكشف
            document.getElementById('printStatementBtn').addEventListener('click', printStatement);
            
            // أحداث القائمة الرئيسية
            document.querySelectorAll('.menu-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });
            
            // نموذج إضافة الشركة
            document.getElementById('companyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyName = document.getElementById('companyName').value;
                const companyType = document.getElementById('companyType').value;
                let initialBalance;
                
                try {
                    initialBalance = parseDecimal(document.getElementById('initialBalance').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                if (!companyName || !companyType || isNaN(initialBalance)) {
                    alert('يرجى ملء جميع الحقول المطلوبة');
                    return;
                }
                
                // حساب الرصيد بناءً على نوع الحساب
                const balance = companyType === 'دائن' ? initialBalance : -initialBalance;
                
                // إضافة شركة جديدة
                const newId = isamData.companies.length > 0 
                    ? Math.max(...isamData.companies.map(c => c.id)) + 1 
                    : 1;
                
                const newCompany = {
                    id: newId,
                    name: companyName,
                    type: companyType,
                    balance: balance,
                    initialBalance: initialBalance,
                    date: new Date().toISOString()
                };
                
                isamData.companies.push(newCompany);
                saveData();
                
                alert('تم إضافة الشركة بنجاح!');
                this.reset();
                showSection('companiesList');
            });
            
            // نموذج إضافة تذكرة
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyId = parseInt(document.getElementById('transactionCompany').value);
                const documentNo = document.getElementById('documentNo').value;
                const passengerName = document.getElementById('passengerName').value;
                const destination = document.getElementById('destination').value;
                let amount;
                
                try {
                    amount = parseDecimal(document.getElementById('ticketAmount').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                if (!companyId || !documentNo || !passengerName || !destination || isNaN(amount) || amount <= 0) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }
                
                // إنشاء معرف فريد للمعاملة
                const newId = isamData.transactions.length > 0 
                    ? Math.max(...isamData.transactions.map(t => t.id)) + 1 
                    : 1;
                
                // إضافة المعاملة
                const newTransaction = {
                    id: newId,
                    companyId: companyId,
                    documentNo: documentNo,
                    passenger: passengerName,
                    destination: destination,
                    amount: amount,
                    date: new Date().toISOString()
                };
                
                isamData.transactions.push(newTransaction);
                
                // تحديث رصيد الشركة
                const company = isamData.companies.find(c => c.id === companyId);
                if (company) {
                    if (company.type === 'دائن') {
                        company.balance += amount;
                    } else {
                        company.balance -= amount;
                    }
                }
                
                saveData();
                
                alert('تم إضافة التذكرة بنجاح!');
                this.reset();
            });
            
            // نموذج إضافة غرامة
            document.getElementById('fineForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyId = parseInt(document.getElementById('fineCompany').value);
                const personName = document.getElementById('finePerson').value;
                let amount;
                
                try {
                    amount = parseDecimal(document.getElementById('fineAmount').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                const reason = document.getElementById('fineReason').value;
                const documentNo = document.getElementById('fineDocument').value;
                
                if (!companyId || !personName || !reason || isNaN(amount) || amount <= 0) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }
                
                // إنشاء معرف فريد للغرامة
                const newId = isamData.fines.length > 0 
                    ? Math.max(...isamData.fines.map(f => f.id)) + 1 
                    : 1;
                
                // إضافة الغرامة
                const newFine = {
                    id: newId,
                    companyId: companyId,
                    person: personName,
                    amount: amount,
                    reason: reason,
                    documentNo: documentNo || `FINE-${newId.toString().padStart(3, '0')}`,
                    date: new Date().toISOString()
                };
                
                isamData.fines.push(newFine);
                
                // تحديث رصيد الشركة
                const company = isamData.companies.find(c => c.id === companyId);
                if (company) {
                    if (company.type === 'دائن') {
                        company.balance += amount;
                    } else {
                        company.balance -= amount;
                    }
                }
                
                saveData();
                
                alert('تم إضافة الغرامة بنجاح!');
                this.reset();
            });
            
            // نموذج إضافة تسليم مبلغ
            document.getElementById('deliveryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyId = parseInt(document.getElementById('deliveryCompany').value);
                let amount;
                
                try {
                    amount = parseDecimal(document.getElementById('deliveryAmount').value);
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                const deliveredTo = document.getElementById('deliveredTo').value;
                const notes = document.getElementById('deliveryNotes').value;
                
                if (!companyId || !deliveredTo || isNaN(amount) || amount <= 0) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }
                
                // إنشاء معرف فريد للتسليم
                const newId = isamData.deliveries.length > 0 
                    ? Math.max(...isamData.deliveries.map(d => d.id)) + 1 
                    : 1;
                
                // إضافة التسليم
                const newDelivery = {
                    id: newId,
                    companyId: companyId,
                    amount: amount,
                    deliveredTo: deliveredTo,
                    notes: notes,
                    date: new Date().toISOString()
                };
                
                isamData.deliveries.push(newDelivery);
                
                // تحديث رصيد الشركة
                const company = isamData.companies.find(c => c.id === companyId);
                if (company) {
                    company.balance -= amount;
                }
                
                saveData();
                
                alert('تم تسجيل التسليم بنجاح!');
                this.reset();
            });
            
            console.log("نظام ISAM لحجز التذاكر - جاهز للاستخدام");
        });
    </script>
</body>
</html>