<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام تذاكر - إدارة البيانات والمبالغ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a5276);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            margin: 0 10px;
            text-align: center;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #e74c3c, #3498db);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(45deg); }
            50% { transform: translateY(-5px) rotate(45deg); }
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
            padding: 0 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
            background-color: #f8fafc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-section, .report-section, .manage-section {
            background-color: white;
            padding: 20px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
        }
        
        h2 {
            color: var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
            font-size: 1.5rem;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        h2 span {
            font-size: 1rem;
            color: #666;
            font-weight: normal;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 70px;
            height: 2px;
            background: linear-gradient(to left, var(--secondary-color), var(--success-color));
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #fafafa;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background-color: white;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }
        
        @media (min-width: 480px) {
            .radio-group {
                flex-direction: row;
            }
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 6px;
            background-color: #f8f9fa;
            transition: all 0.3s;
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* تمييز نوع العملية النشط */
        .radio-option.active-ticket {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(39, 174, 96, 0.05));
            border: 2px solid var(--success-color);
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.2);
        }
        
        .radio-option.active-fine {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(231, 76, 60, 0.05));
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.2);
        }
        
        .radio-option.active-payment {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(52, 152, 219, 0.05));
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
        }
        
        .radio-option.active-ticket::before,
        .radio-option.active-fine::before,
        .radio-option.active-payment::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8) 1%, transparent 20%);
            z-index: 1;
        }
        
        .radio-option.active-ticket label {
            color: var(--success-color);
            font-weight: 700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .radio-option.active-fine label {
            color: var(--accent-color);
            font-weight: 700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .radio-option.active-payment label {
            color: var(--secondary-color);
            font-weight: 700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        /* أيقونات مضيئة */
        .radio-icon {
            font-size: 1.2rem;
            transition: all 0.3s;
            z-index: 2;
        }
        
        .active-ticket .radio-icon {
            color: var(--success-color);
            text-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
            transform: scale(1.2);
        }
        
        .active-fine .radio-icon {
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            transform: scale(1.2);
        }
        
        .active-payment .radio-icon {
            color: var(--secondary-color);
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            transform: scale(1.2);
        }
        
        /* مؤشر نوع العملية */
        .type-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            color: var(--primary-color);
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            z-index: 3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .active-ticket .type-indicator {
            background-color: var(--success-color);
            color: white;
        }
        
        .active-fine .type-indicator {
            background-color: var(--accent-color);
            color: white;
        }
        
        .active-payment .type-indicator {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* توهج النص */
        .radio-text-glow {
            position: relative;
            z-index: 2;
        }
        
        .active-ticket .radio-text-glow {
            animation: textGlowGreen 2s infinite alternate;
        }
        
        .active-fine .radio-text-glow {
            animation: textGlowRed 2s infinite alternate;
        }
        
        .active-payment .radio-text-glow {
            animation: textGlowBlue 2s infinite alternate;
        }
        
        @keyframes textGlowGreen {
            from { text-shadow: 0 0 5px rgba(39, 174, 96, 0.5); }
            to { text-shadow: 0 0 15px rgba(39, 174, 96, 0.8); }
        }
        
        @keyframes textGlowRed {
            from { text-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            to { text-shadow: 0 0 15px rgba(231, 76, 60, 0.8); }
        }
        
        @keyframes textGlowBlue {
            from { text-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }
            to { text-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
        }
        
        /* تأثير النبض */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .radio-option.active-ticket,
        .radio-option.active-fine,
        .radio-option.active-payment {
            animation: pulse 3s infinite;
        }
        
        .radio-option input {
            width: auto;
            margin-left: 5px;
            position: relative;
            z-index: 2;
        }
        
        .radio-option label {
            margin-bottom: 0;
            flex: 1;
            position: relative;
            z-index: 2;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
            margin-top: 8px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
        }
        
        .btn-print {
            background: linear-gradient(135deg, var(--primary-color), #1a252f);
            width: auto;
            margin: 0;
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            margin-top: 12px;
        }
        
        .btn-add-company {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            margin-bottom: 15px;
        }
        
        .btn-cancel {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-save {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        /* تحسينات للجدول على الهاتف */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        
        .manage-table-container {
            max-height: 500px;
        }
        
        /* مؤشر التمرير للهواتف */
        .scroll-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            opacity: 0.7;
            pointer-events: none;
            z-index: 5;
            display: none;
            animation: fadeInOut 3s infinite;
            white-space: nowrap;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.9; }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            font-size: 0.85rem;
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 12px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
            background-color: white;
        }
        
        tr:nth-child(even) td {
            background-color: #fafafa;
        }
        
        .total-row {
            font-weight: bold;
            background: linear-gradient(135deg, #e8f4fc, #d4eaf7) !important;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .total-row td {
            border-top: 2px solid var(--secondary-color);
        }
        
        .transaction-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .transaction-ticket {
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            color: #219653;
        }
        
        .transaction-fine {
            background: linear-gradient(135deg, #fde0dc, #f9c9c2);
            color: #c0392b;
        }
        
        .transaction-payment {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #2980b9;
        }
        
        .transaction-initial {
            background: linear-gradient(135deg, #f8f4e6, #f5e9c8);
            color: #d68910;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
            color: white;
            white-space: nowrap;
            touch-action: manipulation;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .action-btn-edit {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .action-btn-delete {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .summary-box {
            background: linear-gradient(135deg, white, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
        }
        
        .summary-box h3 {
            font-size: 0.9rem;
            color: var(--dark-color);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-box .value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .company-selector {
            margin-bottom: 20px;
        }
        
        .company-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid var(--secondary-color);
        }
        
        @media (min-width: 480px) {
            .company-info {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-info h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin: 0;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .company-info h3 {
                text-align: right;
            }
        }
        
        .company-balance {
            font-size: 1.4rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 6px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .positive-balance {
            color: var(--success-color);
            border-right: 3px solid var(--success-color);
        }
        
        .negative-balance {
            color: var(--accent-color);
            border-right: 3px solid var(--accent-color);
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 0.85rem;
            padding-bottom: 20px;
        }
        
        /* =========================================== */
        /* تحسينات الطباعة الاحترافية */
        /* =========================================== */
        
        @media print {
            body {
                padding: 5mm !important;
                background-color: white !important;
                font-size: 12px !important;
                line-height: 1.4 !important;
                color: black !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* إخفاء جميع العناصر غير المرغوبة */
            .form-section, .summary, .manage-section, .tabs,
            .scroll-indicator, .company-info {
                display: none !important;
            }
            
            /* تصميم الصفحة للطباعة */
            .print-page {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                page-break-inside: avoid;
            }
            
            /* ترويسة الطباعة الجميلة */
            .print-header {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 15px 0;
                margin-bottom: 20px;
                border-bottom: 3px double #2c3e50;
                background: linear-gradient(to right, #f8f9fa, #e9ecef) !important;
                border-radius: 8px;
                page-break-after: avoid;
            }
            
            .print-logo {
                display: flex !important;
                align-items: center;
                justify-content: center;
                gap: 15px;
                margin-bottom: 10px;
            }
            
            .print-logo-icon {
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg, #e74c3c, #3498db);
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                font-weight: bold;
                box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            }
            
            .print-title {
                text-align: center;
                margin: 0;
            }
            
            .print-title h1 {
                font-size: 24px !important;
                color: #2c3e50 !important;
                margin-bottom: 5px;
                font-weight: bold;
                text-shadow: none !important;
            }
            
            .print-title p {
                font-size: 14px !important;
                color: #666 !important;
                margin: 0;
            }
            
            /* معلومات الشركة في الطباعة */
            .print-company-info {
                display: block !important;
                text-align: center;
                margin: 15px 0;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 6px;
                border: 1px solid #dee2e6;
                page-break-after: avoid;
            }
            
            .print-company-name {
                font-size: 20px !important;
                color: #2c3e50 !important;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .print-company-details {
                font-size: 14px !important;
                color: #666 !important;
                margin: 5px 0;
            }
            
            /* تحسين الجدول للطباعة */
            #transactions-table {
                font-size: 11px !important;
                min-width: 100% !important;
                width: 100% !important;
                max-width: 100% !important;
                border: 1px solid #dee2e6 !important;
                border-collapse: collapse !important;
                margin: 15px 0 !important;
                page-break-inside: auto;
            }
            
            #transactions-table thead {
                display: table-header-group !important;
            }
            
            #transactions-table th {
                background: linear-gradient(135deg, #2c3e50, #34495e) !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 11px !important;
                padding: 8px 6px !important;
                border: 1px solid #2c3e50 !important;
                text-align: center !important;
                white-space: nowrap !important;
            }
            
            #transactions-table td {
                padding: 6px 5px !important;
                font-size: 10px !important;
                border: 1px solid #dee2e6 !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            
            #transactions-table tr:nth-child(even) td {
                background-color: #f8f9fa !important;
            }
            
            /* جعل جميع الأعمدة تظهر عند الطباعة */
            #transactions-table th,
            #transactions-table td {
                display: table-cell !important;
            }
            
            /* تحسين عرض أنواع العمليات عند الطباعة */
            .transaction-type {
                padding: 3px 8px !important;
                font-size: 9px !important;
                font-weight: bold !important;
                border-radius: 10px !important;
                display: inline-block !important;
                min-width: 60px !important;
                text-align: center !important;
            }
            
            .transaction-ticket {
                background: linear-gradient(135deg, #d4edda, #c3e6cb) !important;
                color: #155724 !important;
                border: 1px solid #c3e6cb !important;
            }
            
            .transaction-fine {
                background: linear-gradient(135deg, #f8d7da, #f5c6cb) !important;
                color: #721c24 !important;
                border: 1px solid #f5c6cb !important;
            }
            
            .transaction-payment {
                background: linear-gradient(135deg, #d1ecf1, #bee5eb) !important;
                color: #0c5460 !important;
                border: 1px solid #bee5eb !important;
            }
            
            .transaction-initial {
                background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
                color: #856404 !important;
                border: 1px solid #ffeaa7 !important;
            }
            
            /* قسم الرصيد النهائي في الطباعة */
            .print-balance-summary {
                display: block !important;
                margin-top: 20px;
                padding: 15px;
                background: linear-gradient(135deg, #e8f4fc, #d4eaf7);
                border-radius: 8px;
                border: 2px solid #3498db;
                text-align: center;
                page-break-before: avoid;
                page-break-after: avoid;
            }
            
            .print-balance-row {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                margin: 10px 0;
                padding: 8px 0;
                border-bottom: 1px dashed #ccc;
            }
            
            .print-balance-label {
                font-size: 14px !important;
                font-weight: bold;
                color: #2c3e50;
            }
            
            .print-balance-value {
                font-size: 15px !important;
                font-weight: bold;
            }
            
            .print-total-balance {
                font-size: 18px !important;
                font-weight: bold;
                color: #2c3e50;
                margin-top: 10px;
                padding-top: 10px;
                border-top: 2px solid #3498db;
            }
            
            .positive-balance-print {
                color: #27ae60 !important;
            }
            
            .negative-balance-print {
                color: #e74c3c !important;
            }
            
            .neutral-balance-print {
                color: #2c3e50 !important;
            }
            
            /* قسم الدائن والمدين في الطباعة */
            .print-balance-types {
                display: flex !important;
                justify-content: center;
                gap: 30px;
                margin-top: 15px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 6px;
                border: 1px solid #dee2e6;
            }
            
            .print-credit, .print-debit {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 15px;
                border-radius: 6px;
                font-weight: bold;
            }
            
            .print-credit {
                background: linear-gradient(135deg, #d4edda, #c3e6cb);
                color: #155724;
                border: 2px solid #28a745;
            }
            
            .print-debit {
                background: linear-gradient(135deg, #f8d7da, #f5c6cb);
                color: #721c24;
                border: 2px solid #dc3545;
            }
            
            /* تذييل الصفحة في الطباعة */
            .print-footer {
                display: block !important;
                text-align: center;
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #dee2e6;
                font-size: 10px !important;
                color: #666 !important;
                page-break-before: avoid;
            }
            
            .print-footer p {
                margin: 3px 0;
            }
            
            .print-signature {
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px dashed #999;
                text-align: center;
            }
            
            .signature-line {
                width: 200px;
                border-bottom: 1px solid #333;
                margin: 20px auto 5px;
                padding-bottom: 15px;
            }
            
            .signature-label {
                font-size: 11px;
                color: #333;
            }
            
            /* تحسينات للطباعة على الهواتف */
            @media (max-width: 768px) and print {
                body {
                    padding: 3mm !important;
                    font-size: 10px !important;
                }
                
                .print-title h1 {
                    font-size: 20px !important;
                }
                
                .print-company-name {
                    font-size: 18px !important;
                }
                
                #transactions-table {
                    font-size: 9px !important;
                }
                
                #transactions-table th,
                #transactions-table td {
                    padding: 4px 3px !important;
                    font-size: 9px !important;
                }
                
                #transactions-table th:nth-child(5),
                #transactions-table td:nth-child(5),
                #transactions-table th:nth-child(7),
                #transactions-table td:nth-child(7) {
                    display: none !important;
                }
                
                .transaction-type {
                    font-size: 8px !important;
                    padding: 2px 6px !important;
                }
            }
            
            /* إخفاء حاوية التمرير */
            .table-container {
                overflow: visible !important;
                max-height: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* إخفاء رسالة عدم وجود بيانات */
            #no-data {
                display: none !important;
            }
            
            /* إخفاء ترويسة التقرير العادية */
            .report-header {
                display: none !important;
            }
            
            /* إخفاء قسم التقرير العادي */
            .report-section {
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
                margin: 0 !important;
                background: white !important;
            }
            
            /* ضبط هوامش الصفحة */
            @page {
                margin: 10mm;
                size: auto;
            }
            
            /* منع تقسيم الصفوف بين الصفحات */
            tr {
                page-break-inside: avoid;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        .company-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .company-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            margin-bottom: 8px;
            border-radius: 6px;
            border-right: 3px solid var(--secondary-color);
        }
        
        @media (min-width: 480px) {
            .company-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .company-item-balance {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: white;
            font-size: 0.9rem;
        }
        
        .company-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .delete-company {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            flex: 1;
        }
        
        /* نافذة إضافة شركة جديدة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background: linear-gradient(135deg, white, #f8f9fa);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #eaeaea;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #7f8c8d;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .balance-type {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (min-width: 480px) {
            .balance-type {
                flex-direction: row;
            }
        }
        
        .debit-option, .credit-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }
        
        .debit-option.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
            color: var(--accent-color);
        }
        
        .credit-option.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
            color: var(--success-color);
        }
        
        .balance-explanation {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            font-size: 0.9rem;
            color: #555;
            border-right: 3px solid var(--secondary-color);
        }
        
        .explanation-positive {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .explanation-negative {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .initial-balance-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .report-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        @media (min-width: 480px) {
            .report-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .company-report-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .company-report-title {
                text-align: right;
            }
        }
        
        .destination-abbr {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            color: #333;
            font-size: 0.8rem;
        }
        
        /* ======= تحسينات خاصة للهواتف ======= */
        
        /* تحسينات للهواتف المحمولة */
        @media (max-width: 768px) {
            .table-container {
                margin: 0 -15px;
                width: calc(100% + 30px);
                border-radius: 0;
                border-left: none;
                border-right: none;
                max-height: 450px;
            }
            
            /* تحسين جدول كشف الحساب للهواتف */
            #transactions-table {
                min-width: 750px;
                font-size: 0.78rem;
            }
            
            #transactions-table th,
            #transactions-table td {
                padding: 9px 6px;
                white-space: nowrap;
            }
            
            /* إخفاء بعض الأعمدة على الهواتف لتحسين القراءة */
            #transactions-table th:nth-child(5), /* المستند */
            #transactions-table td:nth-child(5),
            #transactions-table th:nth-child(7), /* الرحلة */
            #transactions-table td:nth-child(7),
            #transactions-table th:nth-child(8), /* السبب */
            #transactions-table td:nth-child(8) {
                display: none;
            }
            
            /* تكبير الأعمدة المهمة على الهواتف */
            #transactions-table th:nth-child(2), /* التاريخ */
            #transactions-table td:nth-child(2),
            #transactions-table th:nth-child(3), /* النوع */
            #transactions-table td:nth-child(3),
            #transactions-table th:nth-child(4), /* المسافر */
            #transactions-table td:nth-child(4),
            #transactions-table th:nth-child(6), /* الوجهة */
            #transactions-table td:nth-child(6),
            #transactions-table th:nth-child(9), /* المبلغ */
            #transactions-table td:nth-child(9),
            #transactions-table th:nth-child(10), /* الرصيد */
            #transactions-table td:nth-child(10) {
                min-width: 80px;
            }
            
            /* تحسين عرض الوجهة على الهواتف */
            #transactions-table td:nth-child(6) {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* تحسين عرض اسم المسافر على الهواتف */
            #transactions-table td:nth-child(4) {
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* تعديل عرض التبويبات للهواتف */
            .tab {
                padding: 14px 10px;
                font-size: 0.95rem;
            }
            
            /* تحسين الملخص للهواتف */
            .summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .summary-box {
                padding: 12px;
            }
            
            .summary-box .value {
                font-size: 1.3rem;
            }
            
            .summary-box h3 {
                font-size: 0.85rem;
            }
            
            /* تحسين منطقة معلومات الشركة للهواتف */
            .company-info {
                flex-direction: column;
                align-items: flex-start;
                padding: 12px;
            }
            
            .company-info h3 {
                text-align: right;
                font-size: 1.3rem;
                width: 100%;
            }
            
            .company-balance {
                width: 100%;
                text-align: center;
                font-size: 1.4rem;
                margin-top: 10px;
                padding: 10px;
            }
            
            /* تحسين الترويسة للهواتف */
            header {
                padding: 18px 12px;
            }
            
            .logo h1 {
                font-size: 1.6rem;
            }
            
            .logo-icon {
                width: 65px;
                height: 65px;
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 0.95rem;
                line-height: 1.5;
            }
            
            /* تحسين خيارات الراديو للهواتف */
            .radio-group {
                flex-direction: column;
            }
            
            .radio-option {
                justify-content: flex-start;
                padding: 12px;
            }
            
            /* تحسين عرض الجدول للإدارة للهواتف */
            #manage-transactions-table {
                min-width: 650px;
                font-size: 0.78rem;
            }
            
            #manage-transactions-table th,
            #manage-transactions-table td {
                padding: 9px 6px;
            }
            
            /* تحسين الأزرار في جدول الإدارة للهواتف */
            .action-buttons {
                flex-direction: column;
                gap: 6px;
                min-width: 100px;
            }
            
            .action-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            
            /* إظهار مؤشر التمرير للهواتف */
            .scroll-indicator {
                display: block;
            }
            
            /* تحسين التقرير على الهواتف */
            .report-section {
                padding: 15px 10px;
            }
            
            .report-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .company-report-title {
                font-size: 1.4rem;
                text-align: center;
            }
            
            .btn-print {
                width: 100%;
                padding: 12px;
            }
            
            /* تحسين شريط التمرير للهواتف */
            .table-container::-webkit-scrollbar {
                height: 6px;
            }
            
            .table-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
                margin: 0 10px;
            }
            
            .table-container::-webkit-scrollbar-thumb {
                background: var(--secondary-color);
                border-radius: 10px;
            }
            
            /* تحسين فلاتر إدارة العمليات للهواتف */
            .filter-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            #reset-filters {
                width: 100%;
                margin-top: 0;
            }
        }
        
        /* عناصر الطباعة المخفية */
        .print-page,
        .print-header,
        .print-logo,
        .print-logo-icon,
        .print-title,
        .print-company-info,
        .print-balance-summary,
        .print-balance-types,
        .print-footer,
        .print-signature {
            display: none;
        }
        
        /* تحسينات إضافية للهواتف الصغيرة جداً */
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            /* إخفاء المزيد من الأعمدة في كشف الحساب للهواتف الصغيرة */
            #transactions-table th:nth-child(2), /* التاريخ */
            #transactions-table td:nth-child(2) {
                display: none;
            }
            
            /* إظهار العناصر المهمة فقط */
            #transactions-table {
                min-width: 600px;
                font-size: 0.75rem;
            }
            
            #transactions-table th,
            #transactions-table td {
                padding: 8px 5px;
            }
            
            /* تحسين الملخص للهواتف الصغيرة */
            .summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-box {
                padding: 10px;
            }
            
            .summary-box .value {
                font-size: 1.5rem;
            }
            
            /* تحسين التبويبات للهواتف الصغيرة */
            .tabs {
                flex-direction: column;
                border-radius: 8px;
                overflow: hidden;
            }
            
            .tab {
                border-bottom: 1px solid #eee;
                border-right: 3px solid transparent;
                padding: 16px;
                text-align: right;
            }
            
            .tab.active {
                border-bottom: 1px solid #eee;
                border-right: 3px solid var(--secondary-color);
                background-color: #f0f7ff;
            }
            
            /* تحسين منطقة إضافة عملية للهواتف الصغيرة */
            .form-section {
                padding: 15px 12px;
            }
            
            h2 {
                font-size: 1.3rem;
                flex-direction: column;
                align-items: flex-start;
            }
            
            h2 span {
                margin-top: 5px;
                font-size: 0.9rem;
            }
            
            /* تحسين الأزرار للهواتف الصغيرة */
            .btn {
                padding: 14px 16px;
                font-size: 1rem;
                margin-top: 10px;
            }
            
            /* تحسين مربع الشركة للهواتف الصغيرة */
            .company-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .company-item-actions {
                width: 100%;
            }
            
            .delete-company {
                width: 100%;
                padding: 10px;
            }
            
            /* تحسين مؤشر التمرير للهواتف الصغيرة */
            .scroll-indicator {
                font-size: 0.65rem;
                padding: 5px 10px;
                right: 5px;
            }
            
            /* تحسين عرض الشركة الحالية للهواتف الصغيرة */
            .company-info h3 {
                font-size: 1.2rem;
            }
            
            .company-balance {
                font-size: 1.3rem;
            }
            
            /* تحسين النافذة المنبثقة للهواتف الصغيرة */
            .modal-content {
                padding: 15px;
                margin: 10px;
            }
            
            .modal-header h3 {
                font-size: 1.3rem;
            }
        }
        
        /* تحسينات للأجهزة اللوحية */
        @media (min-width: 769px) and (max-width: 1024px) {
            #transactions-table {
                min-width: 900px;
                font-size: 0.82rem;
            }
            
            #transactions-table th,
            #transactions-table td {
                padding: 11px 8px;
            }
            
            /* إخفاء بعض الأعمدة على الأجهزة اللوحية لتحسين القراءة */
            #transactions-table th:nth-child(7), /* الرحلة */
            #transactions-table td:nth-child(7),
            #transactions-table th:nth-child(8), /* السبب */
            #transactions-table td:nth-child(8) {
                display: none;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- عناصر الطباعة المخفية -->
    <div class="print-page">
        <div class="print-header">
            <div class="print-logo">
                <div class="print-logo-icon">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="print-title">
                    <h1>نظام تذاكر</h1>
                    <p>برنامج إدارة بيانات التذاكر والمبالغ - متابعة العمليات المالية مع الشركات</p>
                </div>
            </div>
        </div>
        
        <div class="print-company-info">
            <h2 class="print-company-name" id="print-company-name">كشف الحساب</h2>
            <div class="print-company-details">
                <p>تاريخ الطباعة: <span id="current-print-date"></span></p>
                <p id="print-company-balance-info">الرصيد الحالي: <span id="print-current-balance">0 دينار</span></p>
            </div>
        </div>
        
        <div class="print-balance-summary">
            <div class="print-balance-row">
                <span class="print-balance-label">عدد التذاكر:</span>
                <span class="print-balance-value" id="print-total-tickets">0</span>
            </div>
            <div class="print-balance-row">
                <span class="print-balance-label">إجمالي الغرامات:</span>
                <span class="print-balance-value" id="print-total-fines">0 دينار</span>
            </div>
            <div class="print-balance-row">
                <span class="print-balance-label">إجمالي التسليمات:</span>
                <span class="print-balance-value" id="print-total-payments">0 دينار</span>
            </div>
            <div class="print-total-balance">
                الرصيد النهائي: <span id="print-final-balance-amount" class="neutral-balance-print">0 دينار</span>
            </div>
        </div>
        
        <div class="print-balance-types" id="print-balance-types">
            <!-- سيتم تعبئتها بواسطة الجافاسكريبت -->
        </div>
        
        <div class="print-footer">
            <p>نظام تذاكر &copy; 2023 - برنامج إدارة بيانات التذاكر والمبالغ</p>
            <p>جميع العمليات المالية مسجلة ومتابعة بشكل آمن</p>
            <p>صفحة 1 من 1 - تم إنشاء هذا التقرير تلقائياً</p>
            
            <div class="print-signature">
                <div class="signature-line"></div>
                <div class="signature-label">التوقيع والختم</div>
            </div>
        </div>
    </div>
    
    <header class="no-print">
        <div class="logo">
            <div class="logo-row">
                <div class="logo-icon">
                    <i class="fas fa-plane airplane-icon"></i>
                </div>
                <h1>نظام تذاكر</h1>
            </div>
        </div>
        <p class="subtitle">برنامج إدارة بيانات التذاكر والمبالغ - متابعة العمليات المالية مع الشركات</p>
    </header>
    
    <!-- تبويبات التنقل -->
    <div class="tabs no-print">
        <div class="tab active" data-tab="add">إضافة عملية</div>
        <div class="tab" data-tab="report">كشف الحساب</div>
        <div class="tab" data-tab="manage">إدارة العمليات</div>
    </div>
    
    <div class="container">
        <!-- تبويب إضافة عملية -->
        <div class="tab-content form-section active" id="add-tab">
            <h2><i class="fas fa-plus-circle"></i> تسجيل عملية جديدة</h2>
            
            <!-- تمييز نوع العملية النشط -->
            <div id="active-type-indicator" class="hidden">
                <!-- سيتم تعبئته بواسطة الجافاسكريبت -->
            </div>
            
            <!-- إدارة الشركات -->
            <button class="btn btn-add-company" id="open-add-company-modal">
                <i class="fas fa-plus"></i> إضافة شركة جديدة
            </button>
            
            <div class="company-list" id="company-list">
                <p id="no-companies">لا توجد شركات مضافة بعد</p>
            </div>
            
            <div class="company-selector">
                <label for="company">اختر الشركة</label>
                <select id="company">
                    <option value="">-- اختر الشركة --</option>
                </select>
            </div>
            
            <div class="company-info">
                <div>
                    <h3 id="current-company">--</h3>
                    <p style="color: #666; margin-top: 5px; font-size: 0.9rem;">الرصيد الحالي</p>
                </div>
                <div class="company-balance" id="company-balance">0 دينار</div>
            </div>
            
            <div class="form-group">
                <label>نوع العملية</label>
                <div class="radio-group">
                    <div class="radio-option" id="ticket-option">
                        <i class="fas fa-ticket-alt radio-icon"></i>
                        <input type="radio" id="ticket" name="transaction-type" value="ticket" checked>
                        <label for="ticket" class="radio-text-glow">تذكرة</label>
                        <div class="type-indicator">نشط</div>
                    </div>
                    <div class="radio-option" id="fine-option">
                        <i class="fas fa-exclamation-triangle radio-icon"></i>
                        <input type="radio" id="fine" name="transaction-type" value="fine">
                        <label for="fine" class="radio-text-glow">غرامة</label>
                        <div class="type-indicator">نشط</div>
                    </div>
                    <div class="radio-option" id="payment-option">
                        <i class="fas fa-money-bill-wave radio-icon"></i>
                        <input type="radio" id="payment" name="transaction-type" value="payment">
                        <label for="payment" class="radio-text-glow">تسليم دفعة</label>
                        <div class="type-indicator">نشط</div>
                    </div>
                </div>
            </div>
            
            <!-- حقول التذكرة والغرامة -->
            <div id="ticket-fine-fields">
                <div class="form-group">
                    <label for="passenger-name">اسم المسافر</label>
                    <input type="text" id="passenger-name" placeholder="أدخل اسم المسافر">
                </div>
                
                <div class="form-group">
                    <label for="document-number">رقم المستند</label>
                    <input type="text" id="document-number" placeholder="أدخل رقم المستند">
                </div>
                
                <div class="form-group">
                    <label for="destination">الوجهة</label>
                    <select id="destination">
                        <option value="TIP - IST">طرابلس - اسطنبول (TIP - IST)</option>
                        <option value="TIP - ANK">طرابلس - أنقرة (TIP - ANK)</option>
                        <option value="TIP - IZM">طرابلس - إزمير (TIP - IZM)</option>
                        <option value="TIP - BJV">طرابلس - بودروم (TIP - BJV)</option>
                        <option value="TIP - DXB">طرابلس - دبي (TIP - DXB)</option>
                        <option value="TIP - CAI">طرابلس - القاهرة (TIP - CAI)</option>
                        <option value="TIP - MED">طرابلس - المدينة (TIP - MED)</option>
                        <option value="TIP - JED">طرابلس - جدة (TIP - JED)</option>
                        <option value="TIP - TUN">طرابلس - تونس (TIP - TUN)</option>
                        <option value="TIP - ALG">طرابلس - الجزائر (TIP - ALG)</option>
                        <option value="other">وجهة أخرى</option>
                    </select>
                    <input type="text" id="other-destination" placeholder="أدخل الوجهة (مثال: TIP - ROM)" class="hidden">
                </div>
                
                <div class="form-group">
                    <label for="trip-type">نوع الرحلة</label>
                    <select id="trip-type">
                        <option value="ذهاب">ذهاب فقط</option>
                        <option value="ذهاب وعودة">ذهاب وعودة</option>
                    </select>
                </div>
            </div>
            
            <!-- حقول الغرامة فقط -->
            <div id="fine-only-fields" class="hidden">
                <div class="form-group">
                    <label for="fine-reason">سبب الغرامة</label>
                    <textarea id="fine-reason" placeholder="أدخل سبب الغرامة" rows="2"></textarea>
                </div>
            </div>
            
            <!-- حقول التسليم -->
            <div id="payment-fields" class="hidden">
                <div class="form-group">
                    <label for="payment-description">وصف الدفعة</label>
                    <input type="text" id="payment-description" placeholder="مثال: تسليم دفعة شهر أكتوبر">
                </div>
            </div>
            
            <!-- حقول مشتركة -->
            <div class="form-group">
                <label for="amount">المبلغ (دينار)</label>
                <input type="number" id="amount" placeholder="أدخل المبلغ" min="0" step="0.01" inputmode="decimal">
            </div>
            
            <div class="form-group">
                <label for="date">تاريخ العملية</label>
                <input type="date" id="date" value="">
            </div>
            
            <div class="form-group" id="notes-group">
                <label for="notes">ملاحظات إضافية</label>
                <input type="text" id="notes" placeholder="ملاحظات (اختياري)">
            </div>
            
            <button class="btn btn-add" id="add-transaction">
                <i class="fas fa-plus"></i> إضافة العملية
            </button>
            
            <button class="btn btn-reset" id="reset-form">
                <i class="fas fa-redo"></i> مسح النموذج
            </button>
        </div>
        
        <!-- تبويب كشف الحساب -->
        <div class="tab-content report-section" id="report-tab">
            <div class="report-header no-print">
                <h2 class="company-report-title" id="report-company-name">كشف الحساب</h2>
                <button class="btn btn-print no-print" id="print-report">
                    <i class="fas fa-print"></i> طباعة الكشف
                </button>
            </div>
            
            <div class="summary no-print">
                <div class="summary-box">
                    <h3>عدد التذاكر</h3>
                    <div class="value total-tickets" id="total-tickets">0</div>
                </div>
                <div class="summary-box">
                    <h3>إجمالي الغرامات</h3>
                    <div class="value total-fines" id="total-fines">0 دينار</div>
                </div>
                <div class="summary-box">
                    <h3>إجمالي التسليمات</h3>
                    <div class="value total-payments" id="total-payments">0 دينار</div>
                </div>
                <div class="summary-box">
                    <h3>الرصيد النهائي</h3>
                    <div class="value total-amount" id="total-balance">0 دينار</div>
                </div>
            </div>
            
            <div class="table-container">
                <div class="scroll-indicator">← اسحب لرؤية المزيد →</div>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>المسافر</th>
                            <th>المستند</th>
                            <th>الوجهة</th>
                            <th>الرحلة</th>
                            <th>السبب</th>
                            <th>المبلغ</th>
                            <th>الرصيد</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- البيانات ستضاف هنا بواسطة الجافاسكريبت -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-data">
                لا توجد عمليات مسجلة بعد. قم بإضافة عمليات جديدة باستخدام النموذج.
            </div>
        </div>
        
        <!-- تبويب إدارة العمليات -->
        <div class="tab-content manage-section" id="manage-tab">
            <h2><i class="fas fa-cog"></i> إدارة العمليات</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filter-company">تصفية حسب الشركة</label>
                    <select id="filter-company">
                        <option value="">جميع الشركات</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-type">تصفية حسب النوع</label>
                    <select id="filter-type">
                        <option value="">جميع الأنواع</option>
                        <option value="ticket">تذكرة</option>
                        <option value="fine">غرامة</option>
                        <option value="payment">تسليم دفعة</option>
                        <option value="initial">رصيد افتتاحي</option>
                    </select>
                </div>
                
                <button class="btn btn-reset" id="reset-filters" style="margin-top: 0;">
                    <i class="fas fa-filter"></i> إعادة التعيين
                </button>
            </div>
            
            <!-- نموذج التعديل -->
            <div id="edit-form-container" class="hidden">
                <div class="edit-form">
                    <h3><i class="fas fa-edit"></i> تعديل العملية</h3>
                    <div class="form-group">
                        <label for="edit-transaction-type">نوع العملية</label>
                        <select id="edit-transaction-type">
                            <option value="ticket">تذكرة</option>
                            <option value="fine">غرامة</option>
                            <option value="payment">تسليم دفعة</option>
                        </select>
                    </div>
                    
                    <div id="edit-ticket-fields">
                        <div class="form-group">
                            <label for="edit-passenger-name">اسم المسافر</label>
                            <input type="text" id="edit-passenger-name" placeholder="اسم المسافر">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-document-number">رقم المستند</label>
                            <input type="text" id="edit-document-number" placeholder="رقم المستند">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-destination">الوجهة</label>
                            <select id="edit-destination">
                                <option value="TIP - IST">طرابلس - اسطنبول (TIP - IST)</option>
                                <option value="TIP - ANK">طرابلس - أنقرة (TIP - ANK)</option>
                                <option value="TIP - IZM">طرابلس - إزمير (TIP - IZM)</option>
                                <option value="TIP - BJV">طرابلس - بودروم (TIP - BJV)</option>
                                <option value="TIP - DXB">طرابلس - دبي (TIP - DXB)</option>
                                <option value="TIP - CAI">طرابلس - القاهرة (TIP - CAI)</option>
                                <option value="other">وجهة أخرى</option>
                            </select>
                            <input type="text" id="edit-other-destination" placeholder="أدخل الوجهة" class="hidden">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-trip-type">نوع الرحلة</label>
                            <select id="edit-trip-type">
                                <option value="ذهاب">ذهاب فقط</option>
                                <option value="ذهاب وعودة">ذهاب وعودة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="edit-fine-only-fields" class="hidden">
                        <div class="form-group">
                            <label for="edit-fine-reason">سبب الغرامة</label>
                            <textarea id="edit-fine-reason" placeholder="سبب الغرامة" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div id="edit-payment-fields" class="hidden">
                        <div class="form-group">
                            <label for="edit-payment-description">وصف الدفعة</label>
                            <input type="text" id="edit-payment-description" placeholder="وصف الدفعة">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-amount">المبلغ (دينار)</label>
                        <input type="number" id="edit-amount" placeholder="المبلغ" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-date">تاريخ العملية</label>
                        <input type="date" id="edit-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notes">ملاحظات إضافية</label>
                        <input type="text" id="edit-notes" placeholder="ملاحظات">
                    </div>
                    
                    <div class="edit-form-buttons">
                        <button class="btn btn-cancel" id="cancel-edit">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                        <button class="btn btn-save" id="save-edit">
                            <i class="fas fa-save"></i> حفظ التعديلات
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- تأكيد الحذف -->
            <div id="delete-confirm-container" class="hidden">
                <div class="confirm-delete">
                    <h4><i class="fas fa-exclamation-triangle"></i> تأكيد الحذف</h4>
                    <p>هل أنت متأكد من حذف هذه العملية؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-cancel" id="cancel-delete">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                        <button class="btn btn-delete" id="confirm-delete">
                            <i class="fas fa-trash"></i> نعم، احذف
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-container manage-table-container">
                <div class="scroll-indicator">← اسحب لرؤية المزيد →</div>
                <table id="manage-transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>الشركة</th>
                            <th>النوع</th>
                            <th>المسافر</th>
                            <th>المبلغ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="manage-transactions-body">
                        <!-- البيانات ستضاف هنا بواسطة الجافاسكريبت -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-transactions">
                لا توجد عمليات مسجلة بعد. قم بإضافة عمليات جديدة باستخدام تبويب "إضافة عملية".
            </div>
        </div>
    </div>
    
    <!-- نافذة إضافة شركة جديدة -->
    <div id="add-company-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-building"></i> إضافة شركة جديدة</h3>
                <button class="close-modal" id="close-add-company-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="new-company-name">اسم الشركة</label>
                <input type="text" id="new-company-name" placeholder="أدخل اسم الشركة">
            </div>
            
            <div class="initial-balance-section">
                <label>الرصيد الافتتاحي</label>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">حدد إذا كانت الشركة تحتاج منك أو أنت تحتاج من الشركة</p>
                
                <div class="balance-type">
                    <div class="credit-option" id="credit-option">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">دائن</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">الشركة تحتاج منك</div>
                    </div>
                    <div class="debit-option" id="debit-option">
                        <i class="fas fa-money-bill-wave"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">مدين</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">أنت تحتاج من الشركة</div>
                    </div>
                </div>
                
                <div class="balance-explanation">
                    <div id="credit-explanation" class="hidden">
                        <p><strong class="explanation-positive">دائن:</strong> الشركة تحتاج منك مبلغاً (لديك رصيد موجب لدى الشركة)</p>
                    </div>
                    <div id="debit-explanation" class="hidden">
                        <p><strong class="explanation-negative">مدين:</strong> أنت تحتاج من الشركة مبلغاً (لديك رصيد سالب لدى الشركة)</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="initial-balance">المبلغ (دينار)</label>
                    <input type="number" id="initial-balance" placeholder="أدخل المبلغ" min="0" step="0.01" inputmode="decimal">
                </div>
            </div>
            
            <button class="btn btn-add" id="save-new-company">
                <i class="fas fa-save"></i> حفظ الشركة
            </button>
        </div>
    </div>
    
    <footer class="no-print">
        <p>نظام تذاكر &copy; 2023 - برنامج إدارة بيانات التذاكر والمبالغ</p>
        <p>جميع العمليات المالية مسجلة ومتابعة بشكل آمن</p>
    </footer>

    <script>
        // بيانات التطبيق
        let transactions = [];
        let companies = {};
        
        // حالة التطبيق
        let balanceType = 'credit';
        let initialBalance = 0;
        let currentEditTransactionId = null;
        let currentDeleteTransactionId = null;
        
        // عناصر DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // مؤشر نوع العملية النشط
        const activeTypeIndicator = document.getElementById('active-type-indicator');
        
        // إدارة الشركات
        const openAddCompanyModalBtn = document.getElementById('open-add-company-modal');
        const addCompanyModal = document.getElementById('add-company-modal');
        const closeAddCompanyModalBtn = document.getElementById('close-add-company-modal');
        const saveNewCompanyBtn = document.getElementById('save-new-company');
        
        const newCompanyNameInput = document.getElementById('new-company-name');
        const debitOption = document.getElementById('debit-option');
        const creditOption = document.getElementById('credit-option');
        const debitExplanation = document.getElementById('debit-explanation');
        const creditExplanation = document.getElementById('credit-explanation');
        const initialBalanceInput = document.getElementById('initial-balance');
        
        const companyList = document.getElementById('company-list');
        const noCompaniesMsg = document.getElementById('no-companies');
        const companySelect = document.getElementById('company');
        const currentCompanyElement = document.getElementById('current-company');
        const companyBalanceElement = document.getElementById('company-balance');
        const reportCompanyNameElement = document.getElementById('report-company-name');
        const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
        
        // عناصر الطباعة
        const printPage = document.querySelector('.print-page');
        const printCompanyName = document.getElementById('print-company-name');
        const printCurrentBalance = document.getElementById('print-current-balance');
        const currentPrintDate = document.getElementById('current-print-date');
        const printTotalTickets = document.getElementById('print-total-tickets');
        const printTotalFines = document.getElementById('print-total-fines');
        const printTotalPayments = document.getElementById('print-total-payments');
        const printFinalBalanceAmount = document.getElementById('print-final-balance-amount');
        const printBalanceTypes = document.getElementById('print-balance-types');
        
        // عناصر خيارات نوع العملية
        const ticketOption = document.getElementById('ticket-option');
        const fineOption = document.getElementById('fine-option');
        const paymentOption = document.getElementById('payment-option');
        
        // حقول إضافة العملية
        const ticketFineFields = document.getElementById('ticket-fine-fields');
        const fineOnlyFields = document.getElementById('fine-only-fields');
        const passengerNameInput = document.getElementById('passenger-name');
        const documentNumberInput = document.getElementById('document-number');
        const destinationSelect = document.getElementById('destination');
        const otherDestinationInput = document.getElementById('other-destination');
        const tripTypeSelect = document.getElementById('trip-type');
        const fineReasonInput = document.getElementById('fine-reason');
        const paymentFields = document.getElementById('payment-fields');
        const paymentDescriptionInput = document.getElementById('payment-description');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const notesInput = document.getElementById('notes');
        const notesGroup = document.getElementById('notes-group');
        
        // حقول التعديل
        const editFormContainer = document.getElementById('edit-form-container');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editTicketFields = document.getElementById('edit-ticket-fields');
        const editFineOnlyFields = document.getElementById('edit-fine-only-fields');
        const editPaymentFields = document.getElementById('edit-payment-fields');
        const editPassengerNameInput = document.getElementById('edit-passenger-name');
        const editDocumentNumberInput = document.getElementById('edit-document-number');
        const editDestinationSelect = document.getElementById('edit-destination');
        const editOtherDestinationInput = document.getElementById('edit-other-destination');
        const editTripTypeSelect = document.getElementById('edit-trip-type');
        const editFineReasonInput = document.getElementById('edit-fine-reason');
        const editPaymentDescriptionInput = document.getElementById('edit-payment-description');
        const editAmountInput = document.getElementById('edit-amount');
        const editDateInput = document.getElementById('edit-date');
        const editNotesInput = document.getElementById('edit-notes');
        
        // تأكيد الحذف
        const deleteConfirmContainer = document.getElementById('delete-confirm-container');
        
        // فلاتر إدارة العمليات
        const filterCompanySelect = document.getElementById('filter-company');
        const filterTypeSelect = document.getElementById('filter-type');
        const resetFiltersBtn = document.getElementById('reset-filters');
        
        // أزرار
        const addTransactionButton = document.getElementById('add-transaction');
        const resetFormButton = document.getElementById('reset-form');
        const printReportButton = document.getElementById('print-report');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        
        // عناصر التقرير
        const transactionsBody = document.getElementById('transactions-body');
        const manageTransactionsBody = document.getElementById('manage-transactions-body');
        const noDataElement = document.getElementById('no-data');
        const noTransactionsElement = document.getElementById('no-transactions');
        const totalTicketsElement = document.getElementById('total-tickets');
        const totalFinesElement = document.getElementById('total-fines');
        const totalPaymentsElement = document.getElementById('total-payments');
        const totalBalanceElement = document.getElementById('total-balance');
        
        // تعيين تاريخ اليوم كتاريخ افتراضي
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        editDateInput.value = today;
        
        // أحداث التحكم
        // التبويبات
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
                
                if (tabId === 'manage') {
                    updateManageTable();
                }
                
                if (tabId === 'report') {
                    updateReport();
                }
                
                if (tabId === 'add') {
                    updateActiveTypeIndicator();
                }
                
                // تحسين العرض للهواتف
                optimizeForMobile();
            });
        });
        
        // إدارة الشركات
        openAddCompanyModalBtn.addEventListener('click', openAddCompanyModal);
        closeAddCompanyModalBtn.addEventListener('click', closeAddCompanyModal);
        saveNewCompanyBtn.addEventListener('click', saveNewCompany);
        
        // أحداث خيارات الرصيد
        debitOption.addEventListener('click', function() {
            selectBalanceType('debit');
        });
        
        creditOption.addEventListener('click', function() {
            selectBalanceType('credit');
        });
        
        // أحداث الحقول
        companySelect.addEventListener('change', function() {
            const companyName = this.value || '--';
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = companyName === '--' ? 'كشف الحساب' : `كشف حساب: ${companyName}`;
            updateCompanyBalance(this.value);
            updateReport();
            optimizeForMobile();
        });
        
        destinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherDestinationInput.classList.remove('hidden');
            } else {
                otherDestinationInput.classList.add('hidden');
            }
        });
        
        editDestinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                editOtherDestinationInput.classList.remove('hidden');
            } else {
                editOtherDestinationInput.classList.add('hidden');
            }
        });
        
        // تغيير حقول النموذج حسب نوع العملية
        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateFormFields(this.value);
                updateActiveTypeClasses(this.value);
                updateActiveTypeIndicator();
            });
        });
        
        editTransactionTypeSelect.addEventListener('change', function() {
            updateEditFormFields(this.value);
        });
        
        // فلاتر إدارة العمليات
        filterCompanySelect.addEventListener('change', updateManageTable);
        filterTypeSelect.addEventListener('change', updateManageTable);
        resetFiltersBtn.addEventListener('click', function() {
            filterCompanySelect.value = '';
            filterTypeSelect.value = '';
            updateManageTable();
        });
        
        // أزرار العمل
        addTransactionButton.addEventListener('click', addTransaction);
        resetFormButton.addEventListener('click', resetForm);
        printReportButton.addEventListener('click', function() {
            preparePrint();
            setTimeout(() => {
                window.print();
                // إعادة إخفاء عناصر الطباعة بعد الطباعة
                setTimeout(() => {
                    printPage.style.display = 'none';
                }, 100);
            }, 500);
        });
        cancelEditBtn.addEventListener('click', cancelEdit);
        saveEditBtn.addEventListener('click', saveEdit);
        cancelDeleteBtn.addEventListener('click', cancelDelete);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        
        // تحميل البيانات من localStorage
        loadData();
        
        // تحديث واجهة المستخدم
        updateReport();
        updateActiveTypeIndicator();
        updateActiveTypeClasses('ticket'); // تذكرة هي الافتراضية
        
        // دالة تحسين العرض للهواتف
        function optimizeForMobile() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // تحسين عرض الوجهة على الهواتف
                document.querySelectorAll('#transactions-table td:nth-child(6)').forEach(td => {
                    const content = td.textContent;
                    if (content.includes('-')) {
                        const parts = content.split('-');
                        if (parts.length >= 2) {
                            td.innerHTML = parts[0].trim();
                            td.title = content; // إضافة تلميح عند التمرير
                        }
                    }
                });
                
                // تحسين عرض السبب/الوصف
                document.querySelectorAll('#transactions-table td:nth-child(8)').forEach(td => {
                    const content = td.textContent;
                    if (content.length > 15) {
                        td.textContent = content.substring(0, 15) + '...';
                        td.title = content; // إضافة تلميح عند التمرير
                    }
                });
                
                // تحسين عرض اسم المسافر
                document.querySelectorAll('#transactions-table td:nth-child(4)').forEach(td => {
                    const content = td.textContent;
                    if (content.length > 12) {
                        td.textContent = content.substring(0, 12) + '...';
                        td.title = content;
                    }
                });
            }
        }
        
        // دالة تحديث فئات النوع النشط
        function updateActiveTypeClasses(activeType) {
            // إزالة جميع الفئات النشطة أولاً
            ticketOption.classList.remove('active-ticket');
            fineOption.classList.remove('active-fine');
            paymentOption.classList.remove('active-payment');
            
            // إضافة الفئة المناسبة
            if (activeType === 'ticket') {
                ticketOption.classList.add('active-ticket');
            } else if (activeType === 'fine') {
                fineOption.classList.add('active-fine');
            } else if (activeType === 'payment') {
                paymentOption.classList.add('active-payment');
            }
        }
        
        // دالة تحديث مؤشر النوع النشط
        function updateActiveTypeIndicator() {
            let activeType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) activeType = radio.value;
            });
            
            let icon = '';
            let title = '';
            let description = '';
            let className = '';
            
            if (activeType === 'ticket') {
                icon = 'fas fa-ticket-alt';
                title = 'تذكرة';
                description = 'أنت تقوم بتسجيل تذكرة جديدة. الرجاء ملء بيانات المسافر والمستند والوجهة.';
                className = 'active-type-ticket';
            } else if (activeType === 'fine') {
                icon = 'fas fa-exclamation-triangle';
                title = 'غرامة';
                description = 'أنت تقوم بتسجيل غرامة. الرجاء ملء سبب الغرامة وبياناتها.';
                className = 'active-type-fine';
            } else if (activeType === 'payment') {
                icon = 'fas fa-money-bill-wave';
                title = 'تسليم دفعة';
                description = 'أنت تقوم بتسجيل تسليم دفعة للشركة. الرجاء إدخال وصف الدفعة.';
                className = 'active-type-payment';
            }
            
            activeTypeIndicator.innerHTML = `
                <div class="active-type-header ${className}">
                    <div class="active-type-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="active-type-text">
                        <h3>نوع العملية الحالي: ${title}</h3>
                        <p>${description}</p>
                    </div>
                </div>
            `;
            
            activeTypeIndicator.classList.remove('hidden');
        }
        
        // دالة فتح نافذة إضافة شركة
        function openAddCompanyModal() {
            addCompanyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            newCompanyNameInput.value = '';
            selectBalanceType('credit');
            initialBalanceInput.value = '';
            setTimeout(() => newCompanyNameInput.focus(), 100);
        }
        
        // دالة إغلاق نافذة إضافة شركة
        function closeAddCompanyModal() {
            addCompanyModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // دالة اختيار نوع الرصيد
        function selectBalanceType(type) {
            balanceType = type;
            
            if (type === 'debit') {
                debitOption.classList.add('selected');
                creditOption.classList.remove('selected');
                debitExplanation.classList.remove('hidden');
                creditExplanation.classList.add('hidden');
            } else {
                debitOption.classList.remove('selected');
                creditOption.classList.add('selected');
                debitExplanation.classList.add('hidden');
                creditExplanation.classList.remove('hidden');
            }
        }
        
        // دالة حفظ شركة جديدة
        function saveNewCompany() {
            const companyName = newCompanyNameInput.value.trim();
            const balance = parseFloat(initialBalanceInput.value) || 0;
            
            if (companyName === '') {
                alert('يرجى إدخال اسم الشركة');
                newCompanyNameInput.focus();
                return;
            }
            
            if (companies.hasOwnProperty(companyName)) {
                alert('هذه الشركة موجودة مسبقاً');
                return;
            }
            
            let openingBalance = balance;
            if (balanceType === 'debit') {
                openingBalance = -balance;
            }
            
            companies[companyName] = openingBalance;
            
            if (balance > 0) {
                const transaction = {
                    id: generateId(),
                    date: today,
                    type: 'initial',
                    company: companyName,
                    amount: balance,
                    description: `رصيد افتتاحي ${balanceType === 'credit' ? 'دائن (الشركة تحتاج مني)' : 'مدين (أحتاج من الشركة)'}`
                };
                
                transactions.push(transaction);
            }
            
            updateCompanyList();
            updateCompanySelect();
            updateFilterCompanySelect();
            
            companySelect.value = companyName;
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = `كشف حساب: ${companyName}`;
            updateCompanyBalance(companyName);
            
            closeAddCompanyModal();
            saveData();
            
            updateReport();
            updateManageTable();
            optimizeForMobile();
            
            alert('تم إضافة الشركة بنجاح!');
        }
        
        // دالة تحديث حقول النموذج حسب نوع العملية
        function updateFormFields(transactionType) {
            ticketFineFields.classList.add('hidden');
            fineOnlyFields.classList.add('hidden');
            paymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.add('hidden');
                notesGroup.classList.remove('hidden');
            } else if (transactionType === 'fine') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            } else if (transactionType === 'payment') {
                paymentFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            }
        }
        
        // دالة تحديث حقول نموذج التعديل
        function updateEditFormFields(transactionType) {
            editTicketFields.classList.add('hidden');
            editFineOnlyFields.classList.add('hidden');
            editPaymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.add('hidden');
            } else if (transactionType === 'fine') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.remove('hidden');
            } else if (transactionType === 'payment') {
                editPaymentFields.classList.remove('hidden');
            }
        }
        
        // دالة إضافة عملية جديدة
        function addTransaction() {
            const company = companySelect.value;
            if (!company) {
                alert('يرجى اختيار شركة أولاً');
                companySelect.focus();
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            let transactionType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) transactionType = radio.value;
            });
            
            const transaction = {
                id: generateId(),
                date: dateInput.value,
                type: transactionType,
                company: company,
                amount: parseFloat(amountInput.value)
            };
            
            if (transactionType === 'ticket') {
                let destination = destinationSelect.value;
                if (destination === 'other') {
                    destination = otherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        otherDestinationInput.focus();
                        return;
                    }
                }
                
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destination;
                transaction.tripType = tripTypeSelect.value;
                transaction.notes = notesInput.value.trim();
                
                if (transaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    passengerNameInput.focus();
                    return;
                }
                
                if (transaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    documentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destinationSelect.value;
                transaction.tripType = tripTypeSelect.value;
                transaction.reason = fineReasonInput.value.trim();
                
                if (transaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    fineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                transaction.description = paymentDescriptionInput.value.trim();
                
                if (transaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    paymentDescriptionInput.focus();
                    return;
                }
            }
            
            updateCompanyBalanceAfterTransaction(company, transaction.type, transaction.amount);
            
            transactions.push(transaction);
            
            saveData();
            
            updateReport();
            updateCompanyList();
            updateManageTable();
            optimizeForMobile();
            
            resetForm();
            
            alert('تم إضافة العملية بنجاح!');
        }
        
        // دالة التحقق من صحة البيانات
        function validateForm() {
            if (amountInput.value === '' || parseFloat(amountInput.value) <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                amountInput.focus();
                return false;
            }
            
            return true;
        }
        
        // دالة تحديث رصيد الشركة بعد العملية
        function updateCompanyBalanceAfterTransaction(company, type, amount) {
            if (type === 'ticket' || type === 'fine') {
                companies[company] += amount;
            } else if (type === 'payment') {
                companies[company] -= amount;
            }
        }
        
        // دالة تحديث عرض رصيد الشركة
        function updateCompanyBalance(company) {
            if (!company) {
                companyBalanceElement.textContent = '0 دينار';
                companyBalanceElement.className = 'company-balance';
                return;
            }
            
            let balance = companies[company] || 0;
            let balanceText = formatCurrency(Math.abs(balance));
            
            if (balance > 0) {
                companyBalanceElement.className = 'company-balance positive-balance';
                companyBalanceElement.textContent = balanceText + ' (دائن)';
            } else if (balance < 0) {
                companyBalanceElement.className = 'company-balance negative-balance';
                companyBalanceElement.textContent = balanceText + ' (مدين)';
            } else {
                companyBalanceElement.className = 'company-balance';
                companyBalanceElement.textContent = balanceText;
            }
        }
        
        // دالة تحديث قائمة الشركات
        function updateCompanyList() {
            if (Object.keys(companies).length === 0) {
                noCompaniesMsg.style.display = 'block';
                companyList.innerHTML = '<p id="no-companies">لا توجد شركات مضافة بعد</p>';
                return;
            }
            
            noCompaniesMsg.style.display = 'none';
            companyList.innerHTML = '';
            
            Object.keys(companies).sort().forEach(company => {
                const companyItem = document.createElement('div');
                companyItem.className = 'company-item';
                
                const balance = companies[company];
                let balanceText = formatCurrency(Math.abs(balance));
                
                if (balance > 0) {
                    balanceText += ' (دائن)';
                } else if (balance < 0) {
                    balanceText += ' (مدين)';
                }
                
                const balanceClass = balance > 0 ? 'positive-balance' : (balance < 0 ? 'negative-balance' : '');
                
                companyItem.innerHTML = `
                    <div class="company-name">${company}</div>
                    <div class="company-item-balance ${balanceClass}">${balanceText}</div>
                    <div class="company-item-actions">
                        <button class="delete-company" data-company="${company}">حذف</button>
                    </div>
                `;
                
                companyList.appendChild(companyItem);
            });
            
            document.querySelectorAll('.delete-company').forEach(btn => {
                btn.addEventListener('click', function() {
                    const companyToDelete = this.getAttribute('data-company');
                    deleteCompany(companyToDelete);
                });
            });
        }
        
        // دالة حذف شركة
        function deleteCompany(companyName) {
            if (!confirm(`هل أنت متأكد من حذف شركة "${companyName}"؟ سيتم حذف جميع عملياتها أيضاً.`)) {
                return;
            }
            
            delete companies[companyName];
            transactions = transactions.filter(t => t.company !== companyName);
            
            updateCompanyList();
            updateCompanySelect();
            updateFilterCompanySelect();
            updateReport();
            updateManageTable();
            saveData();
            optimizeForMobile();
            
            alert('تم حذف الشركة وعملياتها بنجاح!');
        }
        
        // دالة تحديث قائمة الشركات في select
        function updateCompanySelect() {
            const currentValue = companySelect.value;
            
            companySelect.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                companySelect.value = currentValue;
            }
        }
        
        // دالة تحديث قائمة الشركات في فلتر إدارة العمليات
        function updateFilterCompanySelect() {
            filterCompanySelect.innerHTML = '<option value="">جميع الشركات</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                filterCompanySelect.appendChild(option);
            });
        }
        
        // دالة فتح نموذج التعديل
        function openEditForm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentEditTransactionId = transactionId;
            
            editFormContainer.classList.remove('hidden');
            deleteConfirmContainer.classList.add('hidden');
            
            editTransactionTypeSelect.value = transaction.type;
            updateEditFormFields(transaction.type);
            
            if (transaction.type === 'ticket') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ذهاب';
                editNotesInput.value = transaction.notes || '';
            } else if (transaction.type === 'fine') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ذهاب';
                editFineReasonInput.value = transaction.reason || '';
            } else if (transaction.type === 'payment') {
                editPaymentDescriptionInput.value = transaction.description || '';
            }
            
            editAmountInput.value = transaction.amount;
            editDateInput.value = transaction.date;
            
            editFormContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء التعديل
        function cancelEdit() {
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
        }
        
        // دالة حفظ التعديلات
        function saveEdit() {
            if (!currentEditTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentEditTransactionId);
            if (transactionIndex === -1) return;
            
            const oldTransaction = transactions[transactionIndex];
            const oldAmount = oldTransaction.amount;
            const oldType = oldTransaction.type;
            
            if (oldType === 'ticket' || oldType === 'fine') {
                companies[oldTransaction.company] -= oldAmount;
            } else if (oldType === 'payment') {
                companies[oldTransaction.company] += oldAmount;
            }
            
            const transactionType = editTransactionTypeSelect.value;
            const amount = parseFloat(editAmountInput.value);
            
            if (!amount || amount <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                editAmountInput.focus();
                return;
            }
            
            const updatedTransaction = {
                ...oldTransaction,
                date: editDateInput.value,
                type: transactionType,
                amount: amount
            };
            
            if (transactionType === 'ticket') {
                let destination = editDestinationSelect.value;
                if (destination === 'other') {
                    destination = editOtherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        editOtherDestinationInput.focus();
                        return;
                    }
                }
                
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = destination;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.notes = editNotesInput.value.trim();
                updatedTransaction.reason = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    editPassengerNameInput.focus();
                    return;
                }
                
                if (updatedTransaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    editDocumentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = editDestinationSelect.value;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.reason = editFineReasonInput.value.trim();
                updatedTransaction.notes = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    editFineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                updatedTransaction.description = editPaymentDescriptionInput.value.trim();
                updatedTransaction.passengerName = '';
                updatedTransaction.documentNumber = '';
                updatedTransaction.destination = '';
                updatedTransaction.tripType = '';
                updatedTransaction.reason = '';
                updatedTransaction.notes = '';
                
                if (updatedTransaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    editPaymentDescriptionInput.focus();
                    return;
                }
            }
            
            if (transactionType === 'ticket' || transactionType === 'fine') {
                companies[updatedTransaction.company] += amount;
            } else if (transactionType === 'payment') {
                companies[updatedTransaction.company] -= amount;
            }
            
            transactions[transactionIndex] = updatedTransaction;
            
            saveData();
            updateReport();
            updateCompanyList();
            updateManageTable();
            optimizeForMobile();
            
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
            
            alert('تم تحديث العملية بنجاح!');
        }
        
        // دالة فتح تأكيد الحذف
        function openDeleteConfirm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentDeleteTransactionId = transactionId;
            
            deleteConfirmContainer.classList.remove('hidden');
            editFormContainer.classList.add('hidden');
            
            deleteConfirmContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء الحذف
        function cancelDelete() {
            deleteConfirmContainer.classList.add('hidden');
            currentDeleteTransactionId = null;
        }
        
        // دالة تأكيد الحذف
        function confirmDelete() {
            if (!currentDeleteTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentDeleteTransactionId);
            if (transactionIndex === -1) return;
            
            const transaction = transactions[transactionIndex];
            
            if (confirm(`هل أنت متأكد من حذف هذه العملية؟\n\nالتفاصيل:\n- الشركة: ${transaction.company}\n- النوع: ${getTypeName(transaction.type)}\n- المبلغ: ${formatCurrency(transaction.amount)}\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
                if (transaction.type === 'ticket' || transaction.type === 'fine') {
                    companies[transaction.company] -= transaction.amount;
                } else if (transaction.type === 'payment') {
                    companies[transaction.company] += transaction.amount;
                }
                
                transactions.splice(transactionIndex, 1);
                
                saveData();
                updateReport();
                updateCompanyList();
                updateManageTable();
                optimizeForMobile();
                
                deleteConfirmContainer.classList.add('hidden');
                currentDeleteTransactionId = null;
                
                alert('تم حذف العملية بنجاح!');
            }
        }
        
        // دالة تحديث جدول إدارة العمليات
        function updateManageTable() {
            const filterCompany = filterCompanySelect.value;
            const filterType = filterTypeSelect.value;
            
            let filteredTransactions = [...transactions];
            
            if (filterCompany) {
                filteredTransactions = filteredTransactions.filter(t => t.company === filterCompany);
            }
            
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            
            if (filteredTransactions.length > 0) {
                noTransactionsElement.style.display = 'none';
                manageTransactionsBody.innerHTML = '';
            } else {
                noTransactionsElement.style.display = 'block';
                manageTransactionsBody.innerHTML = '';
                return;
            }
            
            filteredTransactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.className = 'transaction-row';
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                }
                
                let passengerName = transaction.passengerName || transaction.description || '-';
                if (passengerName.length > 20) {
                    passengerName = passengerName.substring(0, 20) + '...';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.company}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn action-btn-edit" data-id="${transaction.id}">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn action-btn-delete" data-id="${transaction.id}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </td>
                `;
                
                manageTransactionsBody.appendChild(row);
            });
            
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openEditForm(transactionId);
                });
            });
            
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openDeleteConfirm(transactionId);
                });
            });
        }
        
        // دالة تحديث كشف الحساب
        function updateReport() {
            const currentCompany = companySelect.value;
            if (currentCompany) {
                reportCompanyNameElement.textContent = `كشف حساب: ${currentCompany}`;
                printCompanyName.textContent = `كشف حساب: ${currentCompany}`;
            } else {
                reportCompanyNameElement.textContent = 'كشف الحساب';
                printCompanyName.textContent = 'كشف الحساب';
            }
            
            updateCompanyBalance(currentCompany);
            
            if (transactions.length > 0) {
                noDataElement.style.display = 'none';
                transactionsBody.innerHTML = '';
            } else {
                noDataElement.style.display = 'block';
                transactionsBody.innerHTML = '';
                updateSummary();
                return;
            }
            
            let filteredTransactions = [];
            let finalBalance = 0;
            
            if (currentCompany) {
                filteredTransactions = transactions.filter(t => t.company === currentCompany);
                finalBalance = companies[currentCompany] || 0;
            } else {
                filteredTransactions = [...transactions];
                finalBalance = Object.values(companies).reduce((sum, balance) => sum + balance, 0);
            }
            
            let runningBalance = 0;
            filteredTransactions.forEach((transaction, index) => {
                if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                    runningBalance += transaction.amount;
                } else if (transaction.type === 'payment') {
                    runningBalance -= transaction.amount;
                }
                
                const row = document.createElement('tr');
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                }
                
                let passengerName = transaction.passengerName || '-';
                let documentNumber = transaction.documentNumber || '-';
                
                let destination = transaction.destination || '-';
                if (destination.includes('(')) {
                    const match = destination.match(/\(([^)]+)\)/);
                    if (match) {
                        destination = `<span class="destination-abbr">${match[1]}</span>`;
                    }
                }
                
                let tripType = transaction.tripType || '-';
                let reasonDesc = transaction.reason || transaction.description || '-';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${documentNumber}</td>
                    <td>${destination}</td>
                    <td>${tripType}</td>
                    <td>${reasonDesc}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td>${formatCurrency(runningBalance)}</td>
                `;
                
                transactionsBody.appendChild(row);
            });
            
            // إضافة صف الرصيد النهائي
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="8">الرصيد النهائي</td>
                <td colspan="2">${formatCurrency(finalBalance)}</td>
            `;
            transactionsBody.appendChild(totalRow);
            
            updateSummary(filteredTransactions, finalBalance);
            optimizeForMobile();
        }
        
        // دالة تحديث الملخص
        function updateSummary(filteredTransactions = null, finalBalance = 0) {
            const transactionsToCalculate = filteredTransactions || transactions;
            
            let totalTickets = 0;
            let totalFines = 0;
            let totalPayments = 0;
            
            transactionsToCalculate.forEach(transaction => {
                if (transaction.type === 'ticket') {
                    totalTickets++;
                } else if (transaction.type === 'fine') {
                    totalFines += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                }
            });
            
            totalTicketsElement.textContent = totalTickets;
            totalFinesElement.textContent = formatCurrency(totalFines);
            totalPaymentsElement.textContent = formatCurrency(totalPayments);
            totalBalanceElement.textContent = formatCurrency(finalBalance);
            
            // تحديث عناصر الطباعة
            printTotalTickets.textContent = totalTickets;
            printTotalFines.textContent = formatCurrency(totalFines);
            printTotalPayments.textContent = formatCurrency(totalPayments);
            printFinalBalanceAmount.textContent = formatCurrency(finalBalance);
            
            const currentCompany = companySelect.value;
            if (currentCompany) {
                const balance = companies[currentCompany] || 0;
                printCurrentBalance.textContent = formatCurrency(Math.abs(balance)) + (balance > 0 ? ' (دائن)' : balance < 0 ? ' (مدين)' : '');
            } else {
                printCurrentBalance.textContent = '0 دينار';
            }
            
            // تحديث ألوان الرصيد النهائي
            if (finalBalance > 0) {
                totalBalanceElement.style.color = 'var(--success-color)';
                printFinalBalanceAmount.className = 'positive-balance-print';
            } else if (finalBalance < 0) {
                totalBalanceElement.style.color = 'var(--accent-color)';
                printFinalBalanceAmount.className = 'negative-balance-print';
            } else {
                totalBalanceElement.style.color = 'var(--primary-color)';
                printFinalBalanceAmount.className = 'neutral-balance-print';
            }
        }
        
        // دالة إعداد الطباعة
        function preparePrint() {
            // إظهار صفحة الطباعة
            printPage.style.display = 'block';
            
            // تحديث تاريخ الطباعة
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-LY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' - ' + now.toLocaleTimeString('ar-LY', {
                hour: '2-digit',
                minute: '2-digit'
            });
            currentPrintDate.textContent = formattedDate;
            
            // تحديث قسم الدائن والمدين
            const currentCompany = companySelect.value;
            let creditText = 'دائن: 0 دينار';
            let debitText = 'مدين: 0 دينار';
            
            if (currentCompany) {
                const balance = companies[currentCompany] || 0;
                if (balance > 0) {
                    creditText = `دائن: ${formatCurrency(balance)}`;
                    debitText = 'مدين: 0 دينار';
                } else if (balance < 0) {
                    creditText = 'دائن: 0 دينار';
                    debitText = `مدين: ${formatCurrency(Math.abs(balance))}`;
                }
            }
            
            printBalanceTypes.innerHTML = `
                <div class="print-credit">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span>${creditText}</span>
                </div>
                <div class="print-debit">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>${debitText}</span>
                </div>
            `;
        }
        
        // دالة إعادة تعيين النموذج
        function resetForm() {
            passengerNameInput.value = '';
            documentNumberInput.value = '';
            destinationSelect.value = 'TIP - IST';
            otherDestinationInput.classList.add('hidden');
            otherDestinationInput.value = '';
            tripTypeSelect.value = 'ذهاب';
            
            fineReasonInput.value = '';
            paymentDescriptionInput.value = '';
            
            amountInput.value = '';
            dateInput.value = today;
            notesInput.value = '';
            
            if (companySelect.value) {
                passengerNameInput.focus();
            }
        }
        
        // دالة الحصول على اسم النوع
        function getTypeName(type) {
            switch(type) {
                case 'ticket': return 'تذكرة';
                case 'fine': return 'غرامة';
                case 'payment': return 'تسليم';
                case 'initial': return 'افتتاحي';
                default: return type;
            }
        }
        
        // دالة توليد معرف فريد
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // دالة تنسيق العملة
        function formatCurrency(amount) {
            const absAmount = Math.abs(amount);
            const formatted = new Intl.NumberFormat('ar-LY', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(absAmount) + ' دينار';
            
            if (amount < 0) {
                return '-' + formatted;
            }
            return formatted;
        }
        
        // دالة حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('ticketSystem_transactions', JSON.stringify(transactions));
            localStorage.setItem('ticketSystem_companies', JSON.stringify(companies));
        }
        
        // دالة تحميل البيانات من localStorage
        function loadData() {
            const savedTransactions = localStorage.getItem('ticketSystem_transactions');
            const savedCompanies = localStorage.getItem('ticketSystem_companies');
            
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            
            if (savedCompanies) {
                companies = JSON.parse(savedCompanies);
                updateCompanySelect();
                updateFilterCompanySelect();
                updateCompanyList();
                optimizeForMobile();
            }
        }
        
        // إغلاق النافذة عند النقر خارجها
        addCompanyModal.addEventListener('click', function(e) {
            if (e.target === addCompanyModal) {
                closeAddCompanyModal();
            }
        });
        
        // اختيار نوع الرصيد الافتراضي
        selectBalanceType('credit');
        
        // إغلاق النافذة بمفتاح ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!addCompanyModal.classList.contains('hidden')) {
                    closeAddCompanyModal();
                }
                if (editFormContainer.classList.contains('hidden') === false) {
                    cancelEdit();
                }
                if (deleteConfirmContainer.classList.contains('hidden') === false) {
                    cancelDelete();
                }
            }
        });
        
        // تحديث تحسينات الهواتف عند تغيير حجم النافذة
        window.addEventListener('resize', optimizeForMobile);
        
        // تهيئة التحسينات عند تحميل الصفحة
        window.addEventListener('load', function() {
            optimizeForMobile();
        });
        
        // إخفاء عناصر الطباعة بعد الطباعة
        window.addEventListener('afterprint', function() {
            printPage.style.display = 'none';
        });
    </script>
</body>
</html>