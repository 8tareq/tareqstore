<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAREK Tickets - نظام متعدد العملات</title>
    <style>
        /* ... جميع أنماط CSS تبقى كما هي ... */
        /* (أترك الأنماط كما هي لأنها طويلة جداً) */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ... جميع عناصر HTML تبقى كما هي ... -->
    <!-- (أترك الهيكل HTML كما هو) -->
    
    <script>
        // بيانات التطبيق
        let transactions = [];
        let companies = {};
        
        // حالة التطبيق
        let currentEditTransactionId = null;
        let currentDeleteTransactionId = null;
        let currentCancelTransactionId = null;
        
        // عملات النظام
        const currencies = {
            'dinar': { name: 'الدينار', symbol: 'دينار', icon: 'fas fa-coins', color: 'var(--dinar-color)', gradient: 'var(--gradient-dinar)' },
            'dollar': { name: 'الدولار', symbol: '$', icon: 'fas fa-dollar-sign', color: 'var(--dollar-color)', gradient: 'var(--gradient-dollar)' },
            'euro': { name: 'اليورو', symbol: '€', icon: 'fas fa-euro-sign', color: 'var(--euro-color)', gradient: 'var(--gradient-euro)' }
        };
        
        // بيانات تجريبية افتراضية
        const demoData = {
            companies: {
                "شركة الطيران التركية": { dinar: 1500.500, dollar: 500.00, euro: 0 },
                "الخطوط الجوية القطرية": { dinar: -800.250, dollar: 1200.00, euro: 300.50 },
                "الاتحاد للطيران": { dinar: 2000.750, dollar: 0, euro: 450.25 }
            },
            transactions: [
                {
                    id: "1",
                    date: "2023-10-15",
                    type: "ticket",
                    company: "شركة الطيران التركية",
                    currency: "dinar",
                    amount: 250.500,
                    passengerName: "أحمد محمد",
                    documentNumber: "TK2023-001",
                    destination: "TIP - IST",
                    tripType: "ذهاب وعودة",
                    notes: "تذكرة عائلية"
                },
                {
                    id: "2",
                    date: "2023-10-18",
                    type: "fine",
                    company: "شركة الطيران التركية",
                    currency: "dinar",
                    amount: 50.000,
                    passengerName: "سامي علي",
                    documentNumber: "TK2023-002",
                    destination: "TIP - IST",
                    tripType: "ذهاب",
                    reason: "تأخير في إصدار التذكرة"
                },
                {
                    id: "3",
                    date: "2023-10-20",
                    type: "payment",
                    company: "شركة الطيران التركية",
                    currency: "dinar",
                    amount: 500.000,
                    description: "تسليم دفعة شهر أكتوبر"
                },
                {
                    id: "4",
                    date: "2023-10-22",
                    type: "ticket",
                    company: "الخطوط الجوية القطرية",
                    currency: "dollar",
                    amount: 350.00,
                    passengerName: "ليلى حسن",
                    documentNumber: "QR2023-001",
                    destination: "TIP - DOH",
                    tripType: "ذهاب وعودة",
                    notes: ""
                },
                {
                    id: "5",
                    date: "2023-10-25",
                    type: "initial",
                    company: "الاتحاد للطيران",
                    currency: "dinar",
                    amount: 2000.750,
                    description: "رصيد افتتاحي دائن (الشركة تحتاج مني)"
                }
            ]
        };
        
        // عناصر DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // مؤشر نوع العملية النشط
        const activeTypeIndicator = document.getElementById('active-type-indicator');
        
        // إدارة الشركات
        const openAddCompanyModalBtn = document.getElementById('open-add-company-modal');
        const addCompanyModal = document.getElementById('add-company-modal');
        const closeAddCompanyModalBtn = document.getElementById('close-add-company-modal');
        const saveNewCompanyBtn = document.getElementById('save-new-company');
        
        const newCompanyNameInput = document.getElementById('new-company-name');
        const initialBalanceDinarInput = document.getElementById('initial-balance-dinar');
        const initialBalanceDollarInput = document.getElementById('initial-balance-dollar');
        const initialBalanceEuroInput = document.getElementById('initial-balance-euro');
        
        // خيارات أرصدة العملات
        const creditDinarOption = document.getElementById('credit-dinar-option');
        const debitDinarOption = document.getElementById('debit-dinar-option');
        const creditDollarOption = document.getElementById('credit-dollar-option');
        const debitDollarOption = document.getElementById('debit-dollar-option');
        const creditEuroOption = document.getElementById('credit-euro-option');
        const debitEuroOption = document.getElementById('debit-euro-option');
        
        const companyList = document.getElementById('company-list');
        const noCompaniesMsg = document.getElementById('no-companies');
        const companySelect = document.getElementById('company');
        const reportCompanySelect = document.getElementById('report-company');
        const currentCompanyElement = document.getElementById('current-company');
        const companyBalanceDinarElement = document.getElementById('company-balance-dinar');
        const companyBalanceDollarElement = document.getElementById('company-balance-dollar');
        const companyBalanceEuroElement = document.getElementById('company-balance-euro');
        const reportCompanyNameElement = document.getElementById('report-company-name');
        
        // عناصر العملات
        const currencyRadios = document.querySelectorAll('input[name="currency"]');
        const dinarOption = document.getElementById('dinar-option');
        const dollarOption = document.getElementById('dollar-option');
        const euroOption = document.getElementById('euro-option');
        
        // عناصر نوع العملية
        const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
        const ticketOption = document.getElementById('ticket-option');
        const fineOption = document.getElementById('fine-option');
        const paymentOption = document.getElementById('payment-option');
        
        // عناصر الطباعة
        const printPage = document.querySelector('.print-page');
        const printCompanyName = document.getElementById('print-company-name');
        const printCurrencyName = document.getElementById('print-currency-name');
        const printCurrentBalance = document.getElementById('print-current-balance');
        const currentPrintDate = document.getElementById('current-print-date');
        const printTransactionsBody = document.getElementById('print-transactions-body');
        const printSummaryBalance = document.getElementById('print-summary-balance');
        
        // حقول إضافة العملية
        const ticketFineFields = document.getElementById('ticket-fine-fields');
        const fineOnlyFields = document.getElementById('fine-only-fields');
        const passengerNameInput = document.getElementById('passenger-name');
        const documentNumberInput = document.getElementById('document-number');
        const destinationSelect = document.getElementById('destination');
        const otherDestinationInput = document.getElementById('other-destination');
        const tripTypeSelect = document.getElementById('trip-type');
        const fineReasonInput = document.getElementById('fine-reason');
        const paymentFields = document.getElementById('payment-fields');
        const paymentDescriptionInput = document.getElementById('payment-description');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const notesInput = document.getElementById('notes');
        const notesGroup = document.getElementById('notes-group');
        
        // حقول التعديل
        const editFormContainer = document.getElementById('edit-form-container');
        const editCurrencySelect = document.getElementById('edit-currency');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editTicketFields = document.getElementById('edit-ticket-fields');
        const editFineOnlyFields = document.getElementById('edit-fine-only-fields');
        const editPaymentFields = document.getElementById('edit-payment-fields');
        const editPassengerNameInput = document.getElementById('edit-passenger-name');
        const editDocumentNumberInput = document.getElementById('edit-document-number');
        const editDestinationSelect = document.getElementById('edit-destination');
        const editOtherDestinationInput = document.getElementById('edit-other-destination');
        const editTripTypeSelect = document.getElementById('edit-trip-type');
        const editFineReasonInput = document.getElementById('edit-fine-reason');
        const editPaymentDescriptionInput = document.getElementById('edit-payment-description');
        const editAmountInput = document.getElementById('edit-amount');
        const editDateInput = document.getElementById('edit-date');
        const editNotesInput = document.getElementById('edit-notes');
        
        // تأكيد الحذف
        const deleteConfirmContainer = document.getElementById('delete-confirm-container');
        
        // تأكيد الإلغاء
        const cancelTransactionContainer = document.getElementById('cancel-transaction-container');
        const cancelDetails = document.getElementById('cancel-details');
        
        // فلاتر إدارة العمليات
        const filterCompanySelect = document.getElementById('filter-company');
        const filterCurrencySelect = document.getElementById('filter-currency');
        const filterTypeSelect = document.getElementById('filter-type');
        const resetFiltersBtn = document.getElementById('reset-filters');
        
        // كشف الحساب
        const reportCurrencySelect = document.getElementById('report-currency');
        const reportCurrencyBanner = document.getElementById('report-currency-banner');
        const reportCurrencyBannerDollar = document.getElementById('report-currency-banner-dollar');
        const reportCurrencyBannerEuro = document.getElementById('report-currency-banner-euro');
        
        // أزرار
        const addTransactionButton = document.getElementById('add-transaction');
        const resetFormButton = document.getElementById('reset-form');
        const printReportButton = document.getElementById('print-report');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelCancelBtn = document.getElementById('cancel-cancel');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        
        // عناصر التقرير
        const transactionsBody = document.getElementById('transactions-body');
        const manageTransactionsBody = document.getElementById('manage-transactions-body');
        const noDataElement = document.getElementById('no-data');
        const noTransactionsElement = document.getElementById('no-transactions');
        const totalTicketsElement = document.getElementById('total-tickets');
        const totalFinesElement = document.getElementById('total-fines');
        const totalPaymentsElement = document.getElementById('total-payments');
        const totalBalanceElement = document.getElementById('total-balance');
        const summaryBelowTable = document.getElementById('summary-below-table');
        
        // تعيين تاريخ اليوم كتاريخ افتراضي
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        editDateInput.value = today;
        
        // === التحسينات المضافة ===
        
        // دالة تهيئة البيانات
        function initializeData() {
            console.log("بدء تهيئة البيانات...");
            
            // محاولة تحميل البيانات المحفوظة
            const savedTransactions = localStorage.getItem('ticketSystem_transactions');
            const savedCompanies = localStorage.getItem('ticketSystem_companies');
            
            if (savedTransactions && savedCompanies) {
                try {
                    transactions = JSON.parse(savedTransactions);
                    companies = JSON.parse(savedCompanies);
                    console.log("تم تحميل البيانات بنجاح من التخزين المحلي");
                } catch (e) {
                    console.error("خطأ في تحليل البيانات المحفوظة:", e);
                    loadDemoData();
                }
            } else {
                console.log("لا توجد بيانات محفوظة، جاري تحميل بيانات تجريبية");
                loadDemoData();
            }
            
            // التحقق من صحة البيانات
            if (!transactions || !Array.isArray(transactions)) {
                console.warn("بيانات العمليات غير صحيحة، إعادة تعيين");
                transactions = [];
            }
            
            if (!companies || typeof companies !== 'object') {
                console.warn("بيانات الشركات غير صحيحة، إعادة تعيين");
                companies = {};
            }
            
            // تحديث واجهة المستخدم
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            updateCompanyList();
            updateReport();
            updateManageTable();
            updateActiveTypeIndicator();
            updateActiveTypeClasses('ticket');
            updateCurrencyClasses('dinar');
            
            console.log("تهيئة البيانات اكتملت:", {
                companies: Object.keys(companies).length,
                transactions: transactions.length
            });
        }
        
        // دالة تحميل البيانات التجريبية
        function loadDemoData() {
            console.log("تحميل البيانات التجريبية...");
            companies = JSON.parse(JSON.stringify(demoData.companies));
            transactions = JSON.parse(JSON.stringify(demoData.transactions));
            
            // حفظ البيانات في التخزين المحلي
            saveData();
        }
        
        // دالة التحقق من صلاحية localStorage
        function isLocalStorageAvailable() {
            try {
                const testKey = '__test__';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                console.error("localStorage غير متاح:", e);
                return false;
            }
        }
        
        // دالة محسنة لحفظ البيانات
        function saveData() {
            if (!isLocalStorageAvailable()) {
                console.warn("لا يمكن حفظ البيانات، localStorage غير متاح");
                return;
            }
            
            try {
                localStorage.setItem('ticketSystem_transactions', JSON.stringify(transactions));
                localStorage.setItem('ticketSystem_companies', JSON.stringify(companies));
                console.log("تم حفظ البيانات بنجاح");
            } catch (e) {
                console.error("خطأ في حفظ البيانات:", e);
                alert("تنبيه: لم يتم حفظ البيانات بسبب مشكلة في التخزين المحلي. يرجى تصدير البيانات يدوياً.");
            }
        }
        
        // دالة إعادة تعيين جميع البيانات
        function resetAllData() {
            if (confirm("هل أنت متأكد من إعادة تعيين جميع البيانات؟ سيتم حذف جميع الشركات والعمليات ولا يمكن التراجع عن هذا الإجراء.")) {
                transactions = [];
                companies = {};
                saveData();
                initializeData();
                alert("تم إعادة تعيين جميع البيانات بنجاح!");
            }
        }
        
        // دالة تصدير البيانات
        function exportData() {
            const data = {
                companies: companies,
                transactions: transactions,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tickets_backup_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert("تم تصدير البيانات بنجاح!");
        }
        
        // دالة استيراد البيانات
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.companies || !importedData.transactions) {
                            throw new Error("ملف غير صالح");
                        }
                        
                        if (confirm(`هل تريد استيراد البيانات؟\n- الشركات: ${Object.keys(importedData.companies).length}\n- العمليات: ${importedData.transactions.length}\n\nسيتم استبدال البيانات الحالية.`)) {
                            companies = importedData.companies;
                            transactions = importedData.transactions;
                            saveData();
                            initializeData();
                            alert("تم استيراد البيانات بنجاح!");
                        }
                    } catch (error) {
                        alert("خطأ في استيراد البيانات: الملف غير صالح أو تالف");
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // === نهاية التحسينات المضافة ===
        
        // أحداث التحكم
        // التبويبات
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
                
                if (tabId === 'manage') {
                    updateManageTable();
                }
                
                if (tabId === 'report') {
                    updateReport();
                }
                
                if (tabId === 'add') {
                    updateActiveTypeIndicator();
                }
                
                // تحسين العرض للهواتف
                optimizeForMobile();
            });
        });
        
        // إدارة الشركات
        openAddCompanyModalBtn.addEventListener('click', openAddCompanyModal);
        closeAddCompanyModalBtn.addEventListener('click', closeAddCompanyModal);
        saveNewCompanyBtn.addEventListener('click', saveNewCompany);
        
        // أحداث خيارات الرصيد للعملات
        debitDinarOption.addEventListener('click', function() {
            selectBalanceType('dinar', 'debit');
        });
        
        creditDinarOption.addEventListener('click', function() {
            selectBalanceType('dinar', 'credit');
        });
        
        debitDollarOption.addEventListener('click', function() {
            selectBalanceType('dollar', 'debit');
        });
        
        creditDollarOption.addEventListener('click', function() {
            selectBalanceType('dollar', 'credit');
        });
        
        debitEuroOption.addEventListener('click', function() {
            selectBalanceType('euro', 'debit');
        });
        
        creditEuroOption.addEventListener('click', function() {
            selectBalanceType('euro', 'credit');
        });
        
        // أحداث الحقول
        companySelect.addEventListener('change', function() {
            const companyName = this.value || '--';
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = companyName === '--' ? 'كشف الحساب' : `كشف حساب: ${companyName}`;
            updateCompanyBalanceDisplay(this.value);
            updateReport();
            optimizeForMobile();
        });
        
        // حدث اختيار الشركة في التقرير
        reportCompanySelect.addEventListener('change', function() {
            updateReport();
        });
        
        // حدث اختيار العملة في التقرير
        reportCurrencySelect.addEventListener('change', function() {
            updateReport();
        });
        
        destinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherDestinationInput.classList.remove('hidden');
                otherDestinationInput.focus();
            } else {
                otherDestinationInput.classList.add('hidden');
            }
        });
        
        editDestinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                editOtherDestinationInput.classList.remove('hidden');
                editOtherDestinationInput.focus();
            } else {
                editOtherDestinationInput.classList.add('hidden');
            }
        });
        
        // تغيير حقول النموذج حسب نوع العملية
        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateFormFields(this.value);
                updateActiveTypeClasses(this.value);
                updateActiveTypeIndicator();
            });
        });
        
        // تغيير خيارات العملة
        currencyRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateCurrencyClasses(this.value);
                updateActiveTypeIndicator();
            });
        });
        
        editTransactionTypeSelect.addEventListener('change', function() {
            updateEditFormFields(this.value);
        });
        
        editCurrencySelect.addEventListener('change', function() {
            // تحديث لون النموذج حسب العملة
            updateEditFormCurrency(this.value);
        });
        
        // فلاتر إدارة العمليات
        filterCompanySelect.addEventListener('change', updateManageTable);
        filterCurrencySelect.addEventListener('change', updateManageTable);
        filterTypeSelect.addEventListener('change', updateManageTable);
        resetFiltersBtn.addEventListener('click', function() {
            filterCompanySelect.value = '';
            filterCurrencySelect.value = '';
            filterTypeSelect.value = '';
            updateManageTable();
            this.classList.add('pulse');
            setTimeout(() => this.classList.remove('pulse'), 1000);
        });
        
        // أزرار العمل
        addTransactionButton.addEventListener('click', addTransaction);
        resetFormButton.addEventListener('click', resetForm);
        printReportButton.addEventListener('click', function() {
            preparePrint();
            setTimeout(() => {
                window.print();
                // إعادة إخفاء عناصر الطباعة بعد الطباعة
                setTimeout(() => {
                    printPage.style.display = 'none';
                }, 100);
            }, 500);
        });
        cancelEditBtn.addEventListener('click', cancelEdit);
        saveEditBtn.addEventListener('click', saveEdit);
        cancelDeleteBtn.addEventListener('click', cancelDelete);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        cancelCancelBtn.addEventListener('click', cancelCancel);
        confirmCancelBtn.addEventListener('click', confirmCancel);
        
        // === التحسينات المضافة ===
        
        // إضافة أزرار إدارة البيانات في الترويسة
        document.addEventListener('DOMContentLoaded', function() {
            // إضافة أزرار إدارة البيانات في الترويسة
            const headerInfo = document.querySelector('.header-info');
            const dataButtons = document.createElement('div');
            dataButtons.className = 'data-management-buttons';
            dataButtons.style.marginTop = '15px';
            dataButtons.style.display = 'flex';
            dataButtons.style.gap = '10px';
            dataButtons.style.flexWrap = 'wrap';
            
            dataButtons.innerHTML = `
                <button class="btn btn-add" id="load-demo-data" style="padding: 10px 15px; font-size: 0.9rem;">
                    <i class="fas fa-download"></i> بيانات تجريبية
                </button>
                <button class="btn btn-edit" id="export-data" style="padding: 10px 15px; font-size: 0.9rem;">
                    <i class="fas fa-save"></i> تصدير
                </button>
                <button class="btn btn-delete" id="reset-data" style="padding: 10px 15px; font-size: 0.9rem;">
                    <i class="fas fa-trash"></i> إعادة تعيين
                </button>
            `;
            
            headerInfo.appendChild(dataButtons);
            
            // أحداث الأزرار الجديدة
            document.getElementById('load-demo-data').addEventListener('click', function() {
                if (confirm("هل تريد تحميل البيانات التجريبية؟ سيتم استبدال البيانات الحالية.")) {
                    loadDemoData();
                    initializeData();
                    alert("تم تحميل البيانات التجريبية بنجاح!");
                }
            });
            
            document.getElementById('export-data').addEventListener('click', exportData);
            
            document.getElementById('reset-data').addEventListener('click', resetAllData);
            
            // إضافة زر استيراد
            const importButton = document.createElement('button');
            importButton.className = 'btn btn-add';
            importButton.innerHTML = '<i class="fas fa-upload"></i> استيراد';
            importButton.style.padding = '10px 15px';
            importButton.style.fontSize = '0.9rem';
            importButton.addEventListener('click', importData);
            dataButtons.appendChild(importButton);
            
            // تهيئة البيانات عند تحميل الصفحة
            initializeData();
            
            // عرض رسالة ترحيبية
            setTimeout(() => {
                if (transactions.length === 0 && Object.keys(companies).length === 0) {
                    alert("مرحباً بك في نظام TAREK Tickets!\n\nتم تحميل بيانات تجريبية للاختبار. يمكنك:\n1. تجربة النظام مع البيانات التجريبية\n2. حذفها وإضافة بياناتك الخاصة\n3. استخدام أزرار إدارة البيانات في الأعلى للتصدير والاستيراد");
                }
            }, 1000);
        });
        
        // === نهاية التحسينات المضافة ===
        
        // دالة تحسين العرض للهواتف
        function optimizeForMobile() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // تحسين عرض الوجهة على الهواتف
                document.querySelectorAll('#transactions-table td:nth-child(6)').forEach(td => {
                    const content = td.textContent;
                    if (content.includes('-')) {
                        const parts = content.split('-');
                        if (parts.length >= 2) {
                            td.innerHTML = parts[0].trim();
                            td.title = content; // إضافة تلميح عند التمرير
                        }
                    }
                });
                
                // تحسين عرض السبب/الوصف
                document.querySelectorAll('#transactions-table td:nth-child(8)').forEach(td => {
                    const content = td.textContent;
                    if (content.length > 15) {
                        td.textContent = content.substring(0, 15) + '...';
                        td.title = content; // إضافة تلميح عند التمرير
                    }
                });
                
                // تحسين عرض اسم المسافر
                document.querySelectorAll('#transactions-table td:nth-child(4)').forEach(td => {
                    const content = td.textContent;
                    if (content.length > 12) {
                        td.textContent = content.substring(0, 12) + '...';
                        td.title = content;
                    }
                });
            }
        }
        
        // دالة تحديث فئات العملة النشطة
        function updateCurrencyClasses(activeCurrency) {
            // إزالة جميع الفئات النشطة أولاً
            dinarOption.classList.remove('active-dinar');
            dollarOption.classList.remove('active-dollar');
            euroOption.classList.remove('active-euro');
            
            // إضافة الفئة المناسبة
            if (activeCurrency === 'dinar') {
                dinarOption.classList.add('active-dinar');
            } else if (activeCurrency === 'dollar') {
                dollarOption.classList.add('active-dollar');
            } else if (activeCurrency === 'euro') {
                euroOption.classList.add('active-euro');
            }
        }
        
        // دالة تحديث فئات النوع النشط
        function updateActiveTypeClasses(activeType) {
            // إزالة جميع الفئات النشطة أولاً
            ticketOption.classList.remove('active-ticket');
            fineOption.classList.remove('active-fine');
            paymentOption.classList.remove('active-payment');
            
            // إضافة الفئة المناسبة
            if (activeType === 'ticket') {
                ticketOption.classList.add('active-ticket');
            } else if (activeType === 'fine') {
                fineOption.classList.add('active-fine');
            } else if (activeType === 'payment') {
                paymentOption.classList.add('active-payment');
            }
        }
        
        // دالة تحديث مؤشر النوع النشط
        function updateActiveTypeIndicator() {
            let activeType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) activeType = radio.value;
            });
            
            let activeCurrency = '';
            currencyRadios.forEach(radio => {
                if (radio.checked) activeCurrency = radio.value;
            });
            
            let icon = '';
            let title = '';
            let description = '';
            let className = '';
            let currencyName = currencies[activeCurrency]?.name || 'الدينار';
            
            if (activeType === 'ticket') {
                icon = 'fas fa-ticket-alt';
                title = 'تذكرة';
                description = `أنت تقوم بتسجيل تذكرة جديدة بال${currencyName}. الرجاء ملء بيانات المسافر والمستند والوجهة.`;
                className = 'active-type-ticket';
            } else if (activeType === 'fine') {
                icon = 'fas fa-exclamation-triangle';
                title = 'غرامة';
                description = `أنت تقوم بتسجيل غرامة بال${currencyName}. الرجاء ملء سبب الغرامة وبياناتها.`;
                className = 'active-type-fine';
            } else if (activeType === 'payment') {
                icon = 'fas fa-money-bill-wave';
                title = 'تسليم دفعة';
                description = `أنت تقوم بتسجيل تسليم دفعة للشركة بال${currencyName}. الرجاء إدخال وصف الدفعة.`;
                className = 'active-type-payment';
            }
            
            activeTypeIndicator.innerHTML = `
                <div class="active-type-header ${className}">
                    <div class="active-type-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="active-type-text">
                        <h3>نوع العملية الحالي: ${title} (${currencyName})</h3>
                        <p>${description}</p>
                    </div>
                </div>
            `;
            
            activeTypeIndicator.classList.remove('hidden');
        }
        
        // دالة اختيار نوع الرصيد للعملة
        function selectBalanceType(currency, type) {
            // إعادة تعيين جميع الخيارات أولاً
            document.querySelectorAll('.balance-type .debit-option, .balance-type .credit-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // تحديد الخيار المحدد
            if (currency === 'dinar') {
                if (type === 'debit') {
                    debitDinarOption.classList.add('selected');
                    creditDinarOption.classList.remove('selected');
                } else {
                    debitDinarOption.classList.remove('selected');
                    creditDinarOption.classList.add('selected');
                }
            } else if (currency === 'dollar') {
                if (type === 'debit') {
                    debitDollarOption.classList.add('selected');
                    creditDollarOption.classList.remove('selected');
                } else {
                    debitDollarOption.classList.remove('selected');
                    creditDollarOption.classList.add('selected');
                }
            } else if (currency === 'euro') {
                if (type === 'debit') {
                    debitEuroOption.classList.add('selected');
                    creditEuroOption.classList.remove('selected');
                } else {
                    debitEuroOption.classList.remove('selected');
                    creditEuroOption.classList.add('selected');
                }
            }
        }
        
        // دالة فتح نافذة إضافة شركة
        function openAddCompanyModal() {
            addCompanyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            newCompanyNameInput.value = '';
            initialBalanceDinarInput.value = '';
            initialBalanceDollarInput.value = '';
            initialBalanceEuroInput.value = '';
            
            // تعيين الافتراضيات
            selectBalanceType('dinar', 'credit');
            selectBalanceType('dollar', 'credit');
            selectBalanceType('euro', 'credit');
            
            setTimeout(() => newCompanyNameInput.focus(), 100);
        }
        
        // دالة إغلاق نافذة إضافة شركة
        function closeAddCompanyModal() {
            addCompanyModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // دالة حفظ شركة جديدة
        function saveNewCompany() {
            const companyName = newCompanyNameInput.value.trim();
            
            if (companyName === '') {
                alert('يرجى إدخال اسم الشركة');
                newCompanyNameInput.focus();
                return;
            }
            
            if (companies.hasOwnProperty(companyName)) {
                alert('هذه الشركة موجودة مسبقاً');
                return;
            }
            
            // إنشاء كائن الشركة مع أرصدة العملات
            companies[companyName] = {
                dinar: 0,
                dollar: 0,
                euro: 0
            };
            
            // إضافة أرصدة افتتاحية إذا كانت موجودة
            const dinarBalance = parseFloat(initialBalanceDinarInput.value) || 0;
            const dollarBalance = parseFloat(initialBalanceDollarInput.value) || 0;
            const euroBalance = parseFloat(initialBalanceEuroInput.value) || 0;
            
            // تحديد نوع الرصيد لكل عملة
            const isDinarDebit = debitDinarOption.classList.contains('selected');
            const isDollarDebit = debitDollarOption.classList.contains('selected');
            const isEuroDebit = debitEuroOption.classList.contains('selected');
            
            // تحديث أرصدة الشركة
            if (dinarBalance > 0) {
                companies[companyName].dinar = isDinarDebit ? -dinarBalance : dinarBalance;
                
                // إضافة معاملة افتتاحية للدينار
                if (dinarBalance > 0) {
                    const transaction = {
                        id: generateId(),
                        date: today,
                        type: 'initial',
                        company: companyName,
                        currency: 'dinar',
                        amount: dinarBalance,
                        description: `رصيد افتتاحي ${isDinarDebit ? 'مدين (أحتاج من الشركة)' : 'دائن (الشركة تحتاج مني)'}`
                    };
                    
                    transactions.push(transaction);
                }
            }
            
            if (dollarBalance > 0) {
                companies[companyName].dollar = isDollarDebit ? -dollarBalance : dollarBalance;
                
                // إضافة معاملة افتتاحية للدولار
                if (dollarBalance > 0) {
                    const transaction = {
                        id: generateId(),
                        date: today,
                        type: 'initial',
                        company: companyName,
                        currency: 'dollar',
                        amount: dollarBalance,
                        description: `رصيد افتتاحي ${isDollarDebit ? 'مدين (أحتاج من الشركة)' : 'دائن (الشركة تحتاج مني)'}`
                    };
                    
                    transactions.push(transaction);
                }
            }
            
            if (euroBalance > 0) {
                companies[companyName].euro = isEuroDebit ? -euroBalance : euroBalance;
                
                // إضافة معاملة افتتاحية لليورو
                if (euroBalance > 0) {
                    const transaction = {
                        id: generateId(),
                        date: today,
                        type: 'initial',
                        company: companyName,
                        currency: 'euro',
                        amount: euroBalance,
                        description: `رصيد افتتاحي ${isEuroDebit ? 'مدين (أحتاج من الشركة)' : 'دائن (الشركة تحتاج مني)'}`
                    };
                    
                    transactions.push(transaction);
                }
            }
            
            updateCompanyList();
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            
            companySelect.value = companyName;
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = `كشف حساب: ${companyName}`;
            updateCompanyBalanceDisplay(companyName);
            
            closeAddCompanyModal();
            saveData();
            
            updateReport();
            updateManageTable();
            optimizeForMobile();
            
            alert('تم إضافة الشركة بنجاح!');
        }
        
        // دالة تحديث حقول النموذج حسب نوع العملية
        function updateFormFields(transactionType) {
            ticketFineFields.classList.add('hidden');
            fineOnlyFields.classList.add('hidden');
            paymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.add('hidden');
                notesGroup.classList.remove('hidden');
            } else if (transactionType === 'fine') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            } else if (transactionType === 'payment') {
                paymentFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            }
        }
        
        // دالة تحديث حقول نموذج التعديل
        function updateEditFormFields(transactionType) {
            editTicketFields.classList.add('hidden');
            editFineOnlyFields.classList.add('hidden');
            editPaymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.add('hidden');
            } else if (transactionType === 'fine') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.remove('hidden');
            } else if (transactionType === 'payment') {
                editPaymentFields.classList.remove('hidden');
            }
        }
        
        // دالة تحديث لون نموذج التعديل حسب العملة
        function updateEditFormCurrency(currency) {
            // تحديث لون حدود النموذج حسب العملة
            const editForm = document.querySelector('.edit-form');
            editForm.style.borderColor = currencies[currency]?.color || 'rgba(74, 0, 224, 0.1)';
        }
        
        // دالة إضافة عملية جديدة
        function addTransaction() {
            const company = companySelect.value;
            if (!company) {
                alert('يرجى اختيار شركة أولاً');
                companySelect.focus();
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            let transactionType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) transactionType = radio.value;
            });
            
            let currency = '';
            currencyRadios.forEach(radio => {
                if (radio.checked) currency = radio.value;
            });
            
            const transaction = {
                id: generateId(),
                date: dateInput.value,
                type: transactionType,
                company: company,
                currency: currency,
                amount: parseFloat(amountInput.value)
            };
            
            if (transactionType === 'ticket') {
                let destination = destinationSelect.value;
                if (destination === 'other') {
                    destination = otherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        otherDestinationInput.focus();
                        return;
                    }
                }
                
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destination;
                transaction.tripType = tripTypeSelect.value;
                transaction.notes = notesInput.value.trim();
                
                if (transaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    passengerNameInput.focus();
                    return;
                }
                
                if (transaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    documentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destinationSelect.value;
                transaction.tripType = tripTypeSelect.value;
                transaction.reason = fineReasonInput.value.trim();
                
                if (transaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    fineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                transaction.description = paymentDescriptionInput.value.trim();
                
                if (transaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    paymentDescriptionInput.focus();
                    return;
                }
            }
            
            // تحديث رصيد الشركة للعملة المحددة
            updateCompanyBalanceAfterTransaction(company, currency, transaction.type, transaction.amount);
            
            transactions.push(transaction);
            
            saveData();
            
            updateReport();
            updateCompanyList();
            updateCompanyBalanceDisplay(company);
            updateManageTable();
            optimizeForMobile();
            
            resetForm();
            
            alert('تم إضافة العملية بنجاح!');
        }
        
        // دالة التحقق من صحة البيانات
        function validateForm() {
            if (amountInput.value === '' || parseFloat(amountInput.value) <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                amountInput.focus();
                return false;
            }
            
            return true;
        }
        
        // دالة تحديث رصيد الشركة بعد العملية
        function updateCompanyBalanceAfterTransaction(company, currency, type, amount) {
            if (type === 'ticket' || type === 'fine') {
                companies[company][currency] += amount;
            } else if (type === 'payment') {
                companies[company][currency] -= amount;
            } else if (type === 'cancel') {
                // لا يتغير الرصيد مع عملية الإلغاء لأنها عملية معاكسة
                // يتم تحديث الرصيد عند إضافة العملية الأصلية
            } else if (type === 'initial') {
                companies[company][currency] += amount;
            }
        }
        
        // دالة تحديث عرض رصيد الشركة
        function updateCompanyBalanceDisplay(company) {
            if (!company || !companies[company]) {
                companyBalanceDinarElement.textContent = '0 دينار';
                companyBalanceDollarElement.textContent = '0 $';
                companyBalanceEuroElement.textContent = '0 €';
                return;
            }
            
            const dinarBalance = companies[company].dinar || 0;
            const dollarBalance = companies[company].dollar || 0;
            const euroBalance = companies[company].euro || 0;
            
            companyBalanceDinarElement.textContent = formatCurrency(dinarBalance, 'dinar');
            companyBalanceDollarElement.textContent = formatCurrency(dollarBalance, 'dollar');
            companyBalanceEuroElement.textContent = formatCurrency(euroBalance, 'euro');
        }
        
        // دالة تحديث قائمة الشركات
        function updateCompanyList() {
            if (Object.keys(companies).length === 0) {
                noCompaniesMsg.style.display = 'block';
                companyList.innerHTML = '<p id="no-companies">لا توجد شركات مضافة بعد</p>';
                return;
            }
            
            noCompaniesMsg.style.display = 'none';
            companyList.innerHTML = '';
            
            Object.keys(companies).sort().forEach(company => {
                const companyItem = document.createElement('div');
                companyItem.className = 'company-item';
                
                const dinarBalance = companies[company].dinar || 0;
                const dollarBalance = companies[company].dollar || 0;
                const euroBalance = companies[company].euro || 0;
                
                companyItem.innerHTML = `
                    <div class="company-name">${company}</div>
                    <div class="company-balances">
                        <div class="company-balance-item balance-dinar-item">
                            <i class="fas fa-coins"></i>
                            <span>${formatCurrency(dinarBalance, 'dinar')}</span>
                        </div>
                        <div class="company-balance-item balance-dollar-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span>${formatCurrency(dollarBalance, 'dollar')}</span>
                        </div>
                        <div class="company-balance-item balance-euro-item">
                            <i class="fas fa-euro-sign"></i>
                            <span>${formatCurrency(euroBalance, 'euro')}</span>
                        </div>
                    </div>
                    <div class="company-item-actions">
                        <button class="delete-company" data-company="${company}">حذف</button>
                    </div>
                `;
                
                companyList.appendChild(companyItem);
            });
            
            document.querySelectorAll('.delete-company').forEach(btn => {
                btn.addEventListener('click', function() {
                    const companyToDelete = this.getAttribute('data-company');
                    deleteCompany(companyToDelete);
                });
            });
        }
        
        // دالة حذف شركة
        function deleteCompany(companyName) {
            if (!confirm(`هل أنت متأكد من حذف شركة "${companyName}"؟ سيتم حذف جميع عملياتها أيضاً.`)) {
                return;
            }
            
            delete companies[companyName];
            transactions = transactions.filter(t => t.company !== companyName);
            
            updateCompanyList();
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            updateReport();
            updateManageTable();
            saveData();
            optimizeForMobile();
            
            alert('تم حذف الشركة وعملياتها بنجاح!');
        }
        
        // دالة تحديث قائمة الشركات في select
        function updateCompanySelect() {
            const currentValue = companySelect.value;
            
            companySelect.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                companySelect.value = currentValue;
            }
        }
        
        // دالة تحديث قائمة الشركات في select التقرير
        function updateReportCompanySelect() {
            const currentValue = reportCompanySelect.value;
            
            reportCompanySelect.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                reportCompanySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                reportCompanySelect.value = currentValue;
            }
        }
        
        // دالة تحديث قائمة الشركات في فلتر إدارة العمليات
        function updateFilterCompanySelect() {
            filterCompanySelect.innerHTML = '<option value="">جميع الشركات</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                filterCompanySelect.appendChild(option);
            });
        }
        
        // دالة فتح نموذج التعديل
        function openEditForm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentEditTransactionId = transactionId;
            
            editFormContainer.classList.remove('hidden');
            deleteConfirmContainer.classList.add('hidden');
            cancelTransactionContainer.classList.add('hidden');
            
            editCurrencySelect.value = transaction.currency;
            editTransactionTypeSelect.value = transaction.type;
            updateEditFormFields(transaction.type);
            updateEditFormCurrency(transaction.currency);
            
            if (transaction.type === 'ticket') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ذهاب';
                editNotesInput.value = transaction.notes || '';
            } else if (transaction.type === 'fine') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ذهاب';
                editFineReasonInput.value = transaction.reason || '';
            } else if (transaction.type === 'payment') {
                editPaymentDescriptionInput.value = transaction.description || '';
            }
            
            editAmountInput.value = transaction.amount;
            editDateInput.value = transaction.date;
            
            editFormContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء التعديل
        function cancelEdit() {
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
        }
        
        // دالة حفظ التعديلات
        function saveEdit() {
            if (!currentEditTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentEditTransactionId);
            if (transactionIndex === -1) return;
            
            const oldTransaction = transactions[transactionIndex];
            const oldAmount = oldTransaction.amount;
            const oldType = oldTransaction.type;
            const oldCurrency = oldTransaction.currency;
            
            // التراجع عن تأثير العملية القديمة على رصيد الشركة
            if (oldType === 'ticket' || oldType === 'fine' || oldType === 'initial') {
                companies[oldTransaction.company][oldCurrency] -= oldAmount;
            } else if (oldType === 'payment') {
                companies[oldTransaction.company][oldCurrency] += oldAmount;
            } else if (oldType === 'cancel') {
                // لا يتغير الرصيد مع عملية الإلغاء
            }
            
            const transactionType = editTransactionTypeSelect.value;
            const currency = editCurrencySelect.value;
            const amount = parseFloat(editAmountInput.value);
            
            if (!amount || amount <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                editAmountInput.focus();
                return;
            }
            
            const updatedTransaction = {
                ...oldTransaction,
                date: editDateInput.value,
                type: transactionType,
                currency: currency,
                amount: amount
            };
            
            if (transactionType === 'ticket') {
                let destination = editDestinationSelect.value;
                if (destination === 'other') {
                    destination = editOtherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('يرجى إدخال الوجهة');
                        editOtherDestinationInput.focus();
                        return;
                    }
                }
                
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = destination;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.notes = editNotesInput.value.trim();
                updatedTransaction.reason = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.passengerName === '') {
                    alert('يرجى إدخال اسم المسافر للتذكرة');
                    editPassengerNameInput.focus();
                    return;
                }
                
                if (updatedTransaction.documentNumber === '') {
                    alert('يرجى إدخال رقم المستند للتذكرة');
                    editDocumentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = editDestinationSelect.value;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.reason = editFineReasonInput.value.trim();
                updatedTransaction.notes = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.reason === '') {
                    alert('يرجى إدخال سبب الغرامة');
                    editFineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                updatedTransaction.description = editPaymentDescriptionInput.value.trim();
                updatedTransaction.passengerName = '';
                updatedTransaction.documentNumber = '';
                updatedTransaction.destination = '';
                updatedTransaction.tripType = '';
                updatedTransaction.reason = '';
                updatedTransaction.notes = '';
                
                if (updatedTransaction.description === '') {
                    alert('يرجى إدخال وصف الدفعة');
                    editPaymentDescriptionInput.focus();
                    return;
                }
            }
            
            // تطبيق تأثير العملية الجديدة على رصيد الشركة
            if (transactionType === 'ticket' || transactionType === 'fine' || transactionType === 'initial') {
                companies[updatedTransaction.company][currency] += amount;
            } else if (transactionType === 'payment') {
                companies[updatedTransaction.company][currency] -= amount;
            } else if (transactionType === 'cancel') {
                // لا يتغير الرصيد مع عملية الإلغاء
            }
            
            transactions[transactionIndex] = updatedTransaction;
            
            saveData();
            updateReport();
            updateCompanyList();
            updateCompanyBalanceDisplay(updatedTransaction.company);
            updateManageTable();
            optimizeForMobile();
            
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
            
            alert('تم تحديث العملية بنجاح!');
        }
        
        // دالة فتح تأكيد الحذف
        function openDeleteConfirm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentDeleteTransactionId = transactionId;
            
            deleteConfirmContainer.classList.remove('hidden');
            editFormContainer.classList.add('hidden');
            cancelTransactionContainer.classList.add('hidden');
            
            deleteConfirmContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء الحذف
        function cancelDelete() {
            deleteConfirmContainer.classList.add('hidden');
            currentDeleteTransactionId = null;
        }
        
        // دالة تأكيد الحذف
        function confirmDelete() {
            if (!currentDeleteTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentDeleteTransactionId);
            if (transactionIndex === -1) return;
            
            const transaction = transactions[transactionIndex];
            
            if (confirm(`هل أنت متأكد من حذف هذه العملية؟\n\nالتفاصيل:\n- الشركة: ${transaction.company}\n- العملة: ${currencies[transaction.currency]?.name}\n- النوع: ${getTypeName(transaction.type)}\n- المبلغ: ${formatCurrency(transaction.amount, transaction.currency)}\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
                // التراجع عن تأثير العملية على رصيد الشركة
                if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                    companies[transaction.company][transaction.currency] -= transaction.amount;
                } else if (transaction.type === 'payment') {
                    companies[transaction.company][transaction.currency] += transaction.amount;
                } else if (transaction.type === 'cancel') {
                    // لا يتغير الرصيد عند حذف عملية إلغاء
                }
                
                transactions.splice(transactionIndex, 1);
                
                saveData();
                updateReport();
                updateCompanyList();
                updateCompanyBalanceDisplay(transaction.company);
                updateManageTable();
                optimizeForMobile();
                
                deleteConfirmContainer.classList.add('hidden');
                currentDeleteTransactionId = null;
                
                alert('تم حذف العملية بنجاح!');
            }
        }
        
        // دالة فتح تأكيد الإلغاء
        function openCancelConfirm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentCancelTransactionId = transactionId;
            
            // لا يمكن إلغاء عملية إلغاء
            if (transaction.type === 'cancel') {
                alert('لا يمكن إلغاء عملية إلغاء!');
                return;
            }
            
            // تحضير تفاصيل الإلغاء
            const cancelType = getCancelType(transaction.type);
            const newAmount = transaction.amount;
            
            cancelDetails.innerHTML = `
                <p><strong>العملية الأصلية:</strong></p>
                <ul>
                    <li><strong>الشركة:</strong> ${transaction.company}</li>
                    <li><strong>العملة:</strong> ${currencies[transaction.currency]?.name}</li>
                    <li><strong>النوع:</strong> ${getTypeName(transaction.type)}</li>
                    <li><strong>المبلغ:</strong> ${formatCurrency(transaction.amount, transaction.currency)}</li>
                    <li><strong>التاريخ:</strong> ${transaction.date}</li>
                    ${transaction.passengerName ? `<li><strong>المسافر:</strong> ${transaction.passengerName}</li>` : ''}
                    ${transaction.description ? `<li><strong>الوصف:</strong> ${transaction.description}</li>` : ''}
                </ul>
                <p><strong>العملية الجديدة (معكوسة):</strong></p>
                <ul>
                    <li><strong>النوع:</strong> ${getTypeName(cancelType)}</li>
                    <li><strong>المبلغ:</strong> ${formatCurrency(newAmount, transaction.currency)}</li>
                    <li><strong>التاريخ:</strong> اليوم</li>
                </ul>
                <p class="warning-text" style="color: var(--cancel-color); font-weight: bold; margin-top: 10px;">
                    سيتم إضافة عملية جديدة معكوسة لتحييد المبلغ الأصلي.
                </p>
            `;
            
            cancelTransactionContainer.classList.remove('hidden');
            editFormContainer.classList.add('hidden');
            deleteConfirmContainer.classList.add('hidden');
            
            cancelTransactionContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // دالة إلغاء عملية الإلغاء
        function cancelCancel() {
            cancelTransactionContainer.classList.add('hidden');
            currentCancelTransactionId = null;
        }
        
        // دالة تأكيد الإلغاء
        function confirmCancel() {
            if (!currentCancelTransactionId) return;
            
            const originalTransaction = transactions.find(t => t.id === currentCancelTransactionId);
            if (!originalTransaction) return;
            
            // إنشاء عملية إلغاء معاكسة
            const cancelTransaction = {
                id: generateId(),
                date: today,
                type: 'cancel',
                company: originalTransaction.company,
                currency: originalTransaction.currency,
                amount: originalTransaction.amount,
                originalTransactionId: originalTransaction.id,
                cancelType: getCancelType(originalTransaction.type)
            };
            
            // نسخ البيانات من العملية الأصلية
            if (originalTransaction.type === 'ticket' || originalTransaction.type === 'fine') {
                cancelTransaction.passengerName = originalTransaction.passengerName;
                cancelTransaction.documentNumber = originalTransaction.documentNumber;
                cancelTransaction.destination = originalTransaction.destination;
                cancelTransaction.tripType = originalTransaction.tripType;
                cancelTransaction.reason = originalTransaction.reason;
                cancelTransaction.notes = `إلغاء عملية ${getTypeName(originalTransaction.type)} بتاريخ ${originalTransaction.date}`;
            } else if (originalTransaction.type === 'payment') {
                cancelTransaction.description = `إلغاء دفعة: ${originalTransaction.description}`;
            }
            
            // تحديث رصيد الشركة (عملية معاكسة)
            if (originalTransaction.type === 'ticket' || originalTransaction.type === 'fine' || originalTransaction.type === 'initial') {
                companies[originalTransaction.company][originalTransaction.currency] -= originalTransaction.amount;
            } else if (originalTransaction.type === 'payment') {
                companies[originalTransaction.company][originalTransaction.currency] += originalTransaction.amount;
            }
            
            transactions.push(cancelTransaction);
            
            saveData();
            updateReport();
            updateCompanyList();
            updateCompanyBalanceDisplay(originalTransaction.company);
            updateManageTable();
            optimizeForMobile();
            
            cancelTransactionContainer.classList.add('hidden');
            currentCancelTransactionId = null;
            
            alert('تم إضافة عملية الإلغاء بنجاح! تم تحييد المبلغ الأصلي.');
        }
        
        // دالة الحصول على نوع العملية المعاكسة للإلغاء
        function getCancelType(originalType) {
            if (originalType === 'ticket' || originalType === 'fine' || originalType === 'initial') {
                return 'payment'; // تذاكر وغرامات ورصيد افتتاحي تلغى بدفعات
            } else if (originalType === 'payment') {
                return 'ticket'; // دفعات تلغى بتذاكر
            }
            return 'cancel';
        }
        
        // دالة تحديث جدول إدارة العمليات
        function updateManageTable() {
            const filterCompany = filterCompanySelect.value;
            const filterCurrency = filterCurrencySelect.value;
            const filterType = filterTypeSelect.value;
            
            let filteredTransactions = [...transactions];
            
            if (filterCompany) {
                filteredTransactions = filteredTransactions.filter(t => t.company === filterCompany);
            }
            
            if (filterCurrency) {
                filteredTransactions = filteredTransactions.filter(t => t.currency === filterCurrency);
            }
            
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            
            if (filteredTransactions.length > 0) {
                noTransactionsElement.style.display = 'none';
                manageTransactionsBody.innerHTML = '';
            } else {
                noTransactionsElement.style.display = 'block';
                manageTransactionsBody.innerHTML = '';
                return;
            }
            
            filteredTransactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.className = 'transaction-row';
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                } else if (transaction.type === 'cancel') {
                    typeClass = 'transaction-cancel';
                    typeText = 'إلغاء';
                }
                
                let passengerName = transaction.passengerName || transaction.description || '-';
                if (passengerName.length > 20) {
                    passengerName = passengerName.substring(0, 20) + '...';
                }
                
                // تحديد لون وشكل العملة
                let currencyBadgeClass = '';
                let currencySymbol = '';
                if (transaction.currency === 'dinar') {
                    currencyBadgeClass = 'currency-dinar';
                    currencySymbol = 'دينار';
                } else if (transaction.currency === 'dollar') {
                    currencyBadgeClass = 'currency-dollar';
                    currencySymbol = '$';
                } else if (transaction.currency === 'euro') {
                    currencyBadgeClass = 'currency-euro';
                    currencySymbol = '€';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.company}</td>
                    <td><span class="currency-badge ${currencyBadgeClass}">${currencySymbol}</span></td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${formatCurrency(transaction.amount, transaction.currency)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn action-btn-edit" data-id="${transaction.id}">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            ${transaction.type !== 'cancel' ? `<button class="action-btn action-btn-cancel" data-id="${transaction.id}">
                                <i class="fas fa-exchange-alt"></i> إلغاء
                            </button>` : ''}
                            <button class="action-btn action-btn-delete" data-id="${transaction.id}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </td>
                `;
                
                manageTransactionsBody.appendChild(row);
            });
            
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openEditForm(transactionId);
                });
            });
            
            document.querySelectorAll('.action-btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openCancelConfirm(transactionId);
                });
            });
            
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openDeleteConfirm(transactionId);
                });
            });
        }
        
        // دالة تحديث كشف الحساب
        function updateReport() {
            const selectedCompany = reportCompanySelect.value || companySelect.value;
            const selectedCurrency = reportCurrencySelect.value;
            
            // تحديث لافتة العملة
            reportCurrencyBanner.style.display = 'none';
            reportCurrencyBannerDollar.style.display = 'none';
            reportCurrencyBannerEuro.style.display = 'none';
            
            if (selectedCurrency === 'dinar') {
                reportCurrencyBanner.style.display = 'block';
            } else if (selectedCurrency === 'dollar') {
                reportCurrencyBannerDollar.style.display = 'block';
            } else if (selectedCurrency === 'euro') {
                reportCurrencyBannerEuro.style.display = 'block';
            }
            
            if (selectedCompany) {
                reportCompanyNameElement.textContent = `كشف حساب: ${selectedCompany}`;
                printCompanyName.textContent = `كشف حساب: ${selectedCompany}`;
            } else {
                reportCompanyNameElement.textContent = 'كشف الحساب';
                printCompanyName.textContent = 'كشف الحساب';
            }
            
            updateCompanyBalanceDisplay(selectedCompany);
            
            if (transactions.length > 0) {
                noDataElement.style.display = 'none';
                summaryBelowTable.style.display = 'block';
                transactionsBody.innerHTML = '';
            } else {
                noDataElement.style.display = 'block';
                summaryBelowTable.style.display = 'none';
                transactionsBody.innerHTML = '';
                updateSummary();
                return;
            }
            
            let filteredTransactions = [];
            let finalBalance = 0;
            
            if (selectedCompany) {
                filteredTransactions = transactions.filter(t => t.company === selectedCompany && t.currency === selectedCurrency);
                finalBalance = companies[selectedCompany] ? companies[selectedCompany][selectedCurrency] || 0 : 0;
            } else {
                filteredTransactions = transactions.filter(t => t.currency === selectedCurrency);
                finalBalance = Object.values(companies).reduce((sum, company) => sum + (company[selectedCurrency] || 0), 0);
            }
            
            let runningBalance = 0;
            filteredTransactions.forEach((transaction, index) => {
                if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                    runningBalance += transaction.amount;
                } else if (transaction.type === 'payment' || transaction.type === 'cancel') {
                    runningBalance -= transaction.amount;
                }
                
                const row = document.createElement('tr');
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                } else if (transaction.type === 'cancel') {
                    typeClass = 'transaction-cancel';
                    typeText = 'إلغاء';
                }
                
                let passengerName = transaction.passengerName || '-';
                let documentNumber = transaction.documentNumber || '-';
                
                let destination = transaction.destination || '-';
                if (destination.includes('(')) {
                    const match = destination.match(/\(([^)]+)\)/);
                    if (match) {
                        destination = `<span class="destination-abbr">${match[1]}</span>`;
                    }
                }
                
                let tripType = transaction.tripType || '-';
                let reasonDesc = transaction.reason || transaction.description || '-';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td>${documentNumber}</td>
                    <td>${destination}</td>
                    <td>${tripType}</td>
                    <td>${reasonDesc}</td>
                    <td>${formatCurrency(transaction.amount, transaction.currency)}</td>
                    <td>${formatCurrency(runningBalance, transaction.currency)}</td>
                `;
                
                transactionsBody.appendChild(row);
            });
            
            // إضافة صف الرصيد النهائي في الجدول
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="8">الرصيد النهائي</td>
                <td colspan="2">${formatCurrency(finalBalance, selectedCurrency)}</td>
            `;
            transactionsBody.appendChild(totalRow);
            
            updateSummary(filteredTransactions, finalBalance, selectedCurrency);
            optimizeForMobile();
        }
        
        // دالة تحديث الملخص تحت الجدول
        function updateSummary(filteredTransactions = null, finalBalance = 0, currency = 'dinar') {
            const transactionsToCalculate = filteredTransactions || transactions.filter(t => t.currency === currency);
            
            let totalTickets = 0;
            let totalFines = 0;
            let totalPayments = 0;
            let totalCancels = 0;
            
            transactionsToCalculate.forEach(transaction => {
                if (transaction.type === 'ticket') {
                    totalTickets++;
                } else if (transaction.type === 'fine') {
                    totalFines += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                } else if (transaction.type === 'cancel') {
                    totalCancels += transaction.amount;
                } else if (transaction.type === 'initial') {
                    // لا يتم احتساب الرصيد الافتتاحي في الملخص
                }
            });
            
            totalTicketsElement.textContent = totalTickets;
            totalFinesElement.textContent = formatCurrency(totalFines, currency);
            totalPaymentsElement.textContent = formatCurrency(totalPayments, currency);
            totalBalanceElement.textContent = formatCurrency(finalBalance, currency);
            
            // تحديث ألوان الرصيد النهائي
            if (finalBalance > 0) {
                totalBalanceElement.className = 'value positive';
            } else if (finalBalance < 0) {
                totalBalanceElement.className = 'value negative';
            } else {
                totalBalanceElement.className = 'value';
            }
        }
        
        // دالة تحديث جدول الطباعة
        function updatePrintTable(filteredTransactions = null, finalBalance = 0, currency = 'dinar') {
            const currentCompany = reportCompanySelect.value || companySelect.value;
            const currentCurrency = reportCurrencySelect.value;
            const transactionsToShow = filteredTransactions || transactions.filter(t => 
                (!currentCompany || t.company === currentCompany) && t.currency === currentCurrency
            );
            
            printTransactionsBody.innerHTML = '';
            
            if (transactionsToShow.length === 0) {
                return;
            }
            
            let runningBalance = 0;
            transactionsToShow.forEach((transaction, index) => {
                if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                    runningBalance += transaction.amount;
                } else if (transaction.type === 'payment' || transaction.type === 'cancel') {
                    runningBalance -= transaction.amount;
                }
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.passengerName || '-'}</td>
                    <td>${transaction.documentNumber || '-'}</td>
                    <td>${formatCurrency(transaction.amount, transaction.currency)}</td>
                    <td>${formatCurrency(runningBalance, transaction.currency)}</td>
                `;
                
                printTransactionsBody.appendChild(row);
            });
            
            // تحديث الرصيد النهائي في الطباعة
            printSummaryBalance.textContent = formatCurrency(finalBalance, currency);
            
            // تحديث لون الرصيد النهائي
            if (finalBalance > 0) {
                printSummaryBalance.className = 'positive-balance-print';
            } else if (finalBalance < 0) {
                printSummaryBalance.className = 'negative-balance-print';
            } else {
                printSummaryBalance.className = 'neutral-balance-print';
            }
        }
        
        // دالة إعداد الطباعة
        function preparePrint() {
            // إظهار صفحة الطباعة
            printPage.style.display = 'block';
            
            // تحديث تاريخ الطباعة
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-LY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' - ' + now.toLocaleTimeString('ar-LY', {
                hour: '2-digit',
                minute: '2-digit'
            });
            currentPrintDate.textContent = formattedDate;
            
            // تحديث العملة
            const currentCurrency = reportCurrencySelect.value;
            const currencyInfo = currencies[currentCurrency];
            printCurrencyName.textContent = currencyInfo.name;
            
            // تحديث الرصيد الحالي
            const currentCompany = reportCompanySelect.value || companySelect.value;
            if (currentCompany && companies[currentCompany]) {
                const balance = companies[currentCompany][currentCurrency] || 0;
                printCurrentBalance.textContent = formatCurrency(Math.abs(balance), currentCurrency) + (balance > 0 ? ' (دائن)' : balance < 0 ? ' (مدين)' : '');
            } else {
                printCurrentBalance.textContent = formatCurrency(0, currentCurrency);
            }
            
            // تحديث جدول الطباعة
            let filteredTransactions = [];
            let finalBalance = 0;
            
            if (currentCompany) {
                filteredTransactions = transactions.filter(t => t.company === currentCompany && t.currency === currentCurrency);
                finalBalance = companies[currentCompany] ? companies[currentCompany][currentCurrency] || 0 : 0;
            } else {
                filteredTransactions = transactions.filter(t => t.currency === currentCurrency);
                finalBalance = Object.values(companies).reduce((sum, company) => sum + (company[currentCurrency] || 0), 0);
            }
            
            updatePrintTable(filteredTransactions, finalBalance, currentCurrency);
        }
        
        // دالة إعادة تعيين النموذج
        function resetForm() {
            passengerNameInput.value = '';
            documentNumberInput.value = '';
            destinationSelect.value = 'TIP - IST';
            otherDestinationInput.classList.add('hidden');
            otherDestinationInput.value = '';
            tripTypeSelect.value = 'ذهاب';
            
            fineReasonInput.value = '';
            paymentDescriptionInput.value = '';
            
            amountInput.value = '';
            dateInput.value = today;
            notesInput.value = '';
            
            if (companySelect.value) {
                passengerNameInput.focus();
            }
        }
        
        // دالة الحصول على اسم النوع
        function getTypeName(type) {
            switch(type) {
                case 'ticket': return 'تذكرة';
                case 'fine': return 'غرامة';
                case 'payment': return 'تسليم';
                case 'initial': return 'افتتاحي';
                case 'cancel': return 'إلغاء';
                default: return type;
            }
        }
        
        // دالة توليد معرف فريد
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // دالة تنسيق العملة
        function formatCurrency(amount, currency) {
            const currencyInfo = currencies[currency] || currencies.dinar;
            const absAmount = Math.abs(amount);
            
            let formatted;
            if (currency === 'dinar') {
                formatted = new Intl.NumberFormat('ar-LY', {
                    minimumFractionDigits: 3,
                    maximumFractionDigits: 3
                }).format(absAmount) + ' ' + currencyInfo.symbol;
            } else {
                formatted = new Intl.NumberFormat('ar-LY', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(absAmount) + ' ' + currencyInfo.symbol;
            }
            
            if (amount < 0) {
                return '-' + formatted;
            }
            return formatted;
        }
        
        // إغلاق النافذة عند النقر خارجها
        addCompanyModal.addEventListener('click', function(e) {
            if (e.target === addCompanyModal) {
                closeAddCompanyModal();
            }
        });
        
        // اختيار أنواع الرصيد الافتراضية
        selectBalanceType('dinar', 'credit');
        selectBalanceType('dollar', 'credit');
        selectBalanceType('euro', 'credit');
        
        // إغلاق النافذة بمفتاح ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!addCompanyModal.classList.contains('hidden')) {
                    closeAddCompanyModal();
                }
                if (editFormContainer.classList.contains('hidden') === false) {
                    cancelEdit();
                }
                if (deleteConfirmContainer.classList.contains('hidden') === false) {
                    cancelDelete();
                }
                if (cancelTransactionContainer.classList.contains('hidden') === false) {
                    cancelCancel();
                }
            }
        });
        
        // تحديث تحسينات الهواتف عند تغيير حجم النافذة
        window.addEventListener('resize', optimizeForMobile);
        
        // تهيئة التحسينات عند تحميل الصفحة
        window.addEventListener('load', function() {
            optimizeForMobile();
            // إضافة تأثيرات عند التحميل
            document.querySelectorAll('.form-section, .report-section, .manage-section').forEach((section, index) => {
                section.style.animationDelay = `${0.1 * index}s`;
            });
        });
        
        // إخفاء عناصر الطباعة بعد الطباعة
        window.addEventListener('afterprint', function() {
            printPage.style.display = 'none';
        });
    </script>
</body>
</html>
