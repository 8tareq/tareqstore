<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAREK Tickets - ูุชุนุฏุฏ ุงูุนููุงุช</title>
    <style>
        /* ุฌููุน ุฃููุงุท CSS ุงูุณุงุจูุฉ ุชุธู ููุง ูู ูุน ุฅุถุงูุฉ ุงูุชุนุฏููุงุช ุงูุชุงููุฉ ููุท */
        
        /* ุชุนุฏููุงุช ููุนููุงุช ุงููุชุนุฏุฏุฉ */
        .currency-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .currency-section {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        
        .currency-option {
            padding: 18px;
            border: 2px solid #E0E0FF;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            background-color: white;
        }
        
        .currency-option:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-light);
        }
        
        .currency-option.selected {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, rgba(142, 45, 226, 0.1), rgba(74, 0, 224, 0.05));
            box-shadow: 0 10px 25px rgba(74, 0, 224, 0.15);
        }
        
        .currency-flag {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .currency-code {
            font-weight: 800;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .currency-name {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        /* ุฑุตูุฏ ุงูุดุฑูุฉ ุจุงูุนููุงุช ุงููุชุนุฏุฏุฉ */
        .company-currencies {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (min-width: 480px) {
            .company-currencies {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 768px) {
            .company-currencies {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .currency-balance-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: var(--transition);
            border-right: 3px solid var(--secondary-color);
        }
        
        .currency-balance-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .currency-balance-code {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .currency-balance-amount {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--dark-color);
            direction: ltr;
        }
        
        .currency-balance-amount.positive {
            color: var(--success-color);
        }
        
        .currency-balance-amount.negative {
            color: var(--accent-color);
        }
        
        /* ุชุนุฏููุงุช ุงูููุฎุต */
        .summary-items-currency {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .summary-items-currency {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .currency-total {
            background: linear-gradient(135deg, #F0F4FF, #E8EDFF);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            text-align: center;
            border: 2px solid var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .currency-total h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .currency-total .value {
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        /* ุชุนุฏููุงุช ุงูุฌุฏุงูู */
        .currency-column {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            direction: ltr;
            text-align: left;
        }
        
        .currency-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            background-color: #F0F4FF;
            color: var(--primary-color);
            margin-left: 5px;
        }
        
        /* ุชุนุฏููุงุช ุงูุทุจุงุนุฉ */
        .print-currency-summary {
            display: block !important;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .print-currency-item {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            min-width: 120px;
        }
        
        .print-currency-code {
            font-weight: bold;
            color: #1A1A2E;
            font-size: 14px;
        }
        
        .print-currency-amount {
            font-weight: bold;
            font-size: 16px;
            direction: ltr;
        }
        
        /* ุฑุตูุฏ ุงูุดุฑูุฉ ูู ุงูุทุจุงุนุฉ */
        .print-company-currencies {
            display: block !important;
            text-align: center;
            margin: 15px 0;
        }
        
        .print-currency-balance {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #1A1A2E;
            min-width: 140px;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ุฎูููุฉ ูุชุญุฑูุฉ -->
    <div class="bg-animation">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>
    
    <!-- ุนูุงุตุฑ ุงูุทุจุงุนุฉ ุงููุฎููุฉ -->
    <div class="print-page">
        <div class="print-header">
            <div class="print-logo">
                <div class="print-logo-icon">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="print-title">
                    <h1>TAREK Tickets - ูุชุนุฏุฏ ุงูุนููุงุช</h1>
                    <p>@tro8qa</p>
                </div>
            </div>
        </div>
        
        <div class="print-company-info">
            <h2 class="print-company-name" id="print-company-name">ูุดู ุงูุญุณุงุจ</h2>
            <div class="print-company-details">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <span id="current-print-date"></span></p>
                <p id="print-company-balance-info"><span id="print-current-balance"></span></p>
            </div>
            
            <!-- ุฑุตูุฏ ุงูุดุฑูุฉ ุจุงูุนููุงุช -->
            <div class="print-company-currencies" id="print-company-currencies">
                <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
            </div>
        </div>
        
        <!-- ุฌุฏูู ุงูุทุจุงุนุฉ -->
        <div class="print-table-container">
            <table id="print-transactions-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 12%;">ุงูุชุงุฑูุฎ</th>
                        <th style="width: 15%;">ุงููุณุงูุฑ</th>
                        <th style="width: 12%;">ุงููุณุชูุฏ</th>
                        <th style="width: 15%;">ุงููุจูุบ</th>
                        <th style="width: 15%;">ุงูุงุฌูุงูู</th>
                    </tr>
                </thead>
                <tbody id="print-transactions-body">
                    <!-- ุงูุจูุงูุงุช ุณุชูุณุฎ ููุง -->
                </tbody>
            </table>
        </div>
        
        <!-- ููุฎุต ุงูุนููุงุช ูู ุงูุทุจุงุนุฉ -->
        <div class="print-currency-summary" id="print-currency-summary">
            <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
        </div>
        
        <!-- ูุณู ุงูุฑุตูุฏ ุงูููุงุฆู ูู ุงูุทุจุงุนุฉ -->
        <div class="print-balance-summary" id="print-balance-summary">
            <div class="print-total-balance">
                <div id="print-summary-by-currency">
                    <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
                </div>
            </div>
        </div>
        
        <div class="print-footer">
            <p>TAREK Tickets - ูุชุนุฏุฏ ุงูุนููุงุช &copy; 2023</p>
            <p>@tro8qa</p>
            <p>ุทุงุฑู ุงูุทูู ููุจุฑูุฌูุงุช</p>
            <p> - </p>
            <div class="print-signature">
                <div class="signature-line"></div>
                <div class="signature-label">ุงูุชูููุน ูุงูุฎุชู</div>
            </div>
        </div>
    </div>
    
    <!-- ุชุฑููุณุฉ ุฌุฏูุฏุฉ ุจุชุตููู ุนุตุฑู -->
    <header class="main-header no-print">
        <div class="header-decoration"></div>
        <div class="header-decoration"></div>
        <div class="header-content">
            <div class="header-logo">
                <div class="logo-circle">
                    <i class="fas fa-plane-departure"></i>
                </div>
                <div class="logo-text">
                    <h1>TAREK Tickets - ูุชุนุฏุฏ ุงูุนููุงุช</h1>
                    <p>@tro8qa</p>
                </div>
            </div>
            <div class="header-info">
                <div class="system-name">ุฅุฏุงุฑุฉ ุชุฐุงูุฑ ุงูุทูุฑุงู ุงูุฐููุฉ</div>
                <div class="system-description">ุชุชุจุน ุงูุนูููุงุช ุงููุงููุฉ ูุน ุดุฑูุงุช ุงูุทูุฑุงู ูุงูููุงูุงุช</div>
            </div>
        </div>
    </header>
    
    <!-- ุชุจููุจุงุช ุงูุชููู -->
    <div class="tabs no-print">
        <div class="tab active" data-tab="add">
            <i class="fas fa-plus-circle tab-icon"></i> ุฅุถุงูุฉ ุนูููุฉ
        </div>
        <div class="tab" data-tab="report">
            <i class="fas fa-chart-line tab-icon"></i> ูุดู ุงูุญุณุงุจ
        </div>
        <div class="tab" data-tab="manage">
            <i class="fas fa-cogs tab-icon"></i> ุฅุฏุงุฑุฉ ุงูุนูููุงุช
        </div>
    </div>
    
    <div class="container">
        <!-- ุชุจููุจ ุฅุถุงูุฉ ุนูููุฉ -->
        <div class="tab-content form-section active" id="add-tab">
            <h2><i class="fas fa-plus-circle"></i> ุชุณุฌูู ุนูููุฉ ุฌุฏูุฏุฉ</h2>
            
            <!-- ูุคุดุฑ ููุน ุงูุนูููุฉ ุงููุดุท -->
            <div id="active-type-indicator" class="hidden">
                <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
            </div>
            
            <!-- ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช -->
            <button class="btn btn-add-company" id="open-add-company-modal">
                <i class="fas fa-plus"></i> ุฅุถุงูุฉ ุดุฑูุฉ ุฌุฏูุฏุฉ
            </button>
            
            <div class="company-list" id="company-list">
                <p id="no-companies">ูุง ุชูุฌุฏ ุดุฑูุงุช ูุถุงูุฉ ุจุนุฏ</p>
            </div>
            
            <div class="company-selector">
                <label for="company">ุงุฎุชุฑ ุงูุดุฑูุฉ</label>
                <select id="company">
                    <option value="">-- ุงุฎุชุฑ ุงูุดุฑูุฉ --</option>
                </select>
            </div>
            
            <div class="company-info">
                <div>
                    <h3 id="current-company">--</h3>
                    <p style="color: #666; margin-top: 5px; font-size: 0.9rem;">ุงูุฑุตูุฏ ุงูุญุงูู</p>
                </div>
                <!-- ุฑุตูุฏ ุงูุดุฑูุฉ ุจุงูุนููุงุช ุงููุชุนุฏุฏุฉ -->
                <div class="company-currencies" id="company-currency-balances">
                    <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
                </div>
            </div>
            
            <div class="form-group">
                <label>ููุน ุงูุนูููุฉ</label>
                <div class="radio-group">
                    <div class="radio-option" id="ticket-option">
                        <i class="fas fa-ticket-alt radio-icon"></i>
                        <input type="radio" id="ticket" name="transaction-type" value="ticket" checked>
                        <label for="ticket" class="radio-text-glow">ุชุฐูุฑุฉ</label>
                        <div class="type-indicator">ูุดุท</div>
                    </div>
                    <div class="radio-option" id="fine-option">
                        <i class="fas fa-exclamation-triangle radio-icon"></i>
                        <input type="radio" id="fine" name="transaction-type" value="fine">
                        <label for="fine" class="radio-text-glow">ุบุฑุงูุฉ</label>
                        <div class="type-indicator">ูุดุท</div>
                    </div>
                    <div class="radio-option" id="payment-option">
                        <i class="fas fa-money-bill-wave radio-icon"></i>
                        <input type="radio" id="payment" name="transaction-type" value="payment">
                        <label for="payment" class="radio-text-glow">ุชุณููู ุฏูุนุฉ</label>
                        <div class="type-indicator">ูุดุท</div>
                    </div>
                </div>
            </div>
            
            <!-- ุงุฎุชูุงุฑ ุงูุนููุฉ -->
            <div class="form-group">
                <label>ุงูุนููุฉ</label>
                <div class="currency-section">
                    <div class="currency-option" id="currency-dinar">
                        <div class="currency-flag">๐ฑ๐พ</div>
                        <div class="currency-code">LYD</div>
                        <div class="currency-name">ุฏููุงุฑ ููุจู</div>
                    </div>
                    <div class="currency-option" id="currency-dollar">
                        <div class="currency-flag">๐บ๐ธ</div>
                        <div class="currency-code">USD</div>
                        <div class="currency-name">ุฏููุงุฑ ุฃูุฑููู</div>
                    </div>
                    <div class="currency-option" id="currency-euro">
                        <div class="currency-flag">๐ช๐บ</div>
                        <div class="currency-code">EUR</div>
                        <div class="currency-name">ููุฑู</div>
                    </div>
                </div>
                <input type="hidden" id="currency" value="LYD">
            </div>
            
            <!-- ุญููู ุงูุชุฐูุฑุฉ ูุงูุบุฑุงูุฉ -->
            <div id="ticket-fine-fields">
                <div class="form-group">
                    <label for="passenger-name">ุงุณู ุงููุณุงูุฑ</label>
                    <input type="text" id="passenger-name" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุงูุฑ">
                </div>
                
                <div class="form-group">
                    <label for="document-number">ุฑูู ุงููุณุชูุฏ</label>
                    <input type="text" id="document-number" placeholder="ุฃุฏุฎู ุฑูู ุงููุณุชูุฏ">
                </div>
                
                <div class="form-group">
                    <label for="destination">ุงููุฌูุฉ</label>
                    <select id="destination">
                        <option value="TIP - IST">(TIP - IST)</option>
                        <option value="other">ูุฌูุฉ ุฃุฎุฑู</option>
                    </select>
                    <input type="text" id="other-destination" placeholder="ุฃุฏุฎู ุงููุฌูุฉ (ูุซุงู: TIP - ROM)" class="hidden">
                </div>
                
                <div class="form-group">
                    <label for="trip-type">ููุน ุงูุฑุญูุฉ</label>
                    <select id="trip-type">
                        <option value="ุฐูุงุจ">ุฐูุงุจ ููุท</option>
                        <option value="ุฐูุงุจ ูุนูุฏุฉ">ุฐูุงุจ ูุนูุฏุฉ</option>
                    </select>
                </div>
            </div>
            
            <!-- ุญููู ุงูุบุฑุงูุฉ ููุท -->
            <div id="fine-only-fields" class="hidden">
                <div class="form-group">
                    <label for="fine-reason">ุณุจุจ ุงูุบุฑุงูุฉ</label>
                    <textarea id="fine-reason" placeholder="ุฃุฏุฎู ุณุจุจ ุงูุบุฑุงูุฉ" rows="2"></textarea>
                </div>
            </div>
            
            <!-- ุญููู ุงูุชุณููู -->
            <div id="payment-fields" class="hidden">
                <div class="form-group">
                    <label for="payment-description">ูุตู ุงูุฏูุนุฉ</label>
                    <input type="text" id="payment-description" placeholder="ูุซุงู: ุชุณููู ุฏูุนุฉ ุดูุฑ ุฃูุชูุจุฑ">
                </div>
            </div>
            
            <!-- ุญููู ูุดุชุฑูุฉ -->
            <div class="form-group">
                <label for="amount">ุงููุจูุบ</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="amount" placeholder="ุฃุฏุฎู ุงููุจูุบ" min="0" step="0.001" pattern="[0-9]*[.,]?[0-9]{0,3}" inputmode="decimal" style="flex: 1;">
                    <span id="currency-symbol" style="font-weight: bold; color: var(--primary-color);">LYD</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="date">ุชุงุฑูุฎ ุงูุนูููุฉ</label>
                <input type="date" id="date" value="">
            </div>
            
            <div class="form-group" id="notes-group">
                <label for="notes">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                <input type="text" id="notes" placeholder="ููุงุญุธุงุช (ุงุฎุชูุงุฑู)">
            </div>
            
            <button class="btn btn-add" id="add-transaction">
                <i class="fas fa-plus"></i> ุฅุถุงูุฉ ุงูุนูููุฉ
            </button>
            
            <button class="btn btn-reset" id="reset-form">
                <i class="fas fa-redo"></i> ูุณุญ ุงููููุฐุฌ
            </button>
        </div>
        
        <!-- ุชุจููุจ ูุดู ุงูุญุณุงุจ -->
        <div class="tab-content report-section" id="report-tab">
            <div class="report-header no-print">
                <h2 class="company-report-title" id="report-company-name">ูุดู ุงูุญุณุงุจ</h2>
                <div class="report-header-actions">
                    <div class="company-selector-report">
                        <select id="report-company" class="no-print">
                            <option value="">-- ุงุฎุชุฑ ุงูุดุฑูุฉ --</option>
                        </select>
                    </div>
                    <button class="btn btn-print no-print" id="print-report">
                        <i class="fas fa-print"></i> ุทุจุงุนุฉ ุงููุดู
                    </button>
                </div>
            </div>
            
            <!-- ููุฎุต ุงูุนููุงุช -->
            <div class="summary-items-currency no-print" id="currency-summary">
                <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
            </div>
            
            <div class="table-container">
                <div class="scroll-indicator">โ ุงุณุญุจ ูุฑุคูุฉ ุงููุฒูุฏ โ</div>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูููุน</th>
                            <th>ุงููุณุงูุฑ</th>
                            <th>ุงููุณุชูุฏ</th>
                            <th>ุงููุฌูุฉ</th>
                            <th>ุงูุฑุญูุฉ</th>
                            <th>ุงูุณุจุจ</th>
                            <th>ุงููุจูุบ</th>
                            <th>ุงูุนููุฉ</th>
                            <th>ุงูุฑุตูุฏ</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- ุงูุจูุงูุงุช ุณุชุถุงู ููุง ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
                    </tbody>
                </table>
            </div>
            
            <!-- ููุฎุต ุชุญุช ุงูุฌุฏูู -->
            <div class="summary-below-table no-print" id="summary-below-table">
                <h3><i class="fas fa-chart-bar"></i> ููุฎุต ูุดู ุงูุญุณุงุจ</h3>
                <div class="summary-items">
                    <div class="summary-item">
                        <h4>ุนุฏุฏ ุงูุชุฐุงูุฑ</h4>
                        <div class="value" id="total-tickets">0</div>
                    </div>
                    <div class="summary-item">
                        <h4>ูุฌููุน ุงูุบุฑุงูุงุช</h4>
                        <div class="value" id="total-fines">0</div>
                    </div>
                    <div class="summary-item">
                        <h4>ูุฌููุน ุงููุฏููุนุงุช</h4>
                        <div class="value" id="total-payments">0</div>
                    </div>
                    <div class="summary-item">
                        <h4>ุนุฏุฏ ุงูุนูููุงุช</h4>
                        <div class="value" id="total-transactions">0</div>
                    </div>
                </div>
            </div>
            
            <div id="no-data">
                ูุง ุชูุฌุฏ ุนูููุงุช ูุณุฌูุฉ ุจุนุฏ. ูู ุจุฅุถุงูุฉ ุนูููุงุช ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ.
            </div>
        </div>
        
        <!-- ุชุจููุจ ุฅุฏุงุฑุฉ ุงูุนูููุงุช -->
        <div class="tab-content manage-section" id="manage-tab">
            <h2><i class="fas fa-cog"></i> ุฅุฏุงุฑุฉ ุงูุนูููุงุช</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filter-company">ุชุตููุฉ ุญุณุจ ุงูุดุฑูุฉ</label>
                    <select id="filter-company">
                        <option value="">ุฌููุน ุงูุดุฑูุงุช</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-type">ุชุตููุฉ ุญุณุจ ุงูููุน</label>
                    <select id="filter-type">
                        <option value="">ุฌููุน ุงูุฃููุงุน</option>
                        <option value="ticket">ุชุฐูุฑุฉ</option>
                        <option value="fine">ุบุฑุงูุฉ</option>
                        <option value="payment">ุชุณููู ุฏูุนุฉ</option>
                        <option value="initial">ุฑุตูุฏ ุงูุชุชุงุญู</option>
                        <option value="cancel">ุฅูุบุงุก</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-currency">ุชุตููุฉ ุญุณุจ ุงูุนููุฉ</label>
                    <select id="filter-currency">
                        <option value="">ุฌููุน ุงูุนููุงุช</option>
                        <option value="LYD">ุฏููุงุฑ (LYD)</option>
                        <option value="USD">ุฏููุงุฑ (USD)</option>
                        <option value="EUR">ููุฑู (EUR)</option>
                    </select>
                </div>
                
                <button class="btn btn-reset" id="reset-filters" style="margin-top: 0;">
                    <i class="fas fa-filter"></i> ุฅุนุงุฏุฉ ุงูุชุนููู
                </button>
            </div>
            
            <!-- ูููุฐุฌ ุงูุชุนุฏูู -->
            <div id="edit-form-container" class="hidden">
                <div class="edit-form">
                    <h3><i class="fas fa-edit"></i> ุชุนุฏูู ุงูุนูููุฉ</h3>
                    <div class="form-group">
                        <label for="edit-transaction-type">ููุน ุงูุนูููุฉ</label>
                        <select id="edit-transaction-type">
                            <option value="ticket">ุชุฐูุฑุฉ</option>
                            <option value="fine">ุบุฑุงูุฉ</option>
                            <option value="payment">ุชุณููู ุฏูุนุฉ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-currency">ุงูุนููุฉ</label>
                        <select id="edit-currency">
                            <option value="LYD">ุฏููุงุฑ ููุจู (LYD)</option>
                            <option value="USD">ุฏููุงุฑ ุฃูุฑููู (USD)</option>
                            <option value="EUR">ููุฑู (EUR)</option>
                        </select>
                    </div>
                    
                    <div id="edit-ticket-fields">
                        <div class="form-group">
                            <label for="edit-passenger-name">ุงุณู ุงููุณุงูุฑ</label>
                            <input type="text" id="edit-passenger-name" placeholder="ุงุณู ุงููุณุงูุฑ">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-document-number">ุฑูู ุงููุณุชูุฏ</label>
                            <input type="text" id="edit-document-number" placeholder="ุฑูู ุงููุณุชูุฏ">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-destination">ุงููุฌูุฉ</label>
                            <select id="edit-destination">
                                <option value="TIP - IST">(TIP - IST)</option>
                                <option value="other">ูุฌูุฉ ุฃุฎุฑู</option>
                            </select>
                            <input type="text" id="edit-other-destination" placeholder="ุฃุฏุฎู ุงููุฌูุฉ" class="hidden">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-trip-type">ููุน ุงูุฑุญูุฉ</label>
                            <select id="edit-trip-type">
                                <option value="ุฐูุงุจ">ุฐูุงุจ ููุท</option>
                                <option value="ุฐูุงุจ ูุนูุฏุฉ">ุฐูุงุจ ูุนูุฏุฉ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="edit-fine-only-fields" class="hidden">
                        <div class="form-group">
                            <label for="edit-fine-reason">ุณุจุจ ุงูุบุฑุงูุฉ</label>
                            <textarea id="edit-fine-reason" placeholder="ุณุจุจ ุงูุบุฑุงูุฉ" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div id="edit-payment-fields" class="hidden">
                        <div class="form-group">
                            <label for="edit-payment-description">ูุตู ุงูุฏูุนุฉ</label>
                            <input type="text" id="edit-payment-description" placeholder="ูุตู ุงูุฏูุนุฉ">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-amount">ุงููุจูุบ</label>
                        <input type="number" id="edit-amount" placeholder="ุงููุจูุบ" min="0" step="0.001" pattern="[0-9]*[.,]?[0-9]{0,3}">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-date">ุชุงุฑูุฎ ุงูุนูููุฉ</label>
                        <input type="date" id="edit-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notes">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                        <input type="text" id="edit-notes" placeholder="ููุงุญุธุงุช">
                    </div>
                    
                    <div class="edit-form-buttons">
                        <button class="btn btn-cancel" id="cancel-edit">
                            <i class="fas fa-times"></i> ุฅูุบุงุก
                        </button>
                        <button class="btn btn-save" id="save-edit">
                            <i class="fas fa-save"></i> ุญูุธ ุงูุชุนุฏููุงุช
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ุชุฃููุฏ ุงูุญุฐู -->
            <div id="delete-confirm-container" class="hidden">
                <div class="confirm-delete">
                    <h4><i class="fas fa-exclamation-triangle"></i> ุชุฃููุฏ ุงูุญุฐู</h4>
                    <p>ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุนูููุฉุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-cancel" id="cancel-delete">
                            <i class="fas fa-times"></i> ุฅูุบุงุก
                        </button>
                        <button class="btn btn-delete" id="confirm-delete">
                            <i class="fas fa-trash"></i> ูุนูุ ุงุญุฐู
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ุชุฃููุฏ ุงูุฅูุบุงุก -->
            <div id="cancel-transaction-container" class="hidden">
                <div class="confirm-cancel">
                    <h4><i class="fas fa-exchange-alt"></i> ุชุฃููุฏ ุฅูุบุงุก ุงูุนูููุฉ</h4>
                    <p>ุณูุชู ุฅุถุงูุฉ ุนูููุฉ ุฌุฏูุฏุฉ ูุนููุณุฉ ุจููุณ ุงูุจูุงูุงุช ูุชุญููุฏ ุงููุจูุบ.</p>
                    <div class="cancel-details" id="cancel-details">
                        <!-- ุณูุชู ุชุนุจุฆุชู ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
                    </div>
                    <div class="cancel-buttons">
                        <button class="btn btn-cancel" id="cancel-cancel">
                            <i class="fas fa-times"></i> ุฅูุบุงุก
                        </button>
                        <button class="btn btn-cancel-transaction" id="confirm-cancel">
                            <i class="fas fa-exchange-alt"></i> ูุนูุ ุฃูุบ ุงูุนูููุฉ
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-container manage-table-container">
                <div class="scroll-indicator">โ ุงุณุญุจ ูุฑุคูุฉ ุงููุฒูุฏ โ</div>
                <table id="manage-transactions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุดุฑูุฉ</th>
                            <th>ุงูููุน</th>
                            <th>ุงููุณุงูุฑ</th>
                            <th>ุงููุจูุบ</th>
                            <th>ุงูุนููุฉ</th>
                            <th>ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="manage-transactions-body">
                        <!-- ุงูุจูุงูุงุช ุณุชุถุงู ููุง ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑูุจุช -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-transactions">
                ูุง ุชูุฌุฏ ุนูููุงุช ูุณุฌูุฉ ุจุนุฏ. ูู ุจุฅุถุงูุฉ ุนูููุงุช ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู ุชุจููุจ "ุฅุถุงูุฉ ุนูููุฉ".
            </div>
        </div>
    </div>
    
    <!-- ูุงูุฐุฉ ุฅุถุงูุฉ ุดุฑูุฉ ุฌุฏูุฏุฉ -->
    <div id="add-company-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-building"></i> ุฅุถุงูุฉ ุดุฑูุฉ ุฌุฏูุฏุฉ</h3>
                <button class="close-modal" id="close-add-company-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="new-company-name">ุงุณู ุงูุดุฑูุฉ</label>
                <input type="text" id="new-company-name" placeholder="ุฃุฏุฎู ุงุณู ุงูุดุฑูุฉ">
            </div>
            
            <div class="initial-balance-section">
                <label>ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู</label>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">ุญุฏุฏ ุฅุฐุง ูุงูุช ุงูุดุฑูุฉ ุชุญุชุงุฌ ููู ุฃู ุฃูุช ุชุญุชุงุฌ ูู ุงูุดุฑูุฉ</p>
                
                <div class="balance-type">
                    <div class="credit-option" id="credit-option">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">ุฏุงุฆู</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">ุงูุดุฑูุฉ ุชุญุชุงุฌ ููู</div>
                    </div>
                    <div class="debit-option" id="debit-option">
                        <i class="fas fa-money-bill-wave"></i>
                        <div style="margin-top: 8px; font-size: 1rem;">ูุฏูู</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">ุฃูุช ุชุญุชุงุฌ ูู ุงูุดุฑูุฉ</div>
                    </div>
                </div>
                
                <div class="balance-explanation">
                    <div id="credit-explanation" class="hidden">
                        <p><strong class="explanation-positive">ุฏุงุฆู:</strong> ุงูุดุฑูุฉ ุชุญุชุงุฌ ููู ูุจูุบุงู (ูุฏูู ุฑุตูุฏ ููุฌุจ ูุฏู ุงูุดุฑูุฉ)</p>
                    </div>
                    <div id="debit-explanation" class="hidden">
                        <p><strong class="explanation-negative">ูุฏูู:</strong> ุฃูุช ุชุญุชุงุฌ ูู ุงูุดุฑูุฉ ูุจูุบุงู (ูุฏูู ุฑุตูุฏ ุณุงูุจ ูุฏู ุงูุดุฑูุฉ)</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="initial-balance">ุงููุจูุบ (ุฏููุงุฑ ููุจู)</label>
                    <input type="number" id="initial-balance" placeholder="ุฃุฏุฎู ุงููุจูุบ ุจุงูุฏููุงุฑ" min="0" step="0.001" pattern="[0-9]*[.,]?[0-9]{0,3}" inputmode="decimal">
                </div>
                
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    <i class="fas fa-info-circle"></i> ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู ูููู ุจุงูุฏููุงุฑ ุงูููุจู ููุท. ูููู ุฅุถุงูุฉ ุนูููุงุช ุจุนููุงุช ุฃุฎุฑู ุจุนุฏ ุฅูุดุงุก ุงูุดุฑูุฉ.
                </p>
            </div>
            
            <button class="btn btn-add" id="save-new-company">
                <i class="fas fa-save"></i> ุญูุธ ุงูุดุฑูุฉ
            </button>
        </div>
    </div>
    
    <footer class="no-print">
        <p>TAREK Tickets - ูุชุนุฏุฏ ุงูุนููุงุช &copy; 2023</p>
        <p>@tro8qa | ุทุงุฑู ุงูุทูู ููุจุฑูุฌูุงุช</p>
    </footer>

    <script>
        // ุจูุงูุงุช ุงูุชุทุจูู
        let transactions = [];
        let companies = {}; // ูููู ุฌุฏูุฏ: {companyName: {LYD: balance, USD: balance, EUR: balance}}
        
        // ุญุงูุฉ ุงูุชุทุจูู
        let balanceType = 'credit';
        let initialBalance = 0;
        let currentEditTransactionId = null;
        let currentDeleteTransactionId = null;
        let currentCancelTransactionId = null;
        let selectedCurrency = 'LYD';
        
        // ุนูุงุตุฑ DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // ูุคุดุฑ ููุน ุงูุนูููุฉ ุงููุดุท
        const activeTypeIndicator = document.getElementById('active-type-indicator');
        
        // ุนูุงุตุฑ ุงูุนููุงุช
        const currencyDinar = document.getElementById('currency-dinar');
        const currencyDollar = document.getElementById('currency-dollar');
        const currencyEuro = document.getElementById('currency-euro');
        const currencyInput = document.getElementById('currency');
        const currencySymbol = document.getElementById('currency-symbol');
        const companyCurrencyBalances = document.getElementById('company-currency-balances');
        const currencySummary = document.getElementById('currency-summary');
        const filterCurrencySelect = document.getElementById('filter-currency');
        
        // ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช
        const openAddCompanyModalBtn = document.getElementById('open-add-company-modal');
        const addCompanyModal = document.getElementById('add-company-modal');
        const closeAddCompanyModalBtn = document.getElementById('close-add-company-modal');
        const saveNewCompanyBtn = document.getElementById('save-new-company');
        
        const newCompanyNameInput = document.getElementById('new-company-name');
        const debitOption = document.getElementById('debit-option');
        const creditOption = document.getElementById('credit-option');
        const debitExplanation = document.getElementById('debit-explanation');
        const creditExplanation = document.getElementById('credit-explanation');
        const initialBalanceInput = document.getElementById('initial-balance');
        
        const companyList = document.getElementById('company-list');
        const noCompaniesMsg = document.getElementById('no-companies');
        const companySelect = document.getElementById('company');
        const reportCompanySelect = document.getElementById('report-company');
        const currentCompanyElement = document.getElementById('current-company');
        const companyBalanceElement = document.getElementById('company-balance');
        const reportCompanyNameElement = document.getElementById('report-company-name');
        const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
        
        // ุนูุงุตุฑ ุงูุทุจุงุนุฉ
        const printPage = document.querySelector('.print-page');
        const printCompanyName = document.getElementById('print-company-name');
        const printCurrentBalance = document.getElementById('print-current-balance');
        const currentPrintDate = document.getElementById('current-print-date');
        const printTransactionsBody = document.getElementById('print-transactions-body');
        const printSummaryBalance = document.getElementById('print-summary-balance');
        const printCompanyCurrencies = document.getElementById('print-company-currencies');
        const printCurrencySummary = document.getElementById('print-currency-summary');
        const printSummaryByCurrency = document.getElementById('print-summary-by-currency');
        
        // ุนูุงุตุฑ ุฎูุงุฑุงุช ููุน ุงูุนูููุฉ
        const ticketOption = document.getElementById('ticket-option');
        const fineOption = document.getElementById('fine-option');
        const paymentOption = document.getElementById('payment-option');
        
        // ุญููู ุฅุถุงูุฉ ุงูุนูููุฉ
        const ticketFineFields = document.getElementById('ticket-fine-fields');
        const fineOnlyFields = document.getElementById('fine-only-fields');
        const passengerNameInput = document.getElementById('passenger-name');
        const documentNumberInput = document.getElementById('document-number');
        const destinationSelect = document.getElementById('destination');
        const otherDestinationInput = document.getElementById('other-destination');
        const tripTypeSelect = document.getElementById('trip-type');
        const fineReasonInput = document.getElementById('fine-reason');
        const paymentFields = document.getElementById('payment-fields');
        const paymentDescriptionInput = document.getElementById('payment-description');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const notesInput = document.getElementById('notes');
        const notesGroup = document.getElementById('notes-group');
        
        // ุญููู ุงูุชุนุฏูู
        const editFormContainer = document.getElementById('edit-form-container');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editTicketFields = document.getElementById('edit-ticket-fields');
        const editFineOnlyFields = document.getElementById('edit-fine-only-fields');
        const editPaymentFields = document.getElementById('edit-payment-fields');
        const editPassengerNameInput = document.getElementById('edit-passenger-name');
        const editDocumentNumberInput = document.getElementById('edit-document-number');
        const editDestinationSelect = document.getElementById('edit-destination');
        const editOtherDestinationInput = document.getElementById('edit-other-destination');
        const editTripTypeSelect = document.getElementById('edit-trip-type');
        const editFineReasonInput = document.getElementById('edit-fine-reason');
        const editPaymentDescriptionInput = document.getElementById('edit-payment-description');
        const editAmountInput = document.getElementById('edit-amount');
        const editDateInput = document.getElementById('edit-date');
        const editNotesInput = document.getElementById('edit-notes');
        const editCurrencySelect = document.getElementById('edit-currency');
        
        // ุชุฃููุฏ ุงูุญุฐู
        const deleteConfirmContainer = document.getElementById('delete-confirm-container');
        
        // ุชุฃููุฏ ุงูุฅูุบุงุก
        const cancelTransactionContainer = document.getElementById('cancel-transaction-container');
        const cancelDetails = document.getElementById('cancel-details');
        
        // ููุงุชุฑ ุฅุฏุงุฑุฉ ุงูุนูููุงุช
        const filterCompanySelect = document.getElementById('filter-company');
        const filterTypeSelect = document.getElementById('filter-type');
        const resetFiltersBtn = document.getElementById('reset-filters');
        
        // ุฃุฒุฑุงุฑ
        const addTransactionButton = document.getElementById('add-transaction');
        const resetFormButton = document.getElementById('reset-form');
        const printReportButton = document.getElementById('print-report');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelCancelBtn = document.getElementById('cancel-cancel');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        
        // ุนูุงุตุฑ ุงูุชูุฑูุฑ
        const transactionsBody = document.getElementById('transactions-body');
        const manageTransactionsBody = document.getElementById('manage-transactions-body');
        const noDataElement = document.getElementById('no-data');
        const noTransactionsElement = document.getElementById('no-transactions');
        const totalTicketsElement = document.getElementById('total-tickets');
        const totalFinesElement = document.getElementById('total-fines');
        const totalPaymentsElement = document.getElementById('total-payments');
        const totalTransactionsElement = document.getElementById('total-transactions');
        const summaryBelowTable = document.getElementById('summary-below-table');
        
        // ุชุนููู ุชุงุฑูุฎ ุงูููู ูุชุงุฑูุฎ ุงูุชุฑุงุถู
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        editDateInput.value = today;
        
        // ุฃุญุฏุงุซ ุงูุชุญูู
        // ุงูุชุจููุจุงุช
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
                
                if (tabId === 'manage') {
                    updateManageTable();
                }
                
                if (tabId === 'report') {
                    updateReport();
                }
                
                if (tabId === 'add') {
                    updateActiveTypeIndicator();
                }
                
                // ุชุญุณูู ุงูุนุฑุถ ููููุงุชู
                optimizeForMobile();
            });
        });
        
        // ุฃุญุฏุงุซ ุงุฎุชูุงุฑ ุงูุนููุฉ
        currencyDinar.addEventListener('click', () => selectCurrency('LYD'));
        currencyDollar.addEventListener('click', () => selectCurrency('USD'));
        currencyEuro.addEventListener('click', () => selectCurrency('EUR'));
        
        // ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช
        openAddCompanyModalBtn.addEventListener('click', openAddCompanyModal);
        closeAddCompanyModalBtn.addEventListener('click', closeAddCompanyModal);
        saveNewCompanyBtn.addEventListener('click', saveNewCompany);
        
        // ุฃุญุฏุงุซ ุฎูุงุฑุงุช ุงูุฑุตูุฏ
        debitOption.addEventListener('click', function() {
            selectBalanceType('debit');
        });
        
        creditOption.addEventListener('click', function() {
            selectBalanceType('credit');
        });
        
        // ุฃุญุฏุงุซ ุงูุญููู
        companySelect.addEventListener('change', function() {
            const companyName = this.value || '--';
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = companyName === '--' ? 'ูุดู ุงูุญุณุงุจ' : `ูุดู ุญุณุงุจ: ${companyName}`;
            updateCompanyCurrencyBalances(this.value);
            updateReport();
            optimizeForMobile();
        });
        
        // ุญุฏุซ ุงุฎุชูุงุฑ ุงูุดุฑูุฉ ูู ุงูุชูุฑูุฑ
        reportCompanySelect.addEventListener('change', function() {
            updateReport();
        });
        
        destinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherDestinationInput.classList.remove('hidden');
                otherDestinationInput.focus();
            } else {
                otherDestinationInput.classList.add('hidden');
            }
        });
        
        editDestinationSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                editOtherDestinationInput.classList.remove('hidden');
                editOtherDestinationInput.focus();
            } else {
                editOtherDestinationInput.classList.add('hidden');
            }
        });
        
        // ุชุบููุฑ ุญููู ุงููููุฐุฌ ุญุณุจ ููุน ุงูุนูููุฉ
        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateFormFields(this.value);
                updateActiveTypeClasses(this.value);
                updateActiveTypeIndicator();
            });
        });
        
        editTransactionTypeSelect.addEventListener('change', function() {
            updateEditFormFields(this.value);
        });
        
        // ููุงุชุฑ ุฅุฏุงุฑุฉ ุงูุนูููุงุช
        filterCompanySelect.addEventListener('change', updateManageTable);
        filterTypeSelect.addEventListener('change', updateManageTable);
        filterCurrencySelect.addEventListener('change', updateManageTable);
        resetFiltersBtn.addEventListener('click', function() {
            filterCompanySelect.value = '';
            filterTypeSelect.value = '';
            filterCurrencySelect.value = '';
            updateManageTable();
            this.classList.add('pulse');
            setTimeout(() => this.classList.remove('pulse'), 1000);
        });
        
        // ุฃุฒุฑุงุฑ ุงูุนูู
        addTransactionButton.addEventListener('click', addTransaction);
        resetFormButton.addEventListener('click', resetForm);
        printReportButton.addEventListener('click', function() {
            preparePrint();
            setTimeout(() => {
                window.print();
                // ุฅุนุงุฏุฉ ุฅุฎูุงุก ุนูุงุตุฑ ุงูุทุจุงุนุฉ ุจุนุฏ ุงูุทุจุงุนุฉ
                setTimeout(() => {
                    printPage.style.display = 'none';
                }, 100);
            }, 500);
        });
        cancelEditBtn.addEventListener('click', cancelEdit);
        saveEditBtn.addEventListener('click', saveEdit);
        cancelDeleteBtn.addEventListener('click', cancelDelete);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        cancelCancelBtn.addEventListener('click', cancelCancel);
        confirmCancelBtn.addEventListener('click', confirmCancel);
        
        // ุชุญููู ุงูุจูุงูุงุช ูู localStorage
        loadData();
        
        // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        selectCurrency('LYD'); // ุงุฎุชูุงุฑ ุงูุฏููุงุฑ ูุนููุฉ ุงูุชุฑุงุถูุฉ
        updateReport();
        updateActiveTypeIndicator();
        updateActiveTypeClasses('ticket'); // ุชุฐูุฑุฉ ูู ุงูุงูุชุฑุงุถูุฉ
        
        // ุฏุงูุฉ ุงุฎุชูุงุฑ ุงูุนููุฉ
        function selectCurrency(currency) {
            selectedCurrency = currency;
            currencyInput.value = currency;
            currencySymbol.textContent = currency;
            
            // ุชุญุฏูุซ ุงูุชุญุฏูุฏ ุงูุจุตุฑู
            currencyDinar.classList.remove('selected');
            currencyDollar.classList.remove('selected');
            currencyEuro.classList.remove('selected');
            
            if (currency === 'LYD') {
                currencyDinar.classList.add('selected');
            } else if (currency === 'USD') {
                currencyDollar.classList.add('selected');
            } else if (currency === 'EUR') {
                currencyEuro.classList.add('selected');
            }
        }
        
        // ุฏุงูุฉ ุชุญุณูู ุงูุนุฑุถ ููููุงุชู
        function optimizeForMobile() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // ุชุญุณูู ุนุฑุถ ุงููุฌูุฉ ุนูู ุงูููุงุชู
                document.querySelectorAll('#transactions-table td:nth-child(6)').forEach(td => {
                    const content = td.textContent;
                    if (content.includes('-')) {
                        const parts = content.split('-');
                        if (parts.length >= 2) {
                            td.innerHTML = parts[0].trim();
                            td.title = content; // ุฅุถุงูุฉ ุชูููุญ ุนูุฏ ุงูุชูุฑูุฑ
                        }
                    }
                });
                
                // ุชุญุณูู ุนุฑุถ ุงูุณุจุจ/ุงููุตู
                document.querySelectorAll('#transactions-table td:nth-child(8)').forEach(td => {
                    const content = td.textContent;
                    if (content.length > 15) {
                        td.textContent = content.substring(0, 15) + '...';
                        td.title = content; // ุฅุถุงูุฉ ุชูููุญ ุนูุฏ ุงูุชูุฑูุฑ
                    }
                });
                
                // ุชุญุณูู ุนุฑุถ ุงุณู ุงููุณุงูุฑ
                document.querySelectorAll('#transactions-table td:nth-child(4)').forEach(td => {
                    const content = td.textContent;
                    if (content.length > 12) {
                        td.textContent = content.substring(0, 12) + '...';
                        td.title = content;
                    }
                });
            }
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุฆุงุช ุงูููุน ุงููุดุท
        function updateActiveTypeClasses(activeType) {
            // ุฅุฒุงูุฉ ุฌููุน ุงููุฆุงุช ุงููุดุทุฉ ุฃููุงู
            ticketOption.classList.remove('active-ticket');
            fineOption.classList.remove('active-fine');
            paymentOption.classList.remove('active-payment');
            
            // ุฅุถุงูุฉ ุงููุฆุฉ ุงูููุงุณุจุฉ
            if (activeType === 'ticket') {
                ticketOption.classList.add('active-ticket');
            } else if (activeType === 'fine') {
                fineOption.classList.add('active-fine');
            } else if (activeType === 'payment') {
                paymentOption.classList.add('active-payment');
            }
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุคุดุฑ ุงูููุน ุงููุดุท
        function updateActiveTypeIndicator() {
            let activeType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) activeType = radio.value;
            });
            
            let icon = '';
            let title = '';
            let description = '';
            let className = '';
            
            if (activeType === 'ticket') {
                icon = 'fas fa-ticket-alt';
                title = 'ุชุฐูุฑุฉ';
                description = 'ุฃูุช ุชููู ุจุชุณุฌูู ุชุฐูุฑุฉ ุฌุฏูุฏุฉ. ุงูุฑุฌุงุก ููุก ุจูุงูุงุช ุงููุณุงูุฑ ูุงููุณุชูุฏ ูุงููุฌูุฉ.';
                className = 'active-type-ticket';
            } else if (activeType === 'fine') {
                icon = 'fas fa-exclamation-triangle';
                title = 'ุบุฑุงูุฉ';
                description = 'ุฃูุช ุชููู ุจุชุณุฌูู ุบุฑุงูุฉ. ุงูุฑุฌุงุก ููุก ุณุจุจ ุงูุบุฑุงูุฉ ูุจูุงูุงุชูุง.';
                className = 'active-type-fine';
            } else if (activeType === 'payment') {
                icon = 'fas fa-money-bill-wave';
                title = 'ุชุณููู ุฏูุนุฉ';
                description = 'ุฃูุช ุชููู ุจุชุณุฌูู ุชุณููู ุฏูุนุฉ ููุดุฑูุฉ. ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุตู ุงูุฏูุนุฉ.';
                className = 'active-type-payment';
            }
            
            activeTypeIndicator.innerHTML = `
                <div class="active-type-header ${className}">
                    <div class="active-type-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="active-type-text">
                        <h3>ููุน ุงูุนูููุฉ ุงูุญุงูู: ${title}</h3>
                        <p>${description}</p>
                    </div>
                </div>
            `;
            
            activeTypeIndicator.classList.remove('hidden');
        }
        
        // ุฏุงูุฉ ูุชุญ ูุงูุฐุฉ ุฅุถุงูุฉ ุดุฑูุฉ
        function openAddCompanyModal() {
            addCompanyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            newCompanyNameInput.value = '';
            selectBalanceType('credit');
            initialBalanceInput.value = '';
            setTimeout(() => newCompanyNameInput.focus(), 100);
        }
        
        // ุฏุงูุฉ ุฅุบูุงู ูุงูุฐุฉ ุฅุถุงูุฉ ุดุฑูุฉ
        function closeAddCompanyModal() {
            addCompanyModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // ุฏุงูุฉ ุงุฎุชูุงุฑ ููุน ุงูุฑุตูุฏ
        function selectBalanceType(type) {
            balanceType = type;
            
            if (type === 'debit') {
                debitOption.classList.add('selected');
                creditOption.classList.remove('selected');
                debitExplanation.classList.remove('hidden');
                creditExplanation.classList.add('hidden');
            } else {
                debitOption.classList.remove('selected');
                creditOption.classList.add('selected');
                debitExplanation.classList.add('hidden');
                creditExplanation.classList.remove('hidden');
            }
        }
        
        // ุฏุงูุฉ ุญูุธ ุดุฑูุฉ ุฌุฏูุฏุฉ
        function saveNewCompany() {
            const companyName = newCompanyNameInput.value.trim();
            const balance = parseFloat(initialBalanceInput.value) || 0;
            
            if (companyName === '') {
                alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุดุฑูุฉ');
                newCompanyNameInput.focus();
                return;
            }
            
            if (companies.hasOwnProperty(companyName)) {
                alert('ูุฐู ุงูุดุฑูุฉ ููุฌูุฏุฉ ูุณุจูุงู');
                return;
            }
            
            let openingBalance = balance;
            if (balanceType === 'debit') {
                openingBalance = -balance;
            }
            
            // ุฅูุดุงุก ูููู ุฌุฏูุฏ ููุนููุงุช ุงููุชุนุฏุฏุฉ
            companies[companyName] = {
                LYD: openingBalance,
                USD: 0,
                EUR: 0
            };
            
            if (balance > 0) {
                const transaction = {
                    id: generateId(),
                    date: today,
                    type: 'initial',
                    company: companyName,
                    amount: balance,
                    currency: 'LYD',
                    description: `ุฑุตูุฏ ุงูุชุชุงุญู ${balanceType === 'credit' ? 'ุฏุงุฆู (ุงูุดุฑูุฉ ุชุญุชุงุฌ ููู)' : 'ูุฏูู (ุฃุญุชุงุฌ ูู ุงูุดุฑูุฉ)'}`
                };
                
                transactions.push(transaction);
            }
            
            updateCompanyList();
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            
            companySelect.value = companyName;
            currentCompanyElement.textContent = companyName;
            reportCompanyNameElement.textContent = `ูุดู ุญุณุงุจ: ${companyName}`;
            updateCompanyCurrencyBalances(companyName);
            
            closeAddCompanyModal();
            saveData();
            
            updateReport();
            updateManageTable();
            optimizeForMobile();
            
            alert('ุชู ุฅุถุงูุฉ ุงูุดุฑูุฉ ุจูุฌุงุญ!');
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุญููู ุงููููุฐุฌ ุญุณุจ ููุน ุงูุนูููุฉ
        function updateFormFields(transactionType) {
            ticketFineFields.classList.add('hidden');
            fineOnlyFields.classList.add('hidden');
            paymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.add('hidden');
                notesGroup.classList.remove('hidden');
            } else if (transactionType === 'fine') {
                ticketFineFields.classList.remove('hidden');
                fineOnlyFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            } else if (transactionType === 'payment') {
                paymentFields.classList.remove('hidden');
                notesGroup.classList.add('hidden');
            }
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุญููู ูููุฐุฌ ุงูุชุนุฏูู
        function updateEditFormFields(transactionType) {
            editTicketFields.classList.add('hidden');
            editFineOnlyFields.classList.add('hidden');
            editPaymentFields.classList.add('hidden');
            
            if (transactionType === 'ticket') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.add('hidden');
            } else if (transactionType === 'fine') {
                editTicketFields.classList.remove('hidden');
                editFineOnlyFields.classList.remove('hidden');
            } else if (transactionType === 'payment') {
                editPaymentFields.classList.remove('hidden');
            }
        }
        
        // ุฏุงูุฉ ุฅุถุงูุฉ ุนูููุฉ ุฌุฏูุฏุฉ
        function addTransaction() {
            const company = companySelect.value;
            if (!company) {
                alert('ูุฑุฌู ุงุฎุชูุงุฑ ุดุฑูุฉ ุฃููุงู');
                companySelect.focus();
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            let transactionType = '';
            transactionTypeRadios.forEach(radio => {
                if (radio.checked) transactionType = radio.value;
            });
            
            const transaction = {
                id: generateId(),
                date: dateInput.value,
                type: transactionType,
                company: company,
                amount: parseFloat(amountInput.value),
                currency: selectedCurrency
            };
            
            if (transactionType === 'ticket') {
                let destination = destinationSelect.value;
                if (destination === 'other') {
                    destination = otherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('ูุฑุฌู ุฅุฏุฎุงู ุงููุฌูุฉ');
                        otherDestinationInput.focus();
                        return;
                    }
                }
                
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destination;
                transaction.tripType = tripTypeSelect.value;
                transaction.notes = notesInput.value.trim();
                
                if (transaction.passengerName === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุงูุฑ ููุชุฐูุฑุฉ');
                    passengerNameInput.focus();
                    return;
                }
                
                if (transaction.documentNumber === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุณุชูุฏ ููุชุฐูุฑุฉ');
                    documentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                transaction.passengerName = passengerNameInput.value.trim();
                transaction.documentNumber = documentNumberInput.value.trim();
                transaction.destination = destinationSelect.value;
                transaction.tripType = tripTypeSelect.value;
                transaction.reason = fineReasonInput.value.trim();
                
                if (transaction.reason === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุณุจุจ ุงูุบุฑุงูุฉ');
                    fineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                transaction.description = paymentDescriptionInput.value.trim();
                
                if (transaction.description === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ูุตู ุงูุฏูุนุฉ');
                    paymentDescriptionInput.focus();
                    return;
                }
            }
            
            updateCompanyBalanceAfterTransaction(company, transaction.type, transaction.amount, transaction.currency);
            
            transactions.push(transaction);
            
            saveData();
            
            updateReport();
            updateCompanyList();
            updateManageTable();
            optimizeForMobile();
            
            resetForm();
            
            alert('ุชู ุฅุถุงูุฉ ุงูุนูููุฉ ุจูุฌุงุญ!');
        }
        
        // ุฏุงูุฉ ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        function validateForm() {
            if (amountInput.value === '' || parseFloat(amountInput.value) <= 0) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุตูุฑ');
                amountInput.focus();
                return false;
            }
            
            return true;
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุฑุตูุฏ ุงูุดุฑูุฉ ุจุนุฏ ุงูุนูููุฉ
        function updateCompanyBalanceAfterTransaction(company, type, amount, currency) {
            if (!companies[company]) {
                companies[company] = {LYD: 0, USD: 0, EUR: 0};
            }
            
            if (type === 'ticket' || type === 'fine') {
                companies[company][currency] += amount;
            } else if (type === 'payment') {
                companies[company][currency] -= amount;
            } else if (type === 'cancel') {
                // ูุง ูุชุบูุฑ ุงูุฑุตูุฏ ูุน ุนูููุฉ ุงูุฅูุบุงุก ูุฃููุง ุนูููุฉ ูุนุงูุณุฉ
                // ูุชู ุชุญุฏูุซ ุงูุฑุตูุฏ ุนูุฏ ุฅุถุงูุฉ ุงูุนูููุฉ ุงูุฃุตููุฉ
            }
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุนุฑุถ ุฑุตูุฏ ุงูุดุฑูุฉ ุจุงูุนููุงุช ุงููุชุนุฏุฏุฉ
        function updateCompanyCurrencyBalances(company) {
            if (!company) {
                companyCurrencyBalances.innerHTML = `
                    <div class="currency-balance-item">
                        <div class="currency-balance-code">LYD</div>
                        <div class="currency-balance-amount">0.000</div>
                    </div>
                    <div class="currency-balance-item">
                        <div class="currency-balance-code">USD</div>
                        <div class="currency-balance-amount">0.000</div>
                    </div>
                    <div class="currency-balance-item">
                        <div class="currency-balance-code">EUR</div>
                        <div class="currency-balance-amount">0.000</div>
                    </div>
                `;
                return;
            }
            
            const companyBalances = companies[company] || {LYD: 0, USD: 0, EUR: 0};
            
            companyCurrencyBalances.innerHTML = '';
            
            ['LYD', 'USD', 'EUR'].forEach(currency => {
                const balance = companyBalances[currency] || 0;
                const balanceItem = document.createElement('div');
                balanceItem.className = 'currency-balance-item';
                
                let amountClass = 'currency-balance-amount';
                if (balance > 0) {
                    amountClass += ' positive';
                } else if (balance < 0) {
                    amountClass += ' negative';
                }
                
                balanceItem.innerHTML = `
                    <div class="currency-balance-code">${currency}</div>
                    <div class="${amountClass}">${formatCurrency(balance, currency)}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        ${balance > 0 ? '(ุฏุงุฆู)' : balance < 0 ? '(ูุฏูู)' : '(ุตูุฑ)'}
                    </div>
                `;
                
                companyCurrencyBalances.appendChild(balanceItem);
            });
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุดุฑูุงุช
        function updateCompanyList() {
            if (Object.keys(companies).length === 0) {
                noCompaniesMsg.style.display = 'block';
                companyList.innerHTML = '<p id="no-companies">ูุง ุชูุฌุฏ ุดุฑูุงุช ูุถุงูุฉ ุจุนุฏ</p>';
                return;
            }
            
            noCompaniesMsg.style.display = 'none';
            companyList.innerHTML = '';
            
            Object.keys(companies).sort().forEach(company => {
                const companyItem = document.createElement('div');
                companyItem.className = 'company-item';
                
                const companyBalances = companies[company];
                let balanceText = '';
                
                // ุฌูุน ุฅุฌูุงูู ุงูุฑุตูุฏ ูุฌููุน ุงูุนููุงุช
                let totalBalance = 0;
                ['LYD', 'USD', 'EUR'].forEach(currency => {
                    totalBalance += companyBalances[currency] || 0;
                });
                
                if (totalBalance > 0) {
                    balanceText = 'ุฏุงุฆู';
                } else if (totalBalance < 0) {
                    balanceText = 'ูุฏูู';
                } else {
                    balanceText = 'ูุชูุงุฒู';
                }
                
                companyItem.innerHTML = `
                    <div class="company-name">${company}</div>
                    <div class="company-item-balance">${balanceText}</div>
                    <div class="company-item-actions">
                        <button class="delete-company" data-company="${company}">ุญุฐู</button>
                    </div>
                `;
                
                companyList.appendChild(companyItem);
            });
            
            document.querySelectorAll('.delete-company').forEach(btn => {
                btn.addEventListener('click', function() {
                    const companyToDelete = this.getAttribute('data-company');
                    deleteCompany(companyToDelete);
                });
            });
        }
        
        // ุฏุงูุฉ ุญุฐู ุดุฑูุฉ
        function deleteCompany(companyName) {
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุดุฑูุฉ "${companyName}"ุ ุณูุชู ุญุฐู ุฌููุน ุนูููุงุชูุง ุฃูุถุงู.`)) {
                return;
            }
            
            delete companies[companyName];
            transactions = transactions.filter(t => t.company !== companyName);
            
            updateCompanyList();
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            updateReport();
            updateManageTable();
            saveData();
            optimizeForMobile();
            
            alert('ุชู ุญุฐู ุงูุดุฑูุฉ ูุนูููุงุชูุง ุจูุฌุงุญ!');
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุดุฑูุงุช ูู select
        function updateCompanySelect() {
            const currentValue = companySelect.value;
            
            companySelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุดุฑูุฉ --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                companySelect.value = currentValue;
            }
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุดุฑูุงุช ูู select ุงูุชูุฑูุฑ
        function updateReportCompanySelect() {
            const currentValue = reportCompanySelect.value;
            
            reportCompanySelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุดุฑูุฉ --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                reportCompanySelect.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                reportCompanySelect.value = currentValue;
            }
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุดุฑูุงุช ูู ููุชุฑ ุฅุฏุงุฑุฉ ุงูุนูููุงุช
        function updateFilterCompanySelect() {
            filterCompanySelect.innerHTML = '<option value="">ุฌููุน ุงูุดุฑูุงุช</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                filterCompanySelect.appendChild(option);
            });
        }
        
        // ุฏุงูุฉ ูุชุญ ูููุฐุฌ ุงูุชุนุฏูู
        function openEditForm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentEditTransactionId = transactionId;
            
            editFormContainer.classList.remove('hidden');
            deleteConfirmContainer.classList.add('hidden');
            cancelTransactionContainer.classList.add('hidden');
            
            editTransactionTypeSelect.value = transaction.type;
            editCurrencySelect.value = transaction.currency;
            updateEditFormFields(transaction.type);
            
            if (transaction.type === 'ticket') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ุฐูุงุจ';
                editNotesInput.value = transaction.notes || '';
            } else if (transaction.type === 'fine') {
                editPassengerNameInput.value = transaction.passengerName || '';
                editDocumentNumberInput.value = transaction.documentNumber || '';
                editDestinationSelect.value = transaction.destination || 'TIP - IST';
                editTripTypeSelect.value = transaction.tripType || 'ุฐูุงุจ';
                editFineReasonInput.value = transaction.reason || '';
            } else if (transaction.type === 'payment') {
                editPaymentDescriptionInput.value = transaction.description || '';
            }
            
            editAmountInput.value = transaction.amount;
            editDateInput.value = transaction.date;
            
            editFormContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ุฏุงูุฉ ุฅูุบุงุก ุงูุชุนุฏูู
        function cancelEdit() {
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
        }
        
        // ุฏุงูุฉ ุญูุธ ุงูุชุนุฏููุงุช
        function saveEdit() {
            if (!currentEditTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentEditTransactionId);
            if (transactionIndex === -1) return;
            
            const oldTransaction = transactions[transactionIndex];
            const oldAmount = oldTransaction.amount;
            const oldType = oldTransaction.type;
            const oldCurrency = oldTransaction.currency;
            
            // ุฅุฒุงูุฉ ุงูุชุฃุซูุฑ ุงููุฏูู
            if (oldType === 'ticket' || oldType === 'fine') {
                companies[oldTransaction.company][oldCurrency] -= oldAmount;
            } else if (oldType === 'payment') {
                companies[oldTransaction.company][oldCurrency] += oldAmount;
            }
            
            const transactionType = editTransactionTypeSelect.value;
            const amount = parseFloat(editAmountInput.value);
            const currency = editCurrencySelect.value;
            
            if (!amount || amount <= 0) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุตูุฑ');
                editAmountInput.focus();
                return;
            }
            
            const updatedTransaction = {
                ...oldTransaction,
                date: editDateInput.value,
                type: transactionType,
                amount: amount,
                currency: currency
            };
            
            if (transactionType === 'ticket') {
                let destination = editDestinationSelect.value;
                if (destination === 'other') {
                    destination = editOtherDestinationInput.value.trim();
                    if (destination === '') {
                        alert('ูุฑุฌู ุฅุฏุฎุงู ุงููุฌูุฉ');
                        editOtherDestinationInput.focus();
                        return;
                    }
                }
                
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = destination;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.notes = editNotesInput.value.trim();
                updatedTransaction.reason = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.passengerName === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุงูุฑ ููุชุฐูุฑุฉ');
                    editPassengerNameInput.focus();
                    return;
                }
                
                if (updatedTransaction.documentNumber === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุณุชูุฏ ููุชุฐูุฑุฉ');
                    editDocumentNumberInput.focus();
                    return;
                }
                
            } else if (transactionType === 'fine') {
                updatedTransaction.passengerName = editPassengerNameInput.value.trim();
                updatedTransaction.documentNumber = editDocumentNumberInput.value.trim();
                updatedTransaction.destination = editDestinationSelect.value;
                updatedTransaction.tripType = editTripTypeSelect.value;
                updatedTransaction.reason = editFineReasonInput.value.trim();
                updatedTransaction.notes = '';
                updatedTransaction.description = '';
                
                if (updatedTransaction.reason === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุณุจุจ ุงูุบุฑุงูุฉ');
                    editFineReasonInput.focus();
                    return;
                }
                
            } else if (transactionType === 'payment') {
                updatedTransaction.description = editPaymentDescriptionInput.value.trim();
                updatedTransaction.passengerName = '';
                updatedTransaction.documentNumber = '';
                updatedTransaction.destination = '';
                updatedTransaction.tripType = '';
                updatedTransaction.reason = '';
                updatedTransaction.notes = '';
                
                if (updatedTransaction.description === '') {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ูุตู ุงูุฏูุนุฉ');
                    editPaymentDescriptionInput.focus();
                    return;
                }
            }
            
            // ุชุทุจูู ุงูุชุฃุซูุฑ ุงูุฌุฏูุฏ
            if (transactionType === 'ticket' || transactionType === 'fine') {
                companies[updatedTransaction.company][currency] += amount;
            } else if (transactionType === 'payment') {
                companies[updatedTransaction.company][currency] -= amount;
            }
            
            transactions[transactionIndex] = updatedTransaction;
            
            saveData();
            updateReport();
            updateCompanyList();
            updateCompanyCurrencyBalances(updatedTransaction.company);
            updateManageTable();
            optimizeForMobile();
            
            editFormContainer.classList.add('hidden');
            currentEditTransactionId = null;
            
            alert('ุชู ุชุญุฏูุซ ุงูุนูููุฉ ุจูุฌุงุญ!');
        }
        
        // ุฏุงูุฉ ูุชุญ ุชุฃููุฏ ุงูุญุฐู
        function openDeleteConfirm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentDeleteTransactionId = transactionId;
            
            deleteConfirmContainer.classList.remove('hidden');
            editFormContainer.classList.add('hidden');
            cancelTransactionContainer.classList.add('hidden');
            
            deleteConfirmContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ุฏุงูุฉ ุฅูุบุงุก ุงูุญุฐู
        function cancelDelete() {
            deleteConfirmContainer.classList.add('hidden');
            currentDeleteTransactionId = null;
        }
        
        // ุฏุงูุฉ ุชุฃููุฏ ุงูุญุฐู
        function confirmDelete() {
            if (!currentDeleteTransactionId) return;
            
            const transactionIndex = transactions.findIndex(t => t.id === currentDeleteTransactionId);
            if (transactionIndex === -1) return;
            
            const transaction = transactions[transactionIndex];
            
            if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุนูููุฉุ\n\nุงูุชูุงุตูู:\n- ุงูุดุฑูุฉ: ${transaction.company}\n- ุงูููุน: ${getTypeName(transaction.type)}\n- ุงููุจูุบ: ${formatCurrency(transaction.amount, transaction.currency)}\n- ุงูุนููุฉ: ${transaction.currency}\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.`)) {
                if (transaction.type === 'ticket' || transaction.type === 'fine') {
                    companies[transaction.company][transaction.currency] -= transaction.amount;
                } else if (transaction.type === 'payment') {
                    companies[transaction.company][transaction.currency] += transaction.amount;
                } else if (transaction.type === 'cancel') {
                    // ูุง ูุชุบูุฑ ุงูุฑุตูุฏ ุนูุฏ ุญุฐู ุนูููุฉ ุฅูุบุงุก
                }
                
                transactions.splice(transactionIndex, 1);
                
                saveData();
                updateReport();
                updateCompanyList();
                updateCompanyCurrencyBalances(transaction.company);
                updateManageTable();
                optimizeForMobile();
                
                deleteConfirmContainer.classList.add('hidden');
                currentDeleteTransactionId = null;
                
                alert('ุชู ุญุฐู ุงูุนูููุฉ ุจูุฌุงุญ!');
            }
        }
        
        // ุฏุงูุฉ ูุชุญ ุชุฃููุฏ ุงูุฅูุบุงุก
        function openCancelConfirm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            currentCancelTransactionId = transactionId;
            
            // ูุง ูููู ุฅูุบุงุก ุนูููุฉ ุฅูุบุงุก
            if (transaction.type === 'cancel') {
                alert('ูุง ูููู ุฅูุบุงุก ุนูููุฉ ุฅูุบุงุก!');
                return;
            }
            
            // ุชุญุถูุฑ ุชูุงุตูู ุงูุฅูุบุงุก
            const cancelType = getCancelType(transaction.type);
            const newAmount = transaction.amount;
            const currency = transaction.currency;
            
            cancelDetails.innerHTML = `
                <p><strong>ุงูุนูููุฉ ุงูุฃุตููุฉ:</strong></p>
                <ul>
                    <li><strong>ุงูุดุฑูุฉ:</strong> ${transaction.company}</li>
                    <li><strong>ุงูููุน:</strong> ${getTypeName(transaction.type)}</li>
                    <li><strong>ุงููุจูุบ:</strong> ${formatCurrency(transaction.amount, transaction.currency)}</li>
                    <li><strong>ุงูุนููุฉ:</strong> ${currency}</li>
                    <li><strong>ุงูุชุงุฑูุฎ:</strong> ${transaction.date}</li>
                    ${transaction.passengerName ? `<li><strong>ุงููุณุงูุฑ:</strong> ${transaction.passengerName}</li>` : ''}
                    ${transaction.description ? `<li><strong>ุงููุตู:</strong> ${transaction.description}</li>` : ''}
                </ul>
                <p><strong>ุงูุนูููุฉ ุงูุฌุฏูุฏุฉ (ูุนููุณุฉ):</strong></p>
                <ul>
                    <li><strong>ุงูููุน:</strong> ${getTypeName(cancelType)}</li>
                    <li><strong>ุงููุจูุบ:</strong> ${formatCurrency(newAmount, currency)}</li>
                    <li><strong>ุงูุนููุฉ:</strong> ${currency}</li>
                    <li><strong>ุงูุชุงุฑูุฎ:</strong> ุงูููู</li>
                </ul>
                <p class="warning-text" style="color: var(--cancel-color); font-weight: bold; margin-top: 10px;">
                    ุณูุชู ุฅุถุงูุฉ ุนูููุฉ ุฌุฏูุฏุฉ ูุนููุณุฉ ูุชุญููุฏ ุงููุจูุบ ุงูุฃุตูู.
                </p>
            `;
            
            cancelTransactionContainer.classList.remove('hidden');
            editFormContainer.classList.add('hidden');
            deleteConfirmContainer.classList.add('hidden');
            
            cancelTransactionContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ุฏุงูุฉ ุฅูุบุงุก ุนูููุฉ ุงูุฅูุบุงุก
        function cancelCancel() {
            cancelTransactionContainer.classList.add('hidden');
            currentCancelTransactionId = null;
        }
        
        // ุฏุงูุฉ ุชุฃููุฏ ุงูุฅูุบุงุก
        function confirmCancel() {
            if (!currentCancelTransactionId) return;
            
            const originalTransaction = transactions.find(t => t.id === currentCancelTransactionId);
            if (!originalTransaction) return;
            
            // ุฅูุดุงุก ุนูููุฉ ุฅูุบุงุก ูุนุงูุณุฉ
            const cancelTransaction = {
                id: generateId(),
                date: today,
                type: 'cancel',
                company: originalTransaction.company,
                amount: originalTransaction.amount,
                currency: originalTransaction.currency,
                originalTransactionId: originalTransaction.id,
                cancelType: getCancelType(originalTransaction.type)
            };
            
            // ูุณุฎ ุงูุจูุงูุงุช ูู ุงูุนูููุฉ ุงูุฃุตููุฉ
            if (originalTransaction.type === 'ticket' || originalTransaction.type === 'fine') {
                cancelTransaction.passengerName = originalTransaction.passengerName;
                cancelTransaction.documentNumber = originalTransaction.documentNumber;
                cancelTransaction.destination = originalTransaction.destination;
                cancelTransaction.tripType = originalTransaction.tripType;
                cancelTransaction.reason = originalTransaction.reason;
                cancelTransaction.notes = `ุฅูุบุงุก ุนูููุฉ ${getTypeName(originalTransaction.type)} ุจุชุงุฑูุฎ ${originalTransaction.date}`;
            } else if (originalTransaction.type === 'payment') {
                cancelTransaction.description = `ุฅูุบุงุก ุฏูุนุฉ: ${originalTransaction.description}`;
            }
            
            // ุชุญุฏูุซ ุฑุตูุฏ ุงูุดุฑูุฉ (ุนูููุฉ ูุนุงูุณุฉ)
            if (originalTransaction.type === 'ticket' || originalTransaction.type === 'fine') {
                companies[originalTransaction.company][originalTransaction.currency] -= originalTransaction.amount;
            } else if (originalTransaction.type === 'payment') {
                companies[originalTransaction.company][originalTransaction.currency] += originalTransaction.amount;
            }
            
            transactions.push(cancelTransaction);
            
            saveData();
            updateReport();
            updateCompanyList();
            updateCompanyCurrencyBalances(originalTransaction.company);
            updateManageTable();
            optimizeForMobile();
            
            cancelTransactionContainer.classList.add('hidden');
            currentCancelTransactionId = null;
            
            alert('ุชู ุฅุถุงูุฉ ุนูููุฉ ุงูุฅูุบุงุก ุจูุฌุงุญ! ุชู ุชุญููุฏ ุงููุจูุบ ุงูุฃุตูู.');
        }
        
        // ุฏุงูุฉ ุงูุญุตูู ุนูู ููุน ุงูุนูููุฉ ุงููุนุงูุณุฉ ููุฅูุบุงุก
        function getCancelType(originalType) {
            if (originalType === 'ticket' || originalType === 'fine') {
                return 'payment'; // ุชุฐุงูุฑ ูุบุฑุงูุงุช ุชูุบู ุจุฏูุนุงุช
            } else if (originalType === 'payment') {
                return 'ticket'; // ุฏูุนุงุช ุชูุบู ุจุชุฐุงูุฑ
            }
            return 'cancel';
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุฌุฏูู ุฅุฏุงุฑุฉ ุงูุนูููุงุช
        function updateManageTable() {
            const filterCompany = filterCompanySelect.value;
            const filterType = filterTypeSelect.value;
            const filterCurrency = filterCurrencySelect.value;
            
            let filteredTransactions = [...transactions];
            
            if (filterCompany) {
                filteredTransactions = filteredTransactions.filter(t => t.company === filterCompany);
            }
            
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            
            if (filterCurrency) {
                filteredTransactions = filteredTransactions.filter(t => t.currency === filterCurrency);
            }
            
            if (filteredTransactions.length > 0) {
                noTransactionsElement.style.display = 'none';
                manageTransactionsBody.innerHTML = '';
            } else {
                noTransactionsElement.style.display = 'block';
                manageTransactionsBody.innerHTML = '';
                return;
            }
            
            filteredTransactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.className = 'transaction-row';
                
                let typeClass = '';
                let typeText = getTypeName(transaction.type);
                
                if (transaction.type === 'ticket') {
                    typeClass = 'transaction-ticket';
                } else if (transaction.type === 'fine') {
                    typeClass = 'transaction-fine';
                } else if (transaction.type === 'payment') {
                    typeClass = 'transaction-payment';
                } else if (transaction.type === 'initial') {
                    typeClass = 'transaction-initial';
                } else if (transaction.type === 'cancel') {
                    typeClass = 'transaction-cancel';
                    typeText = 'ุฅูุบุงุก';
                }
                
                let passengerName = transaction.passengerName || transaction.description || '-';
                if (passengerName.length > 20) {
                    passengerName = passengerName.substring(0, 20) + '...';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.company}</td>
                    <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                    <td>${passengerName}</td>
                    <td class="currency-column">${formatCurrency(transaction.amount, transaction.currency, false)}</td>
                    <td><span class="currency-badge">${transaction.currency}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn action-btn-edit" data-id="${transaction.id}">
                                <i class="fas fa-edit"></i> ุชุนุฏูู
                            </button>
                            <button class="action-btn action-btn-cancel" data-id="${transaction.id}">
                                <i class="fas fa-exchange-alt"></i> ุฅูุบุงุก
                            </button>
                            <button class="action-btn action-btn-delete" data-id="${transaction.id}">
                                <i class="fas fa-trash"></i> ุญุฐู
                            </button>
                        </div>
                    </td>
                `;
                
                manageTransactionsBody.appendChild(row);
            });
            
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openEditForm(transactionId);
                });
            });
            
            document.querySelectorAll('.action-btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openCancelConfirm(transactionId);
                });
            });
            
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    openDeleteConfirm(transactionId);
                });
            });
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุดู ุงูุญุณุงุจ
        function updateReport() {
            const selectedCompany = reportCompanySelect.value || companySelect.value;
            
            if (selectedCompany) {
                reportCompanyNameElement.textContent = `ูุดู ุญุณุงุจ: ${selectedCompany}`;
                printCompanyName.textContent = `ูุดู ุญุณุงุจ: ${selectedCompany}`;
            } else {
                reportCompanyNameElement.textContent = 'ูุดู ุงูุญุณุงุจ';
                printCompanyName.textContent = 'ูุดู ุงูุญุณุงุจ';
            }
            
            updateCompanyCurrencyBalances(selectedCompany);
            
            if (transactions.length > 0) {
                noDataElement.style.display = 'none';
                summaryBelowTable.style.display = 'block';
                transactionsBody.innerHTML = '';
            } else {
                noDataElement.style.display = 'block';
                summaryBelowTable.style.display = 'none';
                transactionsBody.innerHTML = '';
                updateSummary();
                updateCurrencySummary();
                return;
            }
            
            let filteredTransactions = [];
            
            if (selectedCompany) {
                filteredTransactions = transactions.filter(t => t.company === selectedCompany);
            } else {
                filteredTransactions = [...transactions];
            }
            
            // ุฅูุดุงุก ุฌุฏุงูู ูููุตูุฉ ููู ุนููุฉ
            const currencyGroups = {
                LYD: [],
                USD: [],
                EUR: []
            };
            
            filteredTransactions.forEach(transaction => {
                if (currencyGroups[transaction.currency]) {
                    currencyGroups[transaction.currency].push(transaction);
                }
            });
            
            // ุนุฑุถ ูู ุนููุฉ ูู ุฌุฏูู ูููุตู
            let rowIndex = 1;
            
            ['LYD', 'USD', 'EUR'].forEach(currency => {
                const currencyTransactions = currencyGroups[currency];
                
                if (currencyTransactions.length === 0) {
                    return;
                }
                
                // ุฅุถุงูุฉ ุนููุงู ุงูุนููุฉ
                const currencyHeaderRow = document.createElement('tr');
                currencyHeaderRow.className = 'currency-header-row';
                currencyHeaderRow.innerHTML = `
                    <td colspan="11" style="background-color: var(--light-color); font-weight: bold; text-align: center; padding: 15px;">
                        <i class="fas fa-money-bill-wave"></i> ${getCurrencyName(currency)} (${currency})
                    </td>
                `;
                transactionsBody.appendChild(currencyHeaderRow);
                
                let runningBalance = 0;
                currencyTransactions.forEach((transaction, index) => {
                    if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                        runningBalance += transaction.amount;
                    } else if (transaction.type === 'payment') {
                        runningBalance -= transaction.amount;
                    } else if (transaction.type === 'cancel') {
                        runningBalance -= transaction.amount;
                    }
                    
                    const row = document.createElement('tr');
                    
                    let typeClass = '';
                    let typeText = getTypeName(transaction.type);
                    
                    if (transaction.type === 'ticket') {
                        typeClass = 'transaction-ticket';
                    } else if (transaction.type === 'fine') {
                        typeClass = 'transaction-fine';
                    } else if (transaction.type === 'payment') {
                        typeClass = 'transaction-payment';
                    } else if (transaction.type === 'initial') {
                        typeClass = 'transaction-initial';
                    } else if (transaction.type === 'cancel') {
                        typeClass = 'transaction-cancel';
                        typeText = 'ุฅูุบุงุก';
                    }
                    
                    let passengerName = transaction.passengerName || '-';
                    let documentNumber = transaction.documentNumber || '-';
                    
                    let destination = transaction.destination || '-';
                    if (destination.includes('(')) {
                        const match = destination.match(/\(([^)]+)\)/);
                        if (match) {
                            destination = `<span class="destination-abbr">${match[1]}</span>`;
                        }
                    }
                    
                    let tripType = transaction.tripType || '-';
                    let reasonDesc = transaction.reason || transaction.description || '-';
                    
                    row.innerHTML = `
                        <td>${rowIndex++}</td>
                        <td>${transaction.date}</td>
                        <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                        <td>${passengerName}</td>
                        <td>${documentNumber}</td>
                        <td>${destination}</td>
                        <td>${tripType}</td>
                        <td>${reasonDesc}</td>
                        <td class="currency-column">${formatCurrency(transaction.amount, transaction.currency, false)}</td>
                        <td><span class="currency-badge">${transaction.currency}</span></td>
                        <td class="currency-column">${formatCurrency(runningBalance, transaction.currency, false)}</td>
                    `;
                    
                    transactionsBody.appendChild(row);
                });
                
                // ุฅุถุงูุฉ ุตู ุงูุฑุตูุฏ ุงูููุงุฆู ููู ุนููุฉ
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td colspan="9">ุงูุฑุตูุฏ ุงูููุงุฆู ูู${getCurrencyName(currency)} (${currency})</td>
                    <td>${currency}</td>
                    <td class="currency-column">${formatCurrency(runningBalance, currency, false)}</td>
                `;
                transactionsBody.appendChild(totalRow);
            });
            
            updateSummary(filteredTransactions);
            updateCurrencySummary(filteredTransactions);
            optimizeForMobile();
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ููุฎุต ุงูุนููุงุช
        function updateCurrencySummary(filteredTransactions = null) {
            const transactionsToCalculate = filteredTransactions || transactions;
            
            currencySummary.innerHTML = '';
            
            const currencyTotals = {
                LYD: {tickets: 0, fines: 0, payments: 0, balance: 0},
                USD: {tickets: 0, fines: 0, payments: 0, balance: 0},
                EUR: {tickets: 0, fines: 0, payments: 0, balance: 0}
            };
            
            // ุญุณุงุจ ุงูุฅุฌูุงููุงุช ููู ุนููุฉ
            transactionsToCalculate.forEach(transaction => {
                const currency = transaction.currency;
                if (!currencyTotals[currency]) return;
                
                if (transaction.type === 'ticket') {
                    currencyTotals[currency].tickets += transaction.amount;
                } else if (transaction.type === 'fine') {
                    currencyTotals[currency].fines += transaction.amount;
                } else if (transaction.type === 'payment') {
                    currencyTotals[currency].payments += transaction.amount;
                }
            });
            
            // ุญุณุงุจ ุงูุฑุตูุฏ ููู ุนููุฉ
            const selectedCompany = reportCompanySelect.value || companySelect.value;
            if (selectedCompany && companies[selectedCompany]) {
                currencyTotals.LYD.balance = companies[selectedCompany].LYD || 0;
                currencyTotals.USD.balance = companies[selectedCompany].USD || 0;
                currencyTotals.EUR.balance = companies[selectedCompany].EUR || 0;
            } else {
                // ุญุณุงุจ ุฅุฌูุงูู ุฌููุน ุงูุดุฑูุงุช
                Object.values(companies).forEach(companyBalances => {
                    currencyTotals.LYD.balance += companyBalances.LYD || 0;
                    currencyTotals.USD.balance += companyBalances.USD || 0;
                    currencyTotals.EUR.balance += companyBalances.EUR || 0;
                });
            }
            
            // ุนุฑุถ ููุฎุต ูู ุนููุฉ
            ['LYD', 'USD', 'EUR'].forEach(currency => {
                if (currencyTotals[currency].tickets === 0 && 
                    currencyTotals[currency].fines === 0 && 
                    currencyTotals[currency].payments === 0) {
                    return;
                }
                
                const currencyDiv = document.createElement('div');
                currencyDiv.className = 'currency-total';
                
                let balanceClass = '';
                if (currencyTotals[currency].balance > 0) {
                    balanceClass = 'positive';
                } else if (currencyTotals[currency].balance < 0) {
                    balanceClass = 'negative';
                }
                
                currencyDiv.innerHTML = `
                    <h4>${getCurrencyName(currency)} (${currency})</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">ุงูุชุฐุงูุฑ</div>
                            <div style="font-weight: bold;">${formatCurrency(currencyTotals[currency].tickets, currency, false)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">ุงูุบุฑุงูุงุช</div>
                            <div style="font-weight: bold;">${formatCurrency(currencyTotals[currency].fines, currency, false)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">ุงููุฏููุนุงุช</div>
                            <div style="font-weight: bold;">${formatCurrency(currencyTotals[currency].payments, currency, false)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #666;">ุงูุฑุตูุฏ</div>
                            <div style="font-weight: bold;" class="${balanceClass}">${formatCurrency(currencyTotals[currency].balance, currency, false)}</div>
                        </div>
                    </div>
                `;
                
                currencySummary.appendChild(currencyDiv);
            });
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุงูููุฎุต ุชุญุช ุงูุฌุฏูู
        function updateSummary(filteredTransactions = null) {
            const transactionsToCalculate = filteredTransactions || transactions;
            
            let totalTickets = 0;
            let totalFines = 0;
            let totalPayments = 0;
            
            transactionsToCalculate.forEach(transaction => {
                if (transaction.type === 'ticket') {
                    totalTickets++;
                } else if (transaction.type === 'fine') {
                    totalFines++;
                } else if (transaction.type === 'payment') {
                    totalPayments++;
                }
            });
            
            totalTicketsElement.textContent = totalTickets;
            totalFinesElement.textContent = totalFines;
            totalPaymentsElement.textContent = totalPayments;
            totalTransactionsElement.textContent = transactionsToCalculate.length;
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ุฌุฏูู ุงูุทุจุงุนุฉ
        function updatePrintTable(filteredTransactions = null) {
            const currentCompany = reportCompanySelect.value || companySelect.value;
            const transactionsToShow = filteredTransactions || transactions.filter(t => !currentCompany || t.company === currentCompany);
            
            printTransactionsBody.innerHTML = '';
            
            if (transactionsToShow.length === 0) {
                return;
            }
            
            // ุชุฌููุน ุงูุนูููุงุช ุญุณุจ ุงูุนููุฉ
            const currencyGroups = {
                LYD: [],
                USD: [],
                EUR: []
            };
            
            transactionsToShow.forEach(transaction => {
                if (currencyGroups[transaction.currency]) {
                    currencyGroups[transaction.currency].push(transaction);
                }
            });
            
            let rowIndex = 1;
            
            ['LYD', 'USD', 'EUR'].forEach(currency => {
                const currencyTransactions = currencyGroups[currency];
                
                if (currencyTransactions.length === 0) {
                    return;
                }
                
                // ุฅุถุงูุฉ ุนููุงู ุงูุนููุฉ
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `<td colspan="6" style="background-color: #f8f9fa; font-weight: bold; text-align: center; padding: 10px;">${getCurrencyName(currency)} (${currency})</td>`;
                printTransactionsBody.appendChild(headerRow);
                
                let runningBalance = 0;
                currencyTransactions.forEach(transaction => {
                    if (transaction.type === 'ticket' || transaction.type === 'fine' || transaction.type === 'initial') {
                        runningBalance += transaction.amount;
                    } else if (transaction.type === 'payment' || transaction.type === 'cancel') {
                        runningBalance -= transaction.amount;
                    }
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${rowIndex++}</td>
                        <td>${transaction.date}</td>
                        <td>${transaction.passengerName || '-'}</td>
                        <td>${transaction.documentNumber || '-'}</td>
                        <td>${formatCurrency(transaction.amount, transaction.currency, false)}</td>
                        <td>${formatCurrency(runningBalance, transaction.currency, false)}</td>
                    `;
                    
                    printTransactionsBody.appendChild(row);
                });
                
                // ุฅุถุงูุฉ ุตู ุงูุฑุตูุฏ ุงูููุงุฆู ููู ุนููุฉ
                const totalRow = document.createElement('tr');
                totalRow.innerHTML = `
                    <td colspan="5" style="font-weight: bold; text-align: center;">ุงูุฑุตูุฏ ุงูููุงุฆู ูู${getCurrencyName(currency)} (${currency})</td>
                    <td style="font-weight: bold;">${formatCurrency(runningBalance, currency, false)}</td>
                `;
                printTransactionsBody.appendChild(totalRow);
                
                // ุฅุถุงูุฉ ุตู ูุงุฑุบ ูููุตู ุจูู ุงูุนููุงุช
                const spacerRow = document.createElement('tr');
                spacerRow.innerHTML = `<td colspan="6" style="height: 15px;"></td>`;
                printTransactionsBody.appendChild(spacerRow);
            });
        }
        
        // ุฏุงูุฉ ุฅุนุฏุงุฏ ุงูุทุจุงุนุฉ
        function preparePrint() {
            // ุฅุธูุงุฑ ุตูุญุฉ ุงูุทุจุงุนุฉ
            printPage.style.display = 'block';
            
            // ุชุญุฏูุซ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-LY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' - ' + now.toLocaleTimeString('ar-LY', {
                hour: '2-digit',
                minute: '2-digit'
            });
            currentPrintDate.textContent = formattedDate;
            
            // ุชุญุฏูุซ ุฑุตูุฏ ุงูุดุฑูุฉ ุจุงูุนููุงุช
            const currentCompany = reportCompanySelect.value || companySelect.value;
            printCompanyCurrencies.innerHTML = '';
            
            if (currentCompany && companies[currentCompany]) {
                const companyBalances = companies[currentCompany];
                
                ['LYD', 'USD', 'EUR'].forEach(currency => {
                    const balance = companyBalances[currency] || 0;
                    if (balance !== 0) {
                        const balanceDiv = document.createElement('div');
                        balanceDiv.className = 'print-currency-balance';
                        balanceDiv.innerHTML = `
                            <div class="print-currency-code">${currency}</div>
                            <div class="print-currency-amount">${formatCurrency(balance, currency, false)}</div>
                            <div style="font-size: 12px;">${balance > 0 ? '(ุฏุงุฆู)' : '(ูุฏูู)'}</div>
                        `;
                        printCompanyCurrencies.appendChild(balanceDiv);
                    }
                });
            }
            
            // ุชุญุฏูุซ ููุฎุต ุงูุนููุงุช ูู ุงูุทุจุงุนุฉ
            printCurrencySummary.innerHTML = '';
            const transactionsToShow = currentCompany ? 
                transactions.filter(t => t.company === currentCompany) : 
                transactions;
            
            const currencyTotals = {
                LYD: {tickets: 0, fines: 0, payments: 0, balance: 0},
                USD: {tickets: 0, fines: 0, payments: 0, balance: 0},
                EUR: {tickets: 0, fines: 0, payments: 0, balance: 0}
            };
            
            transactionsToShow.forEach(transaction => {
                const currency = transaction.currency;
                if (!currencyTotals[currency]) return;
                
                if (transaction.type === 'ticket') {
                    currencyTotals[currency].tickets += transaction.amount;
                } else if (transaction.type === 'fine') {
                    currencyTotals[currency].fines += transaction.amount;
                } else if (transaction.type === 'payment') {
                    currencyTotals[currency].payments += transaction.amount;
                }
            });
            
            // ุญุณุงุจ ุงูุฑุตูุฏ ููู ุนููุฉ
            if (currentCompany && companies[currentCompany]) {
                currencyTotals.LYD.balance = companies[currentCompany].LYD || 0;
                currencyTotals.USD.balance = companies[currentCompany].USD || 0;
                currencyTotals.EUR.balance = companies[currentCompany].EUR || 0;
            }
            
            ['LYD', 'USD', 'EUR'].forEach(currency => {
                if (currencyTotals[currency].tickets === 0 && 
                    currencyTotals[currency].fines === 0 && 
                    currencyTotals[currency].payments === 0) {
                    return;
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'print-currency-item';
                itemDiv.innerHTML = `
                    <div class="print-currency-code">${currency}</div>
                    <div class="print-currency-amount">${formatCurrency(currencyTotals[currency].balance, currency, false)}</div>
                    <div style="font-size: 11px; margin-top: 5px;">
                        ุช: ${formatCurrency(currencyTotals[currency].tickets, currency, false)}<br>
                        ุบ: ${formatCurrency(currencyTotals[currency].fines, currency, false)}<br>
                        ุฏ: ${formatCurrency(currencyTotals[currency].payments, currency, false)}
                    </div>
                `;
                printCurrencySummary.appendChild(itemDiv);
            });
            
            // ุชุญุฏูุซ ูุณู ุงูุฑุตูุฏ ุงูููุงุฆู
            printSummaryByCurrency.innerHTML = '';
            ['LYD', 'USD', 'EUR'].forEach(currency => {
                const balance = currencyTotals[currency].balance;
                if (balance !== 0) {
                    const balanceDiv = document.createElement('div');
                    balanceDiv.style.margin = '10px 0';
                    balanceDiv.innerHTML = `
                        <strong>${getCurrencyName(currency)} (${currency}):</strong> 
                        <span class="${balance > 0 ? 'positive-balance-print' : 'negative-balance-print'}">
                            ${formatCurrency(balance, currency)}
                        </span>
                    `;
                    printSummaryByCurrency.appendChild(balanceDiv);
                }
            });
            
            // ุชุญุฏูุซ ุฌุฏูู ุงูุทุจุงุนุฉ
            updatePrintTable(transactionsToShow);
        }
        
        // ุฏุงูุฉ ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
        function resetForm() {
            passengerNameInput.value = '';
            documentNumberInput.value = '';
            destinationSelect.value = 'TIP - IST';
            otherDestinationInput.classList.add('hidden');
            otherDestinationInput.value = '';
            tripTypeSelect.value = 'ุฐูุงุจ';
            
            fineReasonInput.value = '';
            paymentDescriptionInput.value = '';
            
            amountInput.value = '';
            dateInput.value = today;
            notesInput.value = '';
            
            if (companySelect.value) {
                passengerNameInput.focus();
            }
        }
        
        // ุฏุงูุฉ ุงูุญุตูู ุนูู ุงุณู ุงูููุน
        function getTypeName(type) {
            switch(type) {
                case 'ticket': return 'ุชุฐูุฑุฉ';
                case 'fine': return 'ุบุฑุงูุฉ';
                case 'payment': return 'ุชุณููู';
                case 'initial': return 'ุงูุชุชุงุญู';
                case 'cancel': return 'ุฅูุบุงุก';
                default: return type;
            }
        }
        
        // ุฏุงูุฉ ุงูุญุตูู ุนูู ุงุณู ุงูุนููุฉ
        function getCurrencyName(currency) {
            switch(currency) {
                case 'LYD': return 'ุฏููุงุฑ ููุจู';
                case 'USD': return 'ุฏููุงุฑ ุฃูุฑููู';
                case 'EUR': return 'ููุฑู';
                default: return currency;
            }
        }
        
        // ุฏุงูุฉ ุชูููุฏ ูุนุฑู ูุฑูุฏ
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // ุฏุงูุฉ ุชูุณูู ุงูุนููุฉ
        function formatCurrency(amount, currency = 'LYD', includeSymbol = true) {
            const absAmount = Math.abs(amount);
            let formatted;
            
            // ุงุณุชุฎุฏุงู ุชูุณูู ููุงุณุจ ููุนููุฉ
            if (currency === 'LYD') {
                formatted = new Intl.NumberFormat('ar-LY', {
                    minimumFractionDigits: 3,
                    maximumFractionDigits: 3
                }).format(absAmount);
            } else if (currency === 'USD') {
                formatted = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(absAmount);
            } else if (currency === 'EUR') {
                formatted = new Intl.NumberFormat('de-DE', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(absAmount);
            } else {
                formatted = absAmount.toFixed(3);
            }
            
            let result = formatted;
            
            if (includeSymbol) {
                const symbols = {
                    'LYD': 'ุฏููุงุฑ',
                    'USD': 'ุฏููุงุฑ',
                    'EUR': 'ููุฑู'
                };
                result += ` ${symbols[currency] || ''}`;
            }
            
            if (amount < 0) {
                result = '-' + result;
            }
            
            return result;
        }
        
        // ุฏุงูุฉ ุญูุธ ุงูุจูุงูุงุช ูู localStorage
        function saveData() {
            localStorage.setItem('ticketSystem_transactions_multi', JSON.stringify(transactions));
            localStorage.setItem('ticketSystem_companies_multi', JSON.stringify(companies));
        }
        
        // ุฏุงูุฉ ุชุญููู ุงูุจูุงูุงุช ูู localStorage
        function loadData() {
            // ูุญุงููุฉ ุชุญููู ุงูุจูุงูุงุช ูุชุนุฏุฏุฉ ุงูุนููุงุช
            const savedTransactions = localStorage.getItem('ticketSystem_transactions_multi');
            const savedCompanies = localStorage.getItem('ticketSystem_companies_multi');
            
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            
            if (savedCompanies) {
                companies = JSON.parse(savedCompanies);
            } else {
                // ูุญุงููุฉ ุชุญููู ุงูุจูุงูุงุช ุงููุฏููุฉ ูุชุญููููุง
                const savedOldTransactions = localStorage.getItem('ticketSystem_transactions');
                const savedOldCompanies = localStorage.getItem('ticketSystem_companies');
                
                if (savedOldTransactions) {
                    const oldTransactions = JSON.parse(savedOldTransactions);
                    transactions = oldTransactions.map(t => ({
                        ...t,
                        currency: 'LYD' // ุชุญููู ุงูุนูููุงุช ุงููุฏููุฉ ุฅูู ุฏููุงุฑ
                    }));
                }
                
                if (savedOldCompanies) {
                    const oldCompanies = JSON.parse(savedOldCompanies);
                    // ุชุญููู ูููู ุงูุดุฑูุงุช ุงููุฏูู ุฅูู ุงูุฌุฏูุฏ
                    Object.keys(oldCompanies).forEach(company => {
                        companies[company] = {
                            LYD: oldCompanies[company],
                            USD: 0,
                            EUR: 0
                        };
                    });
                }
                
                if (savedOldTransactions || savedOldCompanies) {
                    saveData(); // ุญูุธ ุงูุจูุงูุงุช ุงููุญููุฉ ุจุงูุดูู ุงูุฌุฏูุฏ
                }
            }
            
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            updateCompanyList();
            optimizeForMobile();
        }
        
        // ุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
        addCompanyModal.addEventListener('click', function(e) {
            if (e.target === addCompanyModal) {
                closeAddCompanyModal();
            }
        });
        
        // ุงุฎุชูุงุฑ ููุน ุงูุฑุตูุฏ ุงูุงูุชุฑุงุถู
        selectBalanceType('credit');
        
        // ุฅุบูุงู ุงููุงูุฐุฉ ุจููุชุงุญ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!addCompanyModal.classList.contains('hidden')) {
                    closeAddCompanyModal();
                }
                if (editFormContainer.classList.contains('hidden') === false) {
                    cancelEdit();
                }
                if (deleteConfirmContainer.classList.contains('hidden') === false) {
                    cancelDelete();
                }
                if (cancelTransactionContainer.classList.contains('hidden') === false) {
                    cancelCancel();
                }
            }
        });
        
        // ุชุญุฏูุซ ุชุญุณููุงุช ุงูููุงุชู ุนูุฏ ุชุบููุฑ ุญุฌู ุงููุงูุฐุฉ
        window.addEventListener('resize', optimizeForMobile);
        
        // ุชููุฆุฉ ุงูุชุญุณููุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.addEventListener('load', function() {
            optimizeForMobile();
            // ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุนูุฏ ุงูุชุญููู
            document.querySelectorAll('.form-section, .report-section, .manage-section').forEach((section, index) => {
                section.style.animationDelay = `${0.1 * index}s`;
            });
        });
        
        // ุฅุฎูุงุก ุนูุงุตุฑ ุงูุทุจุงุนุฉ ุจุนุฏ ุงูุทุจุงุนุฉ
        window.addEventListener('afterprint', function() {
            printPage.style.display = 'none';
        });
    </script>
</body>
</html>
